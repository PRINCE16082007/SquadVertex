<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SV Routine Tracker - Eternal Growth</title>
  <meta name="theme-color" content="#ff9ec0">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Poppins:wght@300;400;500&family=Great+Vibes&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    :root {
      --primary-color: #ff9ec0;
      --secondary-color: #ffc2d6;
      --accent-color: #ff4d6d;
      --light-color: #fff0f3;
      --dark-color: #4a4a4a;
      --success-color: #8bd450;
      --missed-color: #d5d5d5;
      --header-gradient: linear-gradient(135deg, #ff9ec0, #ffc2d6);
      --card-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 8px 32px rgba(255, 118, 117, 0.15);
      --font-main: 'Poppins', sans-serif;
      --font-heading: 'Playfair Display', serif;
      --font-quote: 'Great Vibes', cursive;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--light-color);
      font-family: var(--font-main);
      margin: 0;
      min-height: 100vh;
      position: relative;
      padding-bottom: 60px;
      color: var(--dark-color);
      background-image: radial-gradient(#ffc2d6 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .header {
      text-align: center;
      padding: 3rem 1rem;
      background: var(--header-gradient);
      border-radius: 20px;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border: 2px solid white;
    }

    .header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
    }

    .header h1 {
      font-family: var(--font-heading);
      color: white;
      font-size: 3rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 2;
      letter-spacing: 0.5px;
    }

    .header p {
      color: white;
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
      opacity: 0.95;
    }

    .header h1::after {
      content: "ðŸŒ¸";
      position: absolute;
      top: -15px;
      right: 20px;
      font-size: 2.5rem;
    }

    .btn {
      background: white;
      color: var(--accent-color);
      border: none;
      padding: 0.9rem 1.8rem;
      border-radius: 30px;
      font-size: 1.05rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
      font-family: var(--font-main);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 4px 15px rgba(255, 117, 140, 0.2);
    }

    .btn:hover {
      background: var(--accent-color);
      color: white;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 77, 109, 0.3);
    }

    .btn i {
      font-size: 1.2rem;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
    }

    .btn-primary:hover {
      background: #ff3a5f;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(3px);
    }

    .modal {
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: 20px;
      max-width: 450px;
      width: 90%;
      position: relative;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .modal h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 1.8rem;
      font-family: var(--font-heading);
      text-align: center;
      margin-bottom: 1.8rem;
      font-weight: 600;
    }

    .modal label {
      display: block;
      margin: 0.8rem 0 0.3rem;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--dark-color);
      padding-left: 0.5rem;
    }

    .modal input {
      width: 100%;
      padding: 1rem;
      border: 1px solid #f0d0d8;
      border-radius: 12px;
      font-family: var(--font-main);
      font-size: 1rem;
      transition: all 0.3s;
      background: white;
    }

    .modal input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(255, 77, 109, 0.15);
    }

    .modal .actions {
      text-align: center;
      margin-top: 2rem;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #aaa;
      transition: color 0.3s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      color: var(--accent-color);
      background: rgba(255, 158, 192, 0.1);
    }

    .quote-container {
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: 20px;
      margin: 2.5rem 0;
      box-shadow: var(--shadow);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .quote-container::before {
      content: """;
      position: absolute;
      top: 20px;
      left: 30px;
      font-size: 5rem;
      color: var(--primary-color);
      opacity: 0.2;
      font-family: var(--font-quote);
    }
    
    .quote {
      font-family: var(--font-quote);
      font-size: 2.4rem;
      color: var(--accent-color);
      text-shadow: 2px 2px 4px rgba(255, 77, 109, 0.1);
      margin: 0;
      line-height: 1.5;
      text-align: center;
      position: relative;
      z-index: 2;
    }
    
    .streak-box, .gallery, .calendar-container {
      margin: 2.5rem 0;
    }
    
    .streak-box {
      background: var(--header-gradient);
      padding: 2.5rem;
      border-radius: 20px;
      color: white;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .streak-box::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: rgba(255, 255, 255, 0.3);
    }

    .streak-content {
      position: relative;
      z-index: 2;
    }

    .streak-stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 2rem 0;
      gap: 1rem;
    }

    .streak-stat {
      background: rgba(255, 255, 255, 0.25);
      padding: 1.5rem 1rem;
      border-radius: 20px;
      min-width: 180px;
      margin: 0.5rem;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.3s;
    }

    .streak-stat:hover {
      transform: translateY(-5px);
    }

    .streak-value {
      font-size: 2.8rem;
      font-weight: 700;
      margin: 0.5rem 0;
      display: block;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }

    .calendar-container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.8rem;
    }

    .calendar-nav {
      display: flex;
      gap: 0.8rem;
    }

    .calendar-nav-btn {
      background: var(--primary-color);
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(255, 158, 192, 0.3);
    }

    .calendar-nav-btn:hover {
      background: var(--accent-color);
      transform: scale(1.05);
    }

    .calendar-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--accent-color);
      font-family: var(--font-heading);
      letter-spacing: 0.5px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day-header {
      text-align: center;
      padding: 12px;
      font-weight: 600;
      color: var(--accent-color);
      font-size: 1rem;
      font-family: var(--font-heading);
    }

    .day-cell {
      padding: 14px 5px;
      text-align: center;
      border-radius: 15px;
      background: #fef9fb;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      border: 1px solid #f8e5eb;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }

    .day-cell:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(255, 77, 109, 0.15);
      background: white;
    }

    .completed-day {
      background: var(--success-color);
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
    }

    .missed-day {
      background: var(--missed-color);
      color: #777;
    }

    .today-cell {
      border: 2px solid var(--accent-color);
      background: white;
    }

    .day-number {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .day-status {
      font-size: 0.75rem;
      margin-top: 3px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    .gallery-item {
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow);
      transition: transform .3s;
      height: 280px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .gallery-item:hover {
      transform: translateY(-8px);
    }

    .gallery img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s;
    }

    .gallery-item:hover img {
      transform: scale(1.08);
    }

    .gallery-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 1.2rem;
      text-align: center;
      font-size: 1rem;
      transform: translateY(100%);
      transition: transform 0.4s;
    }

    .gallery-item:hover .gallery-caption {
      transform: translateY(0);
    }

    .routine-list {
      margin: 2.5rem 0;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.8rem;
      border-bottom: 2px solid #f8e5eb;
      padding-bottom: 1rem;
    }

    .list-title {
      font-size: 1.8rem;
      color: var(--accent-color);
      font-family: var(--font-heading);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .routine-item {
      display: flex;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #f8e5eb;
      transition: background 0.3s;
      border-radius: 12px;
      margin-bottom: 0.8rem;
      background: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.03);
    }

    .routine-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .routine-item:hover {
      background: #fff9fb;
      box-shadow: 0 5px 15px rgba(255, 77, 109, 0.08);
    }

    .routine-checkbox {
      margin-right: 1.2rem;
      width: 26px;
      height: 26px;
      accent-color: var(--success-color);
      cursor: pointer;
    }

    .routine-content {
      flex-grow: 1;
      font-size: 1.15rem;
      font-weight: 500;
      color: #555;
    }

    .routine-actions button {
      margin-left: 0.6rem;
      background: white;
      border: 1px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      color: var(--primary-color);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .routine-actions button:hover {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
      transform: scale(1.1);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #aaa;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      color: #f0d0d8;
    }

    .empty-state p {
      font-size: 1.2rem;
    }

    .footer {
      text-align: center;
      padding: 2rem;
      font-family: var(--font-main);
      color: #777;
      margin-top: 3rem;
      background: white;
      border-top: 1px solid #f8e5eb;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.03);
    }

    .consistency-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.3);
      padding: 0.8rem 1.8rem;
      border-radius: 30px;
      margin: 1rem 0;
      font-weight: 600;
      font-size: 1.1rem;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    /* Retro modal with scroll */
    #retroCalendar {
      max-height: 50vh;
      overflow-y: auto;
      padding: 15px;
      background: #fef9fb;
      border-radius: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
      border: 1px solid #f8e5eb;
    }

    .retro-day-cell {
      padding: 15px 8px;
      text-align: center;
      border-radius: 15px;
      background: #fef9fb;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      border: 1px solid #f8e5eb;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }

    .retro-day-cell:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(255, 77, 109, 0.15);
      background: white;
    }

    .retro-day-cell.missed-day {
      background: var(--missed-color);
      color: #777;
    }

    .retro-day-cell.completed-day {
      background: var(--success-color);
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .container {
        padding: 1.2rem;
      }

      .header h1 {
        font-size: 2.4rem;
      }

      .streak-stats {
        flex-direction: column;
        align-items: center;
      }

      .streak-stat {
        width: 100%;
        max-width: 300px;
      }

      .gallery {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .calendar-title {
        font-size: 1.4rem;
      }
    }

    @media (max-width: 600px) {
      .header {
        padding: 2rem 1rem;
      }

      .header h1 {
        font-size: 2rem;
      }

      .header p {
        font-size: 1rem;
      }

      .streak-stat {
        min-width: auto;
        width: 100%;
      }

      .quote {
        font-size: 2rem;
      }

      .routine-content {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="auth-container" id="authContainer" style="display:none; text-align:center; padding:3rem;">
    <div style="max-width:500px; margin:0 auto;">
      <div style="font-size:4rem; color:#ff9ec0; margin-bottom:1.5rem;">
        <i class="fas fa-seedling"></i>
      </div>
      <h2 style="font-family:var(--font-heading); color:#ff4d6d; font-size:2.5rem; margin-bottom:1.5rem;">ðŸŒ¸ Welcome to Your Growth Journey ðŸŒ¸</h2>
      <p style="font-size:1.2rem; color:#666; margin-bottom:2.5rem;">Sign in to track your progress and cultivate eternal growth</p>
      <button class="btn btn-primary" id="signInBtn"><i class="fab fa-google"></i> Sign in with Google</button>
    </div>
  </div>

  <div class="container" id="mainContainer" style="display:none;">
    <div class="user-info" id="userInfo" style="text-align:right; margin-bottom:1.5rem;"></div>

    <div class="header">
      <h1>My Eternal Growth Journey</h1>
      <p>Track your routines, build habits, and become your best self</p>
    </div>

    <div style="text-align:center; margin-bottom:2.5rem;">
      <button class="btn btn-primary" id="addRoutineBtn"><i class="fas fa-plus"></i> Add Routine</button>
    </div>

    <div class="routine-list">
      <div class="list-header">
        <h2 class="list-title">My Daily Routines</h2>
        <span id="routineCount" style="background:#ff4d6d; color:white; padding:0.3rem 1rem; border-radius:20px; font-weight:500;">0 routines</span>
      </div>
      <div class="routine-list-content" id="routineList"></div>
    </div>

    <div class="quote-container animate__animated animate__fadeIn">
      <p class="quote" id="dynamicQuote"></p>
    </div>

    <div class="streak-box">
      <div class="streak-content">
        <h2 style="margin-bottom:1.5rem; font-size:2rem; font-family:var(--font-heading);">Your Progress Journey</h2>

        <div class="streak-stats">
          <div class="streak-stat">
            <span>ðŸ”¥ Current Streak</span>
            <span class="streak-value" id="currentStreak">0</span>
            <span>days</span>
          </div>

          <div class="streak-stat">
            <span>ðŸŒ¸ Longest Streak</span>
            <span class="streak-value" id="longestStreak">0</span>
            <span>days</span>
          </div>

          <div class="streak-stat">
            <span>ðŸ“Š Consistency</span>
            <span class="streak-value" id="consistencyScore">0%</span>
            <span>(last 30 days)</span>
          </div>
        </div>

        <div class="consistency-badge" id="consistencyMessage">
          Start your journey to see your consistency score!
        </div>

        <div style="margin-top:1.5rem;">
          <button class="btn" id="markBtn"><i class="fas fa-check-circle"></i> Mark Today</button>
          <button class="btn" id="resetBtn"><i class="fas fa-redo"></i> Reset Today</button>
        </div>
      </div>
    </div>

    <div class="calendar-container">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button class="calendar-nav-btn" id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
          <button class="calendar-nav-btn" id="todayBtn">Today</button>
          <button class="calendar-nav-btn" id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <h2 class="calendar-title" id="calendarTitle">July 2025</h2>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>

    <div class="gallery" id="gallery">
      <div class="gallery-item">
        <img src="https://dl.dropboxusercontent.com/scl/fi/9svcemu34ehcmzbgofwtp/photo-1612824857666-f4b20bc92aa7.jpeg?rlkey=2qb8wezugwslyoekau5d8otrl&st=jm0crqoa&dl=0" alt="Growth">
        <div class="gallery-caption">Dedicated workspace for focused growth</div>
      </div>
      <div class="gallery-item">
        <img src="https://dl.dropboxusercontent.com/scl/fi/k19l9mjmc2nk5zohbiby9/photo-1531512073830-ba890ca4eba2.jpeg?rlkey=vypt87g0aix4wp8r20hzn5qs4&st=zawqet25&dl=0" alt="Meditation">
        <div class="gallery-caption">Morning meditation brings clarity</div>
      </div>
      <div class="gallery-item">
        <img src="https://dl.dropboxusercontent.com/scl/fi/ubuq43gztfhz1i2j4k7yr/photo-1553702446-4a0cfb5781f8.jpeg?rlkey=ub9rfam3ragt1we52e007lwhy&st=9ca7jqkw&dl=0" alt="Consistency">
        <div class="gallery-caption">Consistency is the key to mastery</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="routineModal">
    <div class="modal">
      <button class="close-btn" id="closeRoutineModal">&times;</button>
      <h3>Add Routine</h3>
      <label for="routineDesc">Routine Name</label>
      <input type="text" id="routineDesc" placeholder="e.g. No phone after 9pm" required>
      <div class="actions">
        <button class="btn btn-primary" id="saveRoutineBtn">Save Routine</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="retroModal" style="display:none;">
    <div class="modal">
      <button class="close-btn" id="closeRetroModal">&times;</button>
      <h3>Fill Missed Days</h3>
      <p id="missedDaysMessage" style="margin-bottom:1.5rem; font-size:1.1rem; color:#555;">You have missed tracking for X days. Please update your attendance:</p>
      <div id="retroCalendar" class="calendar"></div>
      <div class="actions" style="margin-top:1.5rem;">
        <button class="btn" id="cancelRetroBtn">Skip</button>
        <button class="btn btn-primary" id="saveRetroBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>SquadVertex Â© 2024 - Cultivating Eternal Growth</p>
    <p style="margin-top:0.8rem; font-size:1rem;"><i class="fas fa-heart" style="color:#ff4d6d;"></i> Designed with love for your personal growth journey</p>
  </div>

  <script type="module">
    // Firebase configuration & imports
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, query, 
      where, orderBy, doc, getDoc, updateDoc, deleteDoc, 
      setDoc
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, 
      onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentDate = new Date();
    let missedDays = [];
    let retroChanges = {};

    const quotes = [
      "No matter what we buildâ€”let's never forget who we're building it for.",
      "Some people seek peace in silence. I found mine in a smile I've never met.",
      "You are my today and all of my tomorrows.",
      "In your light I learn how to love. In your beauty, how to make poems.",
      "I love you not because of who you are, but because of who I am when I am with you.",
      "Every atom of my being is in love with every atom of yours.",
      "I would rather spend one lifetime with you, than face all the ages of this world alone.",
      "Your love is my eternal motivation to grow better every day ðŸŒ¸",
      "Growth is the only evidence of life.",
      "The journey of a thousand miles begins with a single step.",
      "Small daily improvements are the key to staggering long-term results.",
      "Your potential is endless. Go do what you were created to do."
    ];

    // Auth state listener
    onAuthStateChanged(auth, async user => {
      if (user) {
        document.getElementById('mainContainer').style.display = 'block';
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('userInfo').innerHTML = `
          <div style="display:inline-flex; align-items:center; gap:10px; background:rgba(255,255,255,0.9); padding:10px 20px; border-radius:30px; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
            <i class="fas fa-user-circle" style="font-size:1.8rem; color:#ff4d6d;"></i>
            <span style="font-weight:500;">${user.email}</span>
            <button class="btn" onclick="signOut(auth)" style="padding:7px 15px; font-size:0.9rem; background:#ff4d6d; color:white;">Sign out</button>
          </div>
        `;
        await initApp(user);
      } else {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
      }
    });

    document.getElementById('signInBtn').addEventListener('click', () => signInWithPopup(auth, provider));

    // Initialize after login
    async function initApp(user) {
      showRandomQuote();
      await fillMissingAttendance(user.uid);
      await renderCalendar(user.uid);
      await updateStreakDisplay(user.uid);
      loadRoutines(user.uid);

      // Check for missed days and prompt user
      if (missedDays.length > 0) {
        showRetroPrompt(user.uid);
      }
    }

    function showRandomQuote() {
      document.getElementById('dynamicQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
    }

    // Fill missing attendance records
    async function fillMissingAttendance(uid) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      // Get all existing records
      const recordsRef = collection(db, 'users', uid, 'dailyRecords');
      const snap = await getDocs(query(recordsRef, orderBy('date')));
      const existingDates = snap.docs.map(d => d.data().date);

      // Find the earliest record date or use today if none
      const earliestDate = existingDates.length > 0 ? existingDates[0] : todayStr;

      // Generate all dates from earliest to today
      const allDates = generateDateRange(earliestDate, todayStr);

      // Find missing dates
      missedDays = allDates.filter(date => !existingDates.includes(date));

      // Add placeholder records for missing dates
      const batch = [];
      missedDays.forEach(date => {
        const record = {
          date: date,
          status: 'Missed',
          reason: 'No data submitted',
          autoGenerated: true
        };
        batch.push(setDoc(doc(recordsRef), record));
      });

      if (batch.length > 0) {
        await Promise.all(batch);
      }
    }

    // Generate date range between two dates (YYYY-MM-DD format)
    function generateDateRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);
      const dates = [];

      let current = new Date(startDate);
      while (current <= endDate) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
      }

      return dates;
    }

    // Show retro prompt for missed days
    function showRetroPrompt(uid) {
      // Only show for days within the grace period (last 7 days)
      const gracePeriod = new Date();
      gracePeriod.setDate(gracePeriod.getDate() - 7);
      const gracePeriodStr = gracePeriod.toISOString().split('T')[0];

      const validMissedDays = missedDays.filter(date => date >= gracePeriodStr);

      if (validMissedDays.length === 0) return;

      document.getElementById('missedDaysMessage').textContent = 
        `You have missed tracking for ${validMissedDays.length} days. Please update them now?`;

      // Render retro calendar
      renderRetroCalendar(validMissedDays);

      document.getElementById('retroModal').style.display = 'flex';
    }

    // Render calendar for retro updates
    function renderRetroCalendar(dates) {
      const calendarEl = document.getElementById('retroCalendar');
      calendarEl.innerHTML = '';

      dates.forEach(dateStr => {
        const date = new Date(dateStr);
        const cell = document.createElement('div');
        cell.className = 'retro-day-cell missed-day';
        cell.dataset.date = dateStr;

        const dayNum = document.createElement('div');
        dayNum.className = 'day-number';
        dayNum.textContent = date.getDate();
        cell.appendChild(dayNum);

        const month = document.createElement('div');
        month.className = 'day-status';
        month.textContent = date.toLocaleString('default', { month: 'short' });
        cell.appendChild(month);

        cell.addEventListener('click', () => {
          if (cell.classList.contains('completed-day')) {
            cell.classList.remove('completed-day');
            cell.classList.add('missed-day');
            retroChanges[dateStr] = 'Missed';
          } else {
            cell.classList.remove('missed-day');
            cell.classList.add('completed-day');
            retroChanges[dateStr] = 'Yes';
          }
        });

        calendarEl.appendChild(cell);
      });
    }

    // Update calendar with attendance data
    async function renderCalendar(uid) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // Set calendar title
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

      // Get records for current month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const start = firstDay.toISOString().split('T')[0];
      const end = lastDay.toISOString().split('T')[0];

      const snap = await getDocs(query(
        collection(db, 'users', uid, 'dailyRecords'), 
        where('date', '>=', start), 
        where('date', '<=', end)
      ));

      const records = {};
      snap.forEach(doc => {
        const data = doc.data();
        records[data.date] = data.status;
      });

      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      const cal = document.getElementById('calendar');
      cal.innerHTML = '';

      // Add day headers
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        cal.appendChild(header);
      });

      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'day-cell';
        emptyCell.style.visibility = 'hidden';
        cal.appendChild(emptyCell);
      }

      // Add cells for each day of the month
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dateObj = new Date(dateStr);
        const cell = document.createElement('div');

        // Check if today
        if (dateStr === todayStr) {
          cell.classList.add('today-cell');
        }

        cell.className = 'day-cell';
        cell.dataset.date = dateStr;

        // Add day number
        const dayNum = document.createElement('div');
        dayNum.className = 'day-number';
        dayNum.textContent = d;
        cell.appendChild(dayNum);

        // Add status indicator if available
        const status = document.createElement('div');
        status.className = 'day-status';

        if (records[dateStr]) {
          if (records[dateStr] === 'Yes') {
            cell.classList.add('completed-day');
            status.textContent = 'Completed';
          } else if (records[dateStr] === 'Missed') {
            cell.classList.add('missed-day');
            status.textContent = 'Missed';
          }
        }

        cell.appendChild(status);

        // Add click handler for grace period days
        const gracePeriod = new Date();
        gracePeriod.setDate(gracePeriod.getDate() - 7);

        if (dateObj >= gracePeriod && dateObj <= today) {
          cell.addEventListener('click', async () => {
            const newStatus = records[dateStr] === 'Yes' ? 'Missed' : 'Yes';
            await updateAttendance(uid, dateStr, newStatus);
          });
        }

        cal.appendChild(cell);
      }
    }

    // Update attendance record
    async function updateAttendance(uid, date, status) {
      const recordsRef = collection(db, 'users', uid, 'dailyRecords');
      const q = query(recordsRef, where('date', '==', date));
      const snap = await getDocs(q);

      if (snap.empty) {
        await addDoc(recordsRef, { date, status });
      } else {
        await updateDoc(snap.docs[0].ref, { status });
      }

      await renderCalendar(uid);
      await updateStreakDisplay(uid);
    }

    // Update streak display and consistency score
    async function updateStreakDisplay(uid) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

      // Get records for last 30 days
      const snap = await getDocs(query(
        collection(db, 'users', uid, 'dailyRecords'),
        where('date', '>=', thirtyDaysAgoStr),
        where('date', '<=', todayStr),
        orderBy('date')
      ));

      const records = snap.docs.map(doc => doc.data());
      const last30DaysRecords = records.filter(record => 
        record.date >= thirtyDaysAgoStr && record.date <= todayStr
      );

      // Calculate streaks
      let currentStreak = 0;
      let longestStreak = 0;
      let tempStreak = 0;

      records.forEach(record => {
        if (record.status === 'Yes') {
          tempStreak++;
          if (tempStreak > longestStreak) longestStreak = tempStreak;
        } else {
          if (tempStreak > longestStreak) longestStreak = tempStreak;
          tempStreak = 0;
        }
      });

      // Current streak (from today backwards)
      let todayRecord = records.find(r => r.date === todayStr);
      if (todayRecord && todayRecord.status === 'Yes') {
        currentStreak = 1;
        let prevDate = new Date(today);
        prevDate.setDate(prevDate.getDate() - 1);

        while (true) {
          const prevDateStr = prevDate.toISOString().split('T')[0];
          const prevRecord = records.find(r => r.date === prevDateStr);
          if (prevRecord && prevRecord.status === 'Yes') {
            currentStreak++;
            prevDate.setDate(prevDate.getDate() - 1);
          } else {
            break;
          }
        }
      }

      // Calculate consistency score (last 30 days)
      const completedDays = last30DaysRecords.filter(r => r.status === 'Yes').length;
      const consistencyScore = Math.round((completedDays / last30DaysRecords.length) * 100) || 0;

      // Update UI
      document.getElementById('currentStreak').textContent = currentStreak;
      document.getElementById('longestStreak').textContent = longestStreak;
      document.getElementById('consistencyScore').textContent = consistencyScore;

      // Set consistency message
      let message = '';
      if (consistencyScore >= 90) {
        message = 'Amazing consistency! You are crushing it! ðŸ’«';
      } else if (consistencyScore >= 75) {
        message = 'Great consistency! Keep up the good work! ðŸŒŸ';
      } else if (consistencyScore >= 50) {
        message = 'Good consistency! You are making progress! ðŸŒ¸';
      } else {
        message = 'You can do it! Every journey begins with a single step. ðŸŒ±';
      }
      document.getElementById('consistencyMessage').textContent = message;
    }

    // Modal handlers
    const routineModal = document.getElementById('routineModal');
    const retroModal = document.getElementById('retroModal');

    document.getElementById('addRoutineBtn').onclick = () => {
      document.getElementById('routineDesc').value = '';
      routineModal.style.display = 'flex';
    };

    document.getElementById('closeRoutineModal').onclick = () => routineModal.style.display = 'none';
    document.getElementById('closeRetroModal').onclick = () => retroModal.style.display = 'none';

    document.getElementById('cancelRetroBtn').onclick = () => retroModal.style.display = 'none';

    // Save retro changes
    document.getElementById('saveRetroBtn').onclick = async () => {
      const user = auth.currentUser;
      const updates = Object.entries(retroChanges).map(([date, status]) => 
        updateAttendance(user.uid, date, status)
      );

      await Promise.all(updates);
      retroChanges = {};
      retroModal.style.display = 'none';
    };

    // Save Routine
    document.getElementById('saveRoutineBtn').onclick = async () => {
      const user = auth.currentUser;
      const today = currentDate.toISOString().split('T')[0];
      await addDoc(collection(db, 'users', user.uid, 'rules'), {
        desc: document.getElementById('routineDesc').value,
        date: today,
        active: false
      });

      routineModal.style.display = 'none';
      loadRoutines(user.uid);
    };

    // Mark Today (removed routine check)
    document.getElementById('markBtn').onclick = async () => {
      const user = auth.currentUser;
      const today = currentDate.toISOString().split('T')[0];

      // Update attendance record
      await updateAttendance(user.uid, today, 'Yes');
    };

    // Reset Today
    document.getElementById('resetBtn').onclick = async () => {
      if (!confirm('Are you sure you want to reset today?')) return;
      const user = auth.currentUser;
      const today = currentDate.toISOString().split('T')[0];
      await updateAttendance(user.uid, today, 'Missed');
    };

    // Calendar navigation
    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(auth.currentUser.uid);
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(auth.currentUser.uid);
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
      currentDate = new Date();
      renderCalendar(auth.currentUser.uid);
    });

    // Load Routines
    async function loadRoutines(uid) {
      const today = currentDate.toISOString().split('T')[0];
      const snap = await getDocs(query(
        collection(db, 'users', uid, 'rules'),
        where('date', '==', today),
        orderBy('date', 'desc')
      ));

      const list = document.getElementById('routineList');
      list.innerHTML = '';

      if (snap.empty) {
        list.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-redo-alt"></i>
            <p>No routines for today. Add your first routine!</p>
          </div>
        `;
        document.getElementById('routineCount').textContent = '0 routines';
        return;
      }

      document.getElementById('routineCount').textContent = `${snap.size} routine${snap.size !== 1 ? 's' : ''}`;

      snap.docs.forEach(d => {
        const r = d.data();
        const item = document.createElement('div');
        item.className = 'routine-item';
        item.innerHTML = `
          <input type="checkbox" class="routine-checkbox" data-id="${d.id}" ${r.active ? 'checked' : ''}>
          <div class="routine-content">${r.desc}</div>
          <div class="routine-actions">
            <button class="delete-btn" data-id="${d.id}"><i class="fas fa-trash"></i></button>
          </div>
        `;

        list.appendChild(item);

        // Add event listener for checkbox
        item.querySelector('.routine-checkbox').addEventListener('change', async e => {
          await updateDoc(doc(db, 'users', uid, 'rules', e.target.dataset.id), {
            active: e.target.checked
          });
        });
      });

      // Add event listeners for delete buttons
      list.addEventListener('click', async e => {
        if (e.target.closest('.delete-btn')) {
          const btn = e.target.closest('.delete-btn');
          if (confirm('Are you sure you want to delete this routine?')) {
            await deleteDoc(doc(db, 'users', uid, 'rules', btn.dataset.id));
            loadRoutines(uid);
          }
        }
      });
    }
  </script>
</body>
</html>