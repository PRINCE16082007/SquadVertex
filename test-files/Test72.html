<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SquadVertex Landing Page</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Loading Screen styles */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      /* Start dark and animate to white */
      background-color: #222;
      animation: bgTransition 7s forwards;
    }
    @keyframes bgTransition {
      from { background-color: #222; }
      to { background-color: #fff; }
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Hide main content until loading finishes */
    #content, #signUpPopup { display: none; }
    /* Terms checkbox styling */
    #termsSection {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    #termsSection label {
      margin-left: 5px;
    }
    /* Footer */
    #footer {
      margin-top: 40px;
      text-align: center;
      font-size: 0.9em;
      color: #777;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    /* Button enabled styles override disabled styles */
    button:not([disabled]) {
      opacity: 1;
      cursor: pointer;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Loading Screen with animated background and SquadVertex branding -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <h2 class="mt-3 text-white">Welcome to SquadVertex</h2>
    <p class="text-white">Loading... This may take a few seconds.</p>
    <p class="text-white">Please wait while we prepare your experience (transitioning from dark to light theme).</p>
  </div>

  <!-- Main Content -->
  <div id="content" class="container mt-4">
    <!-- School Selection -->
    <div id="schoolSelection" class="mb-4">
      <h3>Select Your School</h3>
      <select id="schoolDropdown" class="form-control">
        <option value="">-- Select School --</option>
      </select>
    </div>
    <!-- Terms & Conditions Section -->
    <div id="termsSection" class="mb-4" style="display:none;">
      <h4>Terms &amp; Conditions</h4>
      <p>Please read and accept the SquadVertex terms and conditions, privacy policy, and all related cloud service rules.</p>
      <div class="form-check">
        <input type="checkbox" id="termsCheckbox" class="form-check-input">
        <label for="termsCheckbox" class="form-check-label">
          I accept that I have read and agreed to all SquadVertex terms and conditions.
        </label>
      </div>
      <small id="termsMsg" class="form-text text-muted"></small>
    </div>
    <!-- Role Selection -->
    <div id="roleSelection" class="mb-4" style="display:none;">
      <h3>Choose Your Role</h3>
      <div class="mb-2">
        <button id="btnMainAdmin" class="btn btn-primary m-2" disabled>Main Admin</button>
        <span id="msgMainAdmin" class="text-danger"></span>
      </div>
      <div class="mb-2">
        <button id="btnTeacher" class="btn btn-success m-2" disabled>Teacher</button>
        <span id="msgTeacher" class="text-danger"></span>
      </div>
      <div class="mb-2">
        <button id="btnCoAdmin" class="btn btn-warning m-2" disabled>Co‑Admin</button>
        <span id="msgCoAdmin" class="text-danger"></span>
      </div>
    </div>
    <!-- Not Authorized Message -->
    <div id="notAuthorized" class="alert alert-danger" style="display:none;">
      You are not authorized for any role in this school.
    </div>
  </div>

  <!-- Sign-Up Popup (if not signed in) -->
  <div id="signUpPopup" class="container mt-4">
    <div class="alert alert-info">
      You need to sign in to continue.
      <button id="btnSignIn" class="btn btn-primary">Sign In with Google</button>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer" class="container">
    <p>Powered by SquadVertex Cloud Services. © SquadVertex</p>
    <p>Please ensure that you have read and accepted our terms and conditions before proceeding.</p>
  </div>

  <script>
    // Initialize Firebase (replace with your config)
    var firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
  };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global variables
    let currentUser = null;
    let selectedSchool = null;
    let schoolSettings = null; // systemSettings document data for the chosen school
    let pageLinks = {}; // To hold dynamic URLs for role pages
    let userRole = null; // "mainAdmin", "teacher", or "coAdmin"
    
    // For demo, known school collections (adjust as needed)
    const schoolCollections = ["001-school", "002-school"];

    // Fetch schools from each school's systemSettings document
    async function fetchSchools() {
      const dropdown = document.getElementById("schoolDropdown");
      dropdown.innerHTML = '<option value="">-- Select School --</option>';
      for (let col of schoolCollections) {
        try {
          let doc = await db.collection(col).doc("systemSettings").get();
          if (doc.exists) {
            let data = doc.data();
            let option = document.createElement("option");
            option.value = col;
            option.text = data.schoolName || col;
            dropdown.appendChild(option);
          }
        } catch (error) {
          console.error("Error fetching school from", col, error);
        }
      }
    }

    // Fetch dynamic page links from the "pages" document in the selected school collection
    async function fetchPageLinks(schoolCol) {
      try {
        let doc = await db.collection(schoolCol).doc("pages").get();
        if (doc.exists) {
          pageLinks = doc.data();
        }
      } catch (error) {
        console.error("Error fetching page links from", schoolCol, error);
      }
    }

    // Check user role for the selected school and update UI accordingly
    async function checkUserRoleForSchool(schoolCol) {
      selectedSchool = schoolCol;
      // Get systemSettings
      let sysDoc = await db.collection(schoolCol).doc("systemSettings").get();
      if(sysDoc.exists) {
        schoolSettings = sysDoc.data();
      }
      // Fetch dynamic page links
      await fetchPageLinks(schoolCol);
      
      // Check roles in teachers/list sub-collection (for teacher and co‑admin)
      let teachersRef = db.collection(schoolCol).doc("teachers").collection("list");
      let userEmail = currentUser.email;
      let roleFound = false;
      
      // Reset messages and disable buttons initially
      document.getElementById("btnMainAdmin").disabled = true;
      document.getElementById("btnTeacher").disabled = true;
      document.getElementById("btnCoAdmin").disabled = true;
      document.getElementById("msgMainAdmin").textContent = "";
      document.getElementById("msgTeacher").textContent = "";
      document.getElementById("msgCoAdmin").textContent = "";
      
      // 1. Check Main Admin: match with systemSettings.officialEmail
      if (schoolSettings && schoolSettings.officialEmail &&
          schoolSettings.officialEmail.toLowerCase() === userEmail.toLowerCase()) {
        document.getElementById("btnMainAdmin").disabled = false;
        document.getElementById("msgMainAdmin").textContent = "Authorized.";
        userRole = "mainAdmin";
        roleFound = true;
      } else {
        document.getElementById("msgMainAdmin").textContent = "Not authorized for Main Admin.";
      }
      // 2. Check Teacher and Co‑Admin roles
      let querySnapshot = await teachersRef.where("email", "==", userEmail).get();
      querySnapshot.forEach(doc => {
        if (doc.id.startsWith("teacher")) {
          document.getElementById("btnTeacher").disabled = false;
          document.getElementById("msgTeacher").textContent = "Authorized.";
          userRole = "teacher";
          roleFound = true;
        }
        if (doc.id.startsWith("admin")) {
          document.getElementById("btnCoAdmin").disabled = false;
          document.getElementById("msgCoAdmin").textContent = "Authorized.";
          userRole = "coAdmin";
          roleFound = true;
        }
      });
      
      if (!roleFound) {
        document.getElementById("notAuthorized").style.display = "block";
      } else {
        document.getElementById("notAuthorized").style.display = "none";
        // Show the Terms & Conditions section once a role is found
        document.getElementById("termsSection").style.display = "block";
        // Check if the user has already accepted the terms
        await checkTermsAcceptance();
      }
    }

    // Check if the user has already accepted terms. 
    // For mainAdmin, check in systemSettings; for teacher/coAdmin, check in teachers/list document.
    async function checkTermsAcceptance() {
      let accepted = false;
      let consentDocRef = null;
      let userEmail = currentUser.email;
      if(userRole === "mainAdmin") {
        // For main admin, consent stored in systemSettings (field: consentAccepted)
        consentDocRef = db.collection(selectedSchool).doc("systemSettings");
      } else {
        // For teacher or coAdmin, consent stored in their own document in teachers/list
        let teachersRef = db.collection(selectedSchool).doc("teachers").collection("list");
        // We assume there is exactly one document with matching email
        let querySnapshot = await teachersRef.where("email", "==", userEmail).get();
        querySnapshot.forEach(doc => {
          consentDocRef = doc.ref;
        });
      }
      if (consentDocRef) {
        let doc = await consentDocRef.get();
        if(doc.exists && doc.data().consentAccepted === true) {
          accepted = true;
        }
      }
      // Update the checkbox state accordingly
      let termsCheckbox = document.getElementById("termsCheckbox");
      let termsMsg = document.getElementById("termsMsg");
      if(accepted) {
        termsCheckbox.checked = true;
        termsCheckbox.disabled = true;
        termsMsg.textContent = "You have already accepted the terms.";
      } else {
        termsCheckbox.checked = false;
        termsCheckbox.disabled = false;
        termsMsg.textContent = "Please accept the terms to proceed.";
      }
    }

    // When the user clicks the terms checkbox, update consent in Firestore
    document.getElementById("termsCheckbox").addEventListener("change", async function(){
      if(this.checked) {
        // Update Firestore record to mark consentAccepted = true.
        let consentDocRef = null;
        let userEmail = currentUser.email;
        if(userRole === "mainAdmin") {
          consentDocRef = db.collection(selectedSchool).doc("systemSettings");
        } else {
          let teachersRef = db.collection(selectedSchool).doc("teachers").collection("list");
          let querySnapshot = await teachersRef.where("email", "==", userEmail).get();
          querySnapshot.forEach(doc => {
            consentDocRef = doc.ref;
          });
        }
        if(consentDocRef) {
          await consentDocRef.update({ consentAccepted: true });
          // Disable checkbox after update
          this.disabled = true;
          document.getElementById("termsMsg").textContent = "You have accepted the terms.";
        }
      }
    });

    // Set role button redirection using dynamic page links (fetched earlier)
    document.getElementById("btnMainAdmin").addEventListener("click", function(){
      if(pageLinks.adminSignUp) {
        window.location.href = pageLinks.adminSignUp;
      } else {
        alert("Page link not available.");
      }
    });
    document.getElementById("btnTeacher").addEventListener("click", function(){
      if(pageLinks.teacherSignUp) {
        window.location.href = pageLinks.teacherSignUp;
      } else {
        alert("Page link not available.");
      }
    });
    document.getElementById("btnCoAdmin").addEventListener("click", function(){
      if(pageLinks.coAdminSignUp) {
        window.location.href = pageLinks.coAdminSignUp;
      } else {
        alert("Page link not available.");
      }
    });

    // Handle school selection change event
    document.getElementById("schoolDropdown").addEventListener("change", function(e){
      let selected = e.target.value;
      if(selected) {
        // Show loading screen while checking role and terms acceptance
        document.getElementById("loadingScreen").style.display = "flex";
        checkUserRoleForSchool(selected).then(() => {
          // Ensure minimum 7 seconds loading
          setTimeout(() => {
            document.getElementById("loadingScreen").style.display = "none";
            document.getElementById("content").style.display = "block";
          }, 7000);
        });
      }
    });

    // Listen for authentication state changes
    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = user;
        // Fetch schools and then show content after 7 seconds
        fetchSchools().then(() => {
          setTimeout(() => {
            document.getElementById("loadingScreen").style.display = "none";
            document.getElementById("content").style.display = "block";
          }, 7000);
        });
      } else {
        // If not signed in, hide loading and show sign-up popup
        document.getElementById("loadingScreen").style.display = "none";
        document.getElementById("signUpPopup").style.display = "block";
      }
    });

    // Google Sign-In button event
    document.getElementById("btnSignIn").addEventListener("click", function(){
      var provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => { location.reload(); })
        .catch(error => { console.error("Error during sign-in:", error); });
    });
  </script>
</body>
</html>