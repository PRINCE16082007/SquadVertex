<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GalaxyWeb Functional</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0e17;
    color: #fff;
    font-family: 'Poppins', sans-serif;
    overflow-x: hidden;
  }

  /* ---------- Top / Banner / Desc / Cards / Footer styles (unchanged, kept for context) ---------- */
  .top-bar { display:flex; align-items:center; justify-content:space-between; height:80px; background:rgba(16,23,36,0.85); padding:0 20px; backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,0.1); position:sticky; top:0; z-index:100; width:100%; }
  .logo-title { display:flex; align-items:center; gap:10px; font-size:1.5rem; font-weight:bold; font-family:'Montserrat',sans-serif; color:#fff; white-space:nowrap; }
  .logo-title img { height:60px; filter:drop-shadow(0 0 8px rgba(97,218,251,0.7)); }
  .hamburger { display:none; background:none; border:none; color:#e0e0e0; cursor:pointer; font-size:1.2rem; padding:8px; margin-right:10px; }
  .nav-buttons{ display:flex; align-items:center; gap:15px; font-size:1rem; position:relative; }
  .nav-btn, .profile-btn{ background:none; border:none; color:#e0e0e0; cursor:pointer; font-size:0.95rem; position:relative; font-family:'Poppins',sans-serif; font-weight:500; padding:6px 10px; border-radius:6px; transition:all .3s ease; white-space:nowrap; }
  .nav-btn:hover, .profile-btn:hover { color:#64c2ff; background:rgba(255,255,255,0.05); }
  .profile-btn img{ width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid #64c2ff; }
  .dropdown-content{ display:none; position:absolute; right:0; background:rgba(29,35,54,0.95); min-width:140px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2); top:50px; z-index:1000; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); overflow:hidden; }
  .dropdown-content a{ color:#e0e0e0; padding:10px 14px; text-decoration:none; display:block; border-bottom:1px solid rgba(255,255,255,0.05); transition:all .2s ease; font-size:0.95rem; }
  .dropdown-content a:last-child { border-bottom:none; }
  .dropdown-content a:hover { background:rgba(100,194,255,0.1); color:#64c2ff; }
  .nav-buttons .more-options:hover .dropdown-content, .nav-buttons .profile-btn.show-menu + .dropdown-content { display:block; }

  @media (max-width:768px) { .logo-title { font-size:1.2rem } .logo-title img { height:40px } .hamburger { display:block } .nav-buttons { display:none; position:absolute; top:100%; right:0; background:rgba(16,23,36,0.95); flex-direction:column; padding:20px; gap:10px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.2); z-index:100; width:100%; } .nav-buttons.show{ display:flex } }

  .banner { height:300px; background:#161b28; margin:0; padding:0; overflow:hidden; position:relative; }
  @media(min-width:768px){ .banner{height:400px} } @media(min-width:1200px){ .banner{height:500px} }
  .banner::after{ content:''; position:absolute; bottom:0; left:0; width:100%; height:60px; background:linear-gradient(to top,#0a0e17,transparent); z-index:2; }
  @media(min-width:768px){ .banner::after{height:100px} }
  .banner img{ width:100%; height:100%; object-fit:cover; display:block; }

  .desc-section{ background:linear-gradient(135deg,#161b28 0%,#1c2236 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px 20px; position:relative; text-align:center; }
  .desc-text{ display:flex; flex-direction:column; justify-content:center; text-align:center; gap:20px; width:100%; max-width:90%; }
  .desc-text h1{ font-size:1.8rem; font-family:'Montserrat',sans-serif; background:linear-gradient(90deg,#fff 0%,#64c2ff 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0; word-break:break-word; }
  .desc-text p{ font-size:1rem; white-space:normal; line-height:1.6; color:#d0d0d0; word-break:break-word; }
  .desc-img{ width:100%; display:flex; align-items:center; justify-content:center; margin-top:30px; }
  .desc-img img{ max-width:80%; max-height:300px; object-fit:contain; filter: drop-shadow(0 5px 25px rgba(32,39,70,0.6)) brightness(1.1); transform:none; }
  @media(min-width:768px){ .desc-section{ flex-direction:row; justify-content:space-between; padding:40px 50px; text-align:left; } .desc-text{ text-align:left; align-items:flex-start; gap:28px; max-width:500px; } .desc-img{ margin-top:0; padding-right:40px; align-items:flex-end; justify-content:flex-end; } .desc-img img{ max-width:150%; max-height:550px; transform:translateX(20px); } .desc-text h1{ font-size:2.4rem } .desc-text p{ font-size:1.2rem } }

  /* ---------- Cards ---------- */
  .cards-wrap { position:relative; width:100%; overflow-x:hidden; background:none; margin:0; padding:30px 0; }
  .cards-section { display:flex; flex-direction:row; align-items:center; gap:24px; padding:0 20px; background: linear-gradient(rgba(10,14,23,0.9), rgba(10,14,23,0.9)), url('https://dl.dropboxusercontent.com/scl/fi/702xkjz07yxrq8mr6trzx/192f66_590271f07f9c499c92f0912416c55cbe-mv2.png?rlkey=0vnahm1klu5qf4da6gzmwzmjg&st=pkbwfnoo&dl=0'); background-size:cover; background-position:center center; background-repeat:no-repeat; width:100%; box-sizing:border-box; }
  .card { background:linear-gradient(145deg, rgba(24,31,43,0.95) 0%, rgba(32,40,57,0.95) 100%); border-radius:16px; margin:10px; width:90%; max-width:320px; height:auto; min-height:400px; display:flex; flex-direction:column; color:#fff; overflow:hidden; cursor:pointer; transition:all .3s ease; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  .card:hover{ transform:translateY(-8px); box-shadow:0 15px 35px rgba(0,0,0,0.3); }
  .card img{ height:160px; width:100%; object-fit:cover; border-top-left-radius:16px; border-top-right-radius:16px; margin-bottom:12px; }
  @media(min-width:576px){ .card img { height:170px; } } @media(min-width:768px){ .card img{ height:180px; } }
  .card-content{ padding:20px; flex-grow:1; text-align:center; }
  .card-content h3{ margin:0 0 12px 0; font-family:'Montserrat',sans-serif; font-size:1.3rem; color:#fff; }
  @media(min-width:768px){ .card-content h3{ font-size:1.4rem } }
  .card-content p { font-size:0.95rem; white-space:normal; line-height:1.5; color:#d0d0d0; } @media(min-width:768px){ .card-content p{ font-size:1rem } }
  .card-footer{ display:flex; justify-content:space-between; align-items:center; font-size:0.95rem; opacity:0.92; padding:0 20px 20px 20px; }
  .card-footer .views, .card-footer .likes{ display:flex; align-items:center; gap:7px; }
  .card-footer .likes{ cursor:pointer; transition:all .2s ease; } .card-footer .likes:hover{ color:#ff5b5b }
  .card-footer .likes .fa-heart{ transition:all .2s ease; } .card-footer .likes:hover .fa-heart{ transform:scale(1.2) }
  .card-footer .likes .fa-solid{ color:#ff5b5b; }

  @media(min-width:992px){ .cards-section{ flex-direction:row; flex-wrap:wrap; justify-content:center; height:500px; align-items:stretch; padding:0 40px; } .card{ width:auto; min-width:280px; height:95%; margin:20px 10px; } }

  /* ---------- Overlay & loader (NEW) ---------- */
  /* Full-screen overlay that blocks interaction until content ready */
  #pageOverlay {
    position: fixed;
    inset: 0;
    z-index: 100000; /* above console panel */
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, rgba(6,12,24,0.82), rgba(4,8,18,0.9));
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    transition: transform 900ms cubic-bezier(.2,.9,.25,1), opacity 600ms ease;
    transform: translateY(0);
    opacity: 1;
    pointer-events: all;
    flex-direction: column;
    gap: 20px;
    padding: 40px;
    text-align: center;
  }

  /* when hiding: slide up and fade out */
  #pageOverlay.hide {
    transform: translateY(-110%);
    opacity: 0;
    pointer-events: none;
  }

  /* loader visual: concentric rings + gentle text */
  .loader {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:18px;
    flex-direction:column;
  }

  .rings {
    position: relative;
    width: 120px;
    height: 120px;
  }

  .rings .ring {
    position:absolute;
    inset:0;
    border-radius:50%;
    border:4px solid rgba(100,194,255,0.12);
    display:block;
    animation: ring-rotate 2.6s linear infinite;
    box-shadow: 0 8px 30px rgba(20,36,64,0.45);
    transition: all 300ms ease;
    backdrop-filter: blur(2px);
  }

  .rings .ring.r2 { transform: scale(.78); animation-duration: 2.1s; border-width:5px; border-color: rgba(100,194,255,0.14); }
  .rings .ring.r3 { transform: scale(.56); animation-duration: 1.7s; border-width:6px; border-color: rgba(100,194,255,0.18); }

  .rings .ring::after {
    content:"";
    position:absolute;
    left:50%;
    top:10%;
    width:12px;
    height:12px;
    transform:translateX(-50%) translateY(-50%);
    border-radius:50%;
    background: radial-gradient(circle at 35% 30%, rgba(164,246,255,0.95), rgba(100,194,255,0.9));
    filter: blur(1px);
    animation: pulse 1.8s infinite ease-in-out;
  }

  @keyframes ring-rotate {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(0.98); }
    100% { transform: rotate(360deg) scale(1); }
  }

  @keyframes pulse {
    0% { transform: translateX(-50%) translateY(-50%) scale(0.85); opacity:0.8; }
    50% { transform: translateX(-50%) translateY(-50%) scale(1.15); opacity:1; }
    100% { transform: translateX(-50%) translateY(-50%) scale(0.85); opacity:0.8; }
  }

  .loader h2 {
    color: #dff6ff;
    font-weight:600;
    font-size:1.05rem;
    letter-spacing:0.2px;
    margin-top: 8px;
    text-shadow: 0 6px 18px rgba(20,50,80,0.35);
  }

  .loader p {
    color: #bfeaff;
    font-size:0.9rem;
    max-width:460px;
    line-height:1.4;
    opacity:0.95;
  }

  .overlay-actions { margin-top:6px; display:flex; gap:12px; align-items:center; justify-content:center; }
  .overlay-actions button {
    background:transparent;
    border:1px solid rgba(100,194,255,0.22);
    color:#cfefff;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition:all 220ms ease;
  }
  .overlay-actions button:hover { transform:translateY(-3px); box-shadow:0 8px 20px rgba(36,96,160,0.12); border-color:#64c2ff; color:#fff; }

  /* small responsive fix */
  @media (max-width:480px) { .rings { width:84px; height:84px } .loader h2{ font-size:0.98rem } .loader p{ font-size:0.82rem } }

  /* ---------- console panel (kept) ---------- */
  #console-panel{ position:fixed; bottom:0; left:0; right:0; height:280px; background:#1e1e1e; color:#d4d4d4; font-family:'Consolas','Monaco','Courier New',monospace; z-index:9999; display:flex; flex-direction:column; border-top:2px solid #333; box-shadow:0 -2px 10px rgba(0,0,0,0.5); font-size:12px; }
  #console-header{ padding:8px; background:#2d2d30; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; }
  #console-content{ flex:1; padding:10px; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word; }

  /* small utility */
  .hidden { display:none !important; }
</style>
</head>
<body>
  <!-- Top Section -->
  <div class="top-bar">
    <button class="hamburger">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="logo-title">
      <img
        src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0"
        height="46"
        alt="Logo"
      />
      GalaxyWeb
    </div>
    <div class="nav-buttons">
      <button class="nav-btn" onclick="window.location.href='index.html';">Home</button>
      <button class="nav-btn" onclick="window.location.href='about_us.html';">Team Galaxy</button>
      <div class="more-options">
        <button class="nav-btn">More ▼</button>
        <div class="dropdown-content">
          <a href="galaxy_blogs.html">Blog</a>
          <a href="galaxy_portfolio.html">Portfolio</a>
          <a href="posts.html">Posts</a>
          <a href="community_chat.html">Community Chat</a>
          <a href="galaxy_studio.html">Galaxy Design</a>
        </div>
      </div>
      <button id="profileBtn" class="profile-btn"><i class="fa-solid fa-user"></i></button>
      <div id="profileMenu" class="dropdown-content" style="right:30px; display:none;">
        <a href="/teamgalaxy/user_management/user_profile.html" id="profileLink">Profile</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>
  </div>

  <!-- Banner Section -->
  <div class="banner">
    <img src="https://dl.dropboxusercontent.com/scl/fi/xrm9oz497flxbgeg2ftbh/192f66_67551a1745204b0abb6b170d8aabdea5-mv2.jpg?rlkey=9os8s4wyc1f2mc5xclveeds9t&st=h763i6y8&dl=0" alt="Galaxy Banner" />
  </div>

  <!-- Description Section -->
  <div class="desc-section">
    <div class="desc-text">
      <h1>Welcome to GalaxyWeb</h1>
      <p>
        Welcome to Galaxy — a united space where competition, creativity, and community meet. Here you’ll find the latest news from our Team Galaxy clan, shop official merch to show your pride, explore stunning visuals from Galaxy Design, and connect with fellow players and creators through our blog. Whether you’re here to fight alongside us, wear the Galaxy name, commission a design, or simply be part of an active, welcoming community, this is your home among the stars.
      </p>
    </div>
    <div class="desc-img">
      <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="Random PNG" />
    </div>
  </div>

  <!-- Cards Section (no skeletons here; overlay will block until everything is ready) -->
  <div class="cards-wrap">
    <div id="cardsContainer" class="cards-section" aria-live="polite" aria-busy="true">
      <!-- Cards will be injected here once ready -->
    </div>
  </div>

  <!-- Collaborators -->
  <div class="collaborators-wrap">
    <div class="collaborators-title">Our Collaborators</div>
    <div class="collaborators-section">
      <div class="collaborator-logo-box" data-url="https://www.google.com" tabindex="0">
        <img src="https://dl.dropboxusercontent.com/scl/fi/tgfz0bdpfs8r7emm6xqdo/8699158.jpg?rlkey=769ayec8274jsb4c1ms2ojpeh&st=gwaz95i2&dl=0" alt="I" />
        <div class="collaborator-label">I</div>
      </div>
      <div class="collaborator-logo-box" data-url="https://www.google.com" tabindex="0">
        <img src="https://dl.dropboxusercontent.com/scl/fi/ih79814t1c2od22jmdbfw/8699161.jpg?rlkey=vxrzhkc3id3njeli1xza6gitc&st=rfqt55u3&dl=0" alt="Made" />
        <div class="collaborator-label">Made</div>
      </div>
      <div class="collaborator-logo-box" data-url="https://www.google.com" tabindex="0">
        <img src="https://dl.dropboxusercontent.com/scl/fi/orf6i07ebo705jnq5tkx7/1744702095638.png?rlkey=6jvqg2lrucvw5c8vst71rg5kl&st=r19g59l4&dl=0" alt="It!" />
        <div class="collaborator-label">It!</div>
      </div>
    </div>
  </div>

  <!-- Footer Section -->
  <footer class="footer">
    <div class="footer-col footer-left">
      <div>
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together — join now to explore the Galaxy!
        </div>
      </div>
      <div class="footer-social">
        <a href="https://twitter.com" title="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="https://facebook.com" title="Facebook"><i class="fab fa-facebook"></i></a>
        <a href="https://instagram.com" title="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://youtube.com" title="YouTube"><i class="fab fa-youtube"></i></a>
        <a href="https://discord.com" title="Discord"><i class="fab fa-discord"></i></a>
      </div>
    </div>
    <div class="footer-col footer-right">
      <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms & Conditions</a>
        <a href="about_us.html">About</a>
      </div>
      <div>
        <div class="footer-contact-row">
          <span class="footer-contact-label">
            <i class="fa-solid fa-location-dot footer-contact-icon"></i>Address:
          </span>
          44 Galaxy St, Universe City, WebLand
        </div>
        <div class="footer-contact-row">
          <span class="footer-contact-label">
            <i class="fa-solid fa-phone footer-contact-icon"></i>Phone:
          </span>
          +91-9876543210
        </div>
        <div class="footer-contact-row">
          <span class="footer-contact-label">
            <i class="fa-solid fa-envelope footer-contact-icon"></i>Email:
          </span>
          support@gmail.com
        </div>
        <div class="footer-contact">
          <span class="footer-contact-label">
            <i class="fa-regular fa-clock footer-contact-icon"></i>Working Hours:
          </span>
          Mon-Sat 10am - 10pm
        </div>
      </div>
    </div>
  </footer>

  <!-- Console Panel -->
  <div id="console-panel">
    <div id="console-header">
      <div id="status-indicators">
        <span id="auth-status" style="margin-right:15px; padding:2px 6px; border-radius:3px; background:#404040;">Auth: Checking...</span>
        <span id="network-status" style="margin-right:15px; padding:2px 6px; border-radius:3px; background:#404040;">Network: Online</span>
        <span id="app-status" style="padding:2px 6px; border-radius:3px; background:#404040;">App: Active</span>
      </div>
      <div>
        <button id="test-network-speed" style="margin-right:10px; background:#404040; color:#89d185; border:none; padding:3px 8px;">Test Speed</button>
        <button id="refresh-status" style="margin-right:10px; background:#404040; color:#6796e6; border:none; padding:3px 8px;">Refresh</button>
        <button id="clear-console" style="margin-right:10px; background:#404040; color:white; border:none; padding:3px 8px;">Clear</button>
        <button id="toggle-console" style="background:#404040; color:white; border:none; padding:3px 8px;">Hide</button>
      </div>
    </div>
    <div id="console-content"></div>
  </div>

  <!-- PAGE OVERLAY (blocks whole screen until everything ready) -->
  <div id="pageOverlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="loader" aria-hidden="false">
      <div class="rings" aria-hidden="true">
        <span class="ring r1"></span>
        <span class="ring r2"></span>
        <span class="ring r3"></span>
      </div>
      <h2>Preparing your Galaxy…</h2>
      <p>Gathering visuals and warm-up data — just a sec. This moment helps the page feel smooth and polished.</p>
      <div class="overlay-actions hidden" id="overlayErrorActions">
        <button id="overlayRetry">Retry</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>
  <!-- reCaptcha -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>

<script>
  // ===== Firebase config (unchanged) =====
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  // ===== Initialize Firebase (compat) safely - only once =====
  if (!window.firebase) {
    console.error("Firebase SDK not loaded. Make sure compat scripts are included.");
  } else {
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized (compat)");
    } else {
      console.log("Firebase already initialized - skipping re-init");
    }
  }

  // ===== Activate App Check (compat) - safe try/catch =====
  try {
    const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider("6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx");
    firebase.appCheck().activate(appCheckProvider, true);
    console.log("App Check (compat) activated");
  } catch (e) {
    console.warn("App Check activation failed (compat):", e);
  }

  // ===== compat services =====
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ===== Ensure auth persistence is LOCAL so sessions survive reloads =====
  try {
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log("Auth persistence set to LOCAL"))
      .catch(err => console.warn("Failed to set auth persistence:", err));
  } catch (err) {
    console.warn("Could not set persistence (maybe compat API mismatch):", err);
  }

  // ===== DOM refs =====
  const profileBtn = document.getElementById("profileBtn");
  const profileMenu = document.getElementById("profileMenu");
  const logoutLink = document.getElementById("logoutLink");
  const profileLink = document.getElementById("profileLink");
  const cardsContainer = document.getElementById("cardsContainer");
  const pageOverlay = document.getElementById("pageOverlay");
  const overlayErrorActions = document.getElementById("overlayErrorActions");
  const overlayRetry = document.getElementById("overlayRetry");

  // ===== collaborator boxes (unchanged) =====
  document.querySelectorAll('.collaborator-logo-box').forEach(box => {
    box.addEventListener('click', () => {
      const url = box.getAttribute('data-url');
      if (url) window.open(url, '_blank');
    });
  });

  // ===== profile click handler (unchanged behavior) =====
  function handleProfileBtnClick(e) {
    e && e.stopPropagation();
    try {
      const liveUser = auth.currentUser;
      if (!liveUser) {
        console.log("Profile clicked while not signed in — redirecting to /teamgalaxy/legal/sign_up.html");
        window.location.href = "/teamgalaxy/legal/sign_up.html";
        return;
      }
      if (!profileMenu) return;
      profileMenu.style.display = profileMenu.style.display === "block" ? "none" : "block";
    } catch (err) {
      console.error("Error in profile button click handler:", err);
    }
  }

  if (profileBtn && !profileBtn._attached) {
    profileBtn.addEventListener("click", handleProfileBtnClick);
    profileBtn._attached = true;
  }

  window.addEventListener("click", () => {
    if (profileMenu) profileMenu.style.display = "none";
  });

  // ===== Sign in / Sign out (unchanged) =====
  async function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
      console.log("Sign-in succeeded");
    } catch (error) {
      console.error("Sign-in failed:", error);
      alert("Sign-in failed: " + (error && error.message ? error.message : error));
    }
  }

  async function signOutUser() {
    try {
      await auth.signOut();
      console.log("User signed out");
      if (profileMenu) profileMenu.style.display = "none";
    } catch (error) {
      console.error("Sign-out failed:", error);
      alert("Sign-out failed: " + (error && error.message ? error.message : error));
    }
  }

  if (logoutLink && !logoutLink._attached) {
    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      signOutUser();
    });
    logoutLink._attached = true;
  }

  if (profileLink && !profileLink._attached) {
    profileLink.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (!auth.currentUser) {
        window.location.href = "/teamgalaxy/legal/sign_up.html";
        return;
      }
      window.location.href = "/teamgalaxy/user_management/user_profile.html";
      if (profileMenu) profileMenu.style.display = "none";
    });
    profileLink._attached = true;
  }

  // ===== Auth listener (keeps single) =====
  if (!auth._ourOnAuthAttached) {
    auth.onAuthStateChanged((user) => {
      console.log("onAuthStateChanged fired. user:", !!user);
      currentUser = user;
      updateProfileButton();
      if (typeof loadCards === "function") loadCards();
    });
    auth._ourOnAuthAttached = true;
  } else {
    console.log("Auth listener already attached - skipping re-attach");
  }

  // ===== Update profile button =====
  let currentUser = null;
  function updateProfileButton() {
    if (!profileBtn) return;

    const u = auth.currentUser;
    if (u) {
      currentUser = u;
      if (u.photoURL) {
        profileBtn.innerHTML = `<img src="${u.photoURL}" alt="Profile" style="width:36px;height:36px;border-radius:50%;">`;
      } else {
        profileBtn.innerHTML = `<i class="fa-solid fa-user"></i>`;
      }
      profileBtn.title = u.displayName || u.email || "Profile";
    } else {
      currentUser = null;
      profileBtn.innerHTML = "Sign In";
      profileBtn.title = "Sign In";
    }
  }

  // ===== Visited cache =====
  let visitedCards = JSON.parse(sessionStorage.getItem("visitedCards")) || [];

  // ===== Helper: wait until all images in a container are loaded (resolve on load/error) =====
  function waitForImages(container) {
    const imgs = Array.from(container.querySelectorAll('img'));
    if (!imgs.length) return Promise.resolve();
    return Promise.all(imgs.map(img => {
      return new Promise(resolve => {
        if (img.complete && img.naturalWidth !== 0) return resolve();
        img.addEventListener('load', () => resolve(), { once: true });
        img.addEventListener('error', () => resolve(), { once: true });
        // in case img never fires (very unlikely), resolve after timeout
        setTimeout(resolve, 8000);
      });
    }));
  }

  // ===== Overlay controls =====
  function showOverlay() {
    if (!pageOverlay) return;
    pageOverlay.classList.remove('hide');
    overlayErrorActions.classList.add('hidden');
    pageOverlay.style.display = 'flex';
  }

  function hideOverlay() {
    if (!pageOverlay) return;
    // add hide class to animate upward
    pageOverlay.classList.add('hide');
    // remove overlay from DOM after animation completes to free pointer events
    const onEnd = (ev) => {
      // only after opacity/transform transition ends
      pageOverlay.style.display = 'none';
      pageOverlay.removeEventListener('transitionend', onEnd);
    };
    pageOverlay.addEventListener('transitionend', onEnd);
  }

  function showOverlayError() {
    if (!pageOverlay) return;
    overlayErrorActions.classList.remove('hidden');
    // keep overlay visible so user can Retry
    pageOverlay.classList.remove('hide');
    pageOverlay.style.display = 'flex';
  }

  overlayRetry && overlayRetry.addEventListener('click', (e) => {
    e.preventDefault();
    overlayErrorActions.classList.add('hidden');
    loadCards();
  });

  // ===== createCard (unchanged logic) =====
  function createCard(id, heading, description, views, likes, imageUrl) {
    const card = document.createElement("div");
    card.className = "card";
    card.tabIndex = 0;
    card.setAttribute("role", "button");

    card.addEventListener("click", () => {
      window.location.href = `/teamgalaxy/card_showcase.html?id=${encodeURIComponent(id)}`;
    });

    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter") card.click();
    });

    const img = document.createElement("img");
    img.src = imageUrl || "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=500&q=80";
    img.alt = heading;
    card.appendChild(img);

    const content = document.createElement("div");
    content.className = "card-content";

    const h3 = document.createElement("h3");
    h3.textContent = heading || "uw gzbskzj haosjj";

    const p = document.createElement("p");
    p.textContent = description || "whhaj wnus hcs hx w whhaj hcs woqw kjqw qowq pwq.";

    content.appendChild(h3);
    content.appendChild(p);
    card.appendChild(content);

    const footer = document.createElement("div");
    footer.className = "card-footer";

    const viewsSpan = document.createElement("span");
    viewsSpan.className = "views";
    viewsSpan.innerHTML = `<i class="fa-regular fa-eye"></i> ${views}`;
    footer.appendChild(viewsSpan);

    const likesSpan = document.createElement("span");
    likesSpan.className = "likes";
    likesSpan.style.cursor = auth.currentUser ? "pointer" : "not-allowed";
    likesSpan.title = auth.currentUser ? "Like" : "Sign In to Like";
    likesSpan.innerHTML = `<i class="fa-regular fa-heart"></i> ${likes}`;

    likesSpan.addEventListener("click", async (e) => {
      e.stopPropagation();
      if (!auth.currentUser) {
        alert("Please sign in to like.");
        return;
      }
      try {
        const likeDoc = await db.collection("cards").doc(id).collection("likes").doc(auth.currentUser.uid).get();
        if (likeDoc.exists) {
          alert("You have already liked this card.");
          return;
        }
        await db.collection("cards").doc(id).collection("likes").doc(auth.currentUser.uid).set({
          likedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        await db.collection("cards").doc(id).update({
          likes: firebase.firestore.FieldValue.increment(1),
        });
        const newLikes = likes + 1;
        likesSpan.innerHTML = `<i class="fa-solid fa-heart" style="color: #ff5b5b;"></i> ${newLikes}`;
        likesSpan.style.cursor = "default";
        likesSpan.title = "You liked this";
      } catch (err) {
        alert("Error liking card: " + (err && err.message ? err.message : err));
      }
    });

    footer.appendChild(likesSpan);
    card.appendChild(footer);

    return card;
  }

  // ===== loadCards: show overlay and only remove once everything (images) is ready =====
  async function loadCards() {
    if (!cardsContainer) return;
    // show overlay at start
    showOverlay();
    cardsContainer.innerHTML = ''; // clear any previous content

    try {
      const snapshot = await db
        .collection("cards")
        .orderBy("publishedAt", "desc")
        .limit(3)
        .get();

      if (!snapshot || snapshot.empty) {
        // nothing to show — still dismiss overlay smoothly
        cardsContainer.innerHTML = '<p style="color:#cfefff; padding:20px;">No items to display yet.</p>';
        // wait a short tick so user sees content then hide overlay
        await new Promise(res => setTimeout(res, 400));
        hideOverlay();
        return;
      }

      // Build DOM nodes
      snapshot.docs.forEach((docSnap) => {
        const data = docSnap.data();
        const id = docSnap.id;

        // Increment views once per session
        if (!visitedCards.includes(id)) {
          db.collection("cards").doc(id).update({
            views: firebase.firestore.FieldValue.increment(1),
          }).catch(err => console.warn('views increment failed', err));
          visitedCards.push(id);
          sessionStorage.setItem("visitedCards", JSON.stringify(visitedCards));
        }

        const card = createCard(
          id,
          data.heading,
          data.description,
          data.views || 0,
          data.likes || 0,
          data.imageUrl || ""
        );
        cardsContainer.appendChild(card);
      });

      // Wait for all images inside cardsContainer to load (or timeout)
      await waitForImages(cardsContainer);

      // slight delay so loader doesn't cut too abruptly — feels smoother
      await new Promise(res => setTimeout(res, 260));

      // remove overlay with gentle bottom->top fade
      hideOverlay();
    } catch (error) {
      console.error("Error loading cards:", error);
      // show an error state inside overlay with Retry action so user isn't staring at a stuck screen
      showOverlayError();
      overlayErrorActions.classList.remove('hidden');
      // optional: also show a tiny message in page area
      cardsContainer.innerHTML = '<p style="color:#ffb4b4; padding:20px;">Error loading content. Use Retry in the overlay.</p>';
    }
  }

  // ===== Initial run: update UI and load cards once =====
  updateProfileButton();
  // Ensure overlay visible at startup — in case firebase auth triggers loadCards later
  showOverlay();
  loadCards();
  console.log("Auth + cards script loaded");

</script>

<script>
  // hamburger toggle
  document.querySelector('.hamburger').addEventListener('click', function() {
    document.querySelector('.nav-buttons').classList.toggle('show');
  });

  // console panel helpers (simple)
  document.getElementById('toggle-console').addEventListener('click', function() {
    const panel = document.getElementById('console-panel');
    if (panel.style.display === 'none' || panel.classList.contains('hidden')) {
      panel.style.display = 'flex';
      this.textContent = 'Hide';
    } else {
      panel.style.display = 'none';
      this.textContent = 'Show';
    }
  });
  document.getElementById('clear-console').addEventListener('click', function() {
    document.getElementById('console-content').textContent = '';
  });
</script>
</body>
</html>