<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile Picture Upload</title>
  <style>
    body { 
      background: #111; color: #fff; font-family: sans-serif;
      display: flex; flex-direction: column; align-items: center; padding: 20px; 
    }
    input, button { margin: 10px; padding: 10px; }
    #preview {
      width: 180px; height: 180px; margin-top: 20px;
      background: #222; display: flex; align-items: center; justify-content: center;
      border: 2px dashed #555;
      border-radius: 50%;
      overflow: hidden;
    }
    #preview img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .hidden { display: none; }
    #authError { color: #ff5555; }
  </style>
</head>
<body>
  <h1>Set Profile Picture</h1>
  
  <div id="authError" class="hidden">Please login first!</div>
  <input id="fileInput" type="file" accept="image/*" class="hidden" />
  <button id="uploadBtn" class="hidden">Upload New Picture</button>

  <div id="preview">
    <span>Fetching profile...</span>
  </div>

  <!-- Firebase SDK 11.9.0 (Modular) -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase config (exactly as provided)
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    // Supabase config (use your existing setup)
    const SUPABASE_URL = 'https://dvjihjkyenzkacviywgk.supabase.co';
    const FUNCTION_URL = 'https://dvjihjkyenzkacviywgk.functions.supabase.co/upload-image';

    // DOM elements
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const preview = document.getElementById('preview');
    const authError = document.getElementById('authError');

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        // User logged in - show upload UI
        fileInput.classList.remove('hidden');
        uploadBtn.classList.remove('hidden');
        
        // Show current profile pic (if exists)
        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${user.uid}.png?v=${Date.now()}`;
        preview.innerHTML = `<img src="${publicUrl}" alt="Profile Picture" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22180%22 height=%22180%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23555%22 stroke-width=%221.5%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/><path d=%22M12 8v4%22/><circle cx=%2212%22 cy=%2216%22 r=%221%22/></svg>';">`;
      } else {
        // User not logged in
        authError.classList.remove('hidden');
        preview.innerHTML = '<span>ðŸ”’ Login required</span>';
      }
    });

    // Upload handler
    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return alert('Please select an image');
      if (file.size > 3 * 1024 * 1024) {
        return alert('Max 3 MB allowed');
      }

      try {
        // Get current user (double-check)
        const user = auth.currentUser;
        if (!user) throw new Error('User not authenticated');

        // Read file as base64
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        // Filename = UID.png (overwrites existing)
        const fileName = `${user.uid}.png`;

        // Upload via existing Edge Function
        const response = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileName, base64 })
        });

        const result = await response.json();
        if (!response.ok || result.error) {
          throw new Error(result.error || 'Upload failed');
        }

        // Update preview immediately
        const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
        preview.innerHTML = `<img src="${newUrl}" alt="Profile Picture">`;
        
        alert('Profile picture updated successfully!');
      } catch (e) {
        console.error('Upload error:', e);
        alert(`Failed: ${e.message}`);
      }
    });
  </script>
</body>
</html>