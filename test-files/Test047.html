<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encoder Fixed</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

</head>
<body style="background:#000;color:white">

<h2>Secure Encoder</h2>

<input type="file" id="upload"><br><br>

<textarea id="secret" rows="3" cols="40">Hello from Galaxy</textarea><br><br>

Password:
<input id="password" value="1234"><br><br>

<button onclick="encode()">Encode</button>

<br><br>

<img id="out" width="400">

<script>

let img = new Image();

upload.onchange = e=>{
  img.src = URL.createObjectURL(e.target.files[0]);
};

// ========== ENCODE ==========
function encode(){

  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");

  canvas.width=img.width;
  canvas.height=img.height;

  ctx.drawImage(img,0,0);

  let data = ctx.getImageData(0,0,canvas.width,canvas.height);
  let px=data.data;

  // marker to detect existence
  const MARKER = "GALAXY_SECURE::";

  let secret = document.getElementById("secret").value;
  let pass = document.getElementById("password").value;

  let encrypted = CryptoJS.AES.encrypt(secret,pass).toString();

  let final = MARKER + encrypted + "|END";

  let bin="";

  for(let i=0;i<final.length;i++){
    bin += final[i].charCodeAt(0).toString(2).padStart(8,"0");
  }

  for(let i=0;i<bin.length;i++){
    px[i]=(px[i]&254)|parseInt(bin[i]);
  }

  ctx.putImageData(data,0,0);

  document.getElementById("out").src = canvas.toDataURL();

}

</script>

</body>
</html>