<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>My Transactions | SquadVertex</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 { color: #1db954; margin-bottom: .5rem; }
    .total-svx { font-size: 1.25rem; margin-bottom: 1rem; }
    table {
      width: 100%; max-width: 600px;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border-radius: 8px; overflow: hidden;
    }
    th, td {
      padding: .75rem 1rem;
      border-bottom: 1px solid #e0e0e0;
      font-size: .95rem; text-align: left;
    }
    th {
      background: #e8f5e9; color: #2e7d32;
      font-weight: 600;
    }
    tr:last-child td { border-bottom: none }
    .amount-positive { color: #2e7d32; }
    .amount-negative { color: #b00; }
    .date { color: #777; font-size: .85rem; }
    .reason { color: #555; }
    .message { margin-top: 2rem; color: #666; font-size: 1rem; }
    /* Debug panel */
    #debug-panel {
      width: 100%; max-width: 800px;
      background: #272822; color: #f8f8f2;
      padding: 1rem; margin-top: 2rem;
      font-family: monospace; font-size: .85rem;
      border-radius: 6px; overflow-y: auto;
      max-height: 300px;
    }
    #debug-panel h2 {
      margin-bottom: .5rem; font-size: 1rem;
      color: #a6e22e;
    }
    #debug-panel pre {
      white-space: pre-wrap; word-break: break-word;
    }
  </style>
</head>
<body>
  <h1>Transaction History</h1>
  <div class="total-svx">Total SVX: <span id="total-svx">0</span></div>
  <table>
    <thead>
      <tr><th>Date</th><th>Amount</th><th>Reason</th></tr>
    </thead>
    <tbody id="tx-body">
      <tr><td colspan="3" class="loading">Loading...</td></tr>
    </tbody>
  </table>
  <div id="message" class="message" style="display:none;"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
  <script>
    // DOM
    const totalEl = document.getElementById('total-svx');
    const bodyEl  = document.getElementById('tx-body');
    const msgEl   = document.getElementById('message');

    // Debug panel
    const debug = document.createElement('div');
    debug.id = 'debug-panel';
    debug.innerHTML = '<h2>Debug Panel</h2><div id="debug-content"><pre>Initializing...</pre></div>';
    document.body.appendChild(debug);
    const dbg = document.getElementById('debug-content');

    // Format date
    function fmtDate(ts) {
      return ts.toDate().toLocaleString('en-IN', {
        dateStyle:'medium', timeStyle:'short'
      });
    }

    // Display debug info
    function logDebug(label, obj) {
      dbg.innerHTML += `<strong>${label}:</strong>\n<pre>${JSON.stringify(obj, null, 2)}</pre>\n`;
    }

    async function loadTransactions(uid) {
      msgEl.style.display = 'none';
      dbg.innerHTML = '<h2>Debug Panel</h2>';

      // Show user UID
      logDebug('Current UID', uid);

      // 1. Fetch user doc
      const userDocRef = firebase.firestore().collection('users').doc(uid);
      const uSnap = await userDocRef.get();
      logDebug('User Document Snapshot', uSnap.exists ? uSnap.data() : 'Document not found');
      totalEl.textContent = uSnap.exists ? (uSnap.data().svx||0) : '0';

      // 2. Fetch transactions
      const txCol = userDocRef.collection('transactions');
      const txSnap = await txCol.orderBy('timestamp','desc').get();
      logDebug('Transactions Snapshots', txSnap.docs.map(d=>({ id:d.id, ...d.data() })));

      bodyEl.innerHTML = '';
      if (txSnap.empty) {
        bodyEl.innerHTML = `
          <tr><td colspan="3" style="text-align:center;color:#777;padding:1rem;">
            No transactions found.
          </td></tr>`;
      } else {
        txSnap.forEach(docSnap => {
          const tx = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="date">${fmtDate(tx.timestamp)}</td>
            <td class="${tx.amount>=0?'amount-positive':'amount-negative'}">
              ${tx.amount>=0?'+':''}${tx.amount} SVX
            </td>
            <td class="reason">${tx.reason||'â€”'}</td>
          `;
          bodyEl.appendChild(tr);
        });
      }
    }

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    logDebug('Firebase Config', firebaseConfig);

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    logDebug('Firebase Initialized', {});

    auth.onAuthStateChanged(user => {
      logDebug('Auth State Changed', user || 'No user signed in');
      if (!user) {
        bodyEl.innerHTML = '';
        msgEl.textContent = 'Please sign in to view your transactions.';
        msgEl.style.display = 'block';
      } else {
        logDebug('User Info', {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName,
          photoURL: user.photoURL
        });
        loadTransactions(user.uid).catch(err => {
          console.error(err);
          bodyEl.innerHTML = `
            <tr><td colspan="3" style="text-align:center;color:#b00;padding:1rem;">
              Error loading transactions.
            </td></tr>`;
          logDebug('Load Error', err.message);
        });
      }
    });
  </script>
</body>
</html>