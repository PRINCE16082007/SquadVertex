<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>My Transactions | SquadVertex</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* NAVBAR */
    nav {
      width: 100%;
      background: #1db954;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    nav .logo { color:#fff; font-size:1.5rem; font-weight:bold; }
    nav ul {
      list-style:none;
      display:flex;
      gap:1.5rem;
    }
    nav ul li {
      color:#fff; cursor:pointer; font-weight:500; position:relative;
    }
    nav ul li:hover { opacity:0.8; }
    /* PROFILE HEADER */
    .profile-header {
      background:#fff;
      padding:1.5rem 2rem;
      display:flex;
      align-items:center;
      gap:1rem;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
    }
    .profile-header img {
      width:60px; height:60px; border-radius:50%; object-fit:cover;
      border:2px solid #1db954;
    }
    .profile-header .info {
      display:flex; flex-direction:column;
    }
    .profile-header .info h2 {
      font-size:1.25rem; color:#1db954; margin-bottom:0.25rem;
    }
    .profile-header .info p {
      color:#666; font-size:0.95rem;
    }
    /* CONTENT */
    .content {
      flex:1;
      padding:2rem;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .total-svx {
      font-size:1.25rem;
      margin-bottom:1rem;
    }
    table {
      width:100%;
      max-width:700px;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
    }
    th, td {
      padding:0.75rem 1rem;
      text-align:left;
      border-bottom:1px solid #e0e0e0;
      font-size:0.95rem;
    }
    th {
      background:#e8f5e9;
      color:#2e7d32;
      font-weight:600;
    }
    tr:nth-child(even) { background:#f9fcfb; }
    tr:hover { background:#f0faf4; }
    tr:last-child td { border-bottom:none; }
    .date { color:#777; font-size:0.85rem; }
    .amount-positive { color:#2e7d32; }
    .amount-negative { color:#b00; }
    .reason { color:#555; }
    .message { margin-top:2rem; color:#666; font-size:1rem; }
  </style>
</head>
<body>
  <nav>
    <div class="logo">SquadVertex</div>
    <ul>
      <li id="nav-home">Home</li>
      <li id="nav-analytics">Analytics</li>
      <li id="nav-settings">Settings</li>
      <li id="nav-logout">Logout</li>
    </ul>
  </nav>

  <div class="profile-header" id="profileHeader">
    <img id="userPic" src="" alt="User Photo"/>
    <div class="info">
      <h2 id="userName">Loading...</h2>
      <p id="userEmail"></p>
    </div>
  </div>

  <div class="content">
    <div class="total-svx">Total SVX: <span id="total-svx">0</span></div>
    <table>
      <thead>
        <tr><th>Date</th><th>Amount</th><th>Reason</th></tr>
      </thead>
      <tbody id="tx-body">
        <tr><td colspan="3" class="message">Loading...</td></tr>
      </tbody>
    </table>
    <div id="message" class="message" style="display:none;"></div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
  <script>
    const cfg = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const totalEl = document.getElementById('total-svx');
    const bodyEl  = document.getElementById('tx-body');
    const msgEl   = document.getElementById('message');
    const userPic = document.getElementById('userPic');
    const userName= document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');

    function fmtDate(ts) {
      return ts.toDate().toLocaleString('en-IN',{
        dateStyle:'medium',timeStyle:'short'
      });
    }

    async function loadTransactions(uid) {
      msgEl.style.display = 'none';
      // total SVX
      const uRef = db.collection('users').doc(uid);
      const uSnap = await uRef.get();
      const uData = uSnap.exists ? uSnap.data() : {};
      userName.textContent = uData.name || auth.currentUser.displayName || '(No Name)';
      userEmail.textContent = uData.email || auth.currentUser.email;
      userPic.src = auth.currentUser.photoURL || 
        'https://www.gstatic.com/images/branding/product/1x/avatar_circle_grey_512dp.png';

      totalEl.textContent = uData.svx || 0;

      // transactions
      const txSnap = await uRef.collection('transactions')
        .orderBy('timestamp','desc').get();

      bodyEl.innerHTML = '';
      if (txSnap.empty) {
        bodyEl.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#777;padding:1rem;">
          No transactions found.
        </td></tr>`;
      } else {
        txSnap.forEach(doc => {
          const tx = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="date">${fmtDate(tx.timestamp)}</td>
            <td class="${tx.amount>=0?'amount-positive':'amount-negative'}">
              ${tx.amount>=0?'+':''}${tx.amount} SVX
            </td>
            <td class="reason">${tx.reason||'â€”'}</td>`;
          bodyEl.appendChild(tr);
        });
      }
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        bodyEl.innerHTML = '';
        msgEl.textContent = 'Please sign in to view your transactions.';
        msgEl.style.display = 'block';
      } else {
        loadTransactions(user.uid).catch(err => {
          console.error(err);
          bodyEl.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#b00;padding:1rem;">
            Error loading transactions.
          </td></tr>`;
        });
      }
    });

    // Nav behavior
    document.getElementById('nav-home').onclick = () => {};
    document.getElementById('nav-analytics').onclick = () => alert('Analytics coming soon');
    document.getElementById('nav-settings').onclick = () => alert('Settings coming soon');
    document.getElementById('nav-logout').onclick = () => auth.signOut();
  </script>
</body>
</html>