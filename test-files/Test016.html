<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Transactions with Debug Console</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2, h3 {
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #debugConsole {
      background-color: #111;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 2px solid #0f0;
      margin-top: 20px;
    }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>
</head>
<body>
  <h1>User Transactions</h1>
  <p id="userIdDisplay"></p>

  <table id="transactionsTable">
    <thead>
      <tr>
        <th>Amount</th>
        <th>Reason</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody>
      <!-- Transaction rows go here -->
    </tbody>
  </table>

  <h2>Total Points: <span id="totalPoints">0</span></h2>
  <h3>SVX Points (User Profile): <span id="svxPoints">-</span></h3>

  <h3>Debug Console</h3>
  <div id="debugConsole"></div>

  <script>
    // Debug console logger
    const debugConsole = document.getElementById('debugConsole');
    function logDebug(msg) {
      const time = new Date().toLocaleTimeString();
      debugConsole.textContent += `[${time}] ${msg}\n`;
      debugConsole.scrollTop = debugConsole.scrollHeight;
      console.log(msg);
    }

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };

    // Enable App Check debug mode in development
    // To use a specific debug token, replace 'true' with the string token
    self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
    logDebug("App Check debug token enabled.");

    // Initialize Firebase app
    firebase.initializeApp(firebaseConfig);
    logDebug("Firebase initialized.");

    // Activate App Check with reCaptcha v3
    try {
      const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
      firebase.appCheck().activate(appCheckProvider, true);
      logDebug("App Check activated with reCaptcha v3.");
    } catch (error) {
      logDebug("App Check activation failed: " + error.message);
    }

    const db = firebase.firestore();

    // Utility: get URL parameter
    function getParameterByName(name) {
      const url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    // Format Firestore timestamp
    function formatTimestamp(ts) {
      if (!ts) return '';
      if (ts.seconds) {
        return new Date(ts.seconds * 1000).toLocaleString();
      } else if (typeof ts === 'string') {
        return new Date(ts).toLocaleString();
      }
      return '';
    }

    async function loadUserTransactions(userId) {
      if (!userId) {
        document.getElementById('userIdDisplay').textContent = 'User ID missing from URL.';
        logDebug('User ID missing in URL param.');
        return;
      }
      document.getElementById('userIdDisplay').textContent = `Transactions for User ID: ${userId}`;
      logDebug('Loading transactions for User ID: ' + userId);

      const tbody = document.querySelector("#transactionsTable tbody");
      tbody.innerHTML = '';
      document.getElementById('totalPoints').textContent = 'Loading...';
      document.getElementById('svxPoints').textContent = '-';

      try {
        // Get user doc to get svx points
        const userDoc = await db.collection('users').doc(userId).get();
        if (!userDoc.exists) {
          document.getElementById('userIdDisplay').textContent = 'User not found.';
          document.getElementById('totalPoints').textContent = '0';
          logDebug('User document not found.');
          return;
        }
        const userData = userDoc.data();
        const svx = userData.svx || '-';
        document.getElementById('svxPoints').textContent = svx;
        logDebug("User SVX points: " + svx);

        // Get transactions subcollection
        const transSnapshot = await db.collection('users').doc(userId).collection('transactions').get();
        if (transSnapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="3">No transactions found for this user.</td></tr>';
          document.getElementById('totalPoints').textContent = '0';
          logDebug('No transactions found.');
          return;
        }

        let totalPoints = 0;
        transSnapshot.forEach(doc => {
          const data = doc.data();
          const amount = data.amount || 0;
          const reason = data.reason || '';
          const timestamp = formatTimestamp(data.timestamp);
          totalPoints += amount;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${amount}</td>
            <td>${reason}</td>
            <td>${timestamp}</td>
          `;
          tbody.appendChild(row);
          logDebug(`Transaction: amount=${amount}, reason=${reason}, timestamp=${timestamp}`);
        });
        document.getElementById('totalPoints').textContent = totalPoints;
        logDebug("Total points calculated: " + totalPoints);
      } catch (error) {
        console.error(error);
        document.getElementById('userIdDisplay').textContent = 'Error loading transactions. Check console.';
        document.getElementById('totalPoints').textContent = '0';
        logDebug("Error loading transactions: " + error.message);
      }
    }

    window.onload = () => {
      const userId = getParameterByName('id');
      loadUserTransactions(userId);
    };
  </script>
</body>
</html>
