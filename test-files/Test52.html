<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple PDF Image Positioning Editor</title>
<style>
  #pdf-container {
    border: 1px solid #ccc;
    width: 600px;
    height: 800px;
    overflow: auto;
    position: relative;
  }
  #pdf-canvas {
    display: block;
    margin: 0 auto;
  }
  img.editable-image {
    position: absolute;
    cursor: move;
    border: 2px dashed #007bff;
  }
  #controls {
    margin: 10px 0;
  }
  label {
    margin-right: 10px;
  }
  input[type=number] {
    width: 60px;
    margin-right: 15px;
  }
</style>
</head>
<body>

<h2>Simple PDF Image Editor (Position and Size Control)</h2>

<input type="file" id="pdf-upload" accept="application/pdf" />
<input type="file" id="image-upload" accept="image/*" />
<div id="pdf-container">
  <canvas id="pdf-canvas"></canvas>
</div>

<div id="controls" style="display:none;">
  <label>X: <input type="number" id="pos-x" value="50" /></label>
  <label>Y: <input type="number" id="pos-y" value="50" /></label>
  <label>Width: <input type="number" id="img-width" value="100" /></label>
  <label>Height: <input type="number" id="img-height" value="100" /></label>
  <button id="update-btn">Update Image</button>
  <button id="save-pdf-btn">Save PDF with Image</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.19.0/pdf-lib.min.js"></script>

<script>
  const pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.worker.min.js';

  let pdfDoc = null;
  let currentPage = 1;
  let scale = 1.5;

  const canvas = document.getElementById('pdf-canvas');
  const ctx = canvas.getContext('2d');
  const pdfContainer = document.getElementById('pdf-container');

  let imageElement = null;

  // Load PDF
  document.getElementById('pdf-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    renderPage(currentPage);
  });

  async function renderPage(pageNum) {
    const page = await pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: scale });
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    // Clear previous image
    if (imageElement) {
      imageElement.style.display = 'none'; 
      pdfContainer.removeChild(imageElement);
      imageElement = null;
      document.getElementById('controls').style.display = 'none';
    }

    const renderContext = {
      canvasContext: ctx,
      viewport: viewport,
    };
    await page.render(renderContext).promise;
  }

  // Load Image on upload
  document.getElementById('image-upload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file || !pdfDoc) {
      alert('Please upload a PDF first!');
      return;
    }
    const url = URL.createObjectURL(file);

    if (imageElement) {
      pdfContainer.removeChild(imageElement);
      imageElement = null;
    }

    imageElement = document.createElement('img');
    imageElement.src = url;
    imageElement.className = 'editable-image';
    imageElement.style.left = '50px';
    imageElement.style.top = '50px';
    imageElement.style.width = '100px';
    imageElement.style.height = '100px';
    pdfContainer.appendChild(imageElement);

    document.getElementById('controls').style.display = 'block';
    updateControlValues();
  });

  // Update input fields with current image values
  function updateControlValues() {
    if (!imageElement) return;
    document.getElementById('pos-x').value = parseInt(imageElement.style.left);
    document.getElementById('pos-y').value = parseInt(imageElement.style.top);
    document.getElementById('img-width').value = parseInt(imageElement.style.width);
    document.getElementById('img-height').value = parseInt(imageElement.style.height);
  }

  // Update image position and size from inputs
  document.getElementById('update-btn').addEventListener('click', () => {
    if (!imageElement) return;
    const x = parseInt(document.getElementById('pos-x').value);
    const y = parseInt(document.getElementById('pos-y').value);
    const w = parseInt(document.getElementById('img-width').value);
    const h = parseInt(document.getElementById('img-height').value);

    imageElement.style.left = x + 'px';
    imageElement.style.top = y + 'px';
    imageElement.style.width = w + 'px';
    imageElement.style.height = h + 'px';
  });

  // Save PDF with embedded image at set position and size
  document.getElementById('save-pdf-btn').addEventListener('click', async () => {
    if (!pdfDoc || !imageElement) {
      alert('Upload both PDF and image first!');
      return;
    }

    // Load original PDF bytes again for pdf-lib
    const fileInput = document.getElementById('pdf-upload');
    const arrayBuffer = await fileInput.files[0].arrayBuffer();

    // Load pdf-lib document
    const pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);

    // Get first page (assuming single page PDF for simplicity)
    const page = pdfLibDoc.getPage(currentPage - 1);
    const { width, height } = page.getSize();

    // Prepare the image bytes for embedding
    const imgSrc = imageElement.src;

    // Convert base64 or object URL to Uint8Array for pdf-lib
    let imgBytes;
    if (imgSrc.startsWith('data:image')) {
      imgBytes = Uint8Array.from(atob(imgSrc.split(',')[1]), c => c.charCodeAt(0));
    } else {
      // Fetch blob from object URL
      const response = await fetch(imgSrc);
      const blob = await response.blob();
      imgBytes = new Uint8Array(await blob.arrayBuffer());
    }

    // Embed image based on type
    let embeddedImage;
    if (imgSrc.includes('.png') || imgSrc.startsWith('data:image/png')) {
      embeddedImage = await pdfLibDoc.embedPng(imgBytes);
    } else {
      embeddedImage = await pdfLibDoc.embedJpg(imgBytes);
    }

    // Adjust coordinates: pdf-lib uses bottom-left origin,
    // our coords are top-left relative to canvas.
    const x = parseInt(imageElement.style.left);
    const y = height - parseInt(imageElement.style.top) - parseInt(imageElement.style.height); // flip y

    const imgWidth = parseInt(imageElement.style.width);
    const imgHeight = parseInt(imageElement.style.height);

    // Draw image on PDF page
    page.drawImage(embeddedImage, {
      x: x,
      y: y,
      width: imgWidth,
      height: imgHeight,
    });

    // Save the PDF
    const pdfBytes = await pdfLibDoc.save();

    // Create downloadable link
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'edited.pdf';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>