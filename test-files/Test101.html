<!-- chat.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>SLN Chat</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #E0E0E0; }
    .noise {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=');
      opacity: 0.015;
    }
    #chatWindow { overflow-y: auto; flex: 1; }
    .input-group textarea { resize: none; }
  </style>
</head>
<body class="d-flex flex-column vh-100 noise">
  <!-- Safe exit -->
  <div class="d-flex justify-end p-2">
    <button id="exitBtn" class="btn btn-sm btn-outline-light">ðŸšª Exit</button>
  </div>

  <!-- Chat Window -->
  <div id="chatWindow" class="flex-grow-1 px-3 pb-3">
    <!-- Messages appended here -->
  </div>

  <!-- Input Bar -->
  <div class="p-3 border-top border-secondary">
    <div class="input-group">
      <textarea id="messageInput" class="form-control bg-secondary text-white" rows="2" placeholder="Yahan apni kahani likho..."></textarea>
      <button id="sendBtn" class="btn btn-primary ms-2">Send</button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Generate or retrieve anonymous ID
    let userId = localStorage.getItem('sln_userId');
    if (!userId) {
      userId = 'SilentSoul' + Math.floor(Math.random() * 900 + 100);
      localStorage.setItem('sln_userId', userId);
    }

    // Elements
    const chatWindow = document.getElementById('chatWindow');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const exitBtn = document.getElementById('exitBtn');

    // Exit handler
    exitBtn.addEventListener('click', () => {
      window.location.href = 'https://duckduckgo.com';
    });

    // Send on click or Enter
    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      appendMessage(userId, text);
      input.value = '';
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Append message to UI
    function appendMessage(id, text) {
      const card = document.createElement('div');
      card.className = 'card bg-dark border-0 mb-2';
      card.innerHTML = `
        <div class="card-body d-flex align-items-start">
          <img src="https://i.pravatar.cc/40?u=${id}" class="rounded-circle me-3" alt="Avatar">
          <div>
            <div class="small text-muted mb-1">${id}</div>
            <div class="bg-secondary text-white p-2 rounded">${escapeHtml(text)}</div>
          </div>
        </div>`;
      chatWindow.appendChild(card);
    }

    // Simple escape
    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Load from localStorage (if any)
    const history = JSON.parse(localStorage.getItem('sln_history') || '[]');
    history.forEach(msg => appendMessage(msg.id, msg.text));
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // Persist on send
    const originalAppend = appendMessage;
    appendMessage = (id, text) => {
      originalAppend(id, text);
      history.push({ id, text });
      localStorage.setItem('sln_history', JSON.stringify(history));
    };
  </script>
</body>
</html>