<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SquadVertex Live Stream</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
    #videoContainer { margin-bottom: 1rem; }
    #metadata { margin-bottom: 1rem; }
    #metadata h2 { margin: 0; }
    #metadata p { margin: .25rem 0; color: #555; }
    #commentsList p { border-bottom: 1px solid #ddd; padding: .5rem 0; }
    button { padding: .5rem 1rem; margin: .5rem 0; }
    textarea { width: 100%; height: 4rem; margin-bottom: .5rem; }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>‚ñ∂Ô∏è SquadVertex Live Stream</h1>

  <!-- Video slot -->
  <div id="videoContainer">Loading live stream‚Ä¶</div>

  <!-- Metadata: title + description -->
  <div id="metadata"></div>

  <hr>

  <!-- Voting UI -->
  <h2>üëç/üëé Voting</h2>
  <button id="btnLike">Like (<span id="likeCount">0</span>)</button>
  <button id="btnDislike">Dislike (<span id="dislikeCount">0</span>)</button>

  <hr>

  <!-- Comments UI -->
  <h2>üí¨ Comments</h2>
  <div id="commentsList">Loading comments‚Ä¶</div>
  <textarea id="commentInput" placeholder="Write a comment"></textarea><br>
  <button id="btnComment">Post Comment</button>

  <script>
      // Firebase initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) References
    const EVENT_ID    = 'SpringLaunch2025';
    const eventRef    = db.collection('events').doc(EVENT_ID);
    const settingsRef = eventRef.collection('settings').doc('activeVideo');
    const commentsCol = eventRef.collection('comments');
    const votesCol    = eventRef.collection('votes');

    let current = { provider: null, videoId: null };

    // 3) Listen for activeVideo 
    settingsRef.onSnapshot(s => {
      const data = s.data() || {};
      current.provider = data.provider || null;
      current.videoId  = data.videoId  || null;
      renderVideo();
      loadVotes();
      loadComments();
    });

    // 4) Render Video + Metadata
    async function renderVideo() {
      const vc = document.getElementById('videoContainer');
      const md = document.getElementById('metadata');
      vc.innerHTML = ''; md.innerHTML = '';

      const { provider, videoId } = current;
      if (!provider || !videoId) {
        vc.textContent = 'No live stream currently.';
        return;
      }

      // 4a) Embed
      if (provider === 'wistia') {
        if (!window._wq) {
          const s = document.createElement('script');
          s.src = 'https://fast.wistia.com/assets/external/E-v1.js'; s.async = true;
          document.head.appendChild(s);
          window._wq = [];
        }
        const div = document.createElement('div');
        div.className = `wistia_embed wistia_async_${videoId}`;
        div.style.width = '640px'; div.style.height = '360px';
        vc.appendChild(div);
        window._wq.push({
          id: videoId,
          onReady(video) {
            video.bind('end', () => {
              video.pause(); video.controls(false);
              alert('Stream ended ‚Äî come back for the next video!');
            });
          }
        });
      } else if (provider === 'vimeo') {
        const iframe = document.createElement('iframe');
        iframe.src = `https://player.vimeo.com/video/${videoId}`
                   + `?badge=0&title=0&byline=0&portrait=0`;
        iframe.width  = '640';
        iframe.height = '360';
        iframe.frameBorder = '0';
        iframe.allow = 'autoplay; fullscreen; picture-in-picture';
        iframe.allowFullscreen = true;
        vc.appendChild(iframe);
      }

      // 4b) Fetch & display title + description via oEmbed
      let title = ''; let desc = '';
      try {
        let url = '';
        if (provider === 'wistia') {
          url = `https://fast.wistia.com/oembed?url=https://home.wistia.com/medias/${videoId}`;
        } else {
          url = `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${videoId}`;
        }
        const res = await fetch(url);
        const o = await res.json();
        title = o.title || '';
        desc = o.description || '';
      } catch {}
      md.innerHTML = `<h2>${title}</h2>${desc? `<p>${desc}</p>` : ''}`;
    }

    // 5) Voting
    function loadVotes() {
      const { provider, videoId } = current;
      const likeCt = document.getElementById('likeCount');
      const disCt  = document.getElementById('dislikeCount');
      if (!provider || !videoId) {
        likeCt.textContent = disCt.textContent = '0';
        return;
      }
      const key = `${provider}_${videoId}`;
      votesCol.doc(key).onSnapshot(s => {
        const v = s.data() || { likes: 0, dislikes: 0 };
        likeCt.textContent = v.likes;
        disCt.textContent  = v.dislikes;
      });
    }
    function vote(isLike) {
      const { provider, videoId } = current;
      if (!provider || !videoId) return;
      const key = `${provider}_${videoId}`;
      const docRef = votesCol.doc(key);
      db.runTransaction(tx =>
        tx.get(docRef).then(s => {
          const v = s.exists? s.data() : { likes:0, dislikes:0 };
          v[isLike? 'likes':'dislikes']++;
          v.lastUpdated = Date.now();
          tx.set(docRef, v);
        })
      );
    }
    document.getElementById('btnLike').onclick    = () => vote(true);
    document.getElementById('btnDislike').onclick = () => vote(false);

    // 6) Comments (no composite index)
    function loadComments() {
      const list = document.getElementById('commentsList');
      list.innerHTML = '';
      commentsCol
        .orderBy('timestamp')
        .onSnapshot(snap => {
          list.innerHTML = '';
          snap.forEach(d => {
            const c = d.data();
            if (c.provider === current.provider && c.videoId === current.videoId) {
              const p = document.createElement('p');
              p.textContent = `[${new Date(c.timestamp).toLocaleTimeString()}] ${c.text}`;
              list.appendChild(p);
            }
          });
        });
    }
    document.getElementById('btnComment').onclick = () => {
      const txt = document.getElementById('commentInput').value.trim();
      const { provider, videoId } = current;
      if (!txt || !provider || !videoId) return;
      commentsCol.add({
        provider,
        videoId,
        text: txt,
        timestamp: Date.now()
      });
      document.getElementById('commentInput').value = '';
    };
  </script>
</body>
</html>