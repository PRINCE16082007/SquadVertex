<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SquadVertex Live Stream</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
    #videoContainer { margin-bottom: 1rem; }
    #metadata { margin-bottom: 1rem; font-style: italic; }
    #commentsList p { border-bottom: 1px solid #ddd; padding: .5rem 0; }
    button { padding: .5rem 1rem; margin: .5rem 0; }
    textarea { width: 100%; height: 4rem; margin-bottom: .5rem; }
  </style>

  <!-- Wistia Player script will be injected when needed -->
  <!-- Vimeo iframe needs no extra script -->

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>▶️ SquadVertex Live Stream</h1>

  <!-- Video slot -->
  <div id="videoContainer">Loading live stream…</div>
  <div id="metadata"></div>

  <hr>

  <!-- Voting UI -->
  <h2>👍/👎 Voting</h2>
  <button id="btnLike">Like (<span id="likeCount">0</span>)</button>
  <button id="btnDislike">Dislike (<span id="dislikeCount">0</span>)</button>

  <hr>

  <!-- Comments UI -->
  <h2>💬 Comments</h2>
  <div id="commentsList">Loading comments…</div>
  <textarea id="commentInput" placeholder="Write a comment"></textarea><br>
  <button id="btnComment">Post Comment</button>

  <script>
    // ── 1) Firebase init ─────────────────────────────────────────────────────────
    const firebaseConfig = {
      apiKey:     "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId:  "YOUR_PROJECT",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ── 2) Constants & refs ──────────────────────────────────────────────────────
    const EVENT_ID    = 'SpringLaunch2025';
    const eventRef    = db.collection('events').doc(EVENT_ID);
    const settingsRef = eventRef.collection('settings').doc('activeVideo');
    const commentsCol = eventRef.collection('comments');
    const votesCol    = eventRef.collection('votes');

    let current = { provider: null, id: null };

    // ── 3) Listen for activeVideo changes ───────────────────────────────────────
    settingsRef.onSnapshot(snap => {
      const data = snap.data() || {};
      current.provider = data.provider || null;
      current.id       = data.id || null;
      renderVideo(current);
      loadVotes(current);
      loadComments(current);
    });

    // ── 4) Render embed + metadata ──────────────────────────────────────────────
    function renderVideo({ provider, id }) {
      const vc = document.getElementById('videoContainer');
      const md = document.getElementById('metadata');
      vc.innerHTML = '';
      md.innerHTML = '';

      if (!provider || !id) {
        vc.textContent = 'No live stream currently.';
        return;
      }

      // Metadata line
      md.textContent = `Now Streaming: ${provider.toUpperCase()} – ${id}`;

      if (provider === 'wistia') {
        // inject Wistia player script once
        if (!window._wq) {
          const s = document.createElement('script');
          s.src = 'https://fast.wistia.com/assets/external/E-v1.js';
          s.async = true;
          document.head.appendChild(s);
          window._wq = [];
        }
        // insert embed div
        const div = document.createElement('div');
        div.className = `wistia_embed wistia_async_${id}`;
        div.style.width  = '640px';
        div.style.height = '360px';
        vc.appendChild(div);
        // disable replay on end
        window._wq.push({
          id,
          onReady(video) {
            video.bind('end', () => {
              video.pause();
              video.controls(false);
              alert('Stream ended — come back for the next video!');
            });
          }
        });
      }
      else if (provider === 'vimeo') {
        // Vimeo embed via iframe
        const iframe = document.createElement('iframe');
        iframe.src = `https://player.vimeo.com/video/${id}`
                   + `?badge=0&title=0&byline=0&portrait=0`;
        iframe.width  = '640';
        iframe.height = '360';
        iframe.frameBorder = '0';
        iframe.allow = 'autoplay; fullscreen; picture-in-picture';
        iframe.allowFullscreen = true;
        vc.appendChild(iframe);
      }
    }

    // ── 5) Voting logic ─────────────────────────────────────────────────────────
    function loadVotes({ provider, id }) {
      const likeCt = document.getElementById('likeCount');
      const disCt  = document.getElementById('dislikeCount');
      if (!provider || !id) {
        likeCt.textContent = disCt.textContent = '0';
        return;
      }
      const key = `${provider}_${id}`;
      votesCol.doc(key)
        .onSnapshot(snap => {
          const v = snap.data() || { likes:0, dislikes:0 };
          likeCt.textContent = v.likes;
          disCt.textContent  = v.dislikes;
        });
    }
    function vote(isLike) {
      if (!current.provider || !current.id) return;
      const key = `${current.provider}_${current.id}`;
      const docRef = votesCol.doc(key);
      db.runTransaction(tx => {
        return tx.get(docRef).then(doc => {
          const v = doc.exists? doc.data() : { likes:0, dislikes:0 };
          v[isLike? 'likes':'dislikes']++;
          v.lastUpdated = Date.now();
          tx.set(docRef, v);
        });
      });
    }
    document.getElementById('btnLike').onclick    = () => vote(true);
    document.getElementById('btnDislike').onclick = () => vote(false);

    // ── 6) Comments logic ───────────────────────────────────────────────────────
    function loadComments({ provider, id }) {
      const list = document.getElementById('commentsList');
      if (!provider || !id) {
        list.innerHTML = '<p>No comments.</p>';
        return;
      }
      list.innerHTML = '';
      commentsCol
        .where('videoKey','==', `${provider}_${id}`)
        .orderBy('timestamp')
        .onSnapshot(snap => {
          list.innerHTML = '';
          snap.forEach(d => {
            const c = d.data();
            const p = document.createElement('p');
            p.textContent = `[${new Date(c.timestamp).toLocaleTimeString()}] ${c.text}`;
            list.appendChild(p);
          });
        });
    }
    document.getElementById('btnComment').onclick = () => {
      const txt = document.getElementById('commentInput').value.trim();
      if (!txt || !current.provider || !current.id) return;
      commentsCol.add({
        videoKey: `${current.provider}_${current.id}`,
        text: txt,
        timestamp: Date.now()
      });
      document.getElementById('commentInput').value = '';
    };
  </script>
</body>
</html>