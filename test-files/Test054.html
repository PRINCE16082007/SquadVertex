<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamGalaxy - Community Chat (with typing)</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: #e0e0ff; min-height: 100vh; display:flex; flex-direction:column; padding:0; }

    .container { max-width:1000px; margin:0 auto; width:100%; padding:1rem; flex:1; display:flex; flex-direction:column; }

    /* Header */
    .header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:rgba(10,10,35,0.95); backdrop-filter:blur(15px); border-radius:15px; border:1px solid #5a4fcf; box-shadow:0 4px 20px rgba(0,0,0,0.4); margin-bottom:2rem; }
    .logo { font-size:1.8rem; font-weight:700; background:linear-gradient(45deg,#8a7cff,#d66efd); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:1px; }
    .user-profile { display:flex; align-items:center; gap:0.8rem; }
    .profile-photo { width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid #8a7cff; background:linear-gradient(45deg,#6a5af9,#d66efd); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:1.2rem; overflow:hidden; }

    /* Chat container */
    .chat-container { display:flex; flex-direction:column; flex:1; background:rgba(20,20,40,0.85); border-radius:20px; border:1px solid #5a4fcf; backdrop-filter:blur(10px); box-shadow:0 15px 35px rgba(0,0,0,0.4); overflow:hidden; margin-bottom:2rem; }
    .messages-area { flex:1; padding:1.5rem; overflow-y:auto; display:flex; flex-direction:column; gap:1.2rem; scroll-behavior:smooth; }
    .message-card { background:rgba(30,30,50,0.7); border-radius:15px; padding:1.2rem; border:1px solid #4a4a8a; transition:transform .3s, box-shadow .3s; animation:fadeIn .2s ease-out; display:flex; flex-direction:column; gap:0.5rem; }
    .message-card:hover { transform:translateY(-3px); border-color:#8a7cff; box-shadow:0 5px 15px rgba(138,124,255,0.15); }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }

    .message-header { display:flex; align-items:center; gap:0.8rem; margin-bottom:0.4rem; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(45deg,#6a5af9,#d66efd); color:#fff; font-weight:700; font-size:1rem; border:2px solid rgba(138,124,255,0.6); overflow:hidden; }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .user-info { display:flex; flex-direction:column; }
    .username { font-weight:600; color:#8a7cff; font-size:0.98rem; }
    .timestamp { font-size:0.8rem; color:#a0a0d0; }
    .message-content { color:#c0c0e0; line-height:1.6; font-size:1rem; word-break:break-word; white-space:pre-wrap; }

    .input-area { padding:1.5rem; background:rgba(30,30,50,0.7); border-top:1px solid #5a4fcf; display:flex; gap:0.8rem; align-items:flex-end; }
    .typing-indicator { color:#a8caff; font-size:0.95rem; margin-bottom:6px; min-height:20px; }
    .message-input { flex:1; padding:.9rem 1.2rem; border-radius:10px; border:1px solid #4a4a8a; background:rgba(20,20,40,0.5); color:#e0e0ff; font-size:1rem; outline:none; transition:border-color .3s, box-shadow .3s; backdrop-filter:blur(5px); }
    .message-input:focus { border-color:#8a7cff; box-shadow:0 0 10px rgba(138,124,255,0.3); }
    .send-button { padding:.9rem 1.5rem; border-radius:10px; border:none; background:linear-gradient(45deg,#6a5af9,#d66efd); color:white; font-weight:600; cursor:pointer; transition:transform .2s, box-shadow .2s; font-size:1rem; }
    .send-button:disabled { opacity:.55; cursor:not-allowed; }
    .send-button:hover:not(:disabled){ transform:scale(1.03); box-shadow:0 0 15px rgba(106,90,249,0.4); }

    /* small bottom helpers */
    .notification { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(106,90,249,0.9); color:white; padding:.8rem 1.5rem; border-radius:8px; font-weight:600; z-index:1000; opacity:0; pointer-events:none; transition:opacity .3s; }
    .notification.show { opacity:1; pointer-events:auto; }

    @media (max-width:768px) { .header { flex-direction:column; gap:1rem; padding:1rem; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">GalaxyWeb</div>
    <div class="user-profile">
      <div class="profile-photo" id="header-avatar">U</div>
    </div>
  </header>

  <div class="container">
    <main class="chat-container">
      <div class="messages-area" id="messages-area">
        <div style="text-align:center;color:#a0a0d0;padding:2rem;">Loading community chat...</div>
      </div>

      <!-- typing indicator sits above the input -->
      <div style="padding:0 1.5rem;">
        <div id="typing-indicator" class="typing-indicator"></div>
      </div>

      <div class="input-area">
        <input type="text" class="message-input" id="message-input" placeholder="Write your message here..." maxlength="500" />
        <button class="send-button" id="send-button" disabled>Send</button>
      </div>
    </main>
  </div>

  <footer style="background:rgba(10,10,35,0.95); padding:3rem 2rem 2rem; border-top:1px solid #5a4fcf;">
    <div style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:3rem;">
      <div>
        <div style="font-size:1.1rem;color:#8a7cff;margin-bottom:1rem;font-weight:600;">About TeamGalaxy</div>
        <div style="color:#a0a0d0;line-height:1.6;font-size:.9rem;">
          TeamGalaxy is an innovative gaming and creative community. Join now to explore the Galaxy!
        </div>
      </div>
      <div>
        <div style="display:flex;flex-direction:column;gap:.6rem;">
          <a href="#" style="color:#a0a0d0;text-decoration:none">Privacy Policy</a>
          <a href="#" style="color:#a0a0d0;text-decoration:none">Terms & Conditions</a>
          <a href="#" style="color:#a0a0d0;text-decoration:none">About</a>
        </div>
      </div>
    </div>
  </footer>

  <div class="notification" id="notification">Message sent!</div>

  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    // Initialize Firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const messagesArea = document.getElementById('messages-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const headerAvatar = document.getElementById('header-avatar');
    const notification = document.getElementById('notification');
    const typingIndicator = document.getElementById('typing-indicator');

    // State
    let unsubscribeMessages = null;
    let unsubscribeTyping = null;
    let currentProfile = null; // { slug, name, photoUrl }
    let typingTimeout = null;
    let localTyping = false;

    // Helpers
    function showNotification(msg) {
      notification.textContent = msg;
      notification.classList.add('show');
      setTimeout(()=>notification.classList.remove('show'), 2500);
    }
    function escapeHtml(str='') { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('en-IN',{ hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short' });
      } catch(e) { return 'Just now'; }
    }

    // Build a message DOM node (safe)
    function buildMessageElement(data, id) {
      const card = document.createElement('div'); card.className='message-card'; if(id) card.dataset.docId = id;
      const header = document.createElement('div'); header.className='message-header';
      const avatarWrap = document.createElement('div'); avatarWrap.className='avatar';

      const initials = document.createElement('div'); initials.textContent = (data.authorName || 'U').charAt(0).toUpperCase();
      initials.style.display = 'flex'; initials.style.width='100%'; initials.style.height='100%'; initials.style.alignItems='center'; initials.style.justifyContent='center';

      if (data.authorPhotoUrl) {
        const img = document.createElement('img'); img.src = data.authorPhotoUrl; img.alt = (data.authorName || 'Avatar').slice(0,20);
        img.onerror = () => { if (img.parentElement) img.parentElement.removeChild(img); initials.style.display='flex'; };
        avatarWrap.appendChild(img); initials.style.display='none'; avatarWrap.appendChild(initials);
      } else {
        initials.style.display='flex'; avatarWrap.appendChild(initials);
      }

      const userInfo = document.createElement('div'); userInfo.className='user-info';
      const userName = document.createElement('div'); userName.className='username'; userName.innerHTML = escapeHtml(data.authorName || 'Anonymous');
      const time = document.createElement('div'); time.className='timestamp'; time.textContent = formatTime(data.timestamp);
      userInfo.appendChild(userName); userInfo.appendChild(time);

      header.appendChild(avatarWrap); header.appendChild(userInfo);

      const content = document.createElement('div'); content.className='message-content'; content.innerHTML = escapeHtml(data.text || '');

      card.appendChild(header); card.appendChild(content);
      return card;
    }

    // Render snapshot in full (stable)
    function renderMessagesFromSnapshot(snapshot) {
      messagesArea.innerHTML = '';
      if (!snapshot.docs.length) {
        messagesArea.innerHTML = '<div style="text-align:center;color:#a0a0d0;padding:2rem;">No messages yet. Say hi ðŸ‘‹</div>';
        return;
      }
      snapshot.docs.forEach(docSnap => {
        const el = buildMessageElement(docSnap.data(), docSnap.id);
        messagesArea.appendChild(el);
      });
      // scroll to bottom so newest visible
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Send message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      sendButton.disabled = true;
      try {
        const user = auth.currentUser; if (!user) throw new Error('Not signed in');

        // get private doc for slug
        const privateDoc = await db.collection('usersPrivate').doc(user.uid).get();
        if (!privateDoc.exists) throw new Error('User private profile missing');
        const udata = privateDoc.data(); const slug = udata.slug; if (!slug) throw new Error('User slug missing');

        // get public profile
        const publicDoc = await db.collection('publicProfiles').doc(slug).get();
        if (!publicDoc.exists) throw new Error('Public profile missing');
        const pd = publicDoc.data();

        const message = {
          text: text,
          authorSlug: slug,
          authorName: pd.name || (user.displayName || 'Anonymous'),
          authorPhotoUrl: pd.profilePhotoUrl || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          visibility: true,
          likes: 0
        };

        await db.collection('communityMessages').add(message);
        messageInput.value = '';
        showNotification('Message sent!');
        // stop typing immediately after sending
        stopTyping();
      } catch (err) {
        console.error('Send error:', err);
        showNotification('Error: ' + (err.message || 'Failed to send'));
      } finally {
        sendButton.disabled = false;
      }
    }

    // Realtime listener (order asc = oldest -> newest)
    function setupRealtimeListener() {
      if (typeof unsubscribeMessages === 'function') unsubscribeMessages();
      messagesArea.innerHTML = '<div style="text-align:center;color:#a0a0d0;padding:2rem;">Loading community chat...</div>';
      const q = db.collection('communityMessages').where('visibility','==',true).orderBy('timestamp','asc').limit(500);
      unsubscribeMessages = q.onSnapshot(snapshot => {
        renderMessagesFromSnapshot(snapshot);
      }, err => {
        console.error('Listener error:', err);
        messagesArea.innerHTML = `<div style="text-align:center;color:red;padding:2rem;">Failed to load chat: ${escapeHtml(err.message || 'Unknown')}</div>`;
      });
    }

    // Typing presence functions
    function startTypingLocal() {
      if (!currentProfile) return;
      if (localTyping) { // refresh timeout
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(stopTyping, 1700);
        return;
      }
      localTyping = true;
      // set typing true in communityTyping/{slug}
      db.collection('communityTyping').doc(currentProfile.slug).set({
        typing: true,
        name: currentProfile.name || '',
        photoUrl: currentProfile.photoUrl || '',
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(err => console.warn('typing set err', err));
      typingTimeout = setTimeout(stopTyping, 1700);
    }

    function stopTyping() {
      if (!currentProfile) return;
      localTyping = false;
      clearTimeout(typingTimeout);
      db.collection('communityTyping').doc(currentProfile.slug).set({
        typing: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(err => console.warn('typing clear err', err));
    }

    // Listen for who is typing
    function setupTypingListener() {
      if (typeof unsubscribeTyping === 'function') unsubscribeTyping();
      unsubscribeTyping = db.collection('communityTyping').where('typing','==',true).onSnapshot(snapshot => {
        const typingUsers = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          // exclude yourself
          if (currentProfile && doc.id === currentProfile.slug) return;
          if (d && d.name) typingUsers.push(d.name);
        });
        updateTypingIndicator(typingUsers);
      }, err => {
        console.warn('typing listener err', err);
      });
    }

    function updateTypingIndicator(typingUsers) {
      if (!typingUsers || typingUsers.length === 0) {
        typingIndicator.textContent = '';
        return;
      }
      if (typingUsers.length === 1) {
        typingIndicator.textContent = `${typingUsers[0]} is typingâ€¦`;
      } else if (typingUsers.length === 2) {
        typingIndicator.textContent = `${typingUsers[0]} and ${typingUsers[1]} are typingâ€¦`;
      } else {
        typingIndicator.textContent = `${typingUsers[0]} and ${typingUsers.length - 1} others are typingâ€¦`;
      }
    }

    // Auth & setup
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = '/teamgalaxy/legal/sign_up.html'; return; }

      // fetch private => slug => public
      try {
        const privateDoc = await db.collection('usersPrivate').doc(user.uid).get();
        const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
        if (privateDoc.exists) {
          const pd = privateDoc.data();
          const slug = pd.slug;
          if (slug) {
            const publicDoc = await db.collection('publicProfiles').doc(slug).get();
            if (publicDoc.exists) {
              const pub = publicDoc.data();
              currentProfile = { slug, name: pub.name || (user.displayName || 'Anonymous'), photoUrl: pub.profilePhotoUrl || '' };
              // set header avatar
              if (currentProfile.photoUrl) {
                headerAvatar.innerHTML = '';
                const img = document.createElement('img');
                img.src = currentProfile.photoUrl;
                img.alt = (currentProfile.name || 'Profile').slice(0, 20);
                img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
                img.onerror = () => { headerAvatar.textContent = (currentProfile.name || initial).charAt(0).toUpperCase(); };
                headerAvatar.appendChild(img);
              } else {
                headerAvatar.textContent = (currentProfile.name || initial).charAt(0).toUpperCase();
              }
            } else {
              currentProfile = { slug, name: user.displayName || 'Anonymous', photoUrl: '' };
              headerAvatar.textContent = (user.displayName || initial).charAt(0).toUpperCase();
            }
          } else {
            currentProfile = { slug: null, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
            headerAvatar.textContent = (user.displayName || initial).charAt(0).toUpperCase();
          }
        } else {
          currentProfile = { slug: null, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
          headerAvatar.textContent = (user.displayName || initial).charAt(0).toUpperCase();
        }
      } catch (e) {
        console.warn('profile fetch err', e);
        currentProfile = { slug: null, name: user.displayName || 'Anonymous', photoUrl: user.photoURL || '' };
        headerAvatar.textContent = (user.displayName || 'U').charAt(0).toUpperCase();
      }

      // Enable send UI
      messageInput.disabled = false;
      sendButton.disabled = false;

      // start listeners
      setupRealtimeListener();
      setupTypingListener();
    });

    // Input events -> typing
    messageInput.addEventListener('input', () => {
      // start typing on any input
      startTypingLocal();
    });

    // Send events
    sendButton.addEventListener('click', () => sendMessage());
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // Clean up typing status on unload
    window.addEventListener('beforeunload', () => {
      try { if (currentProfile && currentProfile.slug) db.collection('communityTyping').doc(currentProfile.slug).set({ typing:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); } catch(e) {}
      if (typeof unsubscribeMessages === 'function') unsubscribeMessages();
      if (typeof unsubscribeTyping === 'function') unsubscribeTyping();
    });
  </script>
</body>
</html>