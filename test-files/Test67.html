<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SchoolMS - Admin & Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <style>
      .admin-section { margin-top: 20px; }
      .schedule-section { margin-top: 30px; border: 1px solid #dee2e6; padding: 20px; border-radius: 5px; }
      .period-row { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; position: relative; }
      .section-title { margin-top: 30px; margin-bottom: 15px; }
      .readonly-duration { background-color: #e9ecef; }
      .fees-table input { max-width: 150px; }
      .fees-table .form-select { max-width: 200px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SchoolMS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
          aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="admissions.html">Admissions</a></li>
            <li class="nav-item"><a class="nav-link" href="staff.html">Staff</a></li>
            <li class="nav-item"><a class="nav-link" href="attendance.html">Attendance</a></li>
            <li class="nav-item"><a class="nav-link" href="classes.html">Classes</a></li>
            <li class="nav-item"><a class="nav-link" href="exams.html">Exams</a></li>
            <li class="nav-item"><a class="nav-link" href="library.html">Library</a></li>
            <li class="nav-item"><a class="nav-link" href="transport.html">Transport</a></li>
            <li class="nav-item"><a class="nav-link" href="hostel.html">Hostel</a></li>
            <li class="nav-item"><a class="nav-link" href="communications.html">Communications</a></li>
            <li class="nav-item"><a class="nav-link" href="inventory.html">Inventory</a></li>
            <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
            <li class="nav-item active"><a class="nav-link" href="admin.html">Admin</a></li>
            <li class="nav-item"><a class="nav-link" href="reports.html">Reports</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container admin-section">
      <h2>Admin & Settings Dashboard</h2>
      <div class="row mb-4">
        <div class="col-md-6">
          <h4>System Settings</h4>
          <form id="settings-form">
            <div class="mb-3">
              <label for="school-name" class="form-label">School Name</label>
              <input type="text" class="form-control" id="school-name" required />
            </div>
            <div class="mb-3">
              <label for="academic-year" class="form-label">Academic Year</label>
              <input type="text" class="form-control" id="academic-year" required />
            </div>
            <div class="mb-3">
              <label for="contact-email" class="form-label">Contact Email</label>
              <input type="email" class="form-control" id="contact-email" required />
            </div>

            <div class="mb-3">
              <h5>Universal Fees Chart</h5>
              <table class="table table-bordered fees-table">
                <thead class="thead-light">
                  <tr>
                    <th>Class</th>
                    <th>Stream</th>
                    <th>Base Fee (â‚¹)</th>
                  </tr>
                </thead>
                <tbody id="fees-body">
                  <!-- Initial row -->
                  <tr>
                    <td><input type="number" class="form-control" data-field="class" required></td>
                    <td>
                      <select class="form-select" data-field="stream" required>
                        <option value="Science">Science</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Arts">Arts</option>
                      </select>
                    </td>
                    <td><input type="number" class="form-control" data-field="fee" required></td>
                  </tr>
                </tbody>
              </table>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addFeeRow()">Add Row</button>
            </div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
          </form>
          <div id="settings-status" class="mt-2"></div>
        </div>

        <div class="col-md-6">
          <!-- Existing user management content -->
        </div>
      </div>

      <div class="schedule-section">
        <h3 class="section-title">Attendance Schedule & Period Planner</h3>
        <form id="schedule-form">
          <h5>Attendance Sessions</h5>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="session1-start" class="form-label">Session 1 Start Time</label>
              <input type="time" class="form-control" id="session1-start" required />
            </div>
            <div class="col-md-4">
              <label for="session1-end" class="form-label">Session 1 End Time</label>
              <input type="time" class="form-control" id="session1-end" required />
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch mt-4">
                <input class="form-check-input" type="checkbox" id="session1-enabled" checked />
                <label class="form-check-label" for="session1-enabled">Enable Session 1</label>
              </div>
            </div>
          </div>

          <h5>Session Control Mode</h5>
          <div class="mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="session-control" id="auto-control" value="auto" checked>
              <label class="form-check-label" for="auto-control">Automatic</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="session-control" id="manual-control" value="manual">
              <label class="form-check-label" for="manual-control">Manual</label>
            </div>
          </div>

          <h5>Holiday Calendar</h5>
          <div class="mb-3">
            <label for="holiday-dates" class="form-label">Select Holidays</label>
            <input type="text" class="form-control" id="holiday-dates" placeholder="Select holidays" />
          </div>

          <h5>Period Schedule</h5>
          <div id="periods-container">
            <!-- Morning Session (4 periods) -->
            <div class="period-row" data-period="1">
              <h6>Period 1</h6>
              <div class="row">
                <div class="col-md-2">
                  <label class="form-label">Start Time</label>
                  <input type="time" class="form-control period-start" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">End Time</label>
                  <input type="time" class="form-control period-end" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Duration (min)</label>
                  <input type="number" class="form-control period-duration readonly-duration" readonly />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Teacher (ID)</label>
                  <select class="form-select period-teacher" required>
                    <option value="">Select Staff ID</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Subject</label>
                  <select class="form-select period-subject" required>
                    <option value="">Select Subject</option>
                    <!-- Subjects list remains same -->
                  </select>
                </div>
              </div>
            </div>
            <!-- Repeat similar structure for Periods 2-4 -->

            <!-- Mid-day Break -->
            <div class="period-row" data-period="midday">
              <h6>Mid-day Break</h6>
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">Duration (min)</label>
                  <input type="number" class="form-control" id="midday-duration" value="45" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Note</label>
                  <input type="text" class="form-control" value="Lunch Break" readonly />
                </div>
              </div>
            </div>

            <!-- Evening Session (4 periods) -->
            <!-- Repeat similar structure for Periods 5-8 -->
          </div>

          <h5>Bells & Special Timings</h5>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="first-bell" class="form-label">First Bell Time</label>
              <input type="time" class="form-control" id="first-bell" required />
            </div>
            <div class="col-md-4">
              <label for="second-bell" class="form-label">Second Bell Time</label>
              <input type="time" class="form-control" id="second-bell" required />
            </div>
            <div class="col-md-4">
              <label for="prayer-time" class="form-label">Prayer Time</label>
              <input type="time" class="form-control" id="prayer-time" required />
            </div>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Save Schedule</button>
        </form>
        <div id="schedule-status" class="mt-3"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Initialize Flatpickr
      flatpickr("#holiday-dates", { mode: "multiple", dateFormat: "Y-m-d" });

      // Fees Chart Functions
      function addFeeRow() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td><input type="number" class="form-control" data-field="class" required></td>
          <td>
            <select class="form-select" data-field="stream" required>
              <option value="Science">Science</option>
              <option value="Commerce">Commerce</option>
              <option value="Arts">Arts</option>
            </select>
          </td>
          <td><input type="number" class="form-control" data-field="fee" required></td>
        `;
        document.getElementById('fees-body').appendChild(newRow);
      }

      // Load Settings
      db.collection("001-school").doc("systemSettings").get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("school-name").value = data.schoolName || '';
          document.getElementById("academic-year").value = data.academicYear || '';
          document.getElementById("contact-email").value = data.contactEmail || '';
          
          // Load Fees Chart
          if(data.feesChart) {
            const feesBody = document.getElementById('fees-body');
            feesBody.innerHTML = '';
            data.feesChart.forEach(fee => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td><input type="number" class="form-control" data-field="class" value="${fee.class}" required></td>
                <td>
                  <select class="form-select" data-field="stream" required>
                    ${['Science','Commerce','Arts'].map(opt => 
                      `<option value="${opt}" ${opt === fee.stream ? 'selected' : ''}>${opt}</option>`
                    ).join('')}
                  </select>
                </td>
                <td><input type="number" class="form-control" data-field="fee" value="${fee.fee}" required></td>
              `;
              feesBody.appendChild(row);
            });
          }
        }
      });

      // Save Settings
      document.getElementById("settings-form").addEventListener("submit", function(e) {
        e.preventDefault();
        
        const feesData = [];
        document.querySelectorAll('#fees-body tr').forEach(row => {
          feesData.push({
            class: row.querySelector('[data-field="class"]').value,
            stream: row.querySelector('[data-field="stream"]').value,
            fee: row.querySelector('[data-field="fee"]').value
          });
        });

        const settingsData = {
          schoolName: document.getElementById("school-name").value.trim(),
          academicYear: document.getElementById("academic-year").value.trim(),
          contactEmail: document.getElementById("contact-email").value.trim(),
          feesChart: feesData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("001-school").doc("systemSettings").set(settingsData)
          .then(() => {
            document.getElementById("settings-status").innerText = "Settings saved successfully!";
            setTimeout(() => document.getElementById("settings-status").innerText = '', 3000);
          })
          .catch(err => {
            console.error("Error saving settings:", err);
            document.getElementById("settings-status").innerText = "Error saving settings.";
          });
      });

      // Rest of the schedule-related JavaScript remains unchanged
      // (period management, teacher dropdowns, schedule saving/loading)
      
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>