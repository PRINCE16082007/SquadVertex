<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SchoolMS - Admissions</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Skeleton screen styling */
      .skeleton {
        height: 1.2em;
        width: 100%;
        background-color: #e2e2e2;
        margin-bottom: 0.5em;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: -100%; }
        100% { background-position: 100%; }
      }
      /* Word count styling for remarks */
      .word-count {
        font-size: 0.9em;
        color: #555;
      }
      .form-section {
        margin-top: 20px;
      }
      .nav-btns {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
     <!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">SchoolMS</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarContent"
      aria-controls="navbarContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="admissions.html">Admissions</a></li>
        <li class="nav-item"><a class="nav-link" href="staff.html">Staff</a></li>
        <li class="nav-item active"><a class="nav-link" href="attendance.html">Attendance</a></li>
        <li class="nav-item"><a class="nav-link" href="classes.html">Classes</a></li>
        <li class="nav-item"><a class="nav-link" href="exams.html">Exams</a></li>
        <li class="nav-item"><a class="nav-link" href="library.html">Library</a></li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
            Transport <span class="bi bi-lock"></span>
          </a>
        </li>
        <li class="nav-item"><a class="nav-link" href="hostel.html">Hostel</a></li>
        <li class="nav-item"><a class="nav-link" href="communications.html">Communications</a></li>
        <li class="nav-item"><a class="nav-link" href="inventory.html">Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="admin.html">Admin</a></li>
        <li class="nav-item"><a class="nav-link" href="reports.html">Reports</a></li>
      </ul>
    </div>
  </div>
</nav>

    <!-- Admission Form Section -->
    <div class="container form-section">
      <h2 class="mb-4">New Student Admission</h2>
      <form id="admission-form">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="student-name" class="form-label">Student Name</label>
            <input type="text" class="form-control" id="student-name" required />
          </div>
          <div class="col-md-6">
            <label for="gender" class="form-label">Gender</label>
            <select class="form-select" id="gender" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <!-- Guardian and Parent Info -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="father-name" class="form-label">Father's Name</label>
            <input type="text" class="form-control" id="father-name" required />
          </div>
          <div class="col-md-6">
            <label for="guardian-name" class="form-label">Mother/Guardian Name</label>
            <input type="text" class="form-control" id="guardian-name" required />
          </div>
        </div>
        <!-- DOB and Class -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="dob" class="form-label">Date of Birth</label>
            <input type="date" class="form-control" id="dob" required />
          </div>
          <div class="col-md-6">
            <label for="class" class="form-label">Class</label>
            <select class="form-select" id="class" required>
              <option value="">Select Class</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>
          </div>
        </div>
        <!-- Subjects Multi-select Dropdown -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="subjects" class="form-label">Subjects</label>
            <select class="form-select" id="subjects" multiple required>
              <option value="Math">Math</option>
              <option value="Science">Science</option>
              <option value="English">English</option>
              <option value="Social Studies">Social Studies</option>
              <option value="History">History</option>
              <option value="Geography">Geography</option>
              <option value="Computer Science">Computer Science</option>
              <option value="Physical Education">Physical Education</option>
              <option value="Economics">Economics</option>
              <option value="Biology">Biology</option>
              <option value="Nothing">Nothing</option>
              <option value="Sanskrit">Sanskrit</option>
              <option value="Punjabi">Punjabi</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="contact" class="form-label">Contact Number</label>
            <input type="tel" class="form-control" id="contact" required />
          </div>
        </div>
        <!-- Stream Drop-down -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="stream" class="form-label">Stream</label>
            <select class="form-select" id="stream" required>
              <option value="">Select Stream</option>
              <option value="Arts">Arts</option>
              <option value="Commerce">Commerce</option>
              <option value="Science">Science</option>
              <option value="Nothing">Nothing</option>
            </select>
          </div>
        </div>
        <!-- New Checkbox for Admission Fee -->
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="admission-fee-checkbox" required>
          <label class="form-check-label" for="admission-fee-checkbox">Admission Fee (â‚¹500) Paid?</label>
        </div>
        <!-- Remarks -->
        <div class="mb-3">
          <label for="remarks" class="form-label">Remarks</label>
          <textarea class="form-control" id="remarks" rows="3" placeholder="Max 50 words"></textarea>
          <div class="word-count" id="word-count">0/50 words</div>
        </div>
        <!-- SR Number Field -->
        <div class="mb-3">
          <label for="sr-number" class="form-label">SR Number</label>
          <input type="number" class="form-control" id="sr-number" placeholder="Enter SR number (e.g., 5 or 6195)" required />
          <div class="form-text">
            This SR number will be used to generate the student document ID in the format: studentXXXXX.
          </div>
        </div>
        <!-- Optional PDF Upload -->
        <div class="mb-3">
          <label for="pdf-upload" class="form-label">Upload Documents (PDF) (Optional)</label>
          <input type="file" class="form-control" id="pdf-upload" accept="application/pdf" />
        </div>
        <!-- Hidden Timestamp -->
        <input type="hidden" id="timestamp" />
        <button type="submit" class="btn btn-primary">Submit Admission</button>
      </form>
    </div>

    <!-- Recent Admission Requests Section -->
    <div class="container form-section">
      <h2 class="mt-5">Recent Admission Requests</h2>
      <!-- Skeleton placeholder -->
      <div id="requests-loading">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
      <!-- Requests Table -->
      <div class="table-responsive d-none" id="requests-table-container">
        <table class="table table-striped" id="requests-table">
          <thead class="table-dark">
            <tr>
              <th>Request ID</th>
              <th>Student Name</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data populated from Firebase ("admission_requests" collection) -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Recent Admissions Section with Quick Search -->
    <div class="container form-section">
      <h2 class="mt-5">Recent Admissions</h2>
      <input
        type="text"
        id="admissions-search"
        class="form-control mb-3"
        placeholder="Quick Search by Student Name"
      />
      <!-- Skeleton placeholder -->
      <div id="admissions-loading">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
      <!-- Admissions Table -->
      <div class="table-responsive d-none" id="admissions-table-container">
        <table class="table table-striped" id="admissions-table">
          <thead class="table-dark">
            <tr>
              <th>SR No</th>
              <th>Student Name</th>
              <th>Gender</th>
              <th>Father's Name</th>
              <th>Guardian Name</th>
              <th>DOB</th>
              <th>Class</th>
              <th>Stream</th>
              <th>Contact</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data populated from Firebase ("001-school/students/list" subcollection) -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="container nav-btns">
      <button class="btn btn-secondary me-2" onclick="location.href='edit_students.html'">
        Edit Student Data
      </button>
      <button class="btn btn-info me-2" onclick="location.href='recent_requests.html'">
        View All Recent Requests
      </button>
      <button class="btn btn-outline-dark" onclick="location.href='index.html'">
        Home Dashboard
      </button>
    </div>

    <!-- Admission Module Instructions -->
    <div class="container form-section">
      <h3>Admission Module Instructions</h3>
      <ul>
        <li>This page is strictly for use by authorized admin and admissions staff.</li>
        <li>Please ensure that all student details are entered accurately; all required fields must be completed.</li>
        <li>The Subjects field allows multiple selections. Use Ctrl (or Cmd on Mac) to select more than one subject. Options include Math, Science, English, Social Studies, History, Geography, Computer Science, Physical Education, Economics, Biology, Nothing, Sanskrit, and Punjabi.</li>
        <li>The Stream field offers the following options: Arts, Commerce, Science, and Nothing. Please choose the option that best describes the studentâ€™s academic focus.</li>
        <li>The SR Number is used to generate the unique student document ID (for example, SR 5 becomes student00005). Ensure you enter the correct number.</li>
        <li>An automatic timestamp is recorded upon submission.</li>
        <li>Please confirm that the â‚¹500 admission fee has been received by checking the Admission Fee Checkbox before submitting the form.</li>
        <li>Recent Admission Requests are fetched from the "admission_requests" collection, and Recent Admissions are dynamically loaded from the "001-school/students/list" subcollection with quick search functionality.</li>
        <li>All data management and updates in this module are the responsibility of the designated administrative staff.</li>
      </ul>
    </div>

    <!-- Footer Note -->
    <footer class="container my-4">
      <p class="text-center">
        Note: All changes and updates to this module are managed solely by the admin.
      </p>
    </footer>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();

      // Utility: Generate student document ID using SR number (padded to 5 digits)
      function generateStudentDocId(srNumber) {
        return "student" + srNumber.toString().padStart(5, "0");
      }

      // Load Recent Admission Requests
      function loadAdmissionRequests() {
        const requestsTableBody = document.querySelector("#requests-table tbody");
        requestsTableBody.innerHTML = "";
        db.collection("admission_requests")
          .orderBy("timestamp", "desc")
          .limit(5)
          .get()
          .then((snapshot) => {
            snapshot.forEach((doc) => {
              const data = doc.data();
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${doc.id}</td>
                              <td>${data.studentName || ""}</td>
                              <td>${
                                data.timestamp
                                  ? new Date(data.timestamp.seconds * 1000).toLocaleString()
                                  : ""
                              }</td>
                              <td>${data.status || "Pending"}</td>`;
              requestsTableBody.appendChild(tr);
            });
            document.getElementById("requests-loading").classList.add("d-none");
            document.getElementById("requests-table-container").classList.remove("d-none");
          })
          .catch((err) => {
            console.error("Error fetching admission requests: ", err);
          });
      }

      // Load Recent Admissions from "001-school/students/list"
      function loadRecentAdmissions() {
        const admissionsTableBody = document.querySelector("#admissions-table tbody");
        admissionsTableBody.innerHTML = "";
        db.collection("001-school")
          .doc("students")
          .collection("list")
          .orderBy("timestamp", "desc")
          .limit(5)
          .get()
          .then((snapshot) => {
            snapshot.forEach((doc) => {
              const data = doc.data();
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${data.srNumber || ""}</td>
                              <td>${data.studentName || ""}</td>
                              <td>${data.gender || ""}</td>
                              <td>${data.fatherName || ""}</td>
                              <td>${data.guardianName || ""}</td>
                              <td>${data.dob || ""}</td>
                              <td>${data.class || ""}</td>
                              <td>${data.stream || ""}</td>
                              <td>${data.contact || ""}</td>
                              <td>${
                                data.timestamp
                                  ? new Date(data.timestamp.seconds * 1000).toLocaleString()
                                  : ""
                              }</td>`;
              admissionsTableBody.appendChild(tr);
            });
            document.getElementById("admissions-loading").classList.add("d-none");
            document.getElementById("admissions-table-container").classList.remove("d-none");
          })
          .catch((err) => {
            console.error("Error fetching recent admissions: ", err);
          });
      }
      // Quick search for Recent Admissions
      document.getElementById("admissions-search").addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#admissions-table tbody tr");
        rows.forEach((row) => {
          const studentName = row.cells[1].textContent.toLowerCase();
          row.style.display = studentName.indexOf(filter) > -1 ? "" : "none";
        });
      });

      // Load data on DOMContentLoaded
      window.addEventListener("DOMContentLoaded", function () {
        loadAdmissionRequests();
        loadRecentAdmissions();
      });
    </script>

    <!-- Admission Form Submission & Word Count -->
    <script>
      // Word count for remarks
      const remarksInput = document.getElementById("remarks");
      const wordCountDisplay = document.getElementById("word-count");
      remarksInput.addEventListener("input", function () {
        const words = this.value.trim().split(/\s+/).filter(Boolean);
        wordCountDisplay.innerText = words.length + "/50 words";
        if (words.length > 50) {
          remarksInput.value = words.slice(0, 50).join(" ");
          wordCountDisplay.innerText = "50/50 words";
        }
      });

      // Admission form submission
      document.getElementById("admission-form").addEventListener("submit", function (e) {
        e.preventDefault();
        // Check if the admission fee checkbox is checked
        const feePaid = document.getElementById("admission-fee-checkbox").checked;
        if (!feePaid) {
          alert("Admission fee of â‚¹500 has not been paid. Please confirm payment before submitting admission.");
          return;
        }
        if (!confirm("Are you sure you want to submit this admission?")) {
          return;
        }
        // Set current timestamp as ISO string
        const now = new Date();
        document.getElementById("timestamp").value = now.toISOString();

        // Retrieve form values
        const studentName = document.getElementById("student-name").value.trim();
        const gender = document.getElementById("gender").value;
        const fatherName = document.getElementById("father-name").value.trim();
        const guardianName = document.getElementById("guardian-name").value.trim();
        const dob = document.getElementById("dob").value;
        const sClass = document.getElementById("class").value;
        // Retrieve subjects from multi-select
        const subjectsSelect = document.getElementById("subjects");
        let subjects = [];
        for (const option of subjectsSelect.options) {
          if (option.selected) {
            subjects.push(option.value);
          }
        }
        const contact = document.getElementById("contact").value.trim();
        const remarks = document.getElementById("remarks").value.trim();
        const srNumber = document.getElementById("sr-number").value.trim();
        if (!srNumber) {
          alert("SR Number is required.");
          return;
        }
        const docId = generateStudentDocId(srNumber);
        // Create student document data with admission fee field
        const studentData = {
          studentName,
          gender,
          fatherName,
          guardianName,
          dob,
          class: sClass,
          subjects,
          stream: document.getElementById("stream").value,
          contact,
          remarks,
          srNumber,
          admissionFeeStatus: "Done", // since fee checkbox is checked
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("001-school")
          .doc("students")
          .collection("list")
          .doc(docId)
          .set(studentData)
          .then(() => {
            alert("Admission submitted successfully!");
            document.getElementById("admission-form").reset();
            wordCountDisplay.innerText = "0/50 words";
          })
          .catch((error) => {
            console.error("Error submitting admission: ", error);
            alert("Error submitting admission. Please try again.");
          });
      });
    </script>
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>