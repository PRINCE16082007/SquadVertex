<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom PDF Editor</title>
<style>
  body, html { margin: 0; padding: 0; height: 100%; }
  #pdf-container { position: relative; width: 100vw; height: 90vh; overflow: auto; border: 1px solid #ccc; }
  canvas { display: block; margin: 0 auto; }
  .editable-text {
    position: absolute;
    border: 1px dashed grey;
    background: rgba(255,255,255,0.8);
    min-width: 100px;
    min-height: 30px;
    padding: 4px;
    cursor: text;
    white-space: pre-wrap;
    overflow-wrap: break-word;
    font-family: Arial, sans-serif;
  }
  .resizable-image {
    position: absolute;
    border: 1px solid blue;
    cursor: move;
    user-select: none;
  }
  #tools { padding: 10px; background: #eee; display: flex; gap: 10px; }
</style>
</head>
<body>

<div id="tools">
  <input type="file" id="file-upload" accept="application/pdf" />
  <button id="add-text-btn">Add Text</button>
  <input type="file" id="image-upload" accept="image/*" />
  <button id="save-pdf-btn">Save PDF</button>
  <button id="undo-btn">Undo</button>
  <button id="redo-btn">Redo</button>
</div>

<div id="pdf-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.19.0/pdf-lib.min.js"></script>
<script>
  // Setup PDF.js
  const pdfContainer = document.getElementById('pdf-container');
  let pdfDoc = null;
  let currentScale = 1.5;
  let pageElements = [];
  let editableElements = [];
  let undoStack = [];
  let redoStack = [];

  // Load PDF on file upload
  document.getElementById('file-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const arrayBuffer = await file.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    renderPages();
    clearUndoRedo();
  });

  // Render all pages as canvas
  async function renderPages() {
    pdfContainer.innerHTML = '';
    pageElements = [];
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const page = await pdfDoc.getPage(i);
      const viewport = page.getViewport({scale: currentScale});
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const context = canvas.getContext('2d');
      await page.render({canvasContext: context, viewport: viewport}).promise;

      const pageWrapper = document.createElement('div');
      pageWrapper.style.position = 'relative';
      pageWrapper.style.width = viewport.width + 'px';
      pageWrapper.style.height = viewport.height + 'px';
      pageWrapper.appendChild(canvas);
      pdfContainer.appendChild(pageWrapper);
      pageElements.push(pageWrapper);
    }
  }

  // Add editable text
  document.getElementById('add-text-btn').addEventListener('click', () => {
    if (!pdfDoc) return alert('Upload a PDF first');
    // Add text to first page for demo; can add on any page with coordinates
    const editable = document.createElement('div');
    editable.contentEditable = true;
    editable.className = 'editable-text';
    editable.style.top = '50px';
    editable.style.left = '50px';
    editable.style.fontSize = '16px';
    editable.innerText = 'Editable text here';
    pageElements[0].appendChild(editable);
    makeDraggableAndResizable(editable);
    editableElements.push(editable);
    pushUndoState();
  });

  // Add image upload
  document.getElementById('image-upload').addEventListener('change', (e) => {
    if (!pdfDoc) return alert('Upload a PDF first');
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const img = document.createElement('img');
    img.src = url;
    img.className = 'resizable-image';
    img.style.top = '100px';
    img.style.left = '100px';
    img.style.width = '100px';
    img.style.height = '100px';
    img.style.position = 'absolute';
    pageElements[0].appendChild(img);
    makeDraggableAndResizable(img);
    editableElements.push(img);
    pushUndoState();
  });

  // Simple drag and resize
  function makeDraggableAndResizable(el) {
    el.style.position = 'absolute';
    let isDragging = false;
    let startX, startY, origX, origY;
    el.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = el.offsetLeft;
      origY = el.offsetTop;
      e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (isDragging) {
        let dx = e.clientX - startX;
        let dy = e.clientY - startY;
        el.style.left = origX + dx + 'px';
        el.style.top = origY + dy + 'px';
      }
    });
    document.addEventListener('mouseup', e => {
      if (isDragging) {
        isDragging = false;
        pushUndoState();
      }
    });

    // Resize with ctrl+drag bottom-right corner (simplified)
    el.addEventListener('dblclick', e => {
      if (el.style.width && el.style.height) {
        // Toggle size for demo
        el.style.width = el.style.width === '100px' ? '150px' : '100px';
        el.style.height = el.style.height === '100px' ? '150px' : '100px';
        pushUndoState();
      }
    });
  }

  // Undo/Redo state management
  function pushUndoState() {
    redoStack = [];
    const state = pdfContainer.innerHTML;
    undoStack.push(state);
    if (undoStack.length > 20) undoStack.shift();
  }

  document.getElementById('undo-btn').addEventListener('click', () => {
    if (undoStack.length < 2) return;
    redoStack.push(undoStack.pop());
    const lastState = undoStack[undoStack.length - 1];
    pdfContainer.innerHTML = lastState;
    // Restore editable references (simplified)
  });

  document.getElementById('redo-btn').addEventListener('click', () => {
    if (!redoStack.length) return;
    const nextState = redoStack.pop();
    pdfContainer.innerHTML = nextState;
  });

  function clearUndoRedo() {
    undoStack = [];
    redoStack = [];
    pushUndoState();
  }

  // Save edited PDF - simplistic example with pdf-lib to insert text/images is complex,
  // this is a placeholder to illustrate intent.
  document.getElementById('save-pdf-btn').addEventListener('click', async () => {
    if (!pdfDoc) return alert('Upload a PDF first');
    alert('Saving PDF with edits is complex and requires embedding changes with pdf-lib, which needs custom coding.');
    // Full save/export implementation involves mapping HTML edits to PDF-lib API calls for text and image embedding.
  });
</script>

</body>
</html>