<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TeamGalaxy Portfolio Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.06);
            --glass-border: 1px solid rgba(255, 255, 255, 0.12);
            --hover-glow: 0 0 24px rgba(102, 126, 234, 0.35);
            --panel-bg: #1e1e1e;
            --muted: rgba(255,255,255,0.75);
            --accent: linear-gradient(45deg,#ff6b6b,#4ecdc4);
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        html,body { height:100%; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: white;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width:1400px; margin:0 auto; }

        .header { text-align:center; margin-bottom:40px; animation: fadeIn 0.8s ease-in-out; }
        .header h1 { font-size:2.6rem; margin-bottom:8px; background: var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-shadow: 0 2px 10px rgba(0,0,0,0.12); }
        .header p { font-size:1.05rem; opacity:0.95; }

        .controls { display:flex; gap:20px; justify-content:center; align-items:center; margin-bottom:30px; flex-wrap:wrap; }

        .upload-section {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 20px;
            text-align:center;
            min-width: 420px;
        }

        .file-input-wrapper {
            position: relative; display:inline-block; cursor:pointer;
            background: rgba(255,255,255,0.02); padding: 16px 26px; border-radius: 50px;
            transition: all 0.22s ease; border: 2px dashed rgba(255,255,255,0.06); margin-bottom:12px;
        }
        .file-input-wrapper:hover { transform: translateY(-4px); box-shadow: var(--hover-glow); background: rgba(255,255,255,0.04); }
        .file-input { position:absolute; opacity:0; width:100%; height:100%; left:0; top:0; cursor:pointer; }

        .upload-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none; padding: 10px 22px; border-radius: 18px; color: white; font-size:15px; cursor:pointer;
            display:inline-flex; align-items:center; gap:8px; transition: transform .18s;
        }
        .upload-btn:hover { transform: translateY(-3px); box-shadow: var(--hover-glow); }

        .category-filter {
            background: rgba(255,255,255,0.04); border: var(--glass-border); border-radius: 25px; padding:8px 12px; color:white;
        }

        .loading { text-align:center; padding:12px; font-size:14px; display:none; }
        .loading.active { display:block; }

        .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:22px; margin-top: 22px; }

        .image-card {
            background: var(--card-bg); backdrop-filter: blur(8px); border: var(--glass-border); border-radius:12px; overflow:hidden;
            transition: all .28s; animation: fadeInUp .5s ease-out; position:relative;
        }
        .image-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--hover-glow); }

        .image-preview { width:100%; height:220px; object-fit:cover; display:block; background:#2b2b2b; }

        .image-info { padding:14px; }
        .image-title { font-weight:bold; font-size:15px; margin-bottom:6px; color:#fff; }
        .image-description { font-size:13px; color: rgba(255,255,255,0.75); margin-bottom:10px; min-height:36px; }
        .image-meta { font-size:12px; color: rgba(255,255,255,0.6); margin-bottom:8px; }

        .image-actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
        .action-btn { background: rgba(255,255,255,0.03); border: var(--glass-border); color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:13px; transition: all .18s; }
        .action-btn:hover { transform: translateY(-3px); background: rgba(255,255,255,0.06); }

        .rocket-shimmer { display:inline-block; animation: shimmer 2s infinite; }

        @keyframes shimmer { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
        @keyframes fadeIn { from{opacity:0; transform: translateY(-8px)} to{opacity:1; transform:none} }
        @keyframes fadeInUp { from{opacity:0; transform: translateY(20px)} to{opacity:1; transform:none} }

        .footer { text-align:center; margin-top:40px; padding:20px; font-size:14px; color: rgba(255,255,255,0.7); }

        .stats { display:flex; justify-content:center; gap:22px; margin-bottom:20px; flex-wrap:wrap; }
        .stat-card { background: var(--card-bg); backdrop-filter: blur(8px); border: var(--glass-border); border-radius: 12px; padding:12px 18px; min-width:120px; text-align:center; }
        .stat-number { font-size:1.6rem; font-weight:700; background: var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .stat-label { font-size:.9rem; color:rgba(255,255,255,0.8) }

        .preview-container { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:12px; }
        .preview-item { width:96px; height:96px; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.06); position:relative; display:flex; align-items:center; justify-content:center; background:#222; }
        .preview-item img { width:100%; height:100%; object-fit:cover; display:block; }
        .preview-item .file-name { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.6); color:#fff; font-size:10px; padding:2px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        /* Console Panel styles (improved) */
        #console-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 240px;
            background: var(--panel-bg);
            color: #d4d4d4;
            font-family: 'Consolas','Monaco','Courier New', monospace;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            border-top: 2px solid #2b2b2b;
            box-shadow: 0 -6px 30px rgba(0,0,0,0.6);
            font-size: 12px;
        }
        #console-header {
            padding: 8px 12px; background: #232323; display:flex; align-items:center; gap:12px; border-bottom:1px solid #2b2b2b;
        }
        #console-header .title { font-weight:700; color:#fff; font-size:13px; margin-right:auto; }
        #console-controls { display:flex; gap:8px; align-items:center; }
        #console-controls button, #console-controls select {
            background:#2f2f2f; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:12px;
        }
        #console-controls button:hover { transform:translateY(-2px); }
        #console-body { flex:1; display:flex; gap:12px; }
        #console-content {
            flex:1; padding:10px; overflow-y:auto; white-space:pre-wrap; word-break:break-word;
            border-right:1px solid #292929;
        }
        #console-sidebar {
            width:240px; padding:10px; background:#1b1b1b; border-left:1px solid #292929;
        }
        .log-entry { padding:6px 6px; border-bottom:1px dashed rgba(255,255,255,0.03); font-size:12px; }
        .log-ts { color:#9aa7d6; margin-right:6px; font-size:11px; }
        .log-level-log { color:#d4d4d4; }
        .log-level-info { color:#6aa0ff; }
        .log-level-success { color:#7ed081; }
        .log-level-warning { color:#e3c07a; }
        .log-level-error { color:#f28b7b; }

        .console-filter { display:flex; gap:6px; flex-direction:column; }
        .console-filter label { font-size:12px; color: #bbb; margin-bottom:6px; }

        .small-muted { font-size:12px; color: #9aa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-rocket"></i> TeamGalaxy Portfolio Manager</h1>
            <p>Manage your portfolio images with realtime updates ‚Äî built for creators.</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalImages">0</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="publicImages">0</div>
                <div class="stat-label">Public</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="storageUsed">0 MB</div>
                <div class="stat-label">Storage</div>
            </div>
        </div>

        <div class="controls">
            <div class="upload-section">
                <div class="file-input-wrapper" title="Click to pick images or drag & drop (supported)">
                    <input type="file" id="imageUpload" class="file-input" accept="image/*" multiple>
                    <span><i class="fas fa-cloud-upload-alt"></i> Select Images</span>
                </div>
                <button id="uploadBtn" class="upload-btn">
                    <i class="fas fa-upload"></i> Upload to Portfolio
                </button>
                <div id="previewContainer" class="preview-container"></div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px;align-items:center;">
                <select class="category-filter" id="categoryFilter">
                    <option value="all">All Categories</option>
                    <option value="web-design">Web Design</option>
                    <option value="ui-ux">UI/UX</option>
                    <option value="photography">Photography</option>
                    <option value="illustration">Illustration</option>
                </select>
                <div class="small-muted">Upload will be sent to a Cloudflare Worker (server-side)</div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i> Uploading to Dropbox... <span class="rocket-shimmer">üöÄ</span>
        </div>

        <div class="gallery" id="portfolioGallery"></div>
    </div>

    <div id="console-panel">
      <div id="console-header">
        <div class="title">Debug Console</div>
        <div id="console-controls">
          <select id="console-level">
            <option value="all">All</option>
            <option value="log">Log</option>
            <option value="info">Info</option>
            <option value="success">Success</option>
            <option value="warning">Warning</option>
            <option value="error">Error</option>
          </select>
          <button id="clear-console"><i class="fas fa-trash"></i> Clear</button>
          <button id="download-console"><i class="fas fa-download"></i> Export</button>
          <button id="toggle-console">Hide</button>
        </div>
      </div>

      <div id="console-body">
        <div id="console-content" aria-live="polite"></div>
        <div id="console-sidebar">
          <div style="margin-bottom:10px"><strong class="small-muted">Console Controls</strong></div>
          <div class="console-filter">
            <label class="small-muted">Filter level (panel only)</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="filter-btn" data-level="all">All</button>
              <button class="filter-btn" data-level="log">Log</button>
              <button class="filter-btn" data-level="info">Info</button>
              <button class="filter-btn" data-level="success">Success</button>
              <button class="filter-btn" data-level="warning">Warn</button>
              <button class="filter-btn" data-level="error">Error</button>
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="small-muted">Shortcuts</div>
            <div style="font-size:12px;margin-top:6px;color:#9aa">Ctrl + ` ‚Äî toggle panel</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
        <p>TeamGalaxy Portfolio Manager <span class="rocket-shimmer">üöÄ</span> | Built with ‚ù§Ô∏è for creators</p>
    </div>

    <!-- Firebase compat libs v11.9.0 (matching other file) -->
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-storage-compat.js"></script>

    <script>
    // CONFIG - change Cloudflare worker URL if needed
    const CLOUDFLARE_WORKER_URL = 'https://portfolio-dropbox-handler.teamgalaxy-interactive.workers.dev/';

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
        authDomain: "teamgalaxy-77344.firebaseapp.com",
        projectId: "teamgalaxy-77344",
        storageBucket: "teamgalaxy-77344.firebasestorage.app",
        messagingSenderId: "770256225320",
        appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
        measurementId: "G-6C2W9NSNCH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ========= APP LOGGING (use this internally) =========
    // appLog writes to native console + to console panel UI
    const appLog = {
      log: (msg) => { console.log(msg); consolePanelLog(msg, 'log'); },
      info: (msg) => { console.info(msg); consolePanelLog(msg, 'info'); },
      success: (msg) => { console.info(msg); consolePanelLog(msg, 'success'); },
      warning: (msg) => { console.warn(msg); consolePanelLog(msg, 'warning'); },
      error: (msg) => { console.error(msg); consolePanelLog(msg, 'error'); }
    };

    // Expose for shorthand in dev
    window.appLog = appLog;

    // Helper: format bytes to human readable
    function formatFileSize(bytes) {
        if (bytes == null || Number.isNaN(bytes)) return '0 Bytes';
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes','KB','MB','GB'];
        const i = Math.floor(Math.log(Math.max(bytes,1)) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ========= MAIN APP BEHAVIOR =========
    document.addEventListener('DOMContentLoaded', () => {
      appLog.info('Portfolio Manager initialized');

      // Event listeners
      document.getElementById('uploadBtn').addEventListener('click', handleUpload);
      document.getElementById('imageUpload').addEventListener('change', handleFileSelect);
      document.getElementById('categoryFilter').addEventListener('change', filterByCategory);

      // Drag & drop support for file-input-wrapper
      const wrapper = document.querySelector('.file-input-wrapper');
      ;['dragenter','dragover'].forEach(ev => wrapper.addEventListener(ev, e => { e.preventDefault(); wrapper.classList.add('drag'); }));
      ;['dragleave','drop'].forEach(ev => wrapper.addEventListener(ev, e => { e.preventDefault(); wrapper.classList.remove('drag'); }));
      wrapper.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        const input = document.getElementById('imageUpload');
        input.files = files;
        input.dispatchEvent(new Event('change'));
      });

      // Load existing portfolio items
      loadPortfolioItems();
    });

    // Preview selected files
    function handleFileSelect(event) {
        const files = event.target.files;
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = ''; // Clear previous previews

        if (files && files.length > 0) {
            appLog.info(`${files.length} files selected: ${Array.from(files).map(f => f.name).join(', ')}`);

            // Update upload button text / title
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload ${files.length} File(s)`;
            uploadBtn.title = Array.from(files).map(f => f.name).join(', ');

            // Create previews and capture image size
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return; // only images

                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="file-name" title="${file.name}">${file.name}</div>
                    `;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        } else {
            document.getElementById('uploadBtn').innerHTML = `<i class="fas fa-upload"></i> Upload to Portfolio`;
            document.getElementById('uploadBtn').title = '';
        }
    }

    // Upload handler: staggered
    function handleUpload() {
        const fileInput = document.getElementById('imageUpload');
        const files = fileInput.files;

        if (!files || files.length === 0) {
            alert('Please select images to upload');
            return;
        }

        document.getElementById('loadingIndicator').classList.add('active');
        const arr = Array.from(files);

        const uploadPromises = arr.map((file, idx) => new Promise((resolve, reject) => {
            // staggered start to avoid burst; but not required
            setTimeout(async () => {
                try {
                    await uploadToCloudflareWorker(file);
                    resolve();
                } catch (err) {
                    reject(err);
                }
            }, idx * 700);
        }));

        Promise.allSettled(uploadPromises).then(results => {
            const failed = results.filter(r => r.status === 'rejected');
            if (failed.length) {
                appLog.error(`${failed.length} uploads failed`);
                alert(`${failed.length} upload(s) failed. Check console for details.`);
            } else {
                appLog.success('All uploads completed');
            }
            document.getElementById('loadingIndicator').classList.remove('active');
            // clear input & previews
            document.getElementById('imageUpload').value = '';
            document.getElementById('previewContainer').innerHTML = '';
        });
    }

    // Upload single file to worker and save metadata to Firestore
    async function uploadToCloudflareWorker(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('category', document.getElementById('categoryFilter').value || 'uncategorized');
        formData.append('title', file.name.replace(/\.[^/.]+$/, ""));
        formData.append('description', `Uploaded ${file.name}`);
        formData.append('isPublic', 'true');

        try {
            appLog.info(`Uploading ${file.name} to Cloudflare Worker...`);

            const resp = await fetch(`${CLOUDFLARE_WORKER_URL.replace(/\/$/, '')}/api/upload`, {
                method: 'POST',
                body: formData,
                mode: 'cors',
                credentials: 'omit'
            });

            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(`HTTP ${resp.status}: ${txt}`);
            }

            const result = await resp.json();

            if (!result || !result.success) {
                throw new Error(result?.error || 'Upload failed (no result)');
            }

            appLog.success(`Uploaded ${file.name} ‚Üí ${result.dropboxUrl || result.fileName}`);

            // Compose item data (server returns fileName, dropboxUrl, fileSize (bytes), fileType)
            const itemData = {
                fileName: result.fileName || file.name,
                originalName: file.name,
                fileSize: result.fileSize || file.size || 0,
                fileType: result.fileType || file.type,
                dropboxUrl: result.dropboxUrl || result.url || '',
                uploadDate: firebase.firestore.FieldValue.serverTimestamp ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
                lastModified: new Date(),
                category: document.getElementById('categoryFilter').value || 'uncategorized',
                title: file.name.replace(/\.[^/.]+$/, ""),
                description: `Uploaded ${file.name}`,
                isPublic: true,
                meta: { dimensions: null }
            };

            await addPortfolioItem(itemData);

        } catch (error) {
            appLog.error(`Upload error for ${file.name}: ${error.message}`);
            throw error;
        }
    }

    // Add item metadata to Firestore and gallery immediately
    async function addPortfolioItem(itemData) {
        try {
            const ref = await db.collection('portfolioItems').add(itemData);
            appLog.success(`Item saved to Firestore with id ${ref.id}`);

            const newItem = { id: ref.id, ...itemData };
            addToGallery(newItem);
            updateStats();
        } catch (err) {
            appLog.error(`Failed to add item to DB: ${err.message}`);
        }
    }

    // Load items from Firestore
    async function loadPortfolioItems() {
        try {
            appLog.info('Loading portfolio items from Firestore...');
            const snapshot = await db.collection('portfolioItems').orderBy('uploadDate','desc').get();
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            appLog.info(`Loaded ${items.length} items`);
            const gallery = document.getElementById('portfolioGallery');
            gallery.innerHTML = '';
            items.forEach(item => addToGallery(item));
            updateStats();
        } catch (err) {
            appLog.error(`Failed to load portfolio items: ${err.message}`);
            document.getElementById('loadingIndicator').classList.remove('active');
        } finally {
            document.getElementById('loadingIndicator').classList.remove('active');
        }
    }

    // Adds a single gallery card; also attempts to read real image dimensions on load and update DB
    function addToGallery(item) {
        const gallery = document.getElementById('portfolioGallery');
        const card = document.createElement('div');
        card.className = 'image-card';
        card.dataset.id = item.id;
        card.dataset.category = item.category || 'uncategorized';
        card.innerHTML = `
            <img src="${item.dropboxUrl || ''}" alt="${escapeHtml(item.title || item.originalName || '')}" class="image-preview" />
            <div class="image-info">
                <div class="image-title">${escapeHtml(item.title || item.originalName || '')}</div>
                <div class="image-description">${escapeHtml(item.description || '')}</div>
                <div class="image-meta">
                    Size: ${formatFileSize(item.fileSize || 0)} | ${item.meta?.dimensions ? `${item.meta.dimensions.width}√ó${item.meta.dimensions.height}` : 'Unknown dimensions'}
                </div>
                <div class="public-toggle">
                    <label style="margin-right:8px;color:#ddd">Public:</label>
                    <label class="toggle-switch">
                      <input type="checkbox" ${item.isPublic ? 'checked' : ''} onchange="togglePublicStatus('${item.id}', this.checked)">
                      <span class="slider"></span>
                    </label>
                </div>
                <div class="image-actions">
                    <button class="action-btn" onclick="copyToClipboard('${item.dropboxUrl || ''}')"><i class="fas fa-copy"></i> Copy URL</button>
                    <button class="action-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i> Delete</button>
                </div>
            </div>
        `;
        gallery.appendChild(card);

        // load image to get natural dimensions and update the meta if missing
        const img = card.querySelector('.image-preview');
        if (img && img.src) {
            img.addEventListener('load', async function() {
                try {
                    const w = img.naturalWidth;
                    const h = img.naturalHeight;
                    // Update display if missing
                    const meta = card.querySelector('.image-meta');
                    if (meta && (!item.meta || !item.meta.dimensions)) {
                        meta.innerText = `Size: ${formatFileSize(item.fileSize || 0)} | ${w}√ó${h}`;
                    }
                    // update firestore if dimensions missing
                    if (!item.meta || !item.meta.dimensions) {
                        await db.collection('portfolioItems').doc(item.id).update({ 'meta.dimensions': { width: w, height: h }, lastModified: new Date() });
                        appLog.info(`Updated dimensions for ${item.id} ‚Üí ${w}√ó${h}`);
                    }
                    updateStats();
                } catch (err) {
                    appLog.warning('Could not update image meta dims: ' + (err.message||err));
                }
            });
            img.addEventListener('error', function() {
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0i100%25IiBoZWlnaHQ9Ij100%25IiBmaWxsPSIj333Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlIEVycm9yPC90ZXh0Pjwvc3ZnPg==';
            });
        }
    }

    // CATEGORY FILTER
    function filterByCategory() {
        const filterValue = document.getElementById('categoryFilter').value;
        const cards = document.querySelectorAll('.image-card');
        cards.forEach(card => {
            if (filterValue === 'all') card.style.display = 'block';
            else card.style.display = (card.dataset.category === filterValue) ? 'block' : 'none';
        });
    }

    // UPDATE STATS (counts & storage)
    function updateStats() {
        const cards = document.querySelectorAll('.image-card');
        document.getElementById('totalImages').textContent = cards.length;

        const publicCount = Array.from(cards).filter(c => c.querySelector('input[type="checkbox"]')?.checked).length;
        document.getElementById('publicImages').textContent = publicCount;

        // Sum fileSize attributes from firestore data (displayed in meta)
        let totalMB = 0;
        cards.forEach(c => {
            const meta = c.querySelector('.image-meta')?.textContent || '';
            const match = meta.match(/Size:\s*([\d,.]+)\s*(MB|KB|GB|Bytes)/i);
            if (match) {
                const num = parseFloat(match[1].replace(/,/g,'')) || 0;
                const unit = match[2].toUpperCase();
                if (unit === 'MB') totalMB += num;
                else if (unit === 'KB') totalMB += num / 1024;
                else if (unit === 'GB') totalMB += num * 1024;
                else if (unit === 'BYTES') totalMB += num / (1024*1024);
            }
        });
        document.getElementById('storageUsed').textContent = `${totalMB.toFixed(2)} MB`;
    }

    // COPY TO CLIPBOARD
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text || '');
            alert('URL copied to clipboard!');
            appLog.success('Copied URL to clipboard');
        } catch (err) {
            appLog.error('Failed to copy: ' + (err.message||err));
        }
    }

    // TOGGLE PUBLIC
    async function togglePublicStatus(itemId, isPublic) {
        try {
            await db.collection('portfolioItems').doc(itemId).update({ isPublic: isPublic, lastModified: new Date() });
            appLog.success(`Public status updated for ${itemId} ‚Üí ${isPublic}`);
            updateStats();
        } catch (err) {
            appLog.error('Failed to update public status: ' + (err.message||err));
        }
    }

    // DELETE ITEM
    async function deleteItem(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        try {
            await db.collection('portfolioItems').doc(itemId).delete();
            const el = document.querySelector(`[data-id="${itemId}"]`);
            if (el) el.remove();
            appLog.success(`Deleted item ${itemId}`);
            updateStats();
        } catch (err) {
            appLog.error('Failed to delete item: ' + (err.message||err));
        }
    }

    // Helper: escape HTML for safer innerHTML usage
    function escapeHtml(s) {
        return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    </script>

    <!-- Console Panel JS (isolated + safe) -->
    <script>
    (function(){
      if (window.consolePanelInitialized) return;
      window.consolePanelInitialized = true;

      const panel = document.getElementById('console-panel');
      const content = document.getElementById('console-content');
      const clearBtn = document.getElementById('clear-console');
      const toggleBtn = document.getElementById('toggle-console');
      const downloadBtn = document.getElementById('download-console');
      const levelSelect = document.getElementById('console-level');
      const filterBtns = document.querySelectorAll('.filter-btn');
      let isVisible = true;
      let currentFilter = 'all';
      const logs = []; // store entries for export

      // Append entry function (exposed)
      window.consolePanelLog = function(message, level='log') {
        try {
          const ts = new Date();
          const entry = { ts: ts.toISOString(), level, message: (typeof message === 'string') ? message : JSON.stringify(message, null, 2) };
          logs.push(entry);

          if (currentFilter !== 'all' && currentFilter !== level) return; // skip render if filter active

          const div = document.createElement('div');
          div.className = 'log-entry';
          const time = ts.toLocaleTimeString();
          const levelCls = `log-level-${level}`;
          const levelLabel = `<span class="log-ts">[${time}]</span><span class="${levelCls}">${level.toUpperCase()}</span>: `;
          div.innerHTML = `${levelLabel} <span style="color:#ddd">${escapeHtml(entry.message)}</span>`;
          content.appendChild(div);
          content.scrollTop = content.scrollHeight;
        } catch (e) {
          // ignore UI errors
        }
      };

      // Wire native console to panel as well (and keep original)
      const orig = {
        log: console.log,
        info: console.info,
        warn: console.warn,
        error: console.error
      };
      console.log = function(...args){ orig.log.apply(console, args); window.consolePanelLog(args.join(' '), 'log'); };
      console.info = function(...args){ orig.info.apply(console, args); window.consolePanelLog(args.join(' '), 'info'); };
      console.warn = function(...args){ orig.warn.apply(console, args); window.consolePanelLog(args.join(' '), 'warning'); };
      console.error = function(...args){ orig.error.apply(console, args); window.consolePanelLog(args.join(' '), 'error'); };

      // Buttons
      clearBtn.onclick = () => {
        content.innerHTML = '';
        logs.length = 0;
      };
      toggleBtn.onclick = () => {
        isVisible = !isVisible;
        panel.style.display = isVisible ? 'flex' : 'none';
        toggleBtn.textContent = isVisible ? 'Hide' : 'Show';
      };

      downloadBtn.onclick = () => {
        try {
          const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `console-logs-${(new Date()).toISOString()}.json`; a.click();
          URL.revokeObjectURL(url);
        } catch (e) { console.error('Export failed', e); }
      };

      levelSelect.onchange = function(){ currentFilter = this.value; // re-render content
        content.innerHTML = '';
        logs.forEach(e => { if (currentFilter==='all' || e.level === currentFilter) window.consolePanelLog(e.message, e.level); });
      };

      filterBtns.forEach(btn => btn.addEventListener('click', function(){
        const lvl = this.dataset.level;
        currentFilter = lvl;
        levelSelect.value = lvl;
        content.innerHTML = '';
        logs.forEach(e => { if (lvl==='all' || e.level === lvl) window.consolePanelLog(e.message, e.level); });
      }));

      // Keyboard shortcut: Ctrl + `
      document.addEventListener('keydown', (ev) => {
        if (ev.ctrlKey && ev.key === '`') {
          toggleBtn.click();
        }
      });

      // Utility: escape HTML
      function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    })();
    </script>
</body>
</html>