<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set Up Your Event | SquadVertex</title>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Poppins', sans-serif; background:#fafafa; color:#333; line-height:1.6; }
    .container { max-width: 600px; margin: 3rem auto; padding: 0 1rem; }
    h1 { text-align:center; font-size:2.25rem; background: linear-gradient(90deg, #7e3af2, #c084fc); -webkit-background-clip: text; color: transparent; margin-bottom:1rem; }
    .info { background:#fff; padding:1rem; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.03); margin-bottom:1.5rem; }
    label { display:block; margin-top:1rem; font-weight:600; }
    input, select, textarea { width:100%; padding:0.6rem; margin-top:0.25rem; border:1px solid #ccc; border-radius:4px; }
    button { background:#7e3af2; color:#fff; border:none; padding:0.75rem 1.5rem; border-radius:6px; font-size:1rem; cursor:pointer; transition:transform 0.2s; margin-top:1rem; }
    button:hover { transform:scale(1.05); }
    #chat { display:none; margin-top:2rem; }
    #messages { max-height:300px; overflow-y:auto; background:#fff; padding:1rem; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .msg { margin-bottom:0.75rem; }
    .msg .author { font-weight:600; margin-bottom:0.25rem; }
    .msg .text { font-size:0.95rem; }
    .chat-input { display:flex; margin-top:1rem; }
    .chat-input input { flex:1; padding:0.6rem; border:1px solid #ccc; border-radius:4px; }
    .chat-input button { margin-left:0.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Set Up Your Event</h1>
    <div class="info">
      <p>Before we chat, tell us a bit about you. Once saved, you can’t change it.</p>
    </div>

    <form id="profileForm">
      <label for="name">Your Name</label>
      <input type="text" id="name" required />

      <label for="age">Your Age</label>
      <input type="number" id="age" min="13" required />

      <label for="ytName">YouTube Channel Name</label>
      <input type="text" id="ytName" required />

      <label for="ytLink">YouTube Channel Link</label>
      <input type="url" id="ytLink" placeholder="https://youtube.com/…" required />

      <label for="feesReady">Ready to pay event fees?</label>
      <select id="feesReady" required>
        <option value="">Select…</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>

      <button type="submit">Save & Start Chat</button>
    </form>

    <div id="chat">
      <div id="messages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Start typing your event idea…" />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const profileForm = document.getElementById("profileForm");
    const chatDiv = document.getElementById("chat");
    const messagesDiv = document.getElementById("messages");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    let userUid;

    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async user => {
      if (!user) return;
      userUid = user.uid;
      const profileRef = doc(db, "tickets", userUid);
      onSnapshot(profileRef, snap => {
        if (snap.exists()) {
          profileForm.style.display = "none";
          showChat();
        }
      });
    });

    profileForm.addEventListener("submit", async e => {
      e.preventDefault();
      const profileData = {
        name: document.getElementById("name").value.trim(),
        age: parseInt(document.getElementById("age").value),
        ytName: document.getElementById("ytName").value.trim(),
        ytLink: document.getElementById("ytLink").value.trim(),
        feesReady: document.getElementById("feesReady").value,
        createdAt: serverTimestamp()
      };
      await setDoc(doc(db, "tickets", userUid), profileData);
    });

    sendBtn.addEventListener("click", async () => {
      const text = chatInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "tickets", userUid, "messages"), {
        author: "Creator",
        text,
        timestamp: serverTimestamp()
      });
      chatInput.value = "";
    });

    function showChat() {
      chatDiv.style.display = "block";
      listenMessages();
    }

    function listenMessages() {
      const msgsRef = collection(db, "tickets", userUid, "messages");
      onSnapshot(msgsRef, snap => {
        messagesDiv.innerHTML = "";
        snap.docs
          .sort((a, b) => a.data().timestamp.toMillis() - b.data().timestamp.toMillis())
          .forEach(doc => {
            const { author, text } = doc.data();
            const el = document.createElement("div");
            el.className = "msg";
            el.innerHTML = `<div class="author">${author}</div><div class="text">${text}</div>`;
            messagesDiv.appendChild(el);
          });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }
  </script>
</body>
</html>