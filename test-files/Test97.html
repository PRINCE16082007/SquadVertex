<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set Up Your Event | SquadVertex</title>
  <style>
    /* Reset & base */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Poppins', sans-serif; background:#fafafa; color:#333; line-height:1.6; }
    a { color:#5b21b6; text-decoration:none; }

    /* Container */
    .container { max-width: 600px; margin: 3rem auto; padding: 0 1rem; }

    /* Hero */
    .hero { text-align:center; margin-bottom:2rem; }
    .hero h1 { font-size:2.25rem; background: linear-gradient(90deg, #7e3af2, #c084fc); -webkit-background-clip: text; color: transparent; }
    .hero p { font-size:1rem; opacity:0.8; margin-top:0.5rem; }

    /* Section titles */
    .section-title { font-size:1.5rem; margin:1.5rem 0 1rem; border-left:4px solid #7e3af2; padding-left:0.75rem; }

    /* Form */
    form { background:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    label { display:block; margin-bottom:0.5rem; font-weight:600; }
    input, textarea { width:100%; padding:0.6rem; margin-bottom:1rem; border:1px solid #ccc; border-radius:4px; }
    button { background:#7e3af2; color:#fff; border:none; padding:0.75rem 1.5rem; border-radius:6px; font-size:1rem; cursor:pointer; transition:transform 0.2s; }
    button:hover { transform:scale(1.05); }

    /* Chat */
    #chat { margin-top:2rem; }
    #messages { max-height:300px; overflow-y:auto; background:#fff; padding:1rem; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
    .msg { margin-bottom:0.75rem; }
    .msg .author { font-weight:600; margin-bottom:0.25rem; }
    .msg .text { font-size:0.95rem; }

    /* Hidden by default */
    #chat, #logoutBtn { display:none; }
    #logoutBtn { margin-top:1rem; background:#e11d48; }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero">
      <h1>Set Up Your Event</h1>
      <p>Tell us who you are, what you want, and we‚Äôll take it from there. üé¨</p>
    </section>

    <!-- Ticket Request Form -->
    <div id="requestSection">
      <h2 class="section-title">üìù Request an Event Ticket</h2>
      <form id="ticketForm">
        <label for="name">Your Name</label>
        <input type="text" id="name" required />

        <label for="email">Email Address</label>
        <input type="email" id="email" required />

        <label for="eventTitle">Event Title</label>
        <input type="text" id="eventTitle" required />

        <label for="message">Message / Requirements</label>
        <textarea id="message" rows="4" placeholder="Describe your video-flow, chat & voting needs‚Ä¶" required></textarea>

        <button type="submit">Submit Request</button>
      </form>
    </div>

    <!-- Chat / Ticket Conversation -->
    <div id="chat">
      <h2 class="section-title">üí¨ Your Ticket Chat</h2>
      <div id="messages"></div>
      <input type="text" id="chatInput" placeholder="Type a message‚Ä¶" />
      <button id="sendBtn">Send</button>
      <button id="logoutBtn">End Session</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc,
      onSnapshot, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

    // Firebase initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let ticketId, userUid;

    // 1Ô∏è‚É£ sign in anonymously
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, user => {
      if (!user) return;
      userUid = user.uid;
      const params = new URLSearchParams(location.search);
      ticketId = params.get("ticket") || null;

      if (ticketId) {
        showChat();
        listenMessages();
      } else {
        document.getElementById("requestSection").style.display = "block";
      }
    });

    // 2Ô∏è‚É£ handle ticket form submit
    document.getElementById("ticketForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const title = eventTitle.value.trim();
      const msg = message.value.trim();

      // create ticket doc
      const ticketRef = await addDoc(collection(db, "tickets"), {
        createdBy: userUid,
        name, email, title,
        createdAt: serverTimestamp()
      });
      ticketId = ticketRef.id;

      // initial message
      await addDoc(collection(db, "tickets", ticketId, "messages"), {
        author: name,
        text: msg,
        timestamp: serverTimestamp()
      });

      // redirect user to chat view
      location.search = `?ticket=${ticketId}`;
    });

    // 3Ô∏è‚É£ chat UI
    const messagesDiv = document.getElementById("messages");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    sendBtn.addEventListener("click", async () => {
      const text = chatInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "tickets", ticketId, "messages"), {
        author: "Creator",
        text,
        timestamp: serverTimestamp()
      });
      chatInput.value = "";
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => location.reload());
    });

    function showChat() {
      document.getElementById("requestSection").style.display = "none";
      document.getElementById("chat").style.display = "block";
      logoutBtn.style.display = "inline-block";
    }

    // 4Ô∏è‚É£ real-time listener
    function listenMessages() {
      const msgsCol = collection(db, "tickets", ticketId, "messages");
      onSnapshot(msgsCol, snap => {
        messagesDiv.innerHTML = "";
        snap.docs.sort((a,b) => a.data().timestamp - b.data().timestamp)
          .forEach(doc => {
            const { author, text } = doc.data();
            const el = document.createElement("div");
            el.classList.add("msg");
            el.innerHTML = `<div class="author">${author}</div><div class="text">${text}</div>`;
            messagesDiv.appendChild(el);
          });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }
  </script>
</body>
</html>

