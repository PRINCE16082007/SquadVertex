<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fee Management - Payments</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
      .table-responsive { overflow-x: auto; }
      body { overflow-x: hidden; }
      .vehicle-eligible-icon { font-size: 1.2em; margin-left: 5px; }
      .fee-summary { background: #f8f9fa; padding: 15px; border-radius: 5px; }
      .fee-summary h6 { border-bottom: 2px solid #dee2e6; padding-bottom: 5px; }
      .history-entry { padding: 5px 0; border-bottom: 1px solid #eee; }
      .month-pill { margin: 2px; padding: 5px 10px; border-radius: 20px; background: #e9ecef; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SchoolMS</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
            <li class="nav-item active"><a class="nav-link" href="fees.html">Fees</a></li>
            <!-- Other menu items unchanged -->
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <h3 class="mb-4">Fee Management</h3>
      <div class="row mb-3">
        <div class="col-md-3">
          <input type="text" id="student-search" class="form-control" placeholder="Search student...">
        </div>
        <div class="col-md-3">
          <select id="class-filter" class="form-control">
            <option value="">All Classes</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="fee-type-filter" class="form-control">
            <option value="">All Fee Types</option>
            <option value="school">School Fees</option>
            <option value="vehicle">Vehicle Fees</option>
          </select>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-bordered" id="students-table">
          <thead class="thead-dark">
            <tr>
              <th>SR No.</th>
              <th>Student Name</th>
              <th>Class</th>
              <th>Total Fees</th>
              <th>Paid</th>
              <th>Pending</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="payment-form">
            <div class="modal-header">
              <h5 class="modal-title">Add Payment</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="payment-student-id">
              <div class="form-group">
                <label>Payment Type</label>
                <select class="form-control" id="payment-type" required>
                  <option value="school">School Fees</option>
                  <option value="vehicle">Vehicle Fees</option>
                </select>
              </div>
              <div class="form-group">
                <label>Amount</label>
                <input type="number" class="form-control" id="payment-amount" required>
              </div>
              <div class="form-group">
                <label>Payment Mode</label>
                <select class="form-control" id="payment-mode">
                  <option value="Cash">Cash</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
              </div>
              <div class="form-group">
                <label>Transaction ID</label>
                <input type="text" class="form-control" id="transaction-id">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Payment</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Vehicle Fee Modal -->
    <div class="modal fade" id="vehicleFeeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="vehicle-fee-form">
            <div class="modal-header">
              <h5 class="modal-title">Vehicle Fee Management</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="vehicle-student-id">
              <div class="form-group">
                <label>Fee Calculation Method</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="feeType" id="fixedFee" checked>
                      <label class="form-check-label" for="fixedFee">
                        Fixed Amount
                      </label>
                      <input type="number" class="form-control mt-2" id="fixed-amount" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="feeType" id="monthlyFee">
                      <label class="form-check-label" for="monthlyFee">
                        Monthly Calculation
                      </label>
                      <select class="form-control mt-2" id="month-select" multiple style="height: 150px;">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <h6>Payment History</h6>
                <div id="vehicle-history" class="mb-3">
                  <!-- History entries will be loaded here -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Fee Details</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <div class="row fee-summary">
              <div class="col-md-6">
                <h6>School Fees</h6>
                <p>Base Fee: ₹<span id="school-base">0</span></p>
                <p>Discount: ₹<span id="school-discount">0</span></p>
                <p>Paid: ₹<span id="school-paid">0</span></p>
                <p>Pending: ₹<span id="school-pending">0</span></p>
              </div>
              <div class="col-md-6">
                <h6>Vehicle Fees</h6>
                <p>Total: ₹<span id="vehicle-total">0</span></p>
                <p>Paid: ₹<span id="vehicle-paid">0</span></p>
                <p>Pending: ₹<span id="vehicle-pending">0</span></p>
              </div>
            </div>
            
            <h6 class="mt-4">Transaction History</h6>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Mode</th>
                  <th>Transaction ID</th>
                </tr>
              </thead>
              <tbody id="transaction-history">
                <!-- Transactions loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let students = [];
      let systemSettings = {};

      // Load system settings
      async function loadSystemSettings() {
        const doc = await db.collection("001-school").doc("systemSettings").get();
        systemSettings = doc.exists ? doc.data() : {};
      }

      // Load students with fee data
      async function loadStudents() {
        const snapshot = await db.collection("001-school").doc("students").collection("list").get();
        students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderStudents();
      }

      function renderStudents() {
        const tbody = $('#students-table tbody');
        tbody.empty();
        
        students.forEach(student => {
          const row = `
            <tr>
              <td>${student.srNumber}</td>
              <td>${student.studentName}</td>
              <td>${student.class}</td>
              <td>₹${calculateTotalFee(student)}</td>
              <td>₹${student.paid || 0}</td>
              <td>₹${calculatePending(student)}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="openPaymentModal('${student.id}')">
                  Add Payment
                </button>
                <button class="btn btn-sm btn-info" onclick="viewDetails('${student.id}')">
                  Details
                </button>
                <button class="btn btn-sm btn-warning" onclick="openVehicleFeeModal('${student.id}')">
                  Vehicle
                </button>
              </td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      function calculateTotalFee(student) {
        const baseFee = systemSettings.universalFeesChart?.find(f => 
          f.class === student.class && f.stream === student.stream
        )?.baseFee || 0;
        
        const vehicleFee = student.vehicleFee?.total || 0;
        return baseFee + vehicleFee - (student.discount || 0);
      }

      function calculatePending(student) {
        return calculateTotalFee(student) - (student.paid || 0);
      }

      // Payment Modal Handling
      function openPaymentModal(studentId) {
        $('#payment-student-id').val(studentId);
        $('#payment-form')[0].reset();
        $('#addPaymentModal').modal('show');
      }

      $('#payment-form').submit(async function(e) {
        e.preventDefault();
        const studentId = $('#payment-student-id').val();
        const payment = {
          type: $('#payment-type').val(),
          amount: parseFloat($('#payment-amount').val()),
          mode: $('#payment-mode').val(),
          transactionId: $('#transaction-id').val(),
          date: new Date().toISOString()
        };

        await db.collection("001-school").doc("students").collection("list")
          .doc(studentId).collection("payments").add(payment);
        
        updateStudentBalance(studentId, payment.amount);
        $('#addPaymentModal').modal('hide');
      });

      async function updateStudentBalance(studentId, amount) {
        const studentRef = db.collection("001-school").doc("students").collection("list").doc(studentId);
        await studentRef.update({
          paid: firebase.firestore.FieldValue.increment(amount)
        });
        loadStudents();
      }

      // Vehicle Fee Modal Handling
      async function openVehicleFeeModal(studentId) {
        $('#vehicle-student-id').val(studentId);
        $('#vehicle-fee-form')[0].reset();
        loadVehicleHistory(studentId);
        $('#vehicleFeeModal').modal('show');
      }

      async function loadVehicleHistory(studentId) {
        const snapshot = await db.collection("001-school").doc("students").collection("list")
          .doc(studentId).collection("vehiclePayments").get();
        
        const history = $('#vehicle-history');
        history.empty();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const entry = `
            <div class="history-entry">
              <small>${new Date(data.timestamp?.toDate()).toLocaleDateString()}</small>
              ${data.type === 'fixed' ? 
                `Fixed Amount: ₹${data.amount}` : 
                `${data.months.length} months selected`}
            </div>
          `;
          history.append(entry);
        });
      }

      $('#vehicle-fee-form').submit(async function(e) {
        e.preventDefault();
        const studentId = $('#vehicle-student-id').val();
        const type = $('input[name="feeType"]:checked').attr('id').replace('Fee', '').toLowerCase();
        const data = {
          type,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        if(type === 'fixed') {
          data.amount = parseFloat($('#fixed-amount').val());
        } else {
          data.months = $('#month-select').val();
        }

        await db.collection("001-school").doc("students").collection("list")
          .doc(studentId).collection("vehiclePayments").add(data);
        
        loadVehicleHistory(studentId);
      });

      // View Details Handling
      async function viewDetails(studentId) {
        const student = students.find(s => s.id === studentId);
        const payments = await db.collection("001-school").doc("students").collection("list")
          .doc(studentId).collection("payments").get();
        
        let schoolPaid = 0;
        let vehiclePaid = 0;
        
        payments.forEach(doc => {
          const payment = doc.data();
          if(payment.type === 'school') schoolPaid += payment.amount;
          else if(payment.type === 'vehicle') vehiclePaid += payment.amount;
        });

        const baseFee = systemSettings.universalFeesChart?.find(f => 
          f.class === student.class && f.stream === student.stream
        )?.baseFee || 0;

        $('#school-base').text(baseFee);
        $('#school-discount').text(student.discount || 0);
        $('#school-paid').text(schoolPaid);
        $('#school-pending').text(baseFee - (student.discount || 0) - schoolPaid);
        
        const vehiclePayments = await db.collection("001-school").doc("students").collection("list")
          .doc(studentId).collection("vehiclePayments").get();
        
        let vehicleTotal = 0;
        vehiclePayments.forEach(doc => {
          const data = doc.data();
          if(data.type === 'fixed') vehicleTotal += data.amount;
          else if(data.type === 'monthly') vehicleTotal += data.months.length * 1000; // ₹1000/month
        });
        
        $('#vehicle-total').text(vehicleTotal);
        $('#vehicle-paid').text(vehiclePaid);
        $('#vehicle-pending').text(vehicleTotal - vehiclePaid);

        renderTransactionHistory(payments);
        $('#detailsModal').modal('show');
      }

      function renderTransactionHistory(payments) {
        const tbody = $('#transaction-history');
        tbody.empty();
        
        payments.forEach(doc => {
          const payment = doc.data();
          const row = `
            <tr>
              <td>${new Date(payment.date).toLocaleDateString()}</td>
              <td>${payment.type}</td>
              <td>₹${payment.amount}</td>
              <td>${payment.mode}</td>
              <td>${payment.transactionId || '-'}</td>
            </tr>
          `;
          tbody.append(row);
        });
      }

      // Initialize
      $(document).ready(async function() {
        await loadSystemSettings();
        await loadStudents();
        
        $('#student-search').on('input', function() {
          const searchTerm = $(this).val().toLowerCase();
          $('#students-table tbody tr').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(searchTerm));
          });
        });
      });
    </script>
  </body>
</html>