<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SchoolMS - Attendance Management</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .attendance-section {
        margin-top: 20px;
      }
      .filter-section {
        margin-bottom: 30px;
      }
      .chart-container {
        position: relative;
        height: 350px;
      }
      .table-responsive {
        margin-bottom: 30px;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .details-modal-table {
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Attendance Details - <span id="detailUserName"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">Summary</h5>
                    <p class="mb-1">Total Days: <span id="totalDays">0</span></p>
                    <p class="mb-1">Present: <span id="totalPresent">0</span></p>
                    <p class="mb-1">Absent: <span id="totalAbsent">0</span></p>
                    <p class="mb-0">Percentage: <span id="attendancePercentage">0</span>%</p>
                  </div>
                </div>
              </div>
              <div class="col-md-8">
                <h6>Daily Records</h6>
                <div class="details-modal-table">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Class/Session</th>
                      </tr>
                    </thead>
                    <tbody id="detailRecordsBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navbar and filter section (same as previous code) -->
    <!-- Add class and gender filters -->
    <div class="container attendance-section">
      <h2 class="mb-4">Attendance Management</h2>
      <div class="row filter-section align-items-center">
        <div class="col-md-3">
          <label for="timeRangeSelect" class="form-label">Time Range:</label>
          <select id="timeRangeSelect" class="form-select">
            <option value="7">Last 7 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="90">Last 3 Months</option>
            <option value="180">Last 6 Months</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="classSelect" class="form-label">Class:</label>
          <select id="classSelect" class="form-select">
            <option value="all">All Classes</option>
            <option value="class9">Class 9</option>
            <option value="class10">Class 10</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="genderSelect" class="form-label">Gender:</label>
          <select id="genderSelect" class="form-select">
            <option value="all">All Genders</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="searchAttendance" class="form-label">Search:</label>
          <input
            type="text"
            id="searchAttendance"
            class="form-control"
            placeholder="Name/ID..."
          />
        </div>
        <div class="col-md-2">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary w-100" onclick="loadAllData()">Apply</button>
        </div>
      </div>

      <!-- Rest of the HTML remains same as previous code -->
      <!-- Add View Details button in table rows -->
      <!-- Update student table header -->
      <table class="table table-bordered" id="student-attendance-table">
        <thead class="table-dark">
          <tr>
            <th>Roll No</th>
            <th>Name</th>
            <th>Class</th>
            <th>Gender</th>
            <th>Last 7 Days</th>
            <th>Actions</th>
          </tr>
        </thead>
        <!-- Similarly update staff table -->
    </div>

    <script>
      // ... Previous firebase config and initialization ...

      // New global variables
      let currentDetailType = '';
      let currentDetailId = '';

      // Enhanced loadStudentAttendance function with filters
      async function loadStudentAttendance(days = 7) {
        showLoading();
        const classFilter = document.getElementById('classSelect').value;
        const genderFilter = document.getElementById('genderSelect').value;
        
        // ... existing code ...
        // Add filter logic to Firestore queries
        if (classFilter !== 'all') {
          // Modify query to specific class
        }
        if (genderFilter !== 'all') {
          // Add gender filter to query
        }
        // ...
        hideLoading();
      }

      // View Details Handler
      async function showDetails(type, id, name) {
        showLoading();
        currentDetailType = type;
        currentDetailId = id;
        document.getElementById('detailUserName').textContent = name;
        
        const days = parseInt(timeRangeSelect.value);
        const dates = getPastDates(days);
        
        let records = [];
        if (type === 'student') {
          // Fetch student attendance details
          for (const date of dates) {
            const sessions = ["session1", "session2"];
            for (const session of sessions) {
              const doc = await db.collection('001-school').doc('attendance')
                .collection('student_attendance').doc(date)
                .collection(session).doc(classFilter)
                .collection('students').doc(id).get();
              if (doc.exists) {
                records.push({
                  date,
                  status: doc.data().status,
                  session: session.replace('session', 'Session ')
                });
              }
            }
          }
        } else {
          // Fetch staff attendance details
          for (const date of dates) {
            const doc = await db.collection('001-school').doc('attendance')
              .collection('staff_attendance').doc(date)
              .collection('records').doc(id).get();
            if (doc.exists) {
              records.push({
                date,
                status: 'Present',
                session: 'Full Day'
              });
            }
          }
        }

        // Update modal content
        const presentCount = records.filter(r => r.status === 'Present').length;
        document.getElementById('totalDays').textContent = records.length;
        document.getElementById('totalPresent').textContent = presentCount;
        document.getElementById('totalAbsent').textContent = records.length - presentCount;
        document.getElementById('attendancePercentage').textContent = 
          ((presentCount / records.length) * 100 || 0).toFixed(1);

        const tbody = document.getElementById('detailRecordsBody');
        tbody.innerHTML = records.map(r => `
          <tr>
            <td>${r.date}</td>
            <td><span class="badge ${r.status === 'Present' ? 'bg-success' : 'bg-danger'}">
              ${r.status}
            </span></td>
            <td>${r.session}</td>
          </tr>
        `).join('');
        
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
        hideLoading();
      }

      // Loading functions
      function showLoading() {
        document.querySelector('.loading-overlay').style.display = 'flex';
      }

      function hideLoading() {
        document.querySelector('.loading-overlay').style.display = 'none';
      }

      // Update table rows to include View Details button
      // Example for student row:
      function createStudentRow(student) {
        return `
          <tr>
            <td>${student.rollNo}</td>
            <td>${student.name}</td>
            <td>${student.class}</td>
            <td>${student.gender}</td>
            <td>${student.last7Days}</td>
            <td>
              <button class="btn btn-sm btn-primary" 
                onclick="showDetails('student', '${student.rollNo}', '${student.name}')">
                View Details
              </button>
            </td>
          </tr>
        `;
      }

      // Update event listeners to include new filters
      document.getElementById('classSelect').addEventListener('change', loadAllData);
      document.getElementById('genderSelect').addEventListener('change', loadAllData);
    </script>
  </body>
</html>