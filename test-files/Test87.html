<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SchoolMS - Advanced Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .attendance-section { margin-top: 20px; }
        .filter-section { margin-bottom: 30px; }
        .chart-container { height: 350px; position: relative; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .details-table { max-height: 400px; overflow-y: auto; }
        .badge-present { background-color: #28a745; }
        .badge-absent { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Attendance Summary</h5>
                                    <p>Total Days: <span id="totalDays">0</span></p>
                                    <p>Present: <span id="totalPresent">0</span></p>
                                    <p>Absent: <span id="totalAbsent">0</span></p>
                                    <p>Percentage: <span id="attendancePercent">0</span>%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Daily Records</h5>
                            <div class="details-table">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Session/Class</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailRecords">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SchoolMS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item active"><a class="nav-link" href="attendance.html">Attendance</a></li>
                    <!-- Other menu items -->
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container attendance-section">
        <h2 class="mb-4">Attendance Management</h2>
        
        <!-- Filters -->
        <div class="row filter-section g-3">
            <div class="col-md-3">
                <select id="timeRange" class="form-select">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="classSelect" class="form-select">
                    <option value="all">All Classes</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="genderSelect" class="form-select">
                    <option value="all">All Genders</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Search...">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="loadData()">Apply</button>
            </div>
        </div>

        <!-- Student Table -->
        <div id="studentSection">
            <h4 class="my-4">Student Attendance</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Gender</th>
                            <th>Last 7 Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Staff Table -->
        <div id="staffSection" class="mt-5" style="display: none;">
            <h4 class="my-4">Staff Attendance</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Last 7 Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mt-5">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="studentChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="staffChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
            authDomain: "squadvertex2007.firebaseapp.com",
            projectId: "squadvertex2007",
            storageBucket: "squadvertex2007.appspot.com",
            messagingSenderId: "168905083514",
            appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let studentChart, staffChart;
        let currentData = [];

        // Utility Functions
        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getPastDates(days) {
            const dates = [];
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                dates.push(formatDate(d));
            }
            return dates;
        }

        // Data Loading
        async function loadData() {
            showLoading();
            const type = document.querySelector('#attendanceType').value;
            const days = parseInt(document.getElementById('timeRange').value);
            
            if (type === 'student') {
                await loadStudentData(days);
                await updateStudentChart(days);
            } else {
                await loadStaffData(days);
                await updateStaffChart(days);
            }
            hideLoading();
        }

        async function loadStudentData(days) {
            const classFilter = document.getElementById('classSelect').value;
            const genderFilter = document.getElementById('genderSelect').value;
            
            const dates = getPastDates(days);
            let students = {};

            for (const date of dates) {
                const sessions = ['session1', 'session2'];
                for (const session of sessions) {
                    const snapshot = await db.collection('001-school').doc('attendance')
                        .collection('student_attendance').doc(date)
                        .collection(session).get();

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!students[data.rollNo]) {
                            students[data.rollNo] = {
                                ...data,
                                presentCount: 0,
                                records: []
                            };
                        }
                        if (data.status === 'Present') students[data.rollNo].presentCount++;
                        students[data.rollNo].records.push({
                            date,
                            session,
                            status: data.status
                        });
                    });
                }
            }

            renderStudentTable(Object.values(students));
        }

        function renderStudentTable(students) {
            const tbody = document.getElementById('studentBody');
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.rollNo}</td>
                    <td>${student.name}</td>
                    <td>Class ${student.class}</td>
                    <td>${student.gender}</td>
                    <td>${student.presentCount}/${student.records.length}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                            onclick="showDetail('student', '${student.rollNo}', '${student.name}')">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Detail Modal
        async function showDetail(type, id, name) {
            showLoading();
            const days = parseInt(document.getElementById('timeRange').value);
            const dates = getPastDates(days);
            let records = [];

            if (type === 'student') {
                for (const date of dates) {
                    const sessions = ['session1', 'session2'];
                    for (const session of sessions) {
                        const doc = await db.collection('001-school').doc('attendance')
                            .collection('student_attendance').doc(date)
                            .collection(session).doc(id).get();
                        if (doc.exists) {
                            records.push({
                                date,
                                session: session.toUpperCase(),
                                status: doc.data().status
                            });
                        }
                    }
                }
            } else {
                // Staff detail implementation
            }

            const presentCount = records.filter(r => r.status === 'Present').length;
            document.getElementById('totalDays').textContent = records.length;
            document.getElementById('totalPresent').textContent = presentCount;
            document.getElementById('totalAbsent').textContent = records.length - presentCount;
            document.getElementById('attendancePercent').textContent = 
                ((presentCount / records.length) * 100 || 0).toFixed(1);

            document.getElementById('detailRecords').innerHTML = records.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td><span class="badge ${r.status === 'Present' ? 'badge-present' : 'badge-absent'}">
                        ${r.status}
                    </span></td>
                    <td>${r.session}</td>
                </tr>
            `).join('');

            document.getElementById('detailTitle').textContent = name;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
            hideLoading();
        }

        // Charts
        async function updateStudentChart(days) {
            const ctx = document.getElementById('studentChart').getContext('2d');
            const dates = getPastDates(days);
            const data = await Promise.all(dates.map(async date => {
                // Implement actual data fetching
                return Math.random() * 100;
            }));

            if (studentChart) studentChart.destroy();
            studentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Student Attendance %',
                        data,
                        borderColor: '#4CAF50',
                        tension: 0.1
                    }]
                }
            });
        }

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            new bootstrap.Modal(document.getElementById('detailModal'));
        });
    </script>
</body>
</html>