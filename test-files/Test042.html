<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeamGalaxy Portfolio Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root{
      --primary-bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --card-bg: rgba(25, 25, 35, 0.9);
      --glass-border: 1px solid rgba(255,255,255,0.1);
      --panel-bg: #1e1e1e;
      --muted: rgba(255,255,255,0.75);
      --accent: linear-gradient(45deg,#00d4ff,#0077ff);
      --primary: #00d4ff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--primary-bg); color:#fff; padding:20px; line-height:1.5;
      position: relative; overflow-x: hidden;
    }

    .container{max-width:1200px;margin:0 auto;position:relative;z-index:10}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .title { display:flex; align-items:center; gap:12px; }
    .title h1{ font-size:1.5rem; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0 }
    .auth-area{display:flex;gap:8px;align-items:center}
    .auth-btn{background:rgba(255,255,255,0.1);border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
    .auth-badge{background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:12px;font-size:13px}
    .stats{display:flex;gap:12px;margin:14px 0 18px;flex-wrap:wrap}
    .stat-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;padding:10px 14px;min-width:120px;text-align:center}
    .stat-number{font-weight:700;font-size:1.2rem;background:var(--accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .upload-section{background:var(--card-bg);border:var(--glass-border);padding:14px;border-radius:10px;min-width:420px}
    .file-input-wrapper{position:relative;display:inline-block;background:rgba(255,255,255,0.02);padding:12px 18px;border-radius:999px;border:2px dashed rgba(255,255,255,0.06);cursor:pointer}
    .file-input{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%}
    .upload-btn{background:linear-gradient(45deg,var(--primary),#0077ff);border:0;color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
    .preview-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .preview-item{width:88px;height:88px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;position:relative}
    .preview-item img{width:100%;height:100%;object-fit:cover}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:18px}
    .image-card{background:var(--card-bg);border:var(--glass-border);border-radius:10px;overflow:hidden;position:relative}
    .image-preview{width:100%;height:160px;object-fit:cover;background:#222}
    .image-info{padding:10px}
    .image-title{font-weight:700}
    .image-meta{font-size:12px;color:rgba(255,255,255,0.7);margin-top:6px}
    .image-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .action-btn{background:rgba(255,255,255,0.03);border:var(--glass-border);padding:6px 8px;border-radius:8px;color:#fff;cursor:pointer}

    .pagination { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:16px; flex-wrap:wrap }
    .page-btn { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.04); color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .page-btn.disabled { opacity:0.5; pointer-events:none; }
    .page-btn.active { background: linear-gradient(45deg,#00d4ff,#0077ff); color:#000; font-weight:700; }

    /* Loading Screen */
    .loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(8,7,20,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2000; gap:12px; }
    .loading-spinner{ width:64px;height:64px;border:6px solid rgba(255,255,255,0.06);border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loading-title{ font-size:1.25rem; color:var(--primary); font-weight:700; }
    .loading-sub{ color:#d7eaff; font-size:0.95rem; opacity:0.9; }
    .loading-progress{ width:360px; max-width:90%; background:rgba(255,255,255,0.04); border-radius:12px; padding:6px; border:1px solid rgba(255,255,255,0.03); }
    .loading-bar { height:10px; background:linear-gradient(90deg,#00d4ff,#0077ff); width:0%; border-radius:8px; transition:width 300ms linear; }

    /* Page spinner overlay (shown during page switching/preload) */
    .page-spinner {
      position: absolute;
      left: 50%;
      top: 48%;
      transform: translate(-50%, -50%);
      z-index: 50;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      background: rgba(10,10,15,0.6);
      padding:14px 18px;
      border-radius:12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    .page-spinner .small { color:#d7eaff; font-size:13px; }
    .page-spinner .mini-spinner { width:36px; height:36px; border:4px solid rgba(255,255,255,0.06); border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }

    /* Console Panel restored */
    #console-panel{ position:fixed; left:0; right:0; bottom:0; height:260px; background:var(--panel-bg); color:#d4d4d4; font-family:Consolas,monospace; z-index:99999; display:flex; flex-direction:column; border-top:2px solid #262626; overflow: hidden; box-shadow: 0 -6px 24px rgba(0,0,0,0.6); }
    #console-header{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#222;border-bottom:1px solid #2a2a2a;flex:0 0 auto}
    #console-controls{display:flex;gap:8px;align-items:center}
    #console-controls button, #console-controls select{background:#2b2b2b;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
    #console-body{display:flex;flex:1;gap:12px;overflow:hidden;min-height:0}
    #console-content{flex:1;padding:10px;overflow:auto;border-right:1px solid #2a2a2a;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;font-size:13px}
    #console-sidebar{width:320px;padding:10px;background:#181818;overflow:auto}
    .log-entry{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .small-muted{font-size:12px;color:#9aa}

    .hidden { display: none !important; }

    @media (max-width:720px){ #console-sidebar{display:none} #console-panel{height:280px} }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-title" id="loadingTitle">Verifying admin access...</div>
    <div class="loading-sub" id="loadingSub">Preparing your portfolio...</div>
    <div class="loading-progress" id="loadingProgressWrap" style="display:none">
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px">
        <div id="loadingCount">0 / 0</div>
        <div id="loadingPercent">0%</div>
      </div>
      <div style="background:rgba(255,255,255,0.04);padding:6px;border-radius:8px"><div class="loading-bar" id="loadingBar" style="width:0%"></div></div>
      <div style="margin-top:6px;font-size:12px;color:#d4e8ff" id="loadingDetail">Starting...</div>
    </div>
  </div>

  <div class="container" id="mainContainer" style="display:none; position:relative;">
    <div class="header">
      <div class="title">
        <button class="page-btn back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <h1><i class="fas fa-rocket"></i> TeamGalaxy Portfolio Manager</h1>
      </div>
      <div class="auth-area">
        <div id="authBadge" class="auth-badge">Not signed in</div>
        <button id="btnSignIn" class="auth-btn">Sign in (Google)</button>
        <button id="btnSignOut" class="auth-btn" style="display:none">Sign out</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="totalImages">0</div><div class="stat-label">Total Images</div></div>
      <div class="stat-card"><div class="stat-number" id="publicImages">0</div><div class="stat-label">Public</div></div>
      <div class="stat-card"><div class="stat-number" id="storageUsed">0 MB</div><div class="stat-label">Storage</div></div>
    </div>

    <div class="controls">
      <div class="upload-section">
        <div class="file-input-wrapper" title="Click to select images or drag & drop">
          <input type="file" id="imageUpload" class="file-input" accept="image/*" multiple>
          <span><i class="fas fa-cloud-upload-alt"></i> Select images (max 5)</span>
        </div>
        <button id="uploadBtn" class="upload-btn"><i class="fas fa-upload"></i> Upload to Portfolio</button>
        <div id="previewContainer" class="preview-container"></div>
        <div id="uploadNotice" class="small-muted">Please select up to <strong>5 images</strong> at once.</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
        <select id="categoryFilter" style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);border:var(--glass-border);color:#fff">
          <option value="all">All categories</option>
          <option value="web-design">Web Design</option>
          <option value="ui-ux">UI/UX</option>
          <option value="photography">Photography</option>
          <option value="illustration">Illustration</option>
        </select>
        <div class="small-muted">Uploads go to Cloudflare Worker → Dropbox (server).</div>
      </div>
    </div>

    <div id="loadingIndicator" style="display:none;margin-top:12px"><i class="fas fa-spinner fa-spin"></i> Uploading…</div>

    <div id="portfolioGallery" class="gallery" aria-live="polite"></div>

    <div id="pagination" class="pagination"></div>

    <!-- Page spinner overlay (shown while switching pages) -->
    <div id="pageSpinner" class="page-spinner hidden" aria-hidden="true">
      <div class="mini-spinner"></div>
      <div class="small">Loading page… please wait</div>
    </div>
  </div>

  <!-- Console Panel -->
  <div id="console-panel" aria-live="polite">
    <div id="console-header">
      <div class="title">Debug Console</div>
      <div id="console-controls">
        <select id="console-level"><option value="all">All</option><option value="log">Log</option><option value="info">Info</option><option value="success">Success</option><option value="warning">Warn</option><option value="error">Error</option></select>
        <button id="clear-console"><i class="fas fa-trash"></i> Clear</button>
        <button id="download-console"><i class="fas fa-download"></i> Export</button>
        <button id="toggle-console">Hide</button>
      </div>
    </div>

    <div id="console-body">
      <div id="console-content"></div>
      <div id="console-sidebar">
        <div style="margin-bottom:8px"><strong>Auth info</strong></div>
        <div class="small-muted">Signed-in Gmail:</div>
        <div id="sidebar-email" style="margin-bottom:8px;color:#dff1ff">—</div>
        <div class="small-muted">User UID:</div>
        <div id="sidebar-uid" style="margin-bottom:12px;color:#dff1ff">—</div>

        <div style="margin-top:8px"><strong>Fields accessed (aggregated)</strong></div>
        <div id="sidebar-fields" class="small-muted">—</div>

        <div style="margin-top:12px" class="small-muted">Shortcuts: Ctrl + ` to toggle panel</div>
      </div>
    </div>
  </div>

  <div style="height:28px"></div>

  <!-- Firebase compat libs v11.9.0 -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>

<script>
/* ==========================================================================
   TeamGalaxy — Console Panel + App Script
   Replaces previous script. Drop in as a single <script> tag.
   - Preserves all behavior
   - Uses selectedFiles array (safer than assigning input.files)
   - Surfaces full server responses in console panel for easy debugging
   ========================================================================== */

(function () {
  'use strict';

  /* -------------------------
     Console Panel Core
     ------------------------- */
  (function initConsolePanel() {
    if (window.consolePanelInitialized) return;
    window.consolePanelInitialized = true;

    const content = document.getElementById('console-content');
    const clearBtn = document.getElementById('clear-console');
    const toggleBtn = document.getElementById('toggle-console');
    const downloadBtn = document.getElementById('download-console');
    const levelSelect = document.getElementById('console-level');
    const panel = document.getElementById('console-panel');

    let isVisible = true;
    let currentFilter = 'all';
    const logs = [];

    function esc(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    window.consolePanelLog = function (message, level = 'log') {
      try {
        const ts = new Date();
        const msg = (typeof message === 'string') ? message : JSON.stringify(message, null, 2);
        const entry = { ts: ts.toISOString(), level, message: msg };
        logs.push(entry);

        if (currentFilter !== 'all' && currentFilter !== level) return;
        if (!content) return;

        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = ts.toLocaleTimeString();
        // Use lighter text for the message so level colors stand out
        div.innerHTML = `<span class="log-ts">[${time}]</span> <strong class="log-level-${level}">${level.toUpperCase()}</strong>: <span style="color:#ddd">${esc(msg)}</span>`;
        content.appendChild(div);
        content.scrollTop = content.scrollHeight;
      } catch (e) {
        // ignore UI errors
      }
    };

    // keep original console behavior while mirroring to panel
    const orig = { log: console.log, info: console.info, warn: console.warn, error: console.error };
    console.log = function (...a) { orig.log.apply(console, a); window.consolePanelLog(a.join(' '), 'log'); };
    console.info = function (...a) { orig.info.apply(console, a); window.consolePanelLog(a.join(' '), 'info'); };
    console.warn = function (...a) { orig.warn.apply(console, a); window.consolePanelLog(a.join(' '), 'warning'); };
    console.error = function (...a) { orig.error.apply(console, a); window.consolePanelLog(a.join(' '), 'error'); };

    if (clearBtn) clearBtn.onclick = () => { if (content) content.innerHTML = ''; logs.length = 0; };
    if (toggleBtn) toggleBtn.onclick = () => {
      isVisible = !isVisible;
      if (panel) panel.style.display = isVisible ? 'flex' : 'none';
      toggleBtn.textContent = isVisible ? 'Hide' : 'Show';
    };
    if (downloadBtn) downloadBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `console-logs-${new Date().toISOString()}.json`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
    };
    if (levelSelect) levelSelect.onchange = function () {
      currentFilter = this.value;
      if (content) content.innerHTML = '';
      logs.forEach(e => {
        if (currentFilter === 'all' || e.level === currentFilter) window.consolePanelLog(e.message, e.level);
      });
    };

    // toggle with Ctrl+`
    document.addEventListener('keydown', (ev) => { if (ev.ctrlKey && ev.key === '`') { if (toggleBtn) toggleBtn.click(); } });
  })();


  /* -------------------------
     App config & state
     ------------------------- */
  const CONFIG = {
    CLOUDFLARE_WORKER_URL: 'https://dropbox-filebridge.teamgalaxy-interactive.workers.dev',
    MAX_UPLOAD: 5,
    PAGE_SIZE: 12,
    PRELOAD_MAX_RETRIES: 6,
    PRELOAD_TIMEOUT_MS: 10000,
    PRELOAD_CONCURRENCY: 2,
    PRELOAD_BACKOFF_BASE: 300
  };

  // Firebase config (preserve as provided)
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  // initialize firebase
  if (typeof firebase !== 'undefined' && !firebase.apps?.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = (typeof firebase !== 'undefined') ? firebase.auth() : null;
  const db = (typeof firebase !== 'undefined') ? firebase.firestore() : null;

  // local state
  let selectedFiles = []; // use this instead of assigning input.files (readonly in some browsers)
  let allItems = [];
  let currentPage = 1;

  const inputEl = document.getElementById('imageUpload');
  const preview = document.getElementById('previewContainer');
  const uploadBtn = document.getElementById('uploadBtn');
  const loadingIndicator = document.getElementById('loadingIndicator');


  /* -------------------------
     Logging helper
     ------------------------- */
  function appLog(msg, level = 'info') {
    if (level === 'error') console.error(msg);
    else if (level === 'warning') console.warn(msg);
    else if (level === 'success') console.info(msg);
    else console.log(msg);
    if (window.consolePanelLog) window.consolePanelLog(msg, level === 'success' ? 'success' : level);
  }


  /* -------------------------
     Access tracking (preserve)
     ------------------------- */
  const accessedFields = new Set();
  function recordAccess(fields, note) {
    fields = Array.from(fields || []);
    fields.forEach(f => accessedFields.add(f));
    const el = document.getElementById('sidebar-fields');
    if (el) el.textContent = Array.from(accessedFields).sort().join(', ') || '—';
    appLog(`[FIELDS] ${note || 'access'} → ${fields.join(', ')}`, 'info');
  }


  /* -------------------------
     Auth UI helpers (preserve)
     ------------------------- */
  async function updateAuthUI(user) {
    const badge = document.getElementById('authBadge');
    const sidebarEmail = document.getElementById('sidebar-email');
    const sidebarUid = document.getElementById('sidebar-uid');

    if (!user) {
      if (badge) badge.textContent = 'Not signed in';
      if (sidebarEmail) sidebarEmail.textContent = '—';
      if (sidebarUid) sidebarUid.textContent = '—';
      const sIn = document.getElementById('btnSignIn'), sOut = document.getElementById('btnSignOut');
      if (sIn) sIn.style.display = 'inline-block';
      if (sOut) sOut.style.display = 'none';
      appLog('No user signed in', 'warning');
      return;
    }

    try { await user.getIdTokenResult(true); } catch (e) { appLog('getIdTokenResult failed: ' + (e?.message || e), 'error'); }

    if (badge) badge.textContent = user.email || user.uid;
    if (sidebarEmail) sidebarEmail.textContent = user.email || '—';
    if (sidebarUid) sidebarUid.textContent = user.uid || '—';
    const sIn = document.getElementById('btnSignIn'), sOut = document.getElementById('btnSignOut');
    if (sIn) sIn.style.display = 'none';
    if (sOut) sOut.style.display = 'inline-block';

    appLog(`Auth: ${user.email || user.uid}`, 'info');
    recordAccess(['ownerUid', 'u.email', 'u.uid', 'idToken.claims'], 'auth check');
  }

  const signInBtn = document.getElementById('btnSignIn');
  const signOutBtn = document.getElementById('btnSignOut');

  if (signInBtn) signInBtn.addEventListener('click', async () => {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const res = await auth.signInWithPopup(provider);
      await updateAuthUI(res.user);
      appLog('Signed in: ' + res.user.email, 'success');
    } catch (e) {
      appLog('Sign-in failed: ' + (e?.message || e), 'error');
    }
  });

  if (signOutBtn) signOutBtn.addEventListener('click', async () => {
    try {
      await auth.signOut();
      updateAuthUI(null);
      appLog('Signed out', 'info');
    } catch (e) {
      appLog('Sign-out failed: ' + (e?.message || e), 'error');
    }
  });


  /* -------------------------
     File selection & preview
     ------------------------- */
  function trimFiles(fileList) {
    return Array.from(fileList).slice(0, CONFIG.MAX_UPLOAD);
  }

  function clearPreview() {
    if (preview) preview.innerHTML = '';
    if (uploadBtn) uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload to Portfolio';
  }

  function renderPreviewFromFiles(files) {
    if (!preview) return;
    preview.innerHTML = '';
    files.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const r = new FileReader();
      r.onload = (e) => {
        const d = document.createElement('div');
        d.className = 'preview-item';
        d.innerHTML = `<img src="${e.target.result}" alt="${escapeHtml(file.name)}"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);color:#fff;padding:2px;font-size:10px;text-align:center">${escapeHtml(file.name)}</div>`;
        preview.appendChild(d);
      };
      r.readAsDataURL(file);
    });
  }

  function handleFileSelect(ev) {
    const files = ev.target.files || [];
    if (files.length === 0) { selectedFiles = []; clearPreview(); return; }
    if (files.length > CONFIG.MAX_UPLOAD) {
      alert(`You selected ${files.length} files. Only first ${CONFIG.MAX_UPLOAD} will be used.`);
      selectedFiles = trimFiles(files);
    } else {
      selectedFiles = Array.from(files);
    }
    if (uploadBtn) uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload ${selectedFiles.length} File(s)`;
    renderPreviewFromFiles(selectedFiles);
  }

  if (inputEl) inputEl.addEventListener('change', handleFileSelect);


  /* -------------------------
     Upload flow
     ------------------------- */
  async function handleUpload() {
    const files = selectedFiles || [];
    if (files.length === 0) { alert('Select images first'); return; }
    if (files.length > CONFIG.MAX_UPLOAD) { alert(`Please select up to ${CONFIG.MAX_UPLOAD} files.`); return; }
    const user = auth?.currentUser;
    if (!user) {
      if (!confirm('You are not signed in. Continue without ownerUid? (recommended: sign in)')) return;
    }

    if (loadingIndicator) loadingIndicator.style.display = 'inline-block';
    appLog(`Starting uploads: ${files.length} file(s)`, 'info');

    const results = await Promise.allSettled(files.map((file, i) => new Promise((resolve, reject) => {
      setTimeout(async () => {
        try {
          const res = await uploadToCloudflareWorker(file, user);
          resolve(res);
        } catch (e) {
          reject(e);
        }
      }, i * 700);
    })));

    const failed = results.filter(r => r.status === 'rejected');
    if (failed.length) appLog(`${failed.length} upload(s) failed`, 'error');
    else appLog('All uploads done', 'success');

    if (loadingIndicator) loadingIndicator.style.display = 'none';
    selectedFiles = [];
    if (inputEl) inputEl.value = '';
    clearPreview();

    try { await loadAllMetadataThenShow(); } catch (e) { appLog('Refresh metadata failed: ' + (e?.message || e), 'error'); }
  }

  if (uploadBtn) uploadBtn.addEventListener('click', handleUpload);


  async function uploadToCloudflareWorker(file, user) {
    const category = (document.getElementById('categoryFilter') && document.getElementById('categoryFilter').value) || 'uncategorized';
    const form = new FormData();
    form.append('file', file);
    form.append('category', category);
    form.append('title', file.name.replace(/\.[^/.]+$/, ''));
    form.append('description', `Uploaded ${file.name}`);
    form.append('isPublic', 'false');

    appLog(`Uploading ${file.name}...`, 'info');

    const endpoint = `${CONFIG.CLOUDFLARE_WORKER_URL.replace(/\/$/, '')}/api/upload`;
    let resp;
    try {
      resp = await fetch(endpoint, { method: 'POST', body: form, mode: 'cors' });
    } catch (networkErr) {
      appLog(`Network error while uploading ${file.name}: ${networkErr?.message || networkErr}`, 'error');
      throw networkErr;
    }

    // read text first for maximum debug visibility
    const respText = await resp.text().catch(() => '<no-response-body>');
    if (!resp.ok) {
      let parsed = null;
      try { parsed = JSON.parse(respText); } catch (e) { /* ignore */ }
      const pretty = parsed ? JSON.stringify(parsed, null, 2) : respText;
      appLog(`Upload HTTP ${resp.status} for ${file.name}: ${pretty}`, 'error');
      const msg = `Upload HTTP ${resp.status}: ${(respText || '').substring(0, 200)}`;
      throw new Error(msg);
    }

    let res;
    try { res = JSON.parse(respText); } catch (e) { throw new Error('Invalid JSON from upload endpoint: ' + (respText || '').substring(0, 200)); }
    if (!res.success) {
      appLog('Worker returned error: ' + (res.error || JSON.stringify(res)), 'error');
      throw new Error(res.error || 'Upload failed');
    }

    // Save metadata into Firestore (preserve original shape)
    const itemData = {
      ownerUid: user ? user.uid : null,
      folderId: null,
      fileName: res.fileName || file.name,
      originalName: file.name,
      fileSize: res.fileSize || file.size || 0,
      fileType: res.fileType || file.type,
      dropboxUrl: res.dropboxUrl || res.url || '',
      uploadDate: new Date(),
      lastModified: new Date(),
      category,
      title: file.name.replace(/\.[^/.]+$/, ''),
      description: `Uploaded ${file.name}`,
      isPublic: false,
      meta: { dimensions: null }
    };

    recordAccess(Object.keys(itemData), 'create portfolioItems (upload)');
    try {
      const docRef = await db.collection('portfolioItems').add(itemData);
      appLog(`Saved metadata ${docRef.id}`, 'success');
    } catch (e) {
      appLog('Failed to save metadata: ' + (e?.message || e), 'error');
      throw e;
    }

    return { ok: true, dropboxUrl: itemData.dropboxUrl };
  }


  /* -------------------------
     Preload helpers
     ------------------------- */
  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  function preloadOnce(url, timeoutMs = CONFIG.PRELOAD_TIMEOUT_MS) {
    return new Promise((resolve, reject) => {
      if (!url) return reject(new Error('no-url'));
      const img = new Image();
      let done = false;
      const t = setTimeout(() => { if (done) return; done = true; img.src = ''; reject(new Error('timeout')); }, timeoutMs);
      img.onload = () => { if (done) return; done = true; clearTimeout(t); resolve(); };
      img.onerror = () => { if (done) return; done = true; clearTimeout(t); reject(new Error('error')); };
      img.src = url;
    });
  }

  async function preloadWithRetries(url, idx, progressCb) {
    let attempt = 0;
    while (attempt < CONFIG.PRELOAD_MAX_RETRIES) {
      attempt++;
      try {
        progressCb && progressCb({ idx, attempt, status: 'trying' });
        await preloadOnce(url, CONFIG.PRELOAD_TIMEOUT_MS);
        progressCb && progressCb({ idx, attempt, status: 'loaded' });
        return { ok: true, attempt };
      } catch (e) {
        progressCb && progressCb({ idx, attempt, status: 'failed', error: e.message });
        await sleep(CONFIG.PRELOAD_BACKOFF_BASE * attempt);
      }
    }
    progressCb && progressCb({ idx, attempt: CONFIG.PRELOAD_MAX_RETRIES, status: 'exhausted' });
    return { ok: false, attempt: CONFIG.PRELOAD_MAX_RETRIES };
  }

  async function preloadPage(itemsForPage, progressCb) {
    const total = itemsForPage.length;
    const results = new Array(total);
    let nextIndex = 0;
    let completed = 0;
    let failed = 0;

    const worker = async () => {
      while (true) {
        const i = nextIndex++;
        if (i >= total) break;

        const url = itemsForPage[i].dropboxUrl || '';
        const itemProgressCb = ({ attempt, status, error }) => {
          progressCb && progressCb({
            total, index: i, attempt, status, error, completed, failed
          });
        };

        const res = await preloadWithRetries(url, i, (p) => itemProgressCb(p));
        results[i] = res;
        if (res.ok) completed++; else failed++;

        progressCb && progressCb({
          total, index: i, attempt: res.attempt, status: res.ok ? 'done' : 'failed-final', error: res.ok ? null : 'exhausted', completed, failed
        });
      }
    };

    const workers = [];
    const c = Math.max(1, Math.min(CONFIG.PRELOAD_CONCURRENCY, total));
    for (let w = 0; w < c; w++) workers.push(worker());
    await Promise.all(workers);

    progressCb && progressCb({ total, completed, failed, finished: true });
    return results;
  }


  /* -------------------------
     Pagination & rendering
     ------------------------- */
  function setPaginationDisabled(disabled) {
    const container = document.getElementById('pagination');
    if (!container) return;
    Array.from(container.querySelectorAll('.page-btn')).forEach(b => {
      if (disabled) b.classList.add('disabled'); else b.classList.remove('disabled');
      b.disabled = disabled;
    });
  }

  function showPageSpinner(show) {
    const sp = document.getElementById('pageSpinner');
    if (!sp) return;
    if (show) { sp.classList.remove('hidden'); sp.setAttribute('aria-hidden', 'false'); }
    else { sp.classList.add('hidden'); sp.setAttribute('aria-hidden', 'true'); }
  }

  async function renderPage(pageNum, options = { showProgress: true }) {
    currentPage = pageNum;
    const gallery = document.getElementById('portfolioGallery');
    if (gallery) gallery.style.display = 'none';
    showPageSpinner(true);

    const start = (pageNum - 1) * CONFIG.PAGE_SIZE;
    const pageItems = allItems.slice(start, start + CONFIG.PAGE_SIZE);

    const frag = document.createDocumentFragment();
    pageItems.forEach(it => {
      const card = document.createElement('div');
      card.className = 'image-card';
      card.dataset.id = it.id;
      card.dataset.isPublic = it.isPublic ? 'true' : 'false';
      card.innerHTML = `
        <img class="image-preview" loading="eager" src="" data-src="${escapeHtml(it.dropboxUrl || '')}" alt="${escapeHtml(it.title || it.originalName || '')}">
        <div class="image-info">
          <div class="image-title">${escapeHtml(it.title || it.originalName || 'Untitled')}</div>
          <div class="image-meta">Size: ${formatFileSize(it.fileSize || 0)} | ${it.meta?.dimensions ? it.meta.dimensions.width + '×' + it.meta.dimensions.height : 'Unknown dims'}</div>
          <div class="image-actions"><button class="action-btn" onclick="copyToClipboard('${it.dropboxUrl || ''}')"><i class="fas fa-copy"></i> Copy URL</button></div>
        </div>
      `;
      frag.appendChild(card);
    });

    if (gallery) { gallery.innerHTML = ''; gallery.appendChild(frag); }

    setPaginationDisabled(true);

    if (options.showProgress) {
      const wrap = document.getElementById('loadingProgressWrap');
      const total = pageItems.length;
      const countEl = document.getElementById('loadingCount');
      const percentEl = document.getElementById('loadingPercent');
      const bar = document.getElementById('loadingBar');
      const detail = document.getElementById('loadingDetail');
      if (wrap) wrap.style.display = 'block';
      if (countEl) countEl.textContent = `0 / ${total}`;
      if (percentEl) percentEl.textContent = `0%`;
      if (bar) bar.style.width = `0%`;
      if (detail) detail.textContent = `Loading page ${pageNum} images...`;
    } else {
      const wrap = document.getElementById('loadingProgressWrap');
      if (wrap) wrap.style.display = 'none';
    }

    const results = await preloadPage(pageItems, ({ total, index = null, attempt = null, status = null, error = null, completed = 0, failed = 0 }) => {
      const doneCount = completed + failed;
      const percent = total ? Math.round((doneCount / total) * 100) : 0;
      const countEl = document.getElementById('loadingCount');
      const percentEl = document.getElementById('loadingPercent');
      const bar = document.getElementById('loadingBar');
      const detail = document.getElementById('loadingDetail');
      if (countEl) countEl.textContent = `${doneCount} / ${total}`;
      if (percentEl) percentEl.textContent = `${percent}%`;
      if (bar) bar.style.width = `${percent}%`;
      if (index !== null && status) {
        if (detail) detail.textContent = `Item ${index + 1}/${total} — attempt ${attempt} — ${status}${error ? ' (' + error + ')' : ''}`;
      } else {
        if (detail) detail.textContent = `Completed ${doneCount} / ${total} — failed ${failed}`;
      }
    });

    const cards = document.querySelectorAll('.image-card');
    cards.forEach((card, idx) => {
      const img = card.querySelector('.image-preview');
      const url = img && img.getAttribute('data-src') || '';
      const res = results[idx] || { ok: false };
      if (res.ok) {
        img.src = url;
        img.setAttribute('data-loaded', 'true');
      } else {
        img.src = '';
        img.setAttribute('data-loaded', 'false');
      }
    });

    await sleep(120);

    setPaginationDisabled(false);
    const wrap = document.getElementById('loadingProgressWrap');
    if (wrap) wrap.style.display = 'none';
    showPageSpinner(false);
    if (gallery) gallery.style.display = 'grid';
    updateStats();
    renderPagination();

    if (document.getElementById('mainContainer') && document.getElementById('mainContainer').style.display === 'none') {
      hideLoadingScreenAndShowMain();
    }
  }

  function renderPagination() {
    const total = allItems.length;
    const pages = Math.max(1, Math.ceil(total / CONFIG.PAGE_SIZE));
    const container = document.getElementById('pagination');
    if (!container) return;
    container.innerHTML = '';
    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.textContent = 'Prev';
    prev.disabled = currentPage === 1;
    prev.onclick = () => { if (currentPage > 1) renderPage(currentPage - 1); };
    container.appendChild(prev);

    for (let p = 1; p <= pages; p++) {
      const b = document.createElement('button');
      b.className = 'page-btn' + (p === currentPage ? ' active' : '');
      b.textContent = p;
      b.onclick = () => { if (p !== currentPage) renderPage(p); };
      container.appendChild(b);
    }

    const next = document.createElement('button');
    next.className = 'page-btn';
    next.textContent = 'Next';
    next.disabled = currentPage === pages;
    next.onclick = () => { if (currentPage < pages) renderPage(currentPage + 1); };
    container.appendChild(next);
  }

  function hideLoadingScreenAndShowMain() {
    const ls = document.getElementById('loadingScreen');
    if (!ls) return;
    ls.style.opacity = '0';
    setTimeout(() => {
      ls.classList.add('hidden');
      const mc = document.getElementById('mainContainer');
      if (mc) mc.style.display = 'block';
    }, 300);
  }


  /* -------------------------
     Metadata load & helpers
     ------------------------- */
  async function loadAllMetadataThenShow() {
    try {
      appLog('Fetching all portfolio metadata...', 'info');
      const loadingTitle = document.getElementById('loadingTitle');
      if (loadingTitle) loadingTitle.textContent = 'Verifying admin and fetching metadata...';

      const snap = await db.collection('portfolioItems').orderBy('uploadDate', 'desc').get();
      allItems = [];
      const foundFields = new Set();
      snap.forEach(doc => { const d = doc.data(); allItems.push({ id: doc.id, ...d }); Object.keys(d || {}).forEach(k => foundFields.add(k)); });
      recordAccess(Array.from(foundFields), 'read portfolioItems (metadata)');
      const totalImages = document.getElementById('totalImages');
      if (totalImages) totalImages.textContent = allItems.length;
      appLog(`Fetched ${allItems.length} items metadata`, 'info');

      await renderPage(1, { showProgress: true });
    } catch (e) {
      appLog('Failed fetching metadata: ' + (e?.message || e), 'error');
      hideLoadingScreenAndShowMain();
      throw e;
    }
  }

  function updateStats() {
    const totalImagesEl = document.getElementById('totalImages');
    if (totalImagesEl) totalImagesEl.textContent = allItems.length;
    const publicCount = allItems.filter(i => i.isPublic).length;
    const publicImagesEl = document.getElementById('publicImages');
    if (publicImagesEl) publicImagesEl.textContent = publicCount;
    let totMB = 0;
    allItems.forEach(i => { const fs = i.fileSize || 0; totMB += (fs / 1024 / 1024); });
    const storageUsed = document.getElementById('storageUsed');
    if (storageUsed) storageUsed.textContent = `${totMB.toFixed(2)} MB`;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    if (!bytes) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
  }

  async function copyToClipboard(text) {
    try { await navigator.clipboard.writeText(text || ''); alert('Copied'); appLog('Copied to clipboard', 'success'); }
    catch (e) { appLog('Copy fail: ' + (e?.message || e), 'error'); }
  }

  function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
  function goBack() { window.location.href = '../admin_panel.html'; }


  /* -------------------------
     Admin check & init
     ------------------------- */
  async function checkAdminAccessAndStart() {
    try {
      const user = await new Promise((resolve, reject) => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            try {
              const adminQuery = await db.collection('admin').where('gmail', '==', user.email).limit(1).get();
              if (!adminQuery.empty) { unsubscribe(); resolve(user); } else { unsubscribe(); reject(new Error('Not an admin')); }
            } catch (err) { unsubscribe(); reject(err); }
          } else { unsubscribe(); reject(new Error('Not signed in')); }
        });
      });

      const loadingTitle = document.getElementById('loadingTitle');
      if (loadingTitle) loadingTitle.textContent = 'Admin verified — loading metadata';
      const loadingSub = document.getElementById('loadingSub');
      if (loadingSub) loadingSub.textContent = `Hello ${user.email}. Loading portfolio...`;
      await updateAuthUI(user);
      await loadAllMetadataThenShow();
    } catch (e) {
      console.error('Admin error', e);
      const loadingTitle = document.getElementById('loadingTitle');
      if (loadingTitle) loadingTitle.textContent = 'Access denied';
      const loadingSub = document.getElementById('loadingSub');
      if (loadingSub) loadingSub.textContent = 'Redirecting...';
      setTimeout(() => window.location.href = 'index.html', 1600);
    }
  }


  /* -------------------------
     Init
     ------------------------- */
  (function init() {
    appLog('App init', 'info');
    checkAdminAccessAndStart();
  })();


  /* -------------------------
     Expose debug helpers
     ------------------------- */
  window.__teamGalaxy = {
    reloadMetadata: loadAllMetadataThenShow,
    getSelectedFiles: () => selectedFiles.slice(),
    setSelectedFiles: (arr) => { selectedFiles = Array.isArray(arr) ? arr.slice(0, CONFIG.MAX_UPLOAD) : []; },
    config: CONFIG
  };

})();
</script>
</body>
</html>