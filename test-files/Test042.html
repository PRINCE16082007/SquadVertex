<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>About Team Galaxy â€” Orbit Playground (Firestore)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <style>
    /* ---------- GLOBAL ---------- */
    :root{
      --bg-1:#071018;
      --panel: rgba(12,18,26,0.55);
      --accent: #64c2ff;
      --muted: #9fcff6;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071018 0%, #081428 60%);color:#eaf7ff;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial}
    a { color: var(--accent); text-decoration: none; }
    /* ---------- TOP BAR (restored) ---------- */
    .top-bar{height:72px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:rgba(6,12,18,0.45);backdrop-filter: blur(6px);position:sticky;top:0;z-index:601;border-bottom:1px solid rgba(255,255,255,0.03)}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-family:'Montserrat',sans-serif;color:#fff;cursor:pointer}
    .logo img{height:42px;filter:drop-shadow(0 6px 18px rgba(36,160,255,0.08))}
    .nav {display:flex;gap:12px;align-items:center}
    .nav button{background:transparent;border:0;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .nav button:hover{color:var(--accent);background:rgba(100,194,255,0.06)}
    /* ---------- HERO/PLAYGROUND: blended, single canvas ---------- */
    .hero-wrap {position:relative;height:420px;margin:18px auto 28px;max-width:1200px;padding:12px;box-sizing:border-box;z-index:10}
    .playground-card {position:relative;height:100%;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(6,10,18,0.48), rgba(3,6,12,0.58));box-shadow:0 18px 60px rgba(5,10,20,0.7), inset 0 -40px 80px rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.03)}
    .play-canvas {position:absolute;inset:0;display:block;mix-blend-mode:screen;opacity:0.98;filter:contrast(1.02) saturate(1.02);pointer-events:none}
    /* Earth uses a fixed position and won't move programmatically */
    .orbit-center {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:6;display:flex;align-items:center;justify-content:center;pointer-events:auto}
    .earth {
      width:128px;height:128px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-size:72px;line-height:1;cursor:default;
      box-shadow: 0 18px 40px rgba(4,12,28,0.6), inset -8px -6px 30px rgba(0,0,0,0.45), 0 6px 18px rgba(100,160,255,0.06);
      border:1px solid rgba(255,255,255,0.04); -webkit-user-select:none; user-select:none;
      transform-origin:center center;
    }
    .earth .emoji { filter: drop-shadow(0 8px 18px rgba(0,0,0,0.45)); text-shadow: 0 2px 8px rgba(0,0,0,0.35); }
    .orbit-ring {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:420px;height:420px;border-radius:50%;pointer-events:none;z-index:4;mix-blend-mode:overlay;opacity:0.36}
    /* HUD */
    .hud {position:absolute;right:18px;top:14px;z-index:18;background:linear-gradient(180deg, rgba(8,14,20,0.56), rgba(6,10,16,0.56));padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:flex;gap:10px;align-items:center;backdrop-filter:blur(6px)}
    .hud .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer;font-weight:600}
    .hud .btn:hover{background:rgba(100,194,255,0.08);color:#fff}
    .score {font-weight:700;color:#dff8ff}
    .small-muted{font-size:0.85rem;color:#bfeaff;opacity:0.95}
    /* Share/download */
    .share-actions {display:flex;gap:8px;align-items:center}
    /* ---------- CONTENT & ABOUT (restored) ---------- */
    .about-main { max-width:900px; margin: 18px auto 50px auto; padding-top: 12px; position: relative; }
    .about-section { background: rgba(24,31,43,0.97); border-radius: 12px; box-shadow: 0 8px 24px #20294429; padding: 28px 34px; margin-bottom: 22px; color:#e6f6ff; }
    .about-flex-row { display: flex; align-items: flex-start; gap: 26px; margin-bottom: 18px; flex-wrap: wrap; }
    .about-img-container { display:flex; justify-content:center; align-items:center; border-radius:12px; overflow:hidden; border:2px solid rgba(255,255,255,0.08); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }
    .about-img-left { width: 260px; height: 347px; }
    .about-img-right { width: 260px; height: 347px; }
    .about-img-inline { width: 760px; height: 340px; margin: 16px auto 20px auto; border-radius:10px; border:2px solid rgba(255,255,255,0.08); }
    .about-flex-text { flex: 1 1 340px; font-size: 1.05rem; line-height: 1.7; white-space: pre-line; color: #dff6ff; }
    .about-section h2 { color: #fab84f; font-size: 1.6rem; margin-top: 0; margin-bottom: 8px; }
    /* Footer: restored */
    .footer { min-height:260px; background: linear-gradient(90deg, #181f2b 60%, #232e44 100%); color: #fff; display:flex; gap:20px; align-items:stretch; justify-content:space-between; padding:28px 34px 22px 34px; border-top:2px solid #163053; flex-wrap:wrap }
    .footer-col { display:flex; flex-direction:column; justify-content:space-between; flex:1 1 45% }
    .footer-about-title { font-size: 1.16rem; font-weight:700; color:#fab84f; margin-bottom:8px; }
    .footer-about-text { color:#e5e5e5; line-height:1.45 }
    .footer-links a { font-size:1.04rem; color:#aaa; display:block; margin-bottom:10px; font-weight:600 }
    /* misc */
    .schema-panel { max-width: 1100px; margin: 10px auto; color:#dff; font-family:monospace; background:rgba(0,0,0,0.35); padding:10px; border-radius:8px; font-size:0.95rem; border:1px solid rgba(255,255,255,0.04); }
    .schema-toggle { cursor:pointer; color:var(--accent); text-decoration:underline; margin-left:6px; font-weight:700 }
    @media (max-width:900px){ .earth{width:96px;height:96px;font-size:56px} .orbit-ring{width:320px;height:320px} .hero-wrap{height:360px} }
  </style>
</head>
<body>
  <!-- Top nav (restored) -->
  <div class="top-bar">
    <div class="logo" onclick="location.href='dashboard.html'">
      <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="logo">
      GalaxyWeb
    </div>
    <div class="nav">
      <button onclick="location.href='posts.html'">Posts</button>
      <button onclick="location.href='community_chat.html'">Community</button>
      <button onclick="location.href='about_us.html'">About</button>
    </div>
  </div>

  <!-- HERO + PLAYGROUND -->
  <div class="hero-wrap">
    <div class="playground-card" id="playgroundCard" aria-label="Orbit playground">
      <!-- single canvas blended into page (pointer-events none so underlying container receives clicks) -->
      <canvas id="playCanvas" class="play-canvas" aria-hidden="true"></canvas>

      <!-- Earth fixed DOM element (won't move) -->
      <div class="orbit-center" role="img" aria-label="Earth">
        <div class="earth" id="earthEl" tabindex="0"><span class="emoji">ðŸŒŽ</span></div>
      </div>

      <!-- decorative orbit ring -->
      <div class="orbit-ring" aria-hidden="true">
        <svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
          <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#64c2ff" stop-opacity="0.06"/><stop offset="0.5" stop-color="#a6f0ff" stop-opacity="0.06"/><stop offset="1" stop-color="#64c2ff" stop-opacity="0.02"/></linearGradient></defs>
          <ellipse cx="100" cy="100" rx="86" ry="42" fill="none" stroke="url(#g1)" stroke-width="2"/>
          <ellipse cx="100" cy="100" rx="54" ry="26" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="1"/>
        </svg>
      </div>

      <!-- HUD -->
      <div class="hud" role="status" aria-live="polite">
        <div>
          <div class="score" id="collected">Collected: 0</div>
          <div class="small-muted" id="highscore">High: 0</div>
        </div>
        <div style="width:8px"></div>
        <div class="share-actions">
          <button class="btn" id="btnSpawn">Spawn</button>
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn" id="btnAuto">Auto: Off</button>
          <button class="btn" id="btnSave">Save</button>
          <button class="btn" id="btnDownload">Download Image</button>
        </div>
      </div>
    </div>
  </div>

  <!-- About content (restored) -->
  <div class="about-main">
    <div class="about-section">
      <div class="about-flex-row">
        <div class="about-img-container about-img-left">
          <img src="https://dl.dropboxusercontent.com/scl/fi/4r0o3ymhfol2ndauy5bwb/IMG_20251108_205841.png?rlkey=hagnr2tms6hzf36vc0qgldu4e&st=czyyqfdb&dl=0" alt="Team Galaxy" style="width:100%;height:100%;object-fit:cover" />
        </div>
        <div class="about-flex-text">
          <h2>What is Team Galaxy?</h2>
          Est. May 2025<br><br>
          Team Galaxy shines brightly on the competitive stage of World of Tanks Blitz. Our mission is to showcase our skills, push our limits, and aim for the top. With a strong and united roster, we make our mark not only in tournaments but in every battle we fight.<br><br>
          But Team Galaxy isn't just about victory â€” it's about having fun, too! Our custom ranking system makes clan missions more exciting and creates a sense of friendly competition among members. Whether you want to fight at the highest level or just relax and enjoy the game with friends, you'll always find your place here.<br><br>
          In Galaxy, every member is a star. ðŸŒŒ
        </div>
      </div>
    </div>

    <div class="about-section">
      <div class="about-flex-row">
        <div class="about-flex-text">
          <h2>Clan Events & Activities</h2>
          At Team Galaxy, we believe that a clan should be more than just a tag next to your name â€” it should be an experience. That's why we host exclusive member-only events designed to bring our community closer and keep the game exciting.<br><br>
          One of our biggest traditions is turning weekly clan missions into a fun competition. Members earn stars by completing missions, and these stars contribute to a long-term leaderboard. The higher you climb, the more rewards you can win â€” from in-game gifts to special Galaxy merchandise.<br><br>
          These events are perfect for both competitive warriors and laid-back tankers who just want to enjoy the ride while working toward something rewarding.
        </div>
        <div class="about-img-container about-img-right">
          <img src="https://dl.dropboxusercontent.com/scl/fi/g4wq4m8pkzd32dc7g79dt/1762616781.png?rlkey=m4ctngnu14zl6lffhbw5lvexz&st=bbrct8s5&dl=0" alt="Clan Event" style="width:100%;height:100%;object-fit:cover" />
        </div>
      </div>
    </div>

    <div class="about-section">
      <h2>How to Apply</h2>
      <div class="about-img-container about-img-inline">
        <img src="https://dl.dropboxusercontent.com/scl/fi/extuxsxwz66h4kxz8apek/IMG_20251108_212726.jpg?rlkey=xw6xxxqtx62ahy9bikj0em3i3&st=34gxu7oj&dl=0" alt="Apply Clan" style="width:100%;height:100%;object-fit:cover" />
      </div>
      <div class="about-flex-text">
        Currently, we operate one main clan that welcomes both competitive and casual players.<br><br>
        <strong>Competitive Player Requirements:</strong>
        <ul>
          <li>2400+ WN8 (last 30 days)</li>
          <li>5,000+ total battles</li>
          <li>60%+ overall win rate</li>
        </ul>
        <strong>Casual Player Requirements:</strong>
        <ul>
          <li>10,000+ total battles</li>
          <li>60%+ overall win rate</li>
        </ul>
        <br>
        If you meet the requirements, simply reach out to us through our official Discord or in-game contact. Our recruitment officers will review your stats and chat with you before inviting you to join.<br><br>
        ðŸ’¡ Coming Soon: We are planning to launch our second clan to welcome even more players into the Galaxy family. Stay tuned for updates!
      </div>
    </div>

    <div class="about-section">
      <div class="about-flex-row">
        <div class="about-img-container about-img-left">
          <img src="https://dl.dropboxusercontent.com/scl/fi/2o26yjla61had31bwpcqh/IMG_20251108_213648.jpg?rlkey=dh5e6uqjquk7bb8jnaofxixt5&st=mt7scwa4&dl=0" alt="Team Philosophy" style="width:100%;height:100%;object-fit:cover" />
        </div>
        <div class="about-flex-text">
          <h2>Our Playstyle & Philosophy</h2>
          At Team Galaxy, we believe that victory is built on teamwork, strategy, and trust. We don't just play â€” we play smart, fast, and as one. Every battle is a chance to learn, improve, and grow stronger together.<br><br>
          Our philosophy is simple: push your limits, respect your team, and enjoy the game. Whether we're fighting for the top spot in a tournament or just having a relaxed evening in platoon, we bring the same passion and dedication to every match.<br><br>
          We value communication, adaptability, and the drive to become better â€” because in the Galaxy, every star shines brighter when united. ðŸŒŒ
        </div>
      </div>
    </div>

    <div class="about-section">
      <h2>Achievements & Journey</h2>
      <div class="about-flex-row">
        <div class="about-flex-text">
          Since our formation in May 2025, Team Galaxy has quickly built a name for itself in the Blitz community. While our sights are set on the biggest stages, we've already dominated numerous smaller-scale tournaments and community events â€” proving that our teamwork and skill can consistently bring home the win.<br><br>
          <strong>Highlights so far:</strong>
          <ul>
            <li>Multiple weekly and community tournament victories.</li>
            <li>Strong performance in clan mission challenges and internal competitions.</li>
            <li>Established a solid and active roster of both competitive and casual players.</li>
            <li>Launched our Galaxy Mission Challenge, turning weekly clan missions into a fun, rewarding contest.</li>
          </ul>
          Our journey is just beginning â€” and each win, no matter the size, brings us closer to our ultimate goal: competing and triumphing at the highest levels.
        </div>
        <div class="about-img-container about-img-right">
          <img src="https://dl.dropboxusercontent.com/scl/fi/athrvawp9mjtjc6psfxhv/1762616303.png?rlkey=4wwayymq6wn1632tquut9fn55&st=f10ldv4f&dl=0" alt="Galaxy Journey" style="width:100%;height:100%;object-fit:cover" />
        </div>
      </div>
    </div>
  </div>

  <!-- Firestore schema / collection structure info (collapsible) -->
  <div class="schema-panel" id="schemaPanel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div><strong>Firestore Collections (structure)</strong></div>
      <div><span class="schema-toggle" id="schemaToggle">Show/Hide</span></div>
    </div>
    <pre id="schemaPre" style="display:none;margin-top:8px;white-space:pre-wrap">
/* Recommended Firestore structure for the playground (uses UID)
 *
 * Collection: usersPrivate (existing)
 *   Document ID: {uid}
 *     - name: string
 *     - email: string
 *     - slug: string
 *     - profilePhotoUrl: string
 *     - ... other profile fields
 *
 * Collection: publicProfiles (existing)
 *   Document ID: {slug} or {uid}
 *     - name, profilePhotoUrl, visibility, joinDate, publicPostCount, etc.
 *
 * New collection for game stats:
 * Collection: gameScores
 *   Document ID: {uid}
 *     - collected: number        // last saved collected score
 *     - high: number             // user high score
 *     - lastUpdated: timestamp
 *     - saveCount: number
 *     - autoMode: boolean (opt-in)
 *     - clientTs: timestamp (client time when saved)
 *
 * Optional leaderboard view:
 * Collection: leaderboard (or you can query gameScores ordered by 'high')
 *   Document ID: auto-generated or {uid}
 *     - uid: string
 *     - high: number
 *     - displayName: string (optional - avoid sensitive data)
 *     - lastUpdated: timestamp
 *
 * Security note: Use Firestore rules to allow users to write only their own gameScores/{uid} doc.
 */
    </pre>
  </div>

  <!-- Footer restored -->
  <footer class="footer">
    <div class="footer-col">
      <div>
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together â€” join now to explore the Galaxy!
        </div>
      </div>
      <div style="margin-top:auto">
        <div style="display:flex;gap:12px">
          <a href="https://x.com/teamgalaxy_wotb" title="Twitter"><i class="fab fa-twitter"></i></a>
          <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
          <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
          <a href="#" title="YouTube"><i class="fab fa-youtube"></i></a>
          <a href="https://discord.gg/26pSCyMRPM" title="Discord"><i class="fab fa-discord"></i></a>
        </div>
      </div>
    </div>

    <div class="footer-col">
      <div class="footer-links">
        <a href="legal/privacy_policy.html">Privacy Policy</a>
        <a href="legal/terms_and_conditions.html">Terms & Conditions</a>
        <a href="about_us.html">About</a>
      </div>
      <div>
        <div class="footer-contact-row"><span class="footer-contact-label"><i class="fa-solid fa-location-dot footer-contact-icon"></i>Address:</span>44 Galaxy St, Universe City, WebLand</div>
        <div class="footer-contact-row"><span class="footer-contact-label"><i class="fa-solid fa-phone footer-contact-icon"></i>Phone:</span>+91-9876543210</div>
        <div class="footer-contact-row"><span class="footer-contact-label"><i class="fa-solid fa-envelope footer-contact-icon"></i>Email:</span>support@gmail.com</div>
      </div>
    </div>
  </footer>

  <!-- FIREBASE + GAME LOGIC -->
  <script type="module">
    /* ======= FIREBASE INITIALIZATION (v11.9.0) =======
     * Uses same firebaseConfig you used earlier.
     * Make sure your Firestore rules allow:
     *  - authenticated user can write to /gameScores/{uid} only when request.auth.uid == uid
     *  - read rules as needed (leaderboard maybe public)
     */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc, serverTimestamp, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ---------- Small UI refs ----------
    const playground = document.getElementById('playgroundCard');
    const canvas = document.getElementById('playCanvas');
    const earthEl = document.getElementById('earthEl');
    const collectedEl = document.getElementById('collected');
    const highscoreEl = document.getElementById('highscore');
    const btnSpawn = document.getElementById('btnSpawn');
    const btnClear = document.getElementById('btnClear');
    const btnAuto = document.getElementById('btnAuto');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');
    const schemaToggle = document.getElementById('schemaToggle');
    const schemaPre = document.getElementById('schemaPre');

    // ---------- Local state ----------
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    let W = 0, H = 0;
    let last = performance.now();
    let nextId = 1;
    const MAX_ORBS = 30;
    let orbs = [];
    let pops = [];
    let stars = [];
    const ORB_TYPES = [
      { name:'common', chance:0.75, size:10, score:1, color:'#8EE7FF' },
      { name:'uncommon', chance:0.18, size:14, score:3, color:'#FFD57B' },
      { name:'rare', chance:0.06, size:18, score:6, color:'#B8FF9A' },
      { name:'epic', chance:0.01, size:22, score:12, color:'#FF9AD6' }
    ];

    // storage keys for local fallback
    const LS_COL = 'galaxy_collected_v_firestore';
    const LS_HIGH = 'galaxy_high_v_firestore';
    const LS_AUTO = 'galaxy_auto_v_firestore';

    // user score state (keeps in memory and syncs to Firestore on save)
    let collected = parseInt(localStorage.getItem(LS_COL)) || 0;
    let high = parseInt(localStorage.getItem(LS_HIGH)) || 0;
    let autoMode = localStorage.getItem(LS_AUTO) === '1';
    let currentUser = null; // firebase user
    let authReady = false;

    // utils
    function rand(a,b){ return a + Math.random()*(b-a); }
    function pickType(){
      const r = Math.random(); let s = 0;
      for(const t of ORB_TYPES){ s += t.chance; if (r <= s) return t; } return ORB_TYPES[0];
    }
    function hexToRgb(hex){ const s = hex.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }

    // ===== Canvas & rendering setup (single canvas blended into page)
    const ctx = canvas.getContext('2d', { alpha:true });
    function resize() {
      const rect = playground.getBoundingClientRect();
      W = Math.max(200, Math.floor(rect.width));
      H = Math.max(160, Math.floor(rect.height));
      canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
      canvas.width = Math.floor(W * DPR); canvas.height = Math.floor(H * DPR);
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      initStars();
    }
    window.addEventListener('resize', resize);

    // star background (low-cost)
    function initStars(){
      stars.length = 0;
      const count = Math.max(18, Math.round((W*H)/70000));
      for(let i=0;i<count;i++) stars.push({ x:Math.random()*W, y:Math.random()*H, s:Math.random()*1.6+0.4, phase:Math.random()*Math.PI*2 });
    }

    // spawn orb
    function spawnOrbAt(clientX, clientY){
      if (orbs.length >= MAX_ORBS) return;
      const rect = playground.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const dx = clientX - cx; const dy = clientY - cy;
      let radius = Math.hypot(dx, dy);
      const minRadius = Math.max(72, Math.min(rect.width, rect.height)/6);
      const maxRadius = Math.min(rect.width, rect.height)/2 - 30;
      radius = Math.max(minRadius, Math.min(maxRadius, radius));
      const angle = Math.atan2(dy, dx);
      const baseSpeed = 0.9 / Math.sqrt(Math.max(1, radius/90));
      const speed = (Math.random() < 0.5 ? 1 : -1) * baseSpeed * (0.6 + Math.random()*0.9);
      const type = pickType();
      const orb = {
        id: nextId++,
        angle, radius, speed,
        size: type.size * (0.9 + Math.random()*0.2),
        color: type.color, score: type.score, rarity: type.name,
        rotation: Math.random()*Math.PI*2,
        rotSpeed: (Math.random()*0.9-0.45)*0.02
      };
      orbs.push(orb);
      playSpawnTone();
    }

    function burst(n=3){
      const rect = playground.getBoundingClientRect();
      for(let i=0;i<n;i++){
        spawnOrbAt(rect.left + rect.width/2 + rand(-120,120), rect.top + rect.height/2 + rand(-90,90));
      }
    }

    // hit test (for touch-friendly big hit radius)
    function toLocalCoords(clientX, clientY){
      const rect = playground.getBoundingClientRect();
      return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function hitTest(x,y){
      let best=null, bestD=Infinity;
      const rect = playground.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      for(const o of orbs){
        const ox = cx + o.radius * Math.cos(o.angle), oy = cy + o.radius * Math.sin(o.angle);
        const d = Math.hypot(x-ox, y-oy);
        const hitR = Math.max(18, o.size*1.6);
        if (d <= hitR && d < bestD){ best = o; bestD = d; }
      }
      return best;
    }

    function collectOrb(o){
      if(!o) return;
      spawnPopForOrb(o);
      collected += o.score;
      if (collected > high){ high = collected; localStorage.setItem(LS_HIGH, high); flashHigh(); }
      localStorage.setItem(LS_COL, collected);
      collectedEl.textContent = 'Collected: ' + collected;
      // remove orb
      orbs = orbs.filter(x => x.id !== o.id);
      playCollectTone(360 + o.score*48);
    }

    function spawnPopForOrb(o){
      const rect = playground.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2;
      const x = cx + o.radius * Math.cos(o.angle); const y = cy + o.radius * Math.sin(o.angle);
      const rgb = hexToRgb(o.color);
      const parts = []; const count = Math.min(28, Math.round(6 + o.size*1.2));
      for(let i=0;i<count;i++){
        const ang = Math.random()*Math.PI*2;
        parts.push({ vx: Math.cos(ang)*(0.6 + Math.random()*2.6), vy: Math.sin(ang)*(0.6 + Math.random()*2.6), size: Math.random()*(o.size*0.6)+0.6, color: `rgba(${rgb.r},${rgb.g},${rgb.b},` });
      }
      pops.push({ x,y, parts, life:1, lifeMax:1, speed: 42 + o.size*6 });
    }

    // draw functions (optimized)
    function drawBackgroundStars(now){
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      for(const s of stars){
        const a = 0.22 + 0.18*Math.abs(Math.sin(now/1200 + s.phase));
        ctx.fillStyle = `rgba(210,235,255,${a})`;
        ctx.beginPath(); ctx.ellipse(s.x, s.y, s.s, s.s, 0,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }
    function drawOrbits(now, dt){
      const rect = playground.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      ctx.save(); ctx.strokeStyle = 'rgba(160,200,255,0.03)'; ctx.lineWidth = 1;
      // optional: draw just light ellipse for first N orbs to avoid overload
      for(const o of orbs){ ctx.beginPath(); ctx.ellipse(cx, cy, o.radius, o.radius, 0, 0, Math.PI*2); ctx.stroke(); }
      ctx.restore();

      for(const o of orbs){
        o.angle += o.speed * dt;
        o.rotation += o.rotSpeed;
        const x = cx + o.radius * Math.cos(o.angle), y = cy + o.radius * Math.sin(o.angle);
        // draw glow
        ctx.save(); ctx.translate(x,y); ctx.rotate(o.rotation);
        const g = ctx.createRadialGradient(0,0,o.size*0.2, 0,0,o.size*3.2);
        const rgb = hexToRgb(o.color);
        g.addColorStop(0, `rgba(${rgb.r},${rgb.g},${rgb.b},0.85)`); g.addColorStop(0.25, `rgba(${rgb.r},${rgb.g},${rgb.b},0.28)`); g.addColorStop(1, `rgba(${rgb.r},${rgb.g},${rgb.b},0.0)`);
        ctx.fillStyle = g; ctx.beginPath(); ctx.ellipse(0,0, o.size*1.9, o.size*0.95, 0,0,Math.PI*2); ctx.fill();
        // body
        ctx.fillStyle = '#0c1116'; ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1; ctx.beginPath(); ctx.roundRect(-o.size*0.6, -o.size*0.4, o.size*1.2, o.size*0.8, o.size*0.18); ctx.fill(); ctx.stroke();
        // panels & little details
        // left panel
        ctx.save(); ctx.translate(-o.size*1.05,0); ctx.rotate(Math.sin(now/600 + o.id)*0.05);
        ctx.fillStyle = '#091521'; ctx.fillRect(-o.size*0.55, -o.size*0.42, o.size*0.6, o.size*0.86);
        ctx.strokeStyle = 'rgba(60,120,140,0.12)'; ctx.lineWidth=1;
        for(let i=-2;i<=2;i++){ ctx.beginPath(); ctx.moveTo(-o.size*0.5 + i*(o.size*0.1), -o.size*0.4); ctx.lineTo(-o.size*0.5 + i*(o.size*0.1), o.size*0.4); ctx.stroke(); }
        ctx.restore();
        // right panel
        ctx.save(); ctx.translate(o.size*1.05,0); ctx.rotate(Math.sin(now/700 + o.id)*0.06);
        ctx.fillStyle = '#091521'; ctx.fillRect(-o.size*0.05, -o.size*0.42, o.size*0.6, o.size*0.86);
        ctx.strokeStyle = 'rgba(60,120,140,0.12)';
        for(let i=-2;i<=2;i++){ ctx.beginPath(); ctx.moveTo(-o.size*0.0 + i*(o.size*0.1), -o.size*0.4); ctx.lineTo(-o.size*0.0 + i*(o.size*0.1), o.size*0.4); ctx.stroke(); }
        ctx.restore();
        // antenna
        ctx.beginPath(); ctx.moveTo(o.size*0.64, -o.size*0.02); ctx.lineTo(o.size*0.98, -o.size*0.6); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1; ctx.stroke();
        ctx.beginPath(); ctx.arc(o.size*0.98, -o.size*0.6, 1.6, 0, Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fill();
        // rarity badge
        if (o.rarity === 'rare' || o.rarity === 'epic'){
          ctx.beginPath(); ctx.arc(o.size*0.6, -o.size*0.36, o.size*0.36, 0, Math.PI*2); ctx.fillStyle = o.color; ctx.fill();
          ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = `${Math.max(7,o.size*0.28)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(o.rarity[0].toUpperCase(), o.size*0.6, -o.size*0.36);
        }

        ctx.restore();
        // save screen pos for interaction
        o.screenX = x; o.screenY = y;
      }
    }

    function drawPops(now, dt){
      ctx.save();
      for(let i=pops.length-1;i>=0;i--){
        const p = pops[i];
        p.life -= dt / 400;
        const alpha = Math.max(0, p.life / p.lifeMax);
        for(const part of p.parts){
          const px = p.x + part.vx * (1 - alpha) * p.speed;
          const py = p.y + part.vy * (1 - alpha) * p.speed;
          const s = Math.max(0.6, part.size * alpha);
          ctx.fillStyle = part.color + (0.85 * alpha) + ')';
          ctx.beginPath(); ctx.ellipse(px, py, s, s, 0,0,Math.PI*2); ctx.fill();
        }
        if (p.life <= 0) pops.splice(i,1);
      }
      ctx.restore();
    }

    function drawVignette(){
      const g = ctx.createRadialGradient(W/2, H/2, Math.max(W,H)/6, W/2, H/2, Math.max(W,H)/1.0);
      g.addColorStop(0,'rgba(255,255,255,0)');
      g.addColorStop(1,'rgba(0,0,0,0.20)');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    }

    function loop(now){
      requestAnimationFrame(loop);
      updateAndDraw(now);
    }
    function updateAndDraw(now){
      const dt = Math.max(8, now - last); // ms
      last = now;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = 'rgba(6,8,12,0.16)';
      ctx.fillRect(0,0,W,H);
      drawBackgroundStars(now);
      drawOrbits(now, dt / 1000);
      drawPops(now, dt);
      drawVignette();
    }

    // pointer handling: we listen on playground (canvas has pointer-events none)
    function handlePointerDown(e){
      if(e.pointerType === 'mouse' && e.button !== 0) return;
      const p = toLocalCoords(e.clientX, e.clientY);
      const found = hitTest(p.x, p.y);
      if(found){ collectOrb(found); return; }
      spawnOrbAt(e.clientX, e.clientY);
    }
    playground.addEventListener('pointerdown', handlePointerDown);

    // controls
    btnSpawn.addEventListener('click', ()=> burst(3));
    btnClear.addEventListener('click', ()=> { orbs = []; pops = []; ctx.clearRect(0,0,W,H); });
    btnAuto.addEventListener('click', ()=> { autoMode = !autoMode; localStorage.setItem(LS_AUTO, autoMode ? '1':'0'); btnAuto.textContent = 'Auto: ' + (autoMode ? 'On':'Off'); });

    // auto spawn
    setInterval(()=> { if (autoMode && orbs.length < 10 && Math.random() < 0.6) burst(1); }, 1400);
    window.addEventListener('keydown', (e)=> { if (e.code === 'Space'){ e.preventDefault(); const rect=playground.getBoundingClientRect(); spawnOrbAt(rect.left + rect.width/2 + rand(-90,90), rect.top + rect.height/2 + rand(-60,60)); } });

    // simple audio (tones)
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ensureAudio(){ if (!audioCtx) audioCtx = new AudioCtx(); }
    function playTone(freq=420, dur=0.08){ try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.setValueAtTime(0.001, now); g.gain.exponentialRampToValueAtTime(0.12, now + 0.01); g.gain.exponentialRampToValueAtTime(0.0001, now + dur); o.start(now); o.stop(now + dur + 0.02);}catch(e){} }
    function playSpawnTone(){ playTone(240,0.06); } function playCollectTone(freq){ playTone(freq, 0.12); }
    document.addEventListener('pointerdown', ()=> { if (!audioCtx) try{ ensureAudio(); }catch(e){} }, { once:true });

    // UI init
    function initUI(){ collectedEl.textContent = 'Collected: ' + collected; highscoreEl.textContent = 'High: ' + high; btnAuto.textContent = 'Auto: ' + (autoMode ? 'On':'Off'); }

    // save game score to Firestore (uses UID). Throttled by caller usage.
    async function saveToFirestore() {
      if (!authReady || !currentUser) {
        alert('Sign in to save to the cloud. Use the Sign In button in the top-right (Profile) â€” your UID will be used to store scores.');
        return;
      }
      try {
        const docRef = doc(db, 'gameScores', currentUser.uid);
        const payload = {
          collected,
          high,
          lastUpdated: serverTimestamp(),
          clientTs: new Date().toISOString(),
          saveCount: (await readSaveCount(currentUser.uid)) + 1
        };
        // Merge/update
        await setDoc(docRef, payload, { merge: true });
        alert('Saved to cloud (gameScores/' + currentUser.uid + ').');
      } catch (err) {
        console.error('save fail', err);
        alert('Save failed: ' + (err.message || err));
      }
    }

    async function readSaveCount(uid){
      try{
        const docRef = doc(db,'gameScores', uid);
        const snap = await getDoc(docRef);
        if (snap.exists()){ return snap.data().saveCount || 0; }
      }catch(e){ console.warn('readSaveCount err', e); }
      return 0;
    }

    // image download of current high-score: builds an image with game stats only (no personal data)
    function downloadHighscoreImage() {
      // Create an export canvas
      const w = 1200, h = 640;
      const c = document.createElement('canvas'); c.width = w; c.height = h;
      const g = c.getContext('2d');
      // background gradient
      const grad = g.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, '#071018'); grad.addColorStop(1, '#081428');
      g.fillStyle = grad; g.fillRect(0,0,w,h);
      // subtle stars
      for (let i=0;i<120;i++){
        g.fillStyle = 'rgba(210,235,255,' + (0.03 + Math.random()*0.12) + ')';
        const x = Math.random()*w, y = Math.random()*h, s = Math.random()*2.6;
        g.beginPath(); g.ellipse(x,y,s,s,0,0,Math.PI*2); g.fill();
      }
      // Earth emoji large (center-left)
      g.font = '140px serif';
      g.fillText('ðŸŒŽ', 110, 220);
      // Title & stats
      g.fillStyle = '#fff'; g.font = 'bold 38px Poppins, Arial, sans-serif'; g.fillText('Team Galaxy â€” Orbit Playground', 320, 120);
      g.fillStyle = '#bfeaff'; g.font = '600 26px Poppins, Arial, sans-serif'; g.fillText('Game stats (public):', 320, 170);
      g.fillStyle = '#fff'; g.font = '700 64px Poppins, Arial, sans-serif'; g.fillText('High: ' + high, 320, 260);
      g.fillStyle = '#9fd8ff'; g.font = '600 40px Poppins, Arial, sans-serif'; g.fillText('Collected: ' + collected, 320, 330);
      // date/time
      const dt = new Date(); const dtStr = dt.toLocaleString();
      g.fillStyle = 'rgba(255,255,255,0.7)'; g.font = '400 18px Poppins, Arial, sans-serif'; g.fillText('Generated: ' + dtStr, 320, 380);
      // small footer
      g.fillStyle = 'rgba(255,255,255,0.6)'; g.font = '400 16px Poppins, Arial, sans-serif'; g.fillText('No personal data included â€” Team Galaxy', 40, h - 28);
      // convert and download
      c.toBlob(function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'teamgalaxy-score-' + Date.now() + '.png';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }, 'image/png');
    }

    // attach save & download handlers
    btnSave.addEventListener('click', saveToFirestore);
    btnDownload.addEventListener('click', downloadHighscoreImage);

    // schema toggle
    schemaToggle.addEventListener('click', ()=> {
      schemaPre.style.display = schemaPre.style.display === 'none' ? 'block' : 'none';
    });

    // Authentication: watch state
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      authReady = true;
      // update UI if needed
      if (user) {
        // try to prefill from Firestore (get user's saved scores)
        (async ()=>{
          try{
            const ref = doc(db,'gameScores', user.uid);
            const snap = await getDoc(ref);
            if (snap.exists()){
              const d = snap.data();
              // use cloud values preferentially if they exist
              if (typeof d.high === 'number' && d.high > (parseInt(localStorage.getItem(LS_HIGH))||0)){
                high = d.high; localStorage.setItem(LS_HIGH, high);
              }
              if (typeof d.collected === 'number') { collected = d.collected; localStorage.setItem(LS_COL, collected); }
              collectedEl.textContent = 'Collected: ' + collected; highscoreEl.textContent = 'High: ' + high;
            }
          }catch(e){ console.warn('prefetch gameScores err', e); }
        })();
      }
    });

    // Download/Share code relies on local or cloud; saving to Firestore requires sign-in
    // Provide an in-page sign-in shortcut (top right profile is outside scope; quick signin here)
    // We'll add a lightweight sign-in if user tries to sign-in via double-click Earth
    earthEl.addEventListener('dblclick', async () => {
      if (currentUser) { alert('Signed in as: ' + (currentUser.displayName || currentUser.email)); return; }
      try{
        await signInWithPopup(auth, provider);
        alert('Signed in â€” your UID will be used to save scores.');
      }catch(e){ console.error('signin err', e); alert('Sign-in failed'); }
    });

    // small helper: flash high score when regained
    function flashHigh(){ highscoreEl.style.transform = 'scale(1.06)'; highscoreEl.style.color = '#fff'; setTimeout(()=>{ highscoreEl.style.transform=''; highscoreEl.style.color=''; }, 420); }

    // Save to local periodically (and on unload)
    setInterval(()=> localStorage.setItem(LS_COL, collected), 2000);
    window.addEventListener('beforeunload', ()=> localStorage.setItem(LS_COL, collected));

    // init and warmup
    function init() {
      DPR = Math.max(1, window.devicePixelRatio || 1);
      resize();
      // warmup / spawn initial orbs
      const rect = playground.getBoundingClientRect();
      for (let i=0;i<7;i++) spawnOrbAt(rect.left + rect.width/2 + rand(-140,140), rect.top + rect.height/2 + rand(-90,90));
      initUI();
      last = performance.now();
      requestAnimationFrame(loop);
    }
    // polyfill roundRect
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        this.beginPath(); this.moveTo(x+r, y); this.arcTo(x+w, y, x+w, y+h, r); this.arcTo(x+w, y+h, x, y+h, r); this.arcTo(x, y+h, x, y, r); this.arcTo(x, y, x+w, y, r); this.closePath();
      };
    }

    // start
    window.addEventListener('load', init);
    window.addEventListener('resize', ()=> { resize(); initStars(); });

    // quick helper to fetch top leaderboard (optional)
    async function fetchTopLeaderboard(limitN=10){
      try{
        const q = query(collection(db,'gameScores'), orderBy('high', 'desc'), limit(limitN));
        const snaps = await getDocs(q);
        return snaps.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
      }catch(e){ console.warn('leaderboard fetch failed', e); return []; }
    }

    // expose a little API on window for debugging (optional)
    window.__galaxy = { spawnOrbAt, burst, fetchTopLeaderboard };

  </script>
</body>
</html>
