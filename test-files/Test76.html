<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SquadVertex Live Stream</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
    #videoContainer { margin-bottom: 1rem; }
    #commentsList p { border-bottom: 1px solid #ddd; padding: .5rem 0; }
    button { padding: .5rem 1rem; margin: .5rem 0; }
    textarea { width: 100%; height: 4rem; margin-bottom: .5rem; }
  </style>

  <!-- Wistia Player script (once) -->
  <script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>▶️ SquadVertex Live Stream</h1>
  <div id="videoContainer">Loading live stream…</div>
  <div id="metadata"></div>

  <hr>

  <h2>👍/👎 Voting</h2>
  <button id="btnLike">Like (<span id="likeCount">0</span>)</button>
  <button id="btnDislike">Dislike (<span id="dislikeCount">0</span>)</button>

  <hr>

  <h2>💬 Comments</h2>
  <div id="commentsList">Loading comments…</div>
  <textarea id="commentInput" placeholder="Write a comment"></textarea><br>
  <button id="btnComment">Post Comment</button>

  <script>
    // ── Initialize Firebase ─────────────────────────────────────────────────────
      // Firebase initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const EVENT_ID    = 'SpringLaunch2025';
    const eventRef    = db.collection('events').doc(EVENT_ID);
    const settingsRef = eventRef.collection('settings').doc('activeVideo');
    const commentsCol = eventRef.collection('comments');
    const votesCol    = eventRef.collection('votes');

    let currentVideoId = null;

    // ── 1) Listen for activeVideo changes ──────────────────────────────────────
    settingsRef.onSnapshot(snap => {
      const vid = snap.data()?.videoId || null;
      currentVideoId = vid;
      renderVideo(vid);
      loadComments(vid);
      loadVotes(vid);
    });

    // ── 2) Render Wistia embed + metadata ─────────────────────────────────────
    function renderVideo(videoId) {
      const vc = document.getElementById('videoContainer');
      vc.innerHTML = '';
      if (!videoId) {
        vc.textContent = 'No live stream currently.';
        document.getElementById('metadata').innerHTML = '';
        return;
      }
      const div = document.createElement('div');
      div.className = `wistia_embed wistia_async_${videoId}`;
      div.style.width  = '640px';
      div.style.height = '360px';
      vc.appendChild(div);

      document.getElementById('metadata').innerHTML =
        `<p><strong>Now Streaming:</strong> ${videoId}</p>`;
    }

    // ── 3) Voting ───────────────────────────────────────────────────────────────
    function loadVotes(videoId) {
      if (!videoId) return;
      votesCol.doc(videoId)
        .onSnapshot(snap => {
          const data = snap.data() || { likes: 0, dislikes: 0 };
          document.getElementById('likeCount').innerText    = data.likes;
          document.getElementById('dislikeCount').innerText = data.dislikes;
        });
    }
    function vote(isLike) {
      if (!currentVideoId) return;
      const docRef = votesCol.doc(currentVideoId);
      db.runTransaction(tx => {
        return tx.get(docRef).then(doc => {
          const data = doc.exists ? doc.data() : { likes:0, dislikes:0 };
          data[isLike ? 'likes' : 'dislikes']++;
          data.lastUpdated = Date.now();
          tx.set(docRef, data);
        });
      }).catch(console.error);
    }
    document.getElementById('btnLike').onclick    = () => vote(true);
    document.getElementById('btnDislike').onclick = () => vote(false);

    // ── 4) Comments ────────────────────────────────────────────────────────────
    function loadComments(videoId) {
      const list = document.getElementById('commentsList');
      if (!videoId) {
        list.innerHTML = '<p>No comments.</p>';
        return;
      }
      commentsCol
        .where('videoId', '==', videoId)
        .orderBy('timestamp')
        .onSnapshot(snap => {
          list.innerHTML = '';
          snap.forEach(d => {
            const cm = d.data();
            const p = document.createElement('p');
            p.textContent = `[${new Date(cm.timestamp).toLocaleTimeString()}] ${cm.text}`;
            list.appendChild(p);
          });
        });
    }
    document.getElementById('btnComment').onclick = () => {
      const txt = document.getElementById('commentInput').value.trim();
      if (!txt || !currentVideoId) return;
      commentsCol.add({
        videoId: currentVideoId,
        text: txt,
        timestamp: Date.now()
      });
      document.getElementById('commentInput').value = '';
    };

    // ── 5) Disable Replay & Download ───────────────────────────────────────────
    window._wq = window._wq || [];
    _wq.push({
      onReady: function(video) {
        video.bind('end', () => {
          video.pause();
          video.controls(false);
          alert('Stream ended — come back during the next live video!');
        });
      }
    });
  </script>
</body>
</html>