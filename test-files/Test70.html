<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Universal Fees Chart</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Container styling: reduced width and centered */
      .module-container {
        max-width: 700px;
        margin: 30px auto;
        padding: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
      }
      .module-container h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }
      .note {
        font-size: 0.95rem;
        color: #555;
        margin-bottom: 15px;
      }
      table {
        margin-bottom: 15px;
      }
      table th,
      table td {
        vertical-align: middle;
      }
      .nav-btns {
        margin-top: 20px;
      }
      /* Skeleton styling */
      .skeleton {
        height: 1.2em;
        width: 100%;
        background-color: #e2e2e2;
        margin-bottom: 0.5em;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: -100%; }
        100% { background-position: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="module-container">
      <h2 class="mb-3">Universal Fees Chart</h2>
      <p class="note">
        Note: Admission fees are not included in this chart; they will be collected separately.
      </p>
      <!-- Module Controller Checkbox -->
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="fees-module-checkbox" />
        <label class="form-check-label" for="fees-module-checkbox">Enable Fees Module</label>
      </div>
      
      <!-- Fees Chart Form -->
      <form id="fees-chart-form">
        <table class="table table-bordered" id="fees-chart-table">
          <thead class="table-dark">
            <tr>
              <th>Class</th>
              <th>Stream</th>
              <th>Base Fee (â‚¹)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic rows will be inserted here -->
          </tbody>
        </table>
        <!-- Save button (if you already have a separate controller, you may remove this) -->
        <button type="submit" class="btn btn-primary">Save Fees Chart</button>
      </form>
      <div id="save-status" class="mt-3"></div>
      <!-- Button to add a new row -->
      <button type="button" id="add-row-btn" class="btn btn-secondary mt-3">Add Row</button>
    </div>

    <!-- Firebase Libraries (Assuming Firebase is already initialized on your admin panel) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
      // Firebase Initialization (if not already done elsewhere)
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();

      // Dropdown options for class and stream
      const classOptions = [
        "Nursery",
        "KG",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12"
      ];
      const streamOptions = ["Arts", "Commerce", "Science", "Agriculture", "Nothing"];

      // Function to add a new fees chart row (with auto-select if feesData is provided)
      function addFeesChartRow(feesData = null) {
        const tbody = document.querySelector("#fees-chart-table tbody");
        const tr = document.createElement("tr");

        // Create Class dropdown
        let classSelectHTML = '<select class="form-select class-select" required>';
        classSelectHTML += '<option value="">Select Class</option>';
        classOptions.forEach((opt) => {
          const selected = feesData && feesData.class === opt ? 'selected' : "";
          classSelectHTML += `<option value="${opt}" ${selected}>${opt}</option>`;
        });
        classSelectHTML += '</select>';

        // Create Stream dropdown
        let streamSelectHTML = '<select class="form-select stream-select" required>';
        streamSelectHTML += '<option value="">Select Stream</option>';
        streamOptions.forEach((opt) => {
          const selected = feesData && feesData.stream === opt ? 'selected' : "";
          streamSelectHTML += `<option value="${opt}" ${selected}>${opt}</option>`;
        });
        streamSelectHTML += '</select>';

        // Base fee input field
        const feeValue = feesData && feesData.baseFee ? feesData.baseFee : "";
        const feeInputHTML = `<input type="number" class="form-control fee-input" placeholder="Enter fee" value="${feeValue}" required />`;

        // Delete button with proper styling
        const delButtonHTML = '<button type="button" class="btn btn-danger btn-sm delete-row-btn">Delete</button>';

        tr.innerHTML = `<td>${classSelectHTML}</td>
                        <td>${streamSelectHTML}</td>
                        <td>${feeInputHTML}</td>
                        <td>${delButtonHTML}</td>`;
        tbody.appendChild(tr);

        // Attach event listener for delete
        tr.querySelector(".delete-row-btn").addEventListener("click", () => {
          tr.remove();
        });
      }

      // Auto-load existing fees chart from systemSettings
      function loadFeesChart() {
        db.collection("001-school").doc("systemSettings").get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              // Set fees module checkbox
              document.getElementById("fees-module-checkbox").checked = !!data.feesModuleEnabled;
              // Load universalFeesChart if available
              if (data.universalFeesChart && data.universalFeesChart.length > 0) {
                document.querySelector("#fees-chart-table tbody").innerHTML = "";
                data.universalFeesChart.forEach(feesRow => {
                  addFeesChartRow(feesRow);
                });
              } else {
                addFeesChartRow();
              }
            } else {
              addFeesChartRow();
            }
          })
          .catch(err => {
            console.error("Error loading fees chart data:", err);
          });
      }
      window.addEventListener("DOMContentLoaded", loadFeesChart);

      // Add row button
      document.getElementById("add-row-btn").addEventListener("click", () => {
        addFeesChartRow();
      });

      // Form submission: Save fees chart data into systemSettings
      document.getElementById("fees-chart-form").addEventListener("submit", function(e) {
        e.preventDefault();
        // Gather all rows' data
        const rows = document.querySelectorAll("#fees-chart-table tbody tr");
        let feesChart = [];
        rows.forEach(row => {
          const classVal = row.querySelector(".class-select").value;
          const streamVal = row.querySelector(".stream-select").value;
          const feeVal = row.querySelector(".fee-input").value;
          feesChart.push({
            class: classVal,
            stream: streamVal,
            baseFee: parseFloat(feeVal)
          });
        });
        const feesModuleEnabled = document.getElementById("fees-module-checkbox").checked;
        // Save to systemSettings document
        db.collection("001-school").doc("systemSettings").update({
          universalFeesChart: feesChart,
          feesModuleEnabled: feesModuleEnabled,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById("save-status").innerHTML = '<div class="alert alert-success">Universal Fees Chart saved successfully!</div>';
        })
        .catch(err => {
          console.error("Error saving fees chart:", err);
          document.getElementById("save-status").innerHTML = `<div class="alert alert-danger">Error saving fees chart: ${err.message}</div>`;
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>