<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... (keep existing head content unchanged) ... -->
</head>
<body>
  <!-- ... (keep existing navbar and HTML structure unchanged) ... -->

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let systemSettings = {};
    let allStudents = [];
    let vehicleRecords = {};
    let sortConfig = { column: 'no', direction: 'asc' };

    async function loadSystemSettings() {
      const [settingsSnap, vehicleSnap] = await Promise.all([
        db.collection("001-school").doc("systemSettings").get(),
        db.collection("001-school").doc("vehicleTransactions").collection("records").get()
      ]);
      
      systemSettings = settingsSnap.exists ? settingsSnap.data() : {};
      vehicleRecords = vehicleSnap.docs.reduce((acc, doc) => {
        acc[doc.id] = doc.data();
        return acc;
      }, {});
    }

    async function loadStudents() {
      const querySnapshot = await db.collection("001-school").doc("students").collection("list").get();
      allStudents = await Promise.all(querySnapshot.docs.map(async doc => {
        const student = doc.data();
        const studentId = doc.id;
        
        // Get transactions
        const payments = await db.collection("001-school").doc("transactions")
          .collection(`class${student.class}`).doc(studentId).collection("payments").get();
        
        // Get vehicle record
        const vehicleRecord = vehicleRecords[studentId] || { eligible: 'No' };
        
        return { ...student, id: studentId, payments, vehicleRecord };
      }));

      applyFiltersAndSort();
    }

    function calculateFees(student) {
      // Base fee calculation
      const baseFee = (systemSettings.universalFeesChart || []).find(f => 
        f.class === student.class && f.stream === student.stream
      )?.baseFee || 0;

      // Discount
      const discount = student.discount || 0;

      // Vehicle fee calculation
      let vehicleTotal = 0;
      if (student.vehicleRecord.eligible === 'Yes' && student.vehicleRecord.vehicleData) {
        const { rent, months = [] } = student.vehicleRecord.vehicleData;
        vehicleTotal = (parseFloat(rent) || 0) * months.length;
      }

      // Payment calculations
      const paid = student.payments.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
      const finalTotal = (baseFee - discount) + vehicleTotal;
      const pending = finalTotal - paid;

      // Vehicle payments (simplified example)
      const vehiclePaid = 0; // You'd need actual vehicle payment data
      const vehiclePending = vehicleTotal - vehiclePaid;

      return {
        baseFee,
        discount,
        finalTotal,
        paid,
        pending,
        vehicleTotal,
        vehiclePaid,
        vehiclePending,
        status: pending <= 0 ? 'Paid' : paid > 0 ? 'Partial' : 'Pending'
      };
    }

    function applyFiltersAndSort() {
      const searchTerm = document.getElementById('student-search').value.toLowerCase();
      const classFilter = document.getElementById('class-filter').value;
      const streamFilter = document.getElementById('stream-filter').value;
      const vehicleFilter = document.getElementById('vehicle-status-filter').value;

      const filtered = allStudents.filter(student => {
        const matchesSearch = [student.srNumber, student.studentName, student.fatherName]
          .some(field => field?.toLowerCase().includes(searchTerm));
        
        const matchesClass = !classFilter || student.class === classFilter;
        const matchesStream = !streamFilter || student.stream === streamFilter;
        
        const vehicleStatus = student.vehicleRecord.eligible === 'Yes' ? 
          (student.vehicleRecord.vehicleData?.months?.length > 0 ? 'not_pending' : 'pending') : 'not_pending';
        const matchesVehicle = vehicleFilter === 'both' || vehicleFilter === vehicleStatus;

        return matchesSearch && matchesClass && matchesStream && matchesVehicle;
      });

      // Sorting
      filtered.sort((a, b) => {
        const valA = getSortValue(a, sortConfig.column);
        const valB = getSortValue(b, sortConfig.column);
        return sortConfig.direction === 'asc' ? compare(valA, valB) : compare(valB, valA);
      });

      renderStudents(filtered);
    }

    function getSortValue(student, column) {
      const fees = calculateFees(student);
      switch(column) {
        case 'no': return student.srNumber;
        case 'name': return student.studentName;
        case 'class': return student.class;
        case 'pending': return fees.pending;
        case 'vehiclePending': return fees.vehiclePending;
        default: return fees[column] || 0;
      }
    }

    function compare(a, b) {
      if (typeof a === 'string') return a.localeCompare(b);
      return (a || 0) - (b || 0);
    }

    function renderStudents(students) {
      const tbody = document.querySelector("#students-table tbody");
      tbody.innerHTML = "";

      students.forEach(student => {
        const fees = calculateFees(student);
        const row = document.createElement('tr');
        row.className = `status-${fees.status.toLowerCase()}`;
        
        row.innerHTML = `
          <td>${student.srNumber}</td>
          <td>${student.studentName}</td>
          <td>${student.fatherName}</td>
          <td>${student.class}</td>
          <td>${student.stream}</td>
          <td>₹${fees.baseFee}</td>
          <td>₹${fees.discount}</td>
          <td>₹${fees.finalTotal}</td>
          <td>₹${fees.paid}</td>
          <td>₹${fees.pending}</td>
          <td>₹${fees.vehicleTotal}</td>
          <td>₹${fees.vehiclePaid}</td>
          <td>₹${fees.vehiclePending}</td>
          <td>${fees.status}</td>
          <td>
            <button class="btn btn-sm btn-info" onclick="loadStudentDetails('${student.id}')">
              View Details
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Add sorting handlers
    document.querySelectorAll('#students-table th').forEach(header => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', () => {
        const column = header.textContent.toLowerCase().replace(/ /g, '');
        sortConfig = {
          column,
          direction: sortConfig.column === column && sortConfig.direction === 'asc' ? 'desc' : 'asc'
        };
        applyFiltersAndSort();
      });
    });

    // Add filter event listeners
    ['input', 'change'].forEach(event => {
      document.getElementById('student-search').addEventListener(event, applyFiltersAndSort);
      document.getElementById('class-filter').addEventListener(event, applyFiltersAndSort);
      document.getElementById('stream-filter').addEventListener(event, applyFiltersAndSort);
      document.getElementById('vehicle-status-filter').addEventListener(event, applyFiltersAndSort);
    });

    // ... (keep existing loadStudentDetails function mostly unchanged, but update fee calculations) ...

    window.addEventListener('DOMContentLoaded', async () => {
      await loadSystemSettings();
      await loadStudents();
    });
  </script>
</body>
</html>