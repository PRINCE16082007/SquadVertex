<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fee Management - Transactions</title>
  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">FeeManage</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="students.html">Students</a></li>
        <li class="nav-item active"><a class="nav-link" href="transactions.html">Transactions</a></li>
      </ul>
    </div>
  </nav>

  <!-- Transactions Content -->
  <div class="container mt-4">
    <h3 class="mb-4">Transaction History</h3>

    <!-- Filters -->
    <div class="row mb-3">
      <div class="col-md-3">
        <input type="date" id="start-date" class="form-control" placeholder="Start Date">
      </div>
      <div class="col-md-3">
        <input type="date" id="end-date" class="form-control" placeholder="End Date">
      </div>
      <div class="col-md-3">
        <select id="mode-filter" class="form-control">
          <option value="">Payment Mode</option>
          <option value="Cash">Cash</option>
          <option value="UPI">UPI</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Cheque">Cheque</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary btn-block" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <!-- Transactions Table (Family ID column removed) -->
    <table class="table table-striped" id="transactionsTable">
      <thead class="thead-dark">
        <tr>
          <th>Roll No</th>
          <th>Name</th>
          <th>Amount Paid</th>
          <th>Mode</th>
          <th>Transaction ID</th>
          <th>Date & Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="transactions-table">
        <!-- Transaction rows will be populated from Firebase -->
      </tbody>
    </table>
  </div>

  <!-- Firebase (using compat versions for ease) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Replace these with your actual Firebase credentials
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Fetch transactions from Firestore and populate the table
    async function fetchTransactions() {
      try {
        // Assuming your transactions are stored in a collection called "transactions"
        const snapshot = await db.collection("transactions").get();
        const transactionsTable = document.getElementById("transactions-table");
        transactionsTable.innerHTML = ""; // Clear any existing rows

        snapshot.forEach(doc => {
          const data = doc.data();
          // Expected fields: rollNo, name, amountPaid, mode, txnId, dateTime, status
          const rollNo = data.rollNo || "";
          const name = data.name || "";
          const amountPaid = data.amountPaid ? "â‚¹" + data.amountPaid : "";
          const mode = data.mode || "";
          const txnId = data.txnId || "";
          const dateTime = data.dateTime || "";
          const status = data.status || "";

          const row = `
            <tr>
              <td>${rollNo}</td>
              <td>${name}</td>
              <td>${amountPaid}</td>
              <td>${mode}</td>
              <td>${txnId}</td>
              <td>${dateTime}</td>
              <td>${status}</td>
            </tr>
          `;
          transactionsTable.insertAdjacentHTML("beforeend", row);
        });

        // Initialize DataTables for sorting and other goodies
        $("#transactionsTable").DataTable();
      } catch (error) {
        console.error("Error fetching transactions: ", error);
      }
    }

    // Call fetchTransactions when the page loads
    window.onload = fetchTransactions;

    // Filtering function using DataTables custom search
    function applyFilters() {
      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;
      const modeFilter = document.getElementById("mode-filter").value;

      // Get the DataTable instance
      const table = $("#transactionsTable").DataTable();

      // Clear previous filters
      $.fn.dataTable.ext.search = [];

      // Custom search filter
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const dateTime = data[5] || ""; // Date & Time column index
        const mode = data[3] || ""; // Mode column index

        // Mode filtering
        if (modeFilter && mode !== modeFilter) {
          return false;
        }

        // Date range filtering
        if (startDate || endDate) {
          const transactionDate = new Date(dateTime);
          if (startDate && transactionDate < new Date(startDate)) {
            return false;
          }
          if (endDate && transactionDate > new Date(endDate)) {
            return false;
          }
        }

        return true;
      });

      table.draw();
    }
  </script>
</body>
</html>