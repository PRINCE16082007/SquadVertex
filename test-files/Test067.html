<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Enhanced Repo Stats Card ‚Äî SquadVertex</title>
    
    <link rel="stylesheet" href="styles1.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Enhanced Repo Stats Card</h1>
            <div style="color:var(--muted);margin-top:6px">Beautiful stats visualization with contributor images and detailed metrics</div>
        </div>
        
        <div id="loading" class="loading" style="display:none">Loading stats...</div>
        <div id="error" class="error" style="display:none"></div>
        <div id="enhancedStatsCardContainer"></div>
    </div>
    
    <script>
        // Function to extract query parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Function to render enhanced stats card
        function renderEnhancedStatsCard(data) {
            const container = document.getElementById('enhancedStatsCardContainer');
            
            // Validate input data
            if (!data || typeof data !== 'object') {
                showError('Invalid data provided for stats card');
                return;
            }
            
            // Start building the enhanced stats card HTML
            let html = '<div class="enhanced-stats-card">';
            
            // Header with title
            html += `
            <div class="enhanced-stats-header">
                <h2 class="enhanced-stats-title">Repository Analysis Report</h2>
                <div style="color:var(--muted);font-size:0.9rem;">${data.repoName || 'Analysis'}</div>
            </div>
            `;
            
            // Detailed stats grid
            html += '<div class="detailed-stats-grid">';
            
            // LOC card
            if (data.totalLoc !== undefined) {
                html += `
                <div class="detailed-stat">
                    <div class="detailed-stat-value" style="color:var(--blue)">${formatNumber(data.totalLoc)}</div>
                    <div class="detailed-stat-label">Lines of Code</div>
                </div>`;
            }
            
            // Files card
            if (data.totalFiles !== undefined) {
                html += `
                <div class="detailed-stat">
                    <div class="detailed-stat-value" style="color:var(--purple)">${formatNumber(data.totalFiles)}</div>
                    <div class="detailed-stat-label">Total Files</div>
                </div>`;
            }
            
            // Size card
            if (data.totalSize !== undefined) {
                html += `
                <div class="detailed-stat">
                    <div class="detailed-stat-value" style="color:var(--orange)">${formatBytes(data.totalSize)}</div>
                    <div class="detailed-stat-label">Total Size</div>
                </div>`;
            }
            
            // Repo age card
            if (data.repoAge !== undefined) {
                html += `
                <div class="detailed-stat">
                    <div class="detailed-stat-value" style="color:var(--green)">${data.repoAge}</div>
                    <div class="detailed-stat-label">Repo Age</div>
                </div>`;
            }
            
            html += '</div>';
            
            // Add spaghetti meter if available
            if (data.spaghettiLevel !== undefined) {
                const spaghettiLevel = data.spaghettiLevel;
                let spaghettiClass = '';
                let spaghettiText = '';
                
                if (spaghettiLevel <= 3) {
                    spaghettiClass = 'spaghetti-clean';
                    spaghettiText = 'Clean Code üíé';
                } else if (spaghettiLevel <= 5) {
                    spaghettiClass = 'spaghetti-medium';
                    spaghettiText = 'Moderately Complex ‚ö†Ô∏è';
                } else if (spaghettiLevel <= 8) {
                    spaghettiClass = 'spaghetti-high';
                    spaghettiText = 'Complex Nesting üçù';
                } else {
                    spaghettiClass = 'spaghetti-max';
                    spaghettiText = `High Complexity üçù`;
                }
                
                html += `
                <div class="spaghetti-meter">
                    <div class="spaghetti-title">Spaghetti Meter üçù</div>
                    <div class="spaghetti-bar-container">
                        <div class="spaghetti-bar ${spaghettiClass}" id="spaghettiBar" style="width: 0%"></div>
                    </div>
                    <div class="spaghetti-text">Maximum indentation level: ${spaghettiLevel}</div>
                </div>`;
            }
            
            // Add bus factor if available
            if (data.busFactor !== undefined) {
                const busFactor = data.busFactor;
                let busClass = '';
                let busText = '';
                
                if (busFactor === 1) {
                    busClass = 'bus-critical';
                    busText = 'Critical Risk!';
                } else if (busFactor === 2) {
                    busClass = 'bus-high';
                    busText = 'High Risk!';
                } else if (busFactor <= 4) {
                    busClass = 'bus-medium';
                    busText = 'Medium Risk';
                } else {
                    busClass = 'bus-low';
                    busText = 'Low Risk';
                }
                
                const busDescription = data.busFactorDesc || 'Distribution of work among contributors';
                
                html += `
                <div class="bus-factor">
                    <div class="bus-title">Bus Factor üöå</div>
                    <div class="bus-factor-value ${busClass}">Factor: ${busFactor}</div>
                    <div class="description">${busDescription}</div>
                </div>`;
            }
            
            // Add important comments alert if high
            if (data.totalImportantComments > 10) {
                html += `
                <div class="alert-card">
                    <div class="alert-title">‚ö†Ô∏è High TODO Count</div>
                    <div class="alert-content">This repo has ${data.totalImportantComments} pending TODOs. Consider addressing them.</div>
                </div>`;
            }
            
            // Add tech stack if available
            if (data.techStack && Array.isArray(data.techStack) && data.techStack.length > 0) {
                html += '<div class="description-section"><h4>Tech Stack</h4><div class="tech-stack">';
                data.techStack.slice(0, 10).forEach(tech => {
                    html += `<span class="tech-badge">${tech}</span>`;
                });
                if (data.techStack.length > 10) {
                    html += `<span class="tech-badge">+${data.techStack.length - 10} more</span>`;
                }
                html += '</div></div>';
            }
            
            // Add contributors section if available
            if (data.contributors && Array.isArray(data.contributors) && data.contributors.length > 0) {
                html += '<div class="contributors-section"><h3 style="margin-bottom:1rem;color:var(--gold)">Contributors</h3><div class="contributors-grid">';
                
                // Sort contributors by contributions to identify top contributor
                const sortedContributors = [...data.contributors].sort((a, b) => b.contributions - a.contributions);
                
                sortedContributors.forEach((contributor, index) => {
                    const isTopContributor = index === 0;
                    const className = isTopContributor ? 'contributor-card top-contributor' : 'contributor-card';
                    
                    html += `
                    <div class="${className}">
                        <img src="${contributor.avatar_url || 'https://via.placeholder.com/60'}" alt="${contributor.login || 'Contributor'}" class="contributor-avatar">
                        <div class="contributor-name">${contributor.login || 'Unknown'}</div>
                        <div class="contributor-contributions">${contributor.contributions || 0} commits</div>
                    </div>`;
                });
                
                html += '</div></div>';
            }
            
            // Add detailed description section
            if (data.description) {
                html += `<div class="description-section">
                    <h4>Description</h4>
                    <p>${data.description}</p>
                </div>`;
            }
            
            // Add charts container
            html += '<div class="stats-charts-container">';
            
            // Language distribution chart placeholder
            html += '<div class="stats-chart-container"><canvas id="languageChartCard"></canvas></div>';
            
            // File type distribution chart placeholder
            html += '<div class="stats-chart-container"><canvas id="typeChartCard"></canvas></div>';
            
            // LOC by language chart placeholder
            html += '<div class="stats-chart-container"><canvas id="locChartCard"></canvas></div>';
            
            html += '</div>';
            
            html += '</div>';
            
            container.innerHTML = html;
            
            // Animate spaghetti bar after DOM is updated
            setTimeout(() => {
                const spaghettiBar = document.getElementById('spaghettiBar');
                if (spaghettiBar) {
                    const spaghettiLevel = data.spaghettiLevel;
                    const maxLevel = 10; // Max expected indentation level
                    const percentage = Math.min(100, (spaghettiLevel / maxLevel) * 100);
                    spaghettiBar.style.width = `${percentage}%`;
                }
                
                // Render charts if data is available
                if (data.languageDistribution) {
                    renderLanguageChart(data.languageDistribution);
                }
                if (data.fileTypes) {
                    renderTypeChart(data.fileTypes);
                }
                if (data.locByLanguage) {
                    renderLocChart(data.locByLanguage);
                }
            }, 100);
        }
        
        // Function to render language distribution chart
        function renderLanguageChart(langDist) {
            const ctx = document.getElementById('languageChartCard').getContext('2d');
            
            // Prepare data for chart
            const labels = Object.keys(langDist);
            const data = Object.values(langDist);
            
            // Create a pie chart
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(199, 199, 199, 0.6)',
                            'rgba(83, 102, 255, 0.6)',
                            'rgba(255, 99, 255, 0.6)',
                            'rgba(99, 255, 132, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to render file type distribution chart
        function renderTypeChart(fileTypes) {
            const ctx = document.getElementById('typeChartCard').getContext('2d');
            
            // Prepare data for chart
            const labels = Object.keys(fileTypes);
            const data = Object.values(fileTypes);
            
            // Create a doughnut chart
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(199, 199, 199, 0.6)',
                            'rgba(83, 102, 255, 0.6)',
                            'rgba(255, 99, 255, 0.6)',
                            'rgba(99, 255, 132, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to render LOC by language chart
        function renderLocChart(locByLang) {
            const ctx = document.getElementById('locChartCard').getContext('2d');
            
            // Prepare data for chart
            const labels = Object.keys(locByLang);
            const data = Object.values(locByLang);
            
            // Create a bar chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Lines of Code',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // Helper function to format numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Helper function to format bytes
        function formatBytes(bytes) {
            if (!bytes && bytes !== 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }
        
        // Show error function
        function showError(msg) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = msg;
            document.getElementById('loading').style.display = 'none';
        }
        
        // Initialize the stats card
        document.addEventListener('DOMContentLoaded', () => {
            // Try to get data from localStorage first
            const cachedData = localStorage.getItem('repoStats');
            if (cachedData) {
                try {
                    const data = JSON.parse(cachedData);
                    renderEnhancedStatsCard(data);
                    return;
                } catch (e) {
                    console.error('Error parsing cached data: ', e);
                }
            }
            
            // If no cached data, try to get from URL parameters
            const totalLoc = getUrlParameter('totalLoc');
            const totalFiles = getUrlParameter('totalFiles');
            const totalSize = getUrlParameter('totalSize');
            const repoAge = getUrlParameter('repoAge');
            const spaghettiLevel = getUrlParameter('spaghettiLevel');
            const busFactor = getUrlParameter('busFactor');
            const busFactorDesc = getUrlParameter('busFactorDesc');
            const totalImportantComments = getUrlParameter('totalImportantComments');
            const repoName = getUrlParameter('repoName');
            const description = getUrlParameter('description');
            
            // Parse numeric values
            const data = {};
            if (totalLoc) data.totalLoc = parseInt(totalLoc);
            if (totalFiles) data.totalFiles = parseInt(totalFiles);
            if (totalSize) data.totalSize = parseInt(totalSize);
            if (repoAge) data.repoAge = repoAge;
            if (spaghettiLevel) data.spaghettiLevel = parseInt(spaghettiLevel);
            if (busFactor) data.busFactor = parseInt(busFactor);
            if (busFactorDesc) data.busFactorDesc = busFactorDesc;
            if (totalImportantComments) data.totalImportantComments = parseInt(totalImportantComments);
            if (repoName) data.repoName = repoName;
            if (description) data.description = description;
            
            // Get tech stack from URL parameter (comma-separated)
            const techStackParam = getUrlParameter('techStack');
            if (techStackParam) {
                data.techStack = techStackParam.split(',');
            }
            
            // Get contributors from URL parameter (JSON string)
            const contributorsParam = getUrlParameter('contributors');
            if (contributorsParam) {
                try {
                    data.contributors = JSON.parse(decodeURIComponent(contributorsParam));
                } catch (e) {
                    console.error('Error parsing contributors parameter: ', e);
                }
            }
            
            // Get language distribution from URL parameter (JSON string)
            const langDistParam = getUrlParameter('languageDistribution');
            if (langDistParam) {
                try {
                    data.languageDistribution = JSON.parse(decodeURIComponent(langDistParam));
                } catch (e) {
                    console.error('Error parsing language distribution parameter: ', e);
                }
            }
            
            // Get file types from URL parameter (JSON string)
            const fileTypesParam = getUrlParameter('fileTypes');
            if (fileTypesParam) {
                try {
                    data.fileTypes = JSON.parse(decodeURIComponent(fileTypesParam));
                } catch (e) {
                    console.error('Error parsing file types parameter: ', e);
                }
            }
            
            // Get LOC by language from URL parameter (JSON string)
            const locByLangParam = getUrlParameter('locByLanguage');
            if (locByLangParam) {
                try {
                    data.locByLanguage = JSON.parse(decodeURIComponent(locByLangParam));
                } catch (e) {
                    console.error('Error parsing LOC by language parameter: ', e);
                }
            }
            
            // Validate if we have at least one stat to show
            const hasStats = Object.keys(data).some(key => data[key] !== undefined && data[key] !== '');
            if (hasStats) {
                renderEnhancedStatsCard(data);
            } else {
                showError('No valid stats data provided in URL parameters');
            }
        });
    </script>
</body>
</html>