<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Voting Page – SquadVertex</title>

  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --dark: #1a1f36;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --gray: #6c757d;
      --border: #e2e8f0;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(
        135deg,
        #f5f7fa 0%,
        #e4edf5 100%
      );
      color: var(--dark);
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    header {
      text-align: center;
      margin-bottom: 2rem;
    }
    header h1 {
      font-size: 1.8rem;
      color: var(--secondary);
    }
    .question {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .contest-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    .contest-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
    }
    .contest-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
    }
    .contest-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: #f0f2f5;
    }
    .contest-info {
      padding: 0.8rem 1rem;
      text-align: center;
    }
    .contest-info h3 {
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
      color: var(--dark);
    }
    .video-thumbs {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5rem;
      padding: 0.8rem 1rem;
      background: #fafbfc;
    }
    .video-thumb {
      width: 100%;
      border-radius: 6px;
      overflow: hidden;
      background: #f8f9ff;
    }
    .video-thumb img {
      width: 100%;
      display: block;
      object-fit: cover;
      aspect-ratio: 16 / 9;
    }
    .vote-btn {
      margin: 0.8rem 1rem 1.2rem;
      padding: 0.6rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .vote-btn:hover {
      background: #3a7de0;
      transform: translateY(-2px);
    }
    .vote-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: var(--success);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s ease;
      z-index: 1000;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast i {
      font-size: 1.2rem;
    }
  </style>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>
  <div class="container">
    <header>
      <h1>SquadVertex Voting</h1>
    </header>

    <div id="loadingMessage" class="question">Loading voting data…</div>
    <div id="questionContainer" class="question" style="display:none;"></div>

    <div id="contestGrid" class="contest-grid"></div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Operation completed successfully!</span>
  </div>

  <script>
    // ─── FIREBASE INITIALIZATION ─────────────────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Refs
    const EVENT_ID = "SpringLaunch2025";
    const eventRef = db.collection("events").doc(EVENT_ID);
    const contestsRef = eventRef.collection("votingContests");

    // DOM Elements
    const loadingMessage = document.getElementById("loadingMessage");
    const questionContainer = document.getElementById("questionContainer");
    const contestGrid = document.getElementById("contestGrid");
    const toastEl = document.getElementById("toast");
    const toastMsgEl = document.getElementById("toastMessage");

    // Current user ID (anonymous)
    let currentUserId = null;

    document.addEventListener("DOMContentLoaded", () => {
      // 1) Sign in anonymously
      auth.signInAnonymously()
        .then(userCred => {
          currentUserId = userCred.user.uid;
          // 2) Load votingQuestion and contests
          loadVotingData();
        })
        .catch(err => {
          console.error("Auth error:", err);
          showToast("Failed to sign in anonymously.", "error");
        });
    });

    // ─────────────────────────────────────────────────────────────────────────
    async function loadVotingData() {
      try {
        const snap = await eventRef.get();
        if (!snap.exists) throw new Error("Event doc not found.");
        const data = snap.data() || {};

        // Display votingQuestion
        const question = data.votingQuestion || "No voting question set.";
        questionContainer.textContent = question;
        questionContainer.style.display = "block";

        // Load all contests
        const contestSnap = await contestsRef.get();
        const contests = [];
        contestSnap.forEach(doc => {
          contests.push({ id: doc.id, ...doc.data() });
        });

        if (!contests.length) {
          loadingMessage.textContent = "No voting contests available.";
          return;
        }
        loadingMessage.style.display = "none";
        renderContests(contests);
      } catch (err) {
        console.error("Error loading voting data:", err);
        loadingMessage.textContent = "Failed to load voting data.";
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Render all contests as cards with “Vote” buttons
    async function renderContests(contests) {
      contestGrid.innerHTML = "";

      // For each contest, check if user has already voted
      await Promise.all(contests.map(async contest => {
        const hasVoted = await checkUserVoted(contest.id);
        const card = document.createElement("div");
        card.className = "contest-card";

        // Contest image
        card.innerHTML = `
          <img class="contest-image" src="${contest.imageURL}" 
               onerror="this.src='https://via.placeholder.com/300x150?text=Invalid+URL';" 
               alt="${contest.creatorName}" />
          <div class="contest-info">
            <h3>${contest.creatorName}</h3>
          </div>
          <div class="video-thumbs">
            ${contest.videos.map(vid => `
              <div class="video-thumb">
                <img 
                  src="https://fast.wistia.com/embed/medias/${vid}/swatch" 
                  alt="${vid}" 
                  onerror="this.src='https://via.placeholder.com/80x45?text=No+Thumb';"
                />
              </div>
            `).join("")}
          </div>
          <button class="vote-btn" id="btnVote_${contest.id}" ${hasVoted ? "disabled" : ""}>
            <i class="fas fa-check-circle"></i> ${hasVoted ? "Voted" : "Vote"}
          </button>
        `;

        // Add click listener to Vote button if not yet voted
        if (!hasVoted) {
          card.querySelector(`#btnVote_${contest.id}`)
            .addEventListener("click", () => handleVote(contest.id));
        }

        contestGrid.appendChild(card);
      }));
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Check if current user has already voted in a given contest
    async function checkUserVoted(contestId) {
      try {
        const voteDoc = await contestsRef
          .doc(contestId)
          .collection("votes")
          .doc(currentUserId)
          .get();
        return voteDoc.exists;
      } catch (err) {
        console.error("Error checking vote:", err);
        return false;
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Handle clicking Vote: record vote and disable button
    async function handleVote(contestId) {
      const voteRef = contestsRef.doc(contestId).collection("votes").doc(currentUserId);
      try {
        // Use a transaction to ensure one vote per user
        await db.runTransaction(async tx => {
          const docSnap = await tx.get(voteRef);
          if (docSnap.exists) {
            throw new Error("Already voted");
          }
          tx.set(voteRef, {
            votedAt: firebase.firestore.Timestamp.now()
          });
        });
        showToast("Your vote has been recorded!");
        // Disable the button
        document.getElementById(`btnVote_${contestId}`).textContent = "Voted";
        document.getElementById(`btnVote_${contestId}`).disabled = true;
      } catch (err) {
        if (err.message === "Already voted") {
          showToast("You have already voted in this contest.", "warning");
        } else {
          console.error("Error recording vote:", err);
          showToast("Failed to record vote.", "error");
        }
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // Toast helper
    function showToast(message, type = "success") {
      toastMsgEl.textContent = message;
      if (type === "error") {
        toastEl.style.background = "var(--danger)";
        toastEl.querySelector("i").className = "fas fa-exclamation-circle";
      } else if (type === "warning") {
        toastEl.style.background = "var(--warning)";
        toastEl.querySelector("i").className = "fas fa-exclamation-triangle";
      } else {
        toastEl.style.background = "var(--success)";
        toastEl.querySelector("i").className = "fas fa-check-circle";
      }
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 3000);
    }
  </script>
</body>
</html>