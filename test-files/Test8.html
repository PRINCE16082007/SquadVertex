<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Channel Management Portal</title>
  <style>
    /* ----- Basic Reset & Vars ----- */
    :root {
      --bg: #121212;
      --fg: #e0e0e0;
      --accent: #1db954;
      --muted: #555;
      --radius: 6px;
      --gap: 16px;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      padding: var(--gap);
    }
    h1, h2 { margin-bottom: 0.5rem; }
    .container { max-width: 900px; margin: auto; }
    .card {
      background: #1e1e1e;
      border-radius: var(--radius);
      padding: var(--gap);
      margin-bottom: var(--gap);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    label { display:block; margin-bottom:4px; color: var(--muted); }
    input, textarea, button, select {
      width: 100%;
      padding:8px;
      margin-bottom: var(--gap);
      border:1px solid #333;
      border-radius: var(--radius);
      background: #2a2a2a;
      color: var(--fg);
      font-size: 1rem;
    }
    button {
      background: var(--accent);
      color: #fff;
      cursor:pointer;
      transition: background 0.2s;
    }
    button:hover { background: #17a74a; }
    .flex { display: flex; gap: var(--gap); }
    .flex > * { flex:1; }
    .list-item {
      background: #2a2a2a;
      padding:8px;
      border-radius: var(--radius);
      display:flex; align-items:center; justify-content: space-between;
      margin-bottom:8px;
    }
    .list-item button { width:auto; padding:4px 8px; font-size:.8rem; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öôÔ∏è Channel Management</h1>

    <!-- Channel Settings -->
    <div class="card">
      <h2>Channel Settings</h2>
      <label for="channelURL">YouTube Channel URL</label>
      <input type="text" id="channelURL" placeholder="https://www.youtube.com/..." />
      <button id="resolveChannelBtn">Resolve &amp; Save Channel ID</button>
      
      <label for="logoURL">Channel Logo URL</label>
      <input type="text" id="logoURL" placeholder="https://..." />

      <label for="chName">Channel Name</label>
      <input type="text" id="chName" placeholder="W Edits" />

      <label for="tagline">Tagline</label>
      <input type="text" id="tagline" placeholder="Your Portal for your fans!" />

      <label for="desc">Description</label>
      <textarea id="desc" rows="3" placeholder="Enter your CustomPortal description"></textarea>

      <label for="instaCount">Instagram Followers</label>
      <input type="number" id="instaCount" placeholder="e.g. 128" />

      <button id="saveSettingsBtn">üíæ Save Settings</button>
    </div>

    <!-- Video Management -->
    <div class="card">
      <h2>Fan Shorts</h2>
      <div class="flex">
        <input type="text" id="newShortURL" placeholder="YouTube Short URL" />
        <button id="addShortBtn">Add</button>
      </div>
      <div id="shortsList"></div>

      <h2>Fan Replays</h2>
      <div class="flex">
        <input type="text" id="newVideoURL" placeholder="YouTube Video URL" />
        <button id="addVideoBtn">Add</button>
      </div>
      <div id="videoList"></div>
    </div>

    <!-- Contributors Management -->
    <div class="card">
      <h2>Top Contributors</h2>
      <div class="flex">
        <input type="text" id="contribName" placeholder="Name" />
        <input type="number" id="contribPoints" placeholder="Points (SVX)" />
        <input type="number" id="contribDon" placeholder="Donations ($)" />
        <button id="addContribBtn">Add</button>
      </div>
      <div id="contribList"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ‚îÄ‚îÄ Initialize Firebase ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const col = "002-channel";

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function extractChannelID(url) {
      let m = url.match(/youtube\.com\/channel\/([A-Za-z0-9_-]+)/);
      if (m) return m[1];
      m = url.match(/youtube\.com\/(c\/|@)([A-Za-z0-9_-]+)/);
      if (m) return null; // handled below
      return null;
    }
    function extractUsername(url) {
      let m = url.match(/youtube\.com\/(c\/|@)([A-Za-z0-9_-]+)/);
      return m ? m[2] : null;
    }
    async function getChannelIDFromUsername(username) {
      const key = "AIzaSyALYK2h1PDv9yDVR3PlFkB4ZAhbu9E1-rA";
      const res = await fetch(
        `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${username}&type=channel&key=${key}`
      );
      const data = await res.json();
      return (data.items?.[0]?.id?.channelId) || null;
    }

    // ‚îÄ‚îÄ Load & Render Helpers ‚îÄ‚îÄ
    async function loadSettings() {
      const snap = await getDoc(doc(db, col, "settings"));
      if (!snap.exists()) return;
      const s = snap.data();
      document.getElementById("logoURL").value = s.logoURL || "";
      document.getElementById("chName").value   = s.name     || "";
      document.getElementById("tagline").value  = s.tagline  || "";
      document.getElementById("desc").value     = s.desc     || "";
      document.getElementById("instaCount").value = s.instaCount || "";
    }
    async function loadList(docId, renderFn) {
      const snap = await getDoc(doc(db, col, docId));
      (snap.exists() ? snap.data().content || [] : []).forEach(renderFn);
    }

    // ‚îÄ‚îÄ Render Items ‚îÄ‚îÄ
    function mkListItem(text, onDelete) {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `<span>${text}</span>`;
      const btn = document.createElement("button");
      btn.textContent = "Remove";
      btn.onclick = onDelete;
      div.appendChild(btn);
      return div;
    }
    function renderShort(url) {
      const el = mkListItem(url, () => removeFromArray("shorts", url));
      document.getElementById("shortsList").appendChild(el);
    }
    function renderVideo(url) {
      const el = mkListItem(url, () => removeFromArray("videos", url));
      document.getElementById("videoList").appendChild(el);
    }
    function renderContrib(c) {
      const txt = `${c.name} ‚Äî ${c.points} SVX ‚Äî $${c.donations}`;
      const el = mkListItem(txt, () => removeContributor(c));
      document.getElementById("contribList").appendChild(el);
    }

    // ‚îÄ‚îÄ Firestore Operations ‚îÄ‚îÄ
    async function saveSettings() {
      const data = {
        logoURL: document.getElementById("logoURL").value.trim(),
        name:     document.getElementById("chName").value.trim(),
        tagline:  document.getElementById("tagline").value.trim(),
        desc:     document.getElementById("desc").value.trim(),
        instaCount: parseInt(document.getElementById("instaCount").value, 10),
      };
      await setDoc(doc(db, col, "settings"), data, { merge:true });
      alert("‚úÖ Settings saved!");
    }
    async function resolveAndSaveChannel() {
      let url = document.getElementById("channelURL").value.trim();
      if (!url) return alert("Enter a YouTube URL!");
      let id = extractChannelID(url) || await getChannelIDFromUsername(extractUsername(url));
      if (!id) return alert("Could not resolve Channel ID.");
      await setDoc(doc(db, col, "settings"), { channelId: id }, { merge:true });
      alert(`‚úÖ Channel ID saved: ${id}`);
    }
    async function addToArray(docId, value, renderFn) {
      if (!value) return;
      await updateDoc(doc(db, col, docId), { content: arrayUnion(value) }).catch(async () => {
        // if doc doesn‚Äôt exist yet, create it
        await setDoc(doc(db, col, docId), { content: [ value ] });
      });
      renderFn(value);
    }
    async function removeFromArray(docId, value) {
      await updateDoc(doc(db, col, docId), { content: arrayRemove(value) });
      location.reload();
    }
    async function addContributor() {
      const obj = {
        name: document.getElementById("contribName").value.trim(),
        points: parseInt(document.getElementById("contribPoints").value,10),
        donations: parseFloat(document.getElementById("contribDon").value)
      };
      if (!obj.name) return;
      await updateDoc(doc(db, col, "contributors"), {
        content: arrayUnion(obj)
      }).catch(async () => {
        await setDoc(doc(db, col, "contributors"), { content: [ obj ] });
      });
      renderContrib(obj);
    }
    async function removeContributor(obj) {
      await updateDoc(doc(db, col, "contributors"), {
        content: arrayRemove(obj)
      });
      location.reload();
    }

    // ‚îÄ‚îÄ Event Hooks ‚îÄ‚îÄ
    document.getElementById("saveSettingsBtn").onclick    = saveSettings;
    document.getElementById("resolveChannelBtn").onclick  = resolveAndSaveChannel;
    document.getElementById("addShortBtn").onclick        = () => {
      const v = document.getElementById("newShortURL").value.trim();
      addToArray("shorts", v, renderShort);
    };
    document.getElementById("addVideoBtn").onclick        = () => {
      const v = document.getElementById("newVideoURL").value.trim();
      addToArray("videos", v, renderVideo);
    };
    document.getElementById("addContribBtn").onclick      = addContributor;

    // ‚îÄ‚îÄ Initial Load ‚îÄ‚îÄ
    window.addEventListener("DOMContentLoaded", async () => {
      await loadSettings();
      await loadList("shorts", renderShort);
      await loadList("videos", renderVideo);
      const cSnap = await getDoc(doc(db, col, "contributors"));
      (cSnap.exists() ? cSnap.data().content : []).forEach(renderContrib);
    });
  </script>
</body>
</html>