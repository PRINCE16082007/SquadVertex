<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Activity Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px;
    }
    th {
      background: #f2f2f2;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>
</head>
<body>
  <h1>User Activity Tracker</h1>
  <table id="usersTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Expire Date</th>
        <th>Join Date</th>
        <th>Last Login</th>
        <th>Name</th>
        <th>Plan</th>
        <th>Status</th>
        <th>SVX</th>
        <th>Terms Accepted</th>
        <th>Terms Timestamp</th>
        <th>Transactions</th>
      </tr>
    </thead>
    <tbody>
      <!-- User rows go here -->
    </tbody>
  </table>

  <script>
    // Firebase config and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };

    // Initialize Firebase app
    firebase.initializeApp(firebaseConfig);

    // Activate App Check with reCaptchaV3Provider
    try {
      const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
      firebase.appCheck().activate(appCheckProvider, true);
      console.log("App Check activated with reCaptcha v3.");
    } catch (e) {
      console.warn("App Check activation failed:", e);
    }

    const db = firebase.firestore();

    // Format Firestore timestamp to readable date string
    function formatTimestamp(ts) {
      if (!ts) return '';
      // Firestore timestamp can be a Timestamp object or string
      if (ts.seconds) {
        return new Date(ts.seconds * 1000).toLocaleString();
      } else if (typeof ts === 'string') {
        return new Date(ts).toLocaleString();
      }
      return '';
    }

    // Load user data from Firestore and fill table
    async function loadUsers() {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = '';

      try {
        const snapshot = await db.collection('users').get();
        snapshot.forEach(doc => {
          const data = doc.data();
          const uid = doc.id;

          const row = document.createElement('tr');

          // Create cells for all fields with fallback empty string
          const email = data.email || '';
          const expireDate = formatTimestamp(data.expireDate);
          const joinDate = formatTimestamp(data.joinDate);
          const lastLogin = formatTimestamp(data.lastLogin);
          const name = data.name || '';
          const plan = data.plan || '';
          const status = data.status || '';
          const svx = data.svx || '';
          const termsAccepted = data.termsAccepted === true ? 'Yes' : 'No';
          const termsTimestamp = formatTimestamp(data.termsTimestamp);

          row.innerHTML = `
            <td>${email}</td>
            <td>${expireDate}</td>
            <td>${joinDate}</td>
            <td>${lastLogin}</td>
            <td>${name}</td>
            <td>${plan}</td>
            <td>${status}</td>
            <td>${svx}</td>
            <td>${termsAccepted}</td>
            <td>${termsTimestamp}</td>
            <td><button onclick="showTransactions('${uid}')">Show Transactions</button></td>
          `;

          tbody.appendChild(row);
        });
      } catch (error) {
        console.error("Error fetching users:", error);
        tbody.innerHTML = `<tr><td colspan="11">Failed to load users. Check console for details.</td></tr>`;
      }
    }

    // Redirect to transactions page for selected user
    function showTransactions(uid) {
      window.open(`https://www.squadvertex.great-site.net/transactions?id=${uid}`, '_blank');
    }

    window.onload = loadUsers;
  </script>
</body>
</html>
