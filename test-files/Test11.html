<!-- save as create-post.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SquadVertex â€” Create Post (Beta)</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Roboto, sans-serif; background:#0f172a; color:#e6eef8; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
    .card { width:100%; max-width:720px; background:#0b1220; border-radius:12px; padding:20px; box-shadow:0 8px 30px rgba(2,6,23,0.7); }
    label { display:block; font-weight:600; margin-top:12px; color:#cfe3ff; }
    input[type="text"], textarea { width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit; }
    textarea { min-height:160px; resize:vertical; }
    .row { display:flex; gap:8px; margin-top:12px; align-items:center; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:700; }
    .btn-primary { background:linear-gradient(90deg,#2563eb,#7c3aed); color:white; }
    .notice { margin-top:12px; color:#9fb3d6; font-size:14px; }
    .small { font-size:13px; color:#9fb3d6; margin-top:8px; }
    .muted { color:#8aa0c3; font-size:13px; }
    .user-bar { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="user-bar">
      <div>
        <strong>SquadVertex â€” Create Post</strong>
        <div class="muted" id="userHint">Sign in to post â€” we will use your users/{uid} â†’ name & email.</div>
      </div>
      <div id="authControls">
        <button id="signInBtn">Sign in (Google)</button>
      </div>
    </div>

    <form id="postForm">
      <label for="title">Title</label>
      <input id="title" name="title" type="text" maxlength="200" placeholder="Your headline (max 200 chars)">

      <label for="body">Body</label>
      <textarea id="body" name="body" placeholder="Write your post..."></textarea>

      <label for="tags">Tags (comma separated)</label>
      <input id="tags" name="tags" type="text" placeholder="e.g. javascript, firebase, ideas">

      <div class="row">
        <button id="submitBtn" class="btn-primary" type="submit">Publish Post</button>
        <button id="clearBtn" type="button">Clear</button>
      </div>

      <p id="status" class="notice"></p>
    </form>
  </div>

  <script type="module">
    // ---------- ðŸ”§ Your Firebase config & recaptcha ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

    // ---------- imports (Firebase v11.9.0) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js';
    import { getFirestore, collection, addDoc, doc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js';

    // ---------- init ----------
    const app = initializeApp(firebaseConfig);

    try {
      initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
        isTokenAutoRefreshEnabled: true
      });
      console.log('App Check initialized.');
    } catch (err) {
      console.warn('App Check init problem:', err);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const postsCol = collection(db, 'posts');

    // ---------- UI elements ----------
    const signInBtn = document.getElementById('signInBtn');
    const authControls = document.getElementById('authControls');
    const userHint = document.getElementById('userHint');
    const statusEl = document.getElementById('status');
    const form = document.getElementById('postForm');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');

    // ---------- auth flow ----------
    const provider = new GoogleAuthProvider();

    signInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
        // onAuthStateChanged handles UI update
      } catch (err) {
        console.error('Sign-in failed', err);
        statusEl.textContent = 'Sign-in failed â€” check console.';
      }
    });

    // handle sign out click (we'll render it dynamically)
    function renderSignedIn(user, profile) {
      authControls.innerHTML = `
        <div style="text-align:right">
          <div style="font-weight:700">${profile?.name || user.email || 'User'}</div>
          <div style="font-size:12px;color:#9fb3d6">${profile?.email || user.email}</div>
          <button id="signOutBtn" style="margin-top:6px">Sign out</button>
        </div>
      `;
      document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
      userHint.textContent = 'Signed in. Posts will use users/{uid} â†’ name & email.';
    }

    function renderSignedOut() {
      authControls.innerHTML = `<button id="signInBtn">Sign in (Google)</button>`;
      document.getElementById('signInBtn').addEventListener('click', async () => {
        try { await signInWithPopup(auth, provider); } catch (err) { console.error(err); statusEl.textContent = 'Sign-in failed'; }
      });
      userHint.textContent = 'Sign in to post â€” we will use your users/{uid} â†’ name & email.';
    }

    // onAuth state: fetch your users/{uid} doc and use it
    onAuthStateChanged(auth, async (user) => {
      statusEl.textContent = '';
      if (user) {
        // fetch your users collection doc
        const userDocRef = doc(db, 'users', user.uid);
        let profile = null;
        try {
          const snap = await getDoc(userDocRef);
          if (snap.exists()) {
            profile = snap.data();
          } else {
            // fallback: use auth profile if users doc doesn't exist.
            profile = { name: user.displayName || null, email: user.email || null };
            // NOTE: we are NOT auto-creating the users doc here (per your existing setup).
          }
        } catch (err) {
          console.warn('Failed reading users/{uid} doc', err);
          profile = { name: user.displayName || null, email: user.email || null };
        }
        renderSignedIn(user, profile);
        // attach profile to form element for use during submit
        form.dataset.currentUid = user.uid;
        form.dataset.currentName = profile?.name || (user.displayName || '');
        form.dataset.currentEmail = profile?.email || (user.email || '');
      } else {
        renderSignedOut();
        delete form.dataset.currentUid;
        delete form.dataset.currentName;
        delete form.dataset.currentEmail;
      }
    });

    // ---------- helpers ----------
    function slugify(text) {
      return text.toString().toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
        .replace(/^-+/, '')
        .replace(/-+$/, '');
    }

    // ---------- form submit ----------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = ''; submitBtn.disabled = true; submitBtn.textContent = 'Publishing...';

      const title = (document.getElementById('title').value || '').trim();
      const body = (document.getElementById('body').value || '').trim();
      const tagsRaw = (document.getElementById('tags').value || '').trim();

      if (!title || !body) {
        statusEl.textContent = 'Title and body required.';
        submitBtn.disabled = false; submitBtn.textContent = 'Publish Post';
        return;
      }
      if (!form.dataset.currentUid) {
        statusEl.textContent = 'You must sign in before publishing.';
        submitBtn.disabled = false; submitBtn.textContent = 'Publish Post';
        return;
      }

      const uid = form.dataset.currentUid;
      const authorName = form.dataset.currentName || null;
      const authorEmail = form.dataset.currentEmail || null;

      const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
      const slug = slugify(title) + '-' + Date.now().toString().slice(-6);

      try {
        const docRef = await addDoc(postsCol, {
          title,
          body,
          tags,
          slug,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          authorId: uid,
          authorName: authorName,
          authorEmail: authorEmail,
          upvotesCount: 0,
          downvotesCount: 0,
          commentsCount: 0,
          status: 'published',
        });
        statusEl.textContent = 'Posted! ID: ' + docRef.id;
        form.reset();
      } catch (err) {
        console.error('Write failed', err);
        statusEl.textContent = 'Publish failed â€” check console. App Check or rules might be blocking.';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Publish Post';
      }
    });

    clearBtn.addEventListener('click', () => { form.reset(); statusEl.textContent = ''; });
  </script>
</body>
</html>