<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>About Team Galaxy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css " />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent: #64c2ff;
      --bg-dark: #08131a;
      --panel: rgba(24,31,43,0.97);
      --muted: #9fd8ff;
    }

    /* Base */
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: linear-gradient(180deg,#08131a 0%, #0f1722 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    a { color: inherit; text-decoration: none; }

    /* Top bar */
    .top-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      height:76px;
      padding:0 18px;
      backdrop-filter: blur(8px);
      background: rgba(8,12,18,0.65);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      position: sticky;
      top: 0;
      z-index: 120;
    }
    .logo-title { display:flex; align-items:center; gap:10px; font-weight:700; font-family: Montserrat, sans-serif; font-size:1.25rem; cursor:pointer; white-space:nowrap; }
    .logo-title img { height:44px; display:block; filter: drop-shadow(0 0 8px rgba(97,218,251,0.6)); }

    .hamburger {
      display: none;
      background:none; border:none; color:#e6f8ff; font-size:1.1rem; padding:8px; cursor:pointer;
    }

    .nav-buttons { display:flex; gap:12px; align-items:center; }
    .nav-btn, .profile-btn { background:none; border:none; color:#e6f8ff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
    .nav-btn:hover, .profile-btn:hover { color:var(--accent); background: rgba(255,255,255,0.03); }

    .more-options { position:relative; }
    .dropdown-content { display:none; position:absolute; right:0; top:48px; min-width:160px; background: rgba(18,26,36,0.98); border-radius:8px; padding:6px 0; box-shadow:0 10px 34px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.04); }
    .more-options:hover .dropdown-content { display:block; }
    .dropdown-content a { display:block; padding:10px 12px; color:#e6f8ff; font-weight:600; }

    /* Stars background (full page) */
    .stars { position:fixed; inset:0; z-index:-1; pointer-events:none; overflow:hidden; }
    .star { position:absolute; border-radius:50%; background: rgba(255,255,255,0.95); opacity:0.16; animation: twinkle var(--duration,5s) infinite ease-in-out; }
    @keyframes twinkle { 0%,100%{opacity:0.2} 50%{opacity:1} }

    /* Container */
    .container { max-width:1200px; margin:14px auto 28px; padding:0 18px; box-sizing:border-box; }

    /* Play area */
    .orbit-playground { position:relative; height:520px; max-width:100%; margin:10px auto 8px; }
    .play-card { position:relative; height:100%; border-radius:14px; overflow:visible; background: linear-gradient(180deg, rgba(6,10,18,0.6), rgba(3,6,12,0.6)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 14px 40px rgba(0,0,0,0.6); }
    .play-canvas { position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none; z-index:1; }
    .nebula-canvas { position:absolute; inset:0; z-index:2; pointer-events:none; }

    /* left static HUD ‚Äî desktop absolute, mobile flow */
    .hud-left {
      position:absolute; left:16px; top:14px; z-index:40;
      display:flex; gap:10px; align-items:center; padding:8px 10px; border-radius:12px;
      background: linear-gradient(180deg, rgba(8,14,22,0.6), rgba(10,18,30,0.36));
      border:1px solid rgba(255,255,255,0.06); backdrop-filter: blur(6px);
      box-shadow:0 8px 22px rgba(2,8,20,0.5); min-width:180px;
    }
    .hud-left .avatar { width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#bfeaff;background:linear-gradient(180deg,#0b2b3a,#06202a); border:2px solid rgba(150,220,255,0.12); }
    .hud-left .title{ font-weight:700; color:#fff; font-size:1rem; }
    .hud-left .subtitle{ color:var(--muted); font-weight:600; font-size:0.82rem; }

    /* Right HUD */
    .hud-small { position:absolute; right:14px; top:14px; z-index:38; background:rgba(6,10,18,0.6); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); display:flex; gap:12px; align-items:center; backdrop-filter: blur(6px); }
    .hud-small .label { font-weight:800; color:#fff; }
    .hud-small .muted { color:var(--muted); font-weight:700; font-size:0.85rem; }
    .hud-small .btn { background:transparent; border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; color:#bfeaff; cursor:pointer; font-weight:600; }
    .hud-small .btn:hover { background: rgba(100,194,255,0.06); color:#fff; }

    /* Center earth wrapper (keeps center) */
    .orbit-center { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:6; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
    .earth-game { width:120px; height:120px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:56px; box-shadow:0 10px 28px rgba(4,12,28,0.6), inset -6px -4px 20px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.04); background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.04), rgba(0,0,0,0.18)); -webkit-user-select:none; user-select:none; pointer-events:auto; }

    /* Play Full Game button */
    .play-full-btn { position:absolute; right:14px; bottom:14px; z-index:42; background: linear-gradient(90deg,#64c2ff 0%, #8ee7ff 50%, #d7fbff 100%); color:#052027; padding:10px 14px; border-radius:12px; border:none; font-weight:800; cursor:pointer; display:flex; gap:8px; align-items:center; box-shadow:0 12px 36px rgba(6,16,28,0.5); }
    .play-full-btn:hover { transform: translateY(-2px); transition: transform .12s ease; box-shadow:0 18px 48px rgba(6,20,36,0.6); }

    /* About content */
    .about-main { max-width:1100px; margin:28px auto 40px auto; padding-top:0; }
    .about-section { background:var(--panel); border-radius:12px; padding:28px 28px; box-shadow:0 8px 30px rgba(32,39,68,0.12); border:1px solid rgba(255,255,255,0.03); margin-bottom:28px; }
    .about-flex-row { display:flex; gap:26px; align-items:flex-start; flex-wrap:wrap; }
    .about-img-container { border-radius:12px; overflow:hidden; box-shadow:0 4px 26px rgba(35,39,70,0.45); border:2px solid rgba(255,255,255,0.06); }
    .about-img-left { width:260px; height:347px; }
    .about-img-right { width:260px; height:347px; }
    .about-img-inline { width:100%; height:320px; border-radius:10px; display:block; }
    .about-flex-text{ flex:1 1 340px; font-size:1.05rem; line-height:1.65; color:#fff; }

    /* Footer */
    .footer { min-height:260px; background: linear-gradient(90deg,#181f2b 60%, #232e44 100%); padding:28px 36px; display:flex; gap:24px; flex-wrap:wrap; border-top:2px solid #163053; }
    .footer-col{ flex:1 1 45%; }
    .footer-about-title{ color:#fab84f; font-weight:700; }
    .footer-links a{ display:block; color:#ccc; margin-bottom:10px; font-weight:600; }

    /* Responsiveness */
    @media (max-width:1200px){
      .orbit-playground{ height:480px; }
      .about-main{ margin-top:18px; }
    }
    @media (max-width:900px){
      .hamburger{ display:block; }
      .nav-buttons{ position:absolute; top:76px; right:0; background: rgba(8,12,20,0.98); flex-direction:column; gap:8px; padding:18px; width:260px; border-radius:8px; display:none; box-shadow:0 18px 60px rgba(0,0,0,0.7); }
      .nav-buttons.show{ display:flex; }
      .logo-title{ flex:1 1 auto; }
      .orbit-playground{ height:420px; }
      .about-main{ margin-top:18px; padding:0 12px; }
      .hud-left{ position: static; margin:10px auto 6px; left:auto; top:auto; display:flex; }
      .hud-small{ position:absolute; right:12px; top:12px; }
      .play-full-btn{ right:12px; bottom:12px; }
    }
    @media (max-width:700px){
      .orbit-playground{ height:360px; }
      .about-flex-row{ flex-direction:column; }
      .about-img-left, .about-img-right{ width:100%; height:260px; }
      .logo-title img{ height:36px; }
      .nav-buttons{ width:100%; right:0; left:0; top:76px; border-radius:0; }
      .hud-left{ width:calc(100% - 36px); }
      .hud-small{ right:10px; top:10px; }
    }
    @media (max-width:520px){
      .orbit-playground{ height:320px; }
      .hud-left .title{ font-size:0.98rem; }
      .hud-left .subtitle{ font-size:0.78rem; }
      .hud-small .label{ font-size:0.9rem; }
      .nav-buttons{ padding:14px; }
    }

    /* small util */
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <!-- Stars background -->
  <div class="stars" id="stars"></div>

  <!-- Header -->
  <header class="top-bar">
    <button class="hamburger" id="hamburgerBtn" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
    <div class="logo-title" onclick="window.location.href='dashboard.html'">
      <img src="https://dl.dropboxusercontent.com/scl/fi/v5d7xte4tksarsdufk4ay/image.png?rlkey=ca8p4jsfcw1pnqr79q8uympso&st=ikst5uy1&dl=0" alt="Logo">
      GalaxyWeb
    </div>

    <nav class="nav-buttons" id="navButtons" aria-hidden="false">
      <button class="nav-btn" onclick="window.location.href='dashboard.html'">Home</button>
      <button class="nav-btn" onclick="window.location.href='about_us.html'">Team Galaxy</button>
      <div class="more-options">
        <button class="nav-btn">More ‚ñº</button>
        <div class="dropdown-content" aria-hidden="true">
          <a href="galaxy_blogs.html">Blog</a>
          <a href="galaxy_portfolio.html">Portfolio</a>
          <a href="posts.html">Posts</a>
          <a href="community_chat.html">Community Chat</a>
          <a href="galaxy_studio.html">Galaxy Design</a>
        </div>
      </div>

      <button id="profileBtn" class="profile-btn" title="Sign In">Sign In</button>
      <div id="profileMenu" class="dropdown-content" style="right:18px; display:none;">
        <a href="/teamgalaxy/user_management/user_profile.html" id="profileLink">Profile</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- Play area -->
    <div class="orbit-playground" id="orbitPlay">
      <div class="play-card" id="playCard" aria-label="Orbit playground">
        <canvas id="playCanvas" class="play-canvas" aria-hidden="true"></canvas>
        <!-- nebula canvas will be appended via JS -->

        <!-- LEFT STATIC HUD (kept static on desktop; becomes flow item on mobile) -->
        <!-- inserted by JS so it appears above canvas in DOM order when mobile -->
        <!-- RIGHT HUD (name/slug + controls) -->
        <div class="hud-small" id="hud">
          <div>
            <div class="label" id="hudName">Guest</div>
            <div class="muted" id="hudSlug">@guest</div>
          </div>
          <div style="width:6px"></div>
          <div style="text-align:right">
            <div class="label" id="hudCollected">0</div>
            <div class="muted" id="hudHigh">High: 0</div>
          </div>
          <div style="width:12px"></div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" id="btnSpawn">Spawn</button>
            <button class="btn" id="btnClear">Clear</button>
            <button class="btn" id="btnSave">Save</button>
            <button class="btn" id="btnDownload">Download</button>
          </div>
        </div>

        <!-- center Earth element -->
        <div class="orbit-center" aria-hidden="false">
          <div class="earth-game" id="earthEl" title="Double-click to sign in (or use Sign In button)">üåé</div>
        </div>

        <!-- Play Full Game button (added via JS below as well) -->
      </div>
    </div>

    <!-- About/content -->
    <div class="about-main">
      <div class="about-section">
        <div class="about-flex-row">
          <div class="about-img-container about-img-left">
            <img src="https://dl.dropboxusercontent.com/scl/fi/4r0o3ymhfol2ndauy5bwb/IMG_20251108_205841.png?rlkey=hagnr2tms6hzf36vc0qgldu4e&st=czyyqfdb&dl=0" alt="Team Galaxy" style="width:100%;height:100%;object-fit:cover;">
          </div>
          <div class="about-flex-text">
            <h2>What is Team Galaxy?</h2>
            Est. May 2025<br><br>
            Team Galaxy shines brightly on the competitive stage of World of Tanks Blitz. Our mission is to showcase our skills, push our limits, and aim for the top...
          </div>
        </div>
      </div>

      <div class="about-section">
        <div class="about-flex-row">
          <div class="about-flex-text">
            <h2>Clan Events & Activities</h2>
            At Team Galaxy, we believe that a clan should be more than just a tag next to your name...
          </div>
          <div class="about-img-container about-img-right">
            <img src="https://dl.dropboxusercontent.com/scl/fi/g4wq4m8pkzd32dc7g79dt/1762616781.png?rlkey=m4ctngnu14zl6lffhbw5lvexz&st=bbrct8s5&dl=0" alt="Clan Event" style="width:100%;height:100%;object-fit:cover;">
          </div>
        </div>
      </div>

      <div class="about-section">
        <h2>How to Apply</h2>
        <div class="about-img-container about-img-inline" style="height:320px;">
          <img src="https://dl.dropboxusercontent.com/scl/fi/extuxsxwz66h4kxz8apek/IMG_20251108_212726.jpg?rlkey=xw6xxxqtx62ahy9bikj0em3i3&st=34gxu7oj&dl=0" alt="Apply Clan" style="width:100%;height:100%;object-fit:cover;">
        </div>
        <div>Currently, we operate one main clan that welcomes both competitive and casual players...</div>
      </div>

      <!-- more sections as before... -->
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-col footer-left">
      <div>
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">TeamGalaxy is an innovative gaming and creative community...</div>
      </div>
      <div class="footer-social">
        <a href="https://x.com/teamgalaxy_wotb" title="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="https://discord.gg/26pSCyMRPM" title="Discord"><i class="fab fa-discord"></i></a>
      </div>
    </div>
    <div class="footer-col footer-right">
      <div class="footer-links">
        <a href="legal/privacy_policy.html">Privacy Policy</a>
        <a href="legal/terms_and_conditions.html">Terms & Conditions</a>
        <a href="about_us.html">About</a>
      </div>
      <div>
        <div class="footer-contact-row">
          <span class="footer-contact-label"><i class="fa-solid fa-envelope footer-contact-icon"></i>Email:</span>
          info@teamgalaxy.net
        </div>
        <div class="footer-contact"><span class="footer-contact-label"><i class="fa-regular fa-clock footer-contact-icon"></i>Working Hours:</span> Mon-Sat 10am - 10pm</div>
      </div>
    </div>
  </footer>

  <!-- ReCAPTCHA (kept) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>

  <!-- Firebase + Game Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js";
    import { getFirestore, doc, setDoc, serverTimestamp, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    /* ----- Firebase config ----- */
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    const app = initializeApp(firebaseConfig);
    try {
      const appCheckProvider = new ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
      initializeAppCheck(app, { provider: appCheckProvider, isTokenAutoRefreshEnabled: true });
    } catch(e){ console.warn('App Check init failed', e); }

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    /* ----- DOM refs ----- */
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navButtons = document.getElementById('navButtons');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const logoutLink = document.getElementById('logoutLink');
    const profileLink = document.getElementById('profileLink');

    const playCard = document.getElementById('playCard');
    const playCanvas = document.getElementById('playCanvas');
    const hudNameRight = document.getElementById('hudName');
    const hudSlugRight = document.getElementById('hudSlug');
    const hudCollected = document.getElementById('hudCollected');
    const hudHigh = document.getElementById('hudHigh');
    const btnSpawn = document.getElementById('btnSpawn');
    const btnClear = document.getElementById('btnClear');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');
    const globalStarsEl = document.getElementById('stars');

    /* ----- Hamburger behavior (accessible) ----- */
    (function setupHamburger(){
      function toggleMenu(){
        const open = navButtons.classList.toggle('show');
        hamburgerBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }
      hamburgerBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
      document.addEventListener('click', (e)=>{ if(navButtons.classList.contains('show') && !navButtons.contains(e.target) && e.target !== hamburgerBtn) navButtons.classList.remove('show'); });
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && navButtons.classList.contains('show')) navButtons.classList.remove('show'); });
      // close after clicking a link inside nav (mobile)
      navButtons.addEventListener('click', (e)=>{ if(e.target.tagName === 'A' || e.target.classList.contains('nav-btn')) navButtons.classList.remove('show'); });
    })();

    /* ----- Create hud-left (static, inserted into playCard) ----- */
    const hudLeft = document.createElement('div');
    hudLeft.className = 'hud-left';
    hudLeft.innerHTML = `
      <div class="avatar">üåå</div>
      <div class="text">
        <div class="title">Orbit Playground</div>
        <div class="subtitle">Play & Collect</div>
      </div>
    `;
    // insert before canvases so it appears above canvas on smaller z stacking
    playCard.appendChild(hudLeft);

    /* ----- Add nebula canvas and Play Full Game button ----- */
    const nebulaCanvas = document.createElement('canvas');
    nebulaCanvas.className = 'nebula-canvas';
    nebulaCanvas.setAttribute('aria-hidden','true');
    playCard.appendChild(nebulaCanvas);
    const nebCtx = nebulaCanvas.getContext('2d');

    const playFullBtn = document.createElement('button');
    playFullBtn.className = 'play-full-btn';
    playFullBtn.innerHTML = `<i class="fa-solid fa-rocket"></i><span>Play Full Game</span>`;
    playFullBtn.addEventListener('click', ()=> { window.location.href = '/teamgalaxy/game/full_game.html'; });
    playCard.appendChild(playFullBtn);

    /* ----- Game state ----- */
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    let W = 0, H = 0;
    const ctx = playCanvas.getContext('2d');
    let last = performance.now();
    let orbs = [], pops = [], stars = [];
    let nextId = 1;
    const MAX_ORBS = 28;
    const ORB_TYPES = [
      { name:'common', chance:0.75, size:18, score:1, color:'#8EE7FF' },
      { name:'uncommon', chance:0.18, size:26, score:3, color:'#FFD57B' },
      { name:'rare', chance:0.06, size:34, score:6, color:'#B8FF9A' },
      { name:'epic', chance:0.01, size:44, score:12, color:'#FF9AD6' }
    ];

    // scores
    let collected = 0; // ALWAYS start session from 0 as requested
    let high = parseInt(localStorage.getItem('galaxy_high')) || 0;

    // spawn config
    const AUTO_SPAWN_INTERVAL_MS = 1200;
    const AUTO_SPAWN_BURST_PROB = 0.22;

    // identity
    let currentUser = null;
    let currentProfile = null;
    let userPrivUnsub = null;

    // helpers
    function rand(a,b){ return a + Math.random()*(b-a); }
    function pickType(){ const r=Math.random(); let s=0; for(const t of ORB_TYPES){ s+=t.chance; if(r <= s) return t; } return ORB_TYPES[0]; }
    function hexToRgb(hex){ const s = hex.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }

    /* ----- HUD update (RIGHT HUD only) ----- */
    function updateHUD(){
      try {
        const displayName = currentProfile?.name || currentUser?.displayName || 'Guest';
        const slug = currentProfile?.slug ? ('@' + currentProfile.slug) : (currentUser ? ('@' + ((currentUser.uid||'guest').slice(0,6))) : '@guest');
        if (hudNameRight) hudNameRight.textContent = displayName;
        if (hudSlugRight) hudSlugRight.textContent = currentProfile?.slug ? ('@' + currentProfile.slug) : (currentUser ? ('@' + (currentUser.displayName ? currentUser.displayName.split(' ')[0] : (currentUser.uid?.slice(0,6) || 'guest'))) : '@guest');
      } catch(e){ console.warn(e); }
      if (hudCollected) hudCollected.textContent = collected;
      if (hudHigh) hudHigh.textContent = 'High: ' + high;
      updateProfileButton();
    }

    /* ----- Canvas sizing & visuals ----- */
    function resizeCanvas(){
      const rect = playCard.getBoundingClientRect();
      const computedHeight = Math.max(260, rect.height || 520);
      const computedWidth = Math.max(320, rect.width || (window.innerWidth - 80));
      W = Math.floor(computedWidth);
      H = Math.floor(computedHeight);
      playCanvas.style.width = W + 'px'; playCanvas.style.height = H + 'px';
      playCanvas.width = Math.floor(W * DPR); playCanvas.height = Math.floor(H * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);

      nebulaCanvas.style.width = W + 'px'; nebulaCanvas.style.height = H + 'px';
      nebulaCanvas.width = Math.floor(W * DPR); nebulaCanvas.height = Math.floor(H * DPR);
      nebCtx.setTransform(DPR,0,0,DPR,0,0);

      initStars(); initNebula();
    }
    window.addEventListener('resize', resizeCanvas);

    function initStars(){
      stars.length = 0;
      const count = Math.max(16, Math.round((W*H)/90000));
      for(let i=0;i<count;i++) stars.push({ x:Math.random()*W, y:Math.random()*H, s:Math.random()*1.6+0.4, phase:Math.random()*Math.PI*2, speed: 0.001 + Math.random()*0.004 });
    }

    (function initGlobalStars(){
      if(!globalStarsEl) return;
      const STAR_COUNT = 160;
      for(let i=0;i<STAR_COUNT;i++){
        const el = document.createElement('div');
        el.className = 'star';
        const x = Math.random()*100, y = Math.random()*100;
        const size = Math.random()*2 + 0.6;
        el.style.left = x+'%'; el.style.top = y+'%';
        el.style.width = size+'px'; el.style.height = size+'px';
        el.style.opacity = (0.18 + Math.random()*0.82).toString();
        el.style.setProperty('--duration', `${2 + Math.random()*5}s`);
        globalStarsEl.appendChild(el);
      }
      // subtle parallax for stars
      document.addEventListener('mousemove', (e)=>{
        const w = window.innerWidth, h = window.innerHeight;
        const rx = (e.clientX / w - 0.5) * 6;
        const ry = (e.clientY / h - 0.5) * 6;
        globalStarsEl.style.transform = `translate(${rx}px, ${ry}px)`;
      });
    })();

    let nebulaBlobs = [];
    function initNebula(){
      nebulaBlobs = [];
      const blobCount = Math.max(2, Math.round(W/420));
      for(let i=0;i<blobCount;i++){
        nebulaBlobs.push({
          x: Math.random()*W,
          y: Math.random()*H,
          r: Math.max(80, Math.random()*220),
          vx: (Math.random()-0.5)*0.14,
          vy: (Math.random()-0.5)*0.14,
          hue: Math.floor(180 + Math.random()*120),
          alpha: 0.06 + Math.random()*0.12
        });
      }
    }
    function drawNebula(now){
      nebCtx.clearRect(0,0,W,H);
      for(const b of nebulaBlobs){
        b.x += b.vx; b.y += b.vy;
        if(b.x < -b.r) b.x = W + b.r;
        if(b.x > W + b.r) b.x = -b.r;
        if(b.y < -b.r) b.y = H + b.r;
        if(b.y > H + b.r) b.y = -b.r;
        const g = nebCtx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
        g.addColorStop(0, `hsla(${b.hue}, 75%, 60%, ${b.alpha*1.6})`);
        g.addColorStop(0.5, `hsla(${b.hue}, 65%, 40%, ${b.alpha})`);
        g.addColorStop(1, `rgba(0,0,0,0)`);
        nebCtx.fillStyle = g;
        nebCtx.beginPath(); nebCtx.arc(b.x, b.y, b.r, 0, Math.PI*2); nebCtx.fill();
      }
    }

    /* ----- Spawn / collect ----- */
    function spawnOrbAt(clientX, clientY){
      if (orbs.length >= MAX_ORBS) return;
      const rect = playCard.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const px = clientX || (cx + rand(-140,140));
      const py = clientY || (cy + rand(-90,90));
      const dx = px - cx; const dy = py - cy;
      const radius = Math.max(72, Math.min(Math.hypot(dx,dy), Math.min(rect.width, rect.height)/2 - 36));
      const angle = Math.atan2(dy, dx);
      const baseSpeed = 1.1 / Math.sqrt(Math.max(1, radius/90));
      const speed = (Math.random() < 0.5 ? 1 : -1) * baseSpeed * (0.7 + Math.random()*1.0); // slightly faster than before
      const t = pickType();
      const orb = {
        id: nextId++,
        angle, radius, speed,
        size: t.size * (0.92 + Math.random()*0.18),
        color: t.color, score: t.score, rarity: t.name,
        rotation: Math.random()*Math.PI*2,
        rotSpeed: (Math.random()*0.9-0.45)*0.02
      };
      orbs.push(orb);
    }

    function toLocalCoords(clientX, clientY){
      const rect = playCard.getBoundingClientRect();
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function hitTest(x,y){
      let best=null, bestD=Infinity;
      const rect = playCard.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      for(const o of orbs){
        const ox = cx + o.radius * Math.cos(o.angle), oy = cy + o.radius * Math.sin(o.angle);
        const d = Math.hypot(x-ox, y-oy);
        const hitR = Math.max(18, o.size*1.6);
        if (d <= hitR && d < bestD){ best = o; bestD = d; }
      }
      return best;
    }

    function collectOrb(o){
      if(!o) return;
      spawnPopForOrb(o);
      collected += o.score;
      if (collected > high){
        high = collected;
        localStorage.setItem('galaxy_high', high);
        flashHigh(); playCelebration(); launchConfetti({count:90});
      }
      if (collected % 10 === 0){ launchConfetti({count:28}); playCelebration(); }
      orbs = orbs.filter(x => x.id !== o.id);
      updateHUD(); playCollect();
    }

    function spawnPopForOrb(o){
      const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2;
      const x = cx + o.radius * Math.cos(o.angle); const y = cy + o.radius * Math.sin(o.angle);
      const rgb = hexToRgb(o.color);
      const parts = []; const count = Math.min(34, Math.round(8 + o.size*1.4));
      for(let i=0;i<count;i++){
        const ang = Math.random()*Math.PI*2;
        parts.push({ vx: Math.cos(ang)*(0.6 + Math.random()*3.2), vy: Math.sin(ang)*(0.6 + Math.random()*3.2), size: Math.random()*(o.size*0.8)+0.6, color: `rgba(${rgb.r},${rgb.g},${rgb.b},` });
      }
      pops.push({ x,y, parts, life:1, lifeMax:1, speed: 42 + o.size*6 });
    }

    /* ----- Drawing functions ----- */
    function drawBackground(now){
      ctx.save();
      const grad = ctx.createLinearGradient(0,0,0,H);
      grad.addColorStop(0, 'rgba(6,10,18,0.20)');
      grad.addColorStop(1, 'rgba(3,6,12,0.32)');
      ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);
      for(let i=0;i<Math.max(8, Math.round((W*H)/200000)); i++){
        const x = (i*37*13) % W + ((now/1200) % 7);
        const y = ((i*17*7) % H) + Math.sin((now/12000)+i)*6;
        ctx.fillStyle = 'rgba(200,230,255,0.02)';
        ctx.beginPath(); ctx.ellipse(x,y,1.2,1.2,0,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    function drawOrbs(now, dt){
      const rect = playCard.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      for(const o of orbs){
        o.angle += o.speed * (dt/1000);
        o.rotation += o.rotSpeed;
        const x = cx + o.radius * Math.cos(o.angle), y = cy + o.radius * Math.sin(o.angle);
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(o.rotation * 0.12);
        const glow = ctx.createRadialGradient(0,0,0,0,0,o.size*2.6);
        glow.addColorStop(0, 'rgba(255,255,255,0.08)');
        glow.addColorStop(0.6, 'rgba(255,255,255,0.02)');
        glow.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = glow;
        ctx.beginPath(); ctx.arc(0,0,o.size*2.6,0,Math.PI*2); ctx.fill();
        const fontSize = Math.max(16, Math.min(56, o.size));
        ctx.font = `${fontSize}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üõ∞Ô∏è', 0, 0);
        if (o.rarity === 'epic' || o.rarity === 'rare'){
          ctx.font = '10px Poppins, Arial';
          ctx.fillStyle = '#fff';
          ctx.fillText(o.rarity[0].toUpperCase(), o.size*0.85, -o.size*0.82);
        }
        ctx.restore();
        o.screenX = x; o.screenY = y;
      }
    }

    function drawPops(now, dt){
      ctx.save();
      for(let i=pops.length-1;i>=0;i--){
        const p = pops[i];
        p.life -= dt / 420;
        const alpha = Math.max(0, p.life / p.lifeMax);
        for(const part of p.parts){
          const px = p.x + part.vx * (1 - alpha) * p.speed;
          const py = p.y + part.vy * (1 - alpha) * p.speed;
          const s = Math.max(0.6, part.size * alpha);
          ctx.fillStyle = part.color + (0.88 * alpha) + ')';
          ctx.beginPath(); ctx.ellipse(px, py, s, s, 0,0,Math.PI*2); ctx.fill();
        }
        if (p.life <= 0) pops.splice(i,1);
      }
      ctx.restore();
    }

    function drawVignette(){
      const g = ctx.createRadialGradient(W/2, H/2, Math.max(W,H)/6, W/2, H/2, Math.max(W,H)/1.0);
      g.addColorStop(0,'rgba(255,255,255,0)');
      g.addColorStop(1,'rgba(0,0,0,0.18)');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    }

    function loop(now){
      requestAnimationFrame(loop);
      const dt = Math.max(8, now - last);
      last = now;
      ctx.clearRect(0,0,W,H);
      drawBackground(now);
      drawOrbs(now, dt);
      drawPops(now, dt);
      drawVignette();
      drawNebula(now);
    }

    /* ----- Pointer / controls ----- */
    playCard.addEventListener('pointerdown', (e)=> {
      if(e.pointerType === 'mouse' && e.button !== 0) return;
      const p = toLocalCoords(e.clientX, e.clientY);
      const found = hitTest(p.x, p.y);
      if(found){ collectOrb(found); return; }
      spawnOrbAt(e.clientX, e.clientY);
    });

    btnSpawn?.addEventListener('click', ()=> { for(let i=0;i<3;i++) spawnOrbAt(); });
    btnClear?.addEventListener('click', ()=> { orbs=[]; pops=[]; ctx.clearRect(0,0,W,H); });
    btnDownload?.addEventListener('click', downloadScoreImage);
    btnSave?.addEventListener('click', saveScoreToCloud);

    /* ----- Audio + confetti ----- */
    let audioCtx = null;
    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playTone(freq=420, dur=0.06){ try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.setValueAtTime(0.001, now); g.gain.exponentialRampToValueAtTime(0.12, now + 0.01); g.gain.exponentialRampToValueAtTime(0.0001, now + dur); o.start(now); o.stop(now + dur + 0.02);}catch(e){} }
    function playCollect(){ playTone(720,0.05); }
    function playCelebration(){ try{ ensureAudio(); const now = audioCtx.currentTime; const notes = [880, 1100, 1320, 1760]; notes.forEach((n,i)=>{ const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.value = n; o.connect(g); g.connect(audioCtx.destination); const t = now + i*0.07; g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.14, t + 0.02); g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22); o.start(t); o.stop(t + 0.26); }); }catch(e){} }
    document.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });

    const confettiCanvas = (function createConfetti(){
      const c = document.createElement('canvas');
      c.style.position = 'fixed'; c.style.left = '0'; c.style.top = '0'; c.style.width = '100%'; c.style.height = '100%';
      c.style.pointerEvents = 'none'; c.style.zIndex = 9999; document.body.appendChild(c);
      const ctx = c.getContext('2d');
      function resize(){ c.width = window.innerWidth * DPR; c.height = window.innerHeight * DPR; ctx.setTransform(DPR,0,0,DPR,0,0); }
      window.addEventListener('resize', resize); resize();
      return { canvas:c, ctx, parts:[] };
    })();

    function launchConfetti({count=80, spread=Math.PI*1.1, duration=2200} = {}){
      const { canvas, ctx, parts } = confettiCanvas;
      const w = canvas.width / DPR, h = canvas.height / DPR;
      const colors = ['#ffd166','#06d6a0','#118ab2','#ef476f','#a8dadc','#ffd6a5','#c084fc'];
      for(let i=0;i<count;i++){
        const angle = (Math.PI/2) + (Math.random()-0.5)*spread;
        const speed = Math.random()*8 + 3;
        const size = 6 + Math.random()*10;
        const shape = Math.random() < 0.5 ? 'rect' : (Math.random() < 0.5 ? 'circle' : 'tri');
        parts.push({ x: w * (0.2 + Math.random()*0.6), y: -10 - Math.random()*60, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed + 1.6, rot: Math.random()*Math.PI*2, rotSpeed: (Math.random()-0.5)*0.28, size, color: colors[Math.floor(Math.random()*colors.length)], shape, life: 1, decay: 1 / (duration/16 + Math.random()*40) });
      }
      let t0 = performance.now();
      (function frame(now){
        const dt = now - t0; t0 = now;
        ctx.clearRect(0,0,w,h);
        for(let i=parts.length-1;i>=0;i--){
          const p = parts[i];
          p.vy += 0.16; p.vx *= 0.998; p.x += p.vx; p.y += p.vy; p.rot += p.rotSpeed; p.life -= p.decay * (dt/16);
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha = Math.max(0, p.life); ctx.fillStyle = p.color;
          if(p.shape === 'rect') ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
          else if(p.shape === 'circle'){ ctx.beginPath(); ctx.ellipse(0,0,p.size*0.55,p.size*0.55,0,0,Math.PI*2); ctx.fill(); }
          else { ctx.beginPath(); ctx.moveTo(0,-p.size/1.3); ctx.lineTo(p.size/1.2,p.size/1.6); ctx.lineTo(-p.size/1.2,p.size/1.6); ctx.closePath(); ctx.fill(); }
          ctx.restore();
          if(p.y > h - 12 && p.life > 0.2){ p.vy *= -0.32; p.vx *= 0.75; p.y = h - 12; }
          if(p.life <= 0 || p.y > h + 80) parts.splice(i,1);
        }
        if(parts.length > 0) requestAnimationFrame(frame);
        else ctx.clearRect(0,0,w,h);
      })(performance.now());
    }

    /* ----- Download & Save (includes photoUrl) ----- */
    function downloadScoreImage(){
      const w = 1400, h = 760;
      const c = document.createElement('canvas'); c.width = w; c.height = h;
      const g = c.getContext('2d');
      const grad = g.createLinearGradient(0,0,0,h); grad.addColorStop(0, '#021224'); grad.addColorStop(1, '#061224'); g.fillStyle = grad; g.fillRect(0,0,w,h);
      for(let i=0;i<200;i++){ g.fillStyle = 'rgba(200,230,255,' + (0.02 + Math.random()*0.07) + ')'; const x=Math.random()*w,y=Math.random()*h,s= Math.random()*2.4; g.beginPath(); g.ellipse(x,y,s,s,0,0,Math.PI*2); g.fill(); }
      g.fillStyle = 'rgba(8,14,22,0.62)'; roundRect(g, 64, 84, w-128, h-188, 20); g.fill();
      const cx = 150, cy = 300, cr = 120;
      const pg = g.createRadialGradient(cx-30, cy-30, 10, cx, cy, cr); pg.addColorStop(0, '#9ee6ff'); pg.addColorStop(0.5, '#6abcf1'); pg.addColorStop(1, '#1b3d66'); g.fillStyle = pg; g.beginPath(); g.arc(cx, cy, cr, 0, Math.PI*2); g.fill();
      g.strokeStyle = 'rgba(255,255,255,0.08)'; g.lineWidth = 8; g.beginPath(); g.ellipse(cx, cy+8, cr+28, cr-18, -0.35, 0, Math.PI*2); g.stroke();
      g.font = '92px serif'; g.textAlign = 'center'; g.textBaseline='middle'; g.fillText('üåé', cx, cy);
      g.font = '700 44px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText('Team Galaxy ‚Äî Orbit Score Card', 380, 140);
      const displayName = currentProfile?.name || (currentUser?.displayName || 'Guest');
      const slug = currentProfile?.slug ? ('@' + currentProfile.slug) : (currentUser ? ('@guest') : '@guest');
      g.font = '600 28px Poppins, Arial'; g.fillStyle = '#bfeaff'; g.fillText(displayName, 380, 210);
      g.font = '500 20px Poppins, Arial'; g.fillStyle = '#9fd8ff'; g.fillText(slug, 380, 246);
      g.font = '700 88px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText(String(high), 380, 380);
      g.font = '500 20px Poppins, Arial'; g.fillStyle = '#9fd8ff'; g.fillText('High Score', 380, 420);
      g.font = '700 38px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText('Collected: ' + collected, 380, 520);
      g.font = '400 16px Poppins, Arial'; g.fillStyle = 'rgba(255,255,255,0.8)'; g.fillText('Generated: ' + new Date().toLocaleString(), 380, 600);
      g.font = '400 14px Poppins, Arial'; g.fillStyle = 'rgba(255,255,255,0.65)'; g.fillText('Public game stats only ‚Äî no personal PII included.', w-300, h-56);
      g.font = '28px serif'; const satPositions = [ [w-240,220], [w-160,340], [w-220,420] ]; g.fillStyle = '#d7f6ff'; satPositions.forEach((p,i)=> g.fillText('üõ∞Ô∏è', p[0], p[1]));
      c.toBlob(function(blob){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'galaxy-score-' + Date.now() + '.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }, 'image/png');
    }
    function roundRect(g, x, y, w, h, r){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath(); }

    async function saveScoreToCloud(){
      if (!currentUser){ alert('Sign in to save to cloud (click Sign In or double-click the Earth).'); return; }
      try{
        const uid = currentUser.uid;
        const ref = doc(db, 'gameScores', uid);
        const payload = {
          collected,
          high,
          name: currentProfile?.name || currentUser?.displayName || null,
          slug: currentProfile?.slug || null,
          photoUrl: currentUser?.photoURL || currentProfile?.profilePhotoUrl || null,
          lastUpdated: serverTimestamp(),
          clientTs: new Date().toISOString()
        };
        await setDoc(ref, payload, { merge: true });
        alert('Saved to cloud (name, slug, photoUrl included).');
      }catch(e){ console.error('save fail', e); alert('Save failed.'); }
    }

    /* ----- Auth state: live subscription to usersPrivate (slug updates) ----- */
    function updateProfileButton(){
      try {
        const u = currentUser;
        if (!profileBtn) return;
        if (u) {
          if (u.photoURL) { profileBtn.innerHTML = `<img src="${u.photoURL}" alt="Profile" style="width:36px;height:36px;border-radius:50%;">`; }
          else { profileBtn.innerHTML = `<i class="fa-solid fa-user"></i>`; }
          profileBtn.title = currentProfile?.name || u.displayName || u.email || "Profile";
        } else { profileBtn.innerHTML = 'Sign In'; profileBtn.title = 'Sign In'; }
      } catch(e){ console.warn('updateProfileBtn err', e); }
    }

    onAuthStateChanged(auth, async (user) => {
      if (userPrivUnsub) { try { userPrivUnsub(); } catch(_){} userPrivUnsub = null; }
      currentUser = user;
      if (user) {
        try {
          const privRef = doc(db, 'usersPrivate', user.uid);
          userPrivUnsub = onSnapshot(privRef, (snap) => {
            if (snap.exists()) currentProfile = snap.data();
            else currentProfile = { name: user.displayName || null, slug: null, profilePhotoUrl: null };
            updateHUD(); // updates RIGHT HUD only
          }, (err) => {
            console.warn('usersPrivate snapshot error', err);
            currentProfile = { name: user.displayName || null, slug: null, profilePhotoUrl: null };
            updateHUD();
          });
        } catch(e){
          console.warn('usersPrivate subscription failed', e);
          currentProfile = { name: user.displayName || null, slug: null, profilePhotoUrl: null };
          updateHUD();
        }
      } else {
        currentProfile = null;
        updateHUD();
      }
    });

    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const liveUser = auth.currentUser;
      if (!liveUser) { window.location.href = "/teamgalaxy/legal/sign_up.html"; return; }
      if (!profileMenu) return;
      profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
    });
    window.addEventListener('click', ()=> { if(profileMenu) profileMenu.style.display = 'none'; });
    logoutLink.addEventListener('click', (e)=> { e.preventDefault(); signOut(auth).then(()=>{ alert('Signed out'); }).catch(()=>{}); });
    profileLink.addEventListener('click', (e)=> { e.preventDefault(); if(!auth.currentUser) window.location.href = "/teamgalaxy/legal/sign_up.html"; else window.location.href = "/teamgalaxy/user_management/user_profile.html"; });

    earthEl.addEventListener('dblclick', async () => {
      if (currentUser){ alert('Signed in as ' + (currentUser.displayName || currentUser.email)); return; }
      try{ await signInWithPopup(auth, provider); alert('Signed in'); }catch(e){ console.warn(e); alert('Sign-in failed'); }
    });

    /* ----- Auto spawn ----- */
    (function startAutoSpawn(){
      setInterval(()=>{
        if (orbs.length >= MAX_ORBS) return;
        if(Math.random() < AUTO_SPAWN_BURST_PROB){
          for(let i=0;i<3;i++) spawnOrbAt();
        } else {
          spawnOrbAt();
        }
      }, AUTO_SPAWN_INTERVAL_MS);
    })();

    /* ----- Init loop ----- */
    function flashHigh(){ if (hudHigh) { hudHigh.style.transform = 'scale(1.06)'; hudHigh.style.color = '#fff'; setTimeout(()=>{ hudHigh.style.transform=''; hudHigh.style.color=''; }, 420); } }

    function init(){
      DPR = Math.max(1, window.devicePixelRatio || 1);
      resizeCanvas();
      const rect = playCard.getBoundingClientRect();
      for(let i=0;i<6;i++) spawnOrbAt(rect.left + rect.width/2 + rand(-140,140), rect.top + rect.height/2 + rand(-90,90));
      updateHUD();
      last = performance.now();
      requestAnimationFrame(loop);
    }
    window.addEventListener('load', init);

    window.addEventListener('beforeunload', ()=> { localStorage.setItem('galaxy_high', high); if (userPrivUnsub) try{ userPrivUnsub(); } catch(_){} });

    // polyfill roundRect
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        this.beginPath(); this.moveTo(x+r, y); this.arcTo(x+w, y, x+w, y+h, r); this.arcTo(x+w, y+h, x, y+h, r); this.arcTo(x, y+h, x, y, r); this.arcTo(x, y, x+w, y, r); this.closePath();
      };
    }
  </script>
</body>
</html>