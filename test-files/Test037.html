<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxy â€” Orbit Game (Upgraded with Real-time Leaderboard)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    :root{ --bg:#08101a; --card:#06121a; --accent:#64c2ff; --muted:#bfeaff }
    html,body{height:100%;margin:0;font-family:Inter, Poppins, Arial, sans-serif;background:linear-gradient(180deg,#05111a 0%, #081222 100%);color:#eaf6ff}
    .container{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start}
    header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .logo{display:flex;align-items:center;gap:10px;cursor:pointer}
    .logo img{height:40px}
    .title{font-weight:700;font-size:1.2rem}

    /* Play card */
    .play-card{background:linear-gradient(180deg, rgba(2,8,18,0.72), rgba(4,8,14,0.56));border-radius:12px;padding:12px;position:relative;overflow:visible;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,12,0.9)}
    .play-area{height:520px;border-radius:10px;position:relative;background:transparent;}
    canvas.play-canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    .orbit-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:6;display:flex;align-items:center;justify-content:center}
    .earth-game{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:46px;cursor:default;box-shadow:0 8px 28px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);background:radial-gradient(circle at 30% 25%, rgba(255,255,255,0.04), rgba(0,0,0,0.18));}

    .hud{position:absolute;right:14px;top:14px;z-index:18;background:rgba(6,10,18,0.6);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:center}
    .hud .label{font-weight:700;color:#fff}
    .hud .muted{color:var(--muted);font-size:0.85rem}
    .hud .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer;font-weight:600}

    /* Leaderboard */
    .leaderboard{background:linear-gradient(180deg, rgba(8,13,20,0.6), rgba(3,6,10,0.6));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .leaderboard h3{margin:0 0 8px 0;color:var(--accent)}
    .leaders{display:flex;flex-direction:column;gap:8px}
    .leader-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .leader-row .meta{display:flex;gap:10px;align-items:center}
    .rank{width:34px;text-align:center;font-weight:800}
    .name{font-weight:700}
    .score{font-weight:800}
    .you{box-shadow:0 6px 20px rgba(100,194,255,0.06);border:1px solid rgba(100,194,255,0.12);background:linear-gradient(90deg, rgba(100,194,255,0.04), rgba(100,194,255,0.02));}
    .small{font-size:0.85rem;color:var(--muted)}

    .leader-footer{margin-top:12px;display:flex;flex-direction:column;gap:8px}
    .my-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .signin{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}

    /* Responsive */
    @media (max-width:980px){.container{grid-template-columns:1fr}.leaderboard{order:2}}
  </style>
</head>
<body>
  <div class="container">
    <div>
      <header>
        <div class="logo" onclick="location.reload()">
          <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="logo"/>
          <div class="title">Galaxy â€” Orbit (Play)</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="profileBtn" class="signin">Sign In</button>
          <button id="btnSaveLocal" class="signin">Save (Cloud)</button>
        </div>
      </header>

      <div class="play-card" id="playCard">
        <div class="play-area">
          <canvas id="playCanvas" class="play-canvas"></canvas>
          <div class="orbit-center"><div id="earthEl" class="earth-game" title="Double-click to sign in">ðŸŒŽ</div></div>
          <div id="hud" class="hud">
            <div>
              <div class="label" id="hudName">Guest</div>
              <div class="muted" id="hudSlug">@guest</div>
            </div>
            <div style="width:14px"></div>
            <div style="text-align:right">
              <div class="label" id="hudCollected">0</div>
              <div class="muted" id="hudHigh">High: 0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <aside class="leaderboard">
      <h3>Real-time Leaderboard</h3>
      <div class="small">Top 10 players by High Score â€” updates live</div>
      <div id="leaders" class="leaders" aria-live="polite"></div>

      <div class="leader-footer">
        <div class="small">Your current rank (updates after sign-in & save)</div>
        <div id="myRow" class="my-row">Not signed in â€” your rank is hidden. <button id="btnSignIn" class="signin">Sign In</button></div>
      </div>
    </aside>
  </div>

  <!-- confetti canvas added dynamically by script -->

  <!-- Firebase + Game code -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js";
  import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp, query, orderBy, limit, onSnapshot, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

  // --- firebase config (kept same as provided) ---
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  const app = initializeApp(firebaseConfig);
  try{
    const appCheckProvider = new ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
    initializeAppCheck(app, { provider: appCheckProvider, isTokenAutoRefreshEnabled: true });
  }catch(e){ console.warn('AppCheck failed', e); }

  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // DOM refs
  const playCanvas = document.getElementById('playCanvas');
  const playCard = document.getElementById('playCard');
  const earthEl = document.getElementById('earthEl');
  const hudCollected = document.getElementById('hudCollected');
  const hudHigh = document.getElementById('hudHigh');
  const hudName = document.getElementById('hudName');
  const hudSlug = document.getElementById('hudSlug');
  const leadersEl = document.getElementById('leaders');
  const myRowEl = document.getElementById('myRow');
  const profileBtn = document.getElementById('profileBtn');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSaveLocal = document.getElementById('btnSaveLocal');

  // confetti helper (small)
  function createConfettiCanvas(){
    const c = document.createElement('canvas'); c.style.position='fixed'; c.style.left='0'; c.style.top='0'; c.style.width='100%'; c.style.height='100%'; c.style.pointerEvents='none'; c.style.zIndex=9999; document.body.appendChild(c);
    const ctx = c.getContext('2d'); function resize(){ c.width = window.innerWidth; c.height = window.innerHeight; } window.addEventListener('resize', resize); resize(); return {c,ctx,parts:[]};
  }
  const confetti = createConfettiCanvas();
  function launchConfettiSimple(count=40){ const {c,ctx,parts} = confetti; for(let i=0;i<count;i++){ parts.push({x:Math.random()*c.width,y:-20+Math.random()*-80,vx:(Math.random()-0.5)*6,vy:Math.random()*6+3,life:1,size:6+Math.random()*8,color:['#ffd166','#06d6a0','#118ab2','#ef476f'][Math.floor(Math.random()*4)]}) } requestAnimationFrame(function frame(){ ctx.clearRect(0,0,c.width,c.height); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.vy+=0.18; p.x+=p.vx; p.y+=p.vy; p.life-=0.01; ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); ctx.restore(); if(p.y>c.height+40||p.life<=0) parts.splice(i,1); } if(parts.length>0) requestAnimationFrame(frame); else ctx.clearRect(0,0,c.width,c.height); }); }

  // --- Game core (stripped down & re-used from your original) ---
  let DPR = Math.max(1, window.devicePixelRatio||1); let W=0,H=0; const ctx = playCanvas.getContext('2d'); let last=performance.now(); let orbs=[]; let pops=[]; let nextId=1; const MAX_ORBS=28;
  const ORB_TYPES=[{name:'common',chance:0.75,size:18,score:1,color:'#8EE7FF'},{name:'uncommon',chance:0.18,size:26,score:3,color:'#FFD57B'},{name:'rare',chance:0.06,size:34,score:6,color:'#B8FF9A'},{name:'epic',chance:0.01,size:44,score:12,color:'#FF9AD6'}];

  let collected = 0; let high = parseInt(localStorage.getItem('galaxy_high'))||0;
  let currentUser=null; let currentProfile=null;

  function rand(a,b){return a+Math.random()*(b-a);} function pickType(){const r=Math.random();let s=0;for(const t of ORB_TYPES){s+=t.chance;if(r<=s) return t;}return ORB_TYPES[0];}

  function updateHUD(){ hudCollected.textContent = collected; hudHigh.textContent = 'High: ' + high; hudName.textContent = currentProfile?.name || (currentUser?.displayName || 'Guest'); hudSlug.textContent = currentProfile?.slug ? ('@'+currentProfile.slug) : (currentUser ? ('@'+currentUser.uid.slice(0,6)) : '@guest'); }

  function resizeCanvas(){ const rect = playCard.getBoundingClientRect(); const computedWidth = Math.min(rect.width, Math.max(320, window.innerWidth-120)); W = Math.max(300, Math.floor(computedWidth)); H = Math.max(220, Math.floor(rect.height)); playCanvas.style.width = W+'px'; playCanvas.style.height = H+'px'; playCanvas.width = Math.floor(W*DPR); playCanvas.height = Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
  window.addEventListener('resize', resizeCanvas);

  function spawnOrbAt(clientX, clientY){ if(orbs.length>=MAX_ORBS) return; const rect = playCard.getBoundingClientRect(); const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2; const px = clientX || (cx + rand(-140,140)); const py = clientY || (cy + rand(-90,90)); const dx = px-cx, dy = py-cy; const radius = Math.max(72, Math.min(Math.hypot(dx,dy), Math.min(rect.width,rect.height)/2 - 36)); const angle = Math.atan2(dy,dx); const baseSpeed = 0.8 / Math.sqrt(Math.max(1, radius/90)); const speed = (Math.random()<0.5?1:-1)*baseSpeed*(0.6+Math.random()*0.9); const t = pickType(); const orb={id:nextId++,angle,radius,speed,size:t.size*(0.9+Math.random()*0.18),color:t.color,score:t.score,rarity:t.name,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()*0.9-0.45)*0.02}; orbs.push(orb); }

  function hitTest(x,y){ let best=null,bestD=Infinity; const rect=playCard.getBoundingClientRect(); const cx=rect.width/2, cy=rect.height/2; for(const o of orbs){ const ox=cx+o.radius*Math.cos(o.angle), oy=cy+o.radius*Math.sin(o.angle); const d=Math.hypot(x-ox,y-oy); const hitR=Math.max(18,o.size*1.6); if(d<=hitR && d<bestD){best=o;bestD=d;} } return best; }

  function collectOrb(o){ if(!o) return; spawnPopForOrb(o); const prev=collected; collected+=o.score; if(collected>high){ high=collected; localStorage.setItem('galaxy_high',high); flashHigh(); playCelebration(); launchConfettiSimple(60); }
    if(collected%10===0){ launchConfettiSimple(28); playCelebration(); }
    orbs = orbs.filter(x=>x.id!==o.id); updateHUD(); playCollect(); }

  function spawnPopForOrb(o){ const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2; const x = cx + o.radius * Math.cos(o.angle); const y = cy + o.radius * Math.sin(o.angle); const parts=[]; const rgb = {r:200,g:220,b:255}; const count=Math.min(34,Math.round(8+o.size*1.4)); for(let i=0;i<count;i++){ const ang=Math.random()*Math.PI*2; parts.push({vx:Math.cos(ang)*(0.6+Math.random()*3.2),vy:Math.sin(ang)*(0.6+Math.random()*3.2),size:Math.random()*(o.size*0.8)+0.6,color:`rgba(${rgb.r},${rgb.g},${rgb.b},`}) } pops.push({x,y,parts,life:1,lifeMax:1,speed:42+o.size*6}); }

  function draw(now){ ctx.clearRect(0,0,W,H); drawBackground(now); drawOrbs(now); drawPops(now); drawVignette(); }
  function drawBackground(now){ ctx.save(); const grad = ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0,'rgba(6,10,18,0.20)'); grad.addColorStop(1,'rgba(3,6,12,0.32)'); ctx.fillStyle=grad; ctx.fillRect(0,0,W,H); ctx.restore(); }
  function drawOrbs(now){ const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2; for(const o of orbs){ o.angle += o.speed * ((now-last)/1000); o.rotation += o.rotSpeed; const x = cx + o.radius * Math.cos(o.angle), y = cy + o.radius * Math.sin(o.angle); ctx.save(); ctx.translate(x,y); ctx.rotate(o.rotation*0.12); const glow = ctx.createRadialGradient(0,0,0,0,0,o.size*2.6); glow.addColorStop(0,'rgba(255,255,255,0.08)'); glow.addColorStop(0.6,'rgba(255,255,255,0.02)'); glow.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(0,0,o.size*2.6,0,Math.PI*2); ctx.fill(); ctx.font = Math.max(16,Math.min(56,o.size)) + 'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ðŸ›°ï¸',0,0); if(o.rarity==='epic'||o.rarity==='rare'){ ctx.font='10px Poppins, Arial'; ctx.fillStyle='#fff'; ctx.fillText(o.rarity[0].toUpperCase(), o.size*0.85, -o.size*0.82); } ctx.restore(); o.screenX=x; o.screenY=y; } }
  function drawPops(now){ for(let i=pops.length-1;i>=0;i--){ const p=pops[i]; p.life -= (now-last)/420; const alpha = Math.max(0, p.life / p.lifeMax); for(const part of p.parts){ const px = p.x + part.vx * (1 - alpha) * p.speed; const py = p.y + part.vy * (1 - alpha) * p.speed; const s = Math.max(0.6, part.size * alpha); ctx.fillStyle = part.color + (0.88 * alpha) + ')'; ctx.beginPath(); ctx.ellipse(px,py,s,s,0,0,Math.PI*2); ctx.fill(); } if(p.life<=0) pops.splice(i,1); } }
  function drawVignette(){ const g = ctx.createRadialGradient(W/2,H/2,Math.max(W,H)/6,W/2,H/2,Math.max(W,H)/1.0); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(1,'rgba(0,0,0,0.18)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }

  function loop(now){ requestAnimationFrame(loop); const dt = Math.max(8, now-last); draw(now); last = now; }

  playCard.addEventListener('pointerdown',(e)=>{ if(e.pointerType==='mouse' && e.button!==0) return; const rect = playCard.getBoundingClientRect(); const p={x: e.clientX-rect.left, y: e.clientY-rect.top}; const found = hitTest(p.x,p.y); if(found){ collectOrb(found); return; } spawnOrbAt(e.clientX,e.clientY); });

  // audio
  let audioCtx=null; function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function playTone(freq=420,dur=0.06){ try{ ensureAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.12, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+dur); o.start(now); o.stop(now+dur+0.02);}catch(e){} }
  function playCollect(){ playTone(720,0.05); } function playCelebration(){ try{ ensureAudio(); const now=audioCtx.currentTime; const notes=[880,1100,1320,1760]; notes.forEach((n,i)=>{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=n; o.connect(g); g.connect(audioCtx.destination); const t=now+i*0.07; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.14,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.start(t); o.stop(t+0.26); }); }catch(e){} }
  document.addEventListener('pointerdown', ()=> ensureAudio(), {once:true});

  // small helpers for leaderboard UI
  function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML = html; return e; }

  /* -------------------------
     REAL-TIME LEADERBOARD
     - Top 10 (onSnapshot)
     - Show user's rank (using getCountFromServer)
  --------------------------*/
  const scoresColl = collection(db, 'gameScores');
  function initLeaderboardRealtime(){
    const qTop = query(scoresColl, orderBy('high','desc'), limit(10));
    onSnapshot(qTop, snapshot => {
      const docs = snapshot.docs.map(d => ({ id:d.id, ...(d.data()) }));
      renderTopList(docs);
    });
  }

  function renderTopList(rows){ leadersEl.innerHTML = '';
    rows.forEach((r, idx)=>{
      const row = el('div','leader-row'+(currentUser&&currentUser.uid===r.id?' you':''));
      if(currentUser && currentUser.uid===r.id) row.classList.add('you');
      const left = el('div','meta',`<div class="rank">${idx+1}</div><div><div class="name">${r.name||r.displayName||'Anonymous'}</div><div class="small">${r.slug?('@'+r.slug):('#'+(r.id||'anon').slice(0,6))}</div></div>`);
      const right = el('div','score', String(r.high||0));
      row.appendChild(left); row.appendChild(right);
      leadersEl.appendChild(row);
    });
  }

  async function updateMyRankUI(){
    if(!currentUser){ myRowEl.innerHTML = 'Not signed in â€” sign in to save & see your exact rank. <button id="btnSignIn2" class="signin">Sign In</button>'; document.getElementById('btnSignIn2').addEventListener('click', doSignIn); return; }
    // read my saved high
    const myRef = doc(db, 'gameScores', currentUser.uid);
    const mySnap = await getDoc(myRef);
    const myHigh = (mySnap.exists() && mySnap.data().high) ? mySnap.data().high : high;
    // count number of docs with high > myHigh
    const q = query(scoresColl, where('high','>', myHigh));
    try{
      const cntSnap = await getCountFromServer(q);
      const rank = cntSnap.data().count + 1;
      // show a compact row (highlight if beyond top 10)
      myRowEl.innerHTML = '';
      const left = el('div',null,`<div style="font-weight:700">${currentProfile?.name || currentUser.displayName || 'You'}</div><div class="small">${currentProfile?.slug?('@'+currentProfile.slug):('@'+currentUser.uid.slice(0,6))}</div>`);
      const right = el('div',null,`<div style="font-weight:800">#${rank}</div><div class="small">High: ${myHigh}</div>`);
      myRowEl.appendChild(left); myRowEl.appendChild(right);
      myRowEl.classList.toggle('you', true);
    }catch(e){ console.warn('rank calc failed', e); }
  }

  // listen for real-time changes and update my-row when relevant
  function watchMyDoc(){ if(!currentUser) return; const myRef = doc(db,'gameScores', currentUser.uid); onSnapshot(myRef, snap => { updateMyRankUI(); }); }

  // save to cloud (user required)
  async function saveScoreToCloud(){ if(!currentUser){ alert('Sign in required to save to cloud.'); return; }
    try{
      const ref = doc(db, 'gameScores', currentUser.uid);
      const payload = { high, name: currentProfile?.name || currentUser.displayName || null, slug: currentProfile?.slug || null, lastUpdated: serverTimestamp() };
      await setDoc(ref, payload, { merge:true });
      alert('Saved! Leaderboard will update automatically.');
    }catch(e){ console.error('save fail', e); alert('Save failed.'); }
  }

  // auth UI & wiring
  async function doSignIn(){ try{ await signInWithPopup(auth, provider); alert('Signed in'); }catch(e){ console.warn(e); alert('Sign-in failed'); } }
  profileBtn.addEventListener('click', doSignIn); btnSignIn.addEventListener('click', doSignIn); btnSaveLocal.addEventListener('click', saveScoreToCloud);

  earthEl.addEventListener('dblclick', async ()=>{ if(currentUser){ alert('Signed in as ' + (currentUser.displayName || currentUser.email)); return; } try{ await signInWithPopup(auth, provider); alert('Signed in'); }catch(e){ console.warn(e); alert('Sign-in failed'); } });

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    if(user){ // attempt to read user profile (usersPrivate)
      try{ const pRef = doc(db,'usersPrivate', user.uid); const pSnap = await getDoc(pRef); if(pSnap.exists()) currentProfile = pSnap.data(); else currentProfile = { name: user.displayName || null, slug: null }; }catch(e){ currentProfile = { name: user.displayName || null, slug: null }; }
      updateHUD(); updateMyRankUI(); watchMyDoc();
    } else { currentProfile = null; updateHUD(); myRowEl.innerHTML = 'Not signed in â€” sign in to save & see your exact rank. <button id="btnSignIn3" class="signin">Sign In</button>'; document.getElementById('btnSignIn3').addEventListener('click', doSignIn); }
    // re-render top list highlight if needed
  });

  // initialize leaderboard realtime
  initLeaderboardRealtime();

  /* -------------------------
     init / boot: spawn some orbs + animation
  --------------------------*/
  function init(){ DPR = Math.max(1, window.devicePixelRatio||1); resizeCanvas(); const rect = playCard.getBoundingClientRect(); for(let i=0;i<4;i++) spawnOrbAt(rect.left+rect.width/2 + rand(-120,120), rect.top+rect.height/2 + rand(-80,80)); last = performance.now(); requestAnimationFrame(function f(t){ loop(t); }); updateHUD(); }
  window.addEventListener('load', init);

  // persist high locally on unload
  window.addEventListener('beforeunload', ()=>{ localStorage.setItem('galaxy_high', high); });

  </script>
</body>
</html>