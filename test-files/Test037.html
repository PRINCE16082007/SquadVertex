<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxy â€” Orbit Game (Upgraded with Real-time Leaderboard)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    :root{ --bg:#071226; --card:#071728; --accent:#64c2ff; --accent-2:#ffb86b; --muted:#bfeaff; --glass: rgba(255,255,255,0.04) }
    html,body{height:100%;margin:0;font-family:Inter, Poppins, Arial, sans-serif;background:linear-gradient(180deg,#021021 0%, #071226 100%);color:#eaf6ff}
    .container{max-width:1240px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
    header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .logo{display:flex;align-items:center;gap:10px;cursor:pointer}
    .logo img{height:44px}
    .title{font-weight:800;font-size:1.28rem;letter-spacing:0.4px}

    /* Play card */
    .play-card{background:linear-gradient(180deg, rgba(3,10,18,0.70), rgba(6,12,20,0.44));border-radius:14px;padding:14px;position:relative;overflow:visible;border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 40px rgba(2,6,10,0.9)}
    .play-area{height:560px;border-radius:12px;position:relative;background:conic-gradient(from 180deg at 50% 50%, rgba(10,30,50,0.06), rgba(3,8,14,0.28));backdrop-filter:blur(4px);}
    canvas.play-canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    .orbit-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:8;display:flex;align-items:center;justify-content:center}
    .earth-game{width:132px;height:132px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:default;box-shadow:0 12px 32px rgba(8,18,34,0.8);border:1px solid rgba(255,255,255,0.05);background:radial-gradient(circle at 35% 28%, rgba(255,255,255,0.04), rgba(0,0,0,0.22));transform:translateZ(0);}

    .hud{position:absolute;right:18px;top:18px;z-index:20;background:linear-gradient(180deg, rgba(12,20,28,0.64), rgba(6,10,16,0.46));padding:10px 14px;border-radius:12px;border:1px solid var(--glass);display:flex;gap:12px;align-items:center;backdrop-filter: blur(6px)}
    .hud .label{font-weight:800;color:#fff}
    .hud .muted{color:var(--muted);font-size:0.86rem}
    .hud .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:700}

    /* Leaderboard */
    .leaderboard{background:linear-gradient(180deg, rgba(6,12,20,0.7), rgba(5,9,16,0.5));border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 14px 36px rgba(0,0,0,0.6)}
    .leaderboard h3{margin:0 0 8px 0;color:var(--accent);font-size:1.1rem}
    .leaders{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .leader-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);}
    .leader-row .meta{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0b2b3a,#05202b);border:1px solid rgba(255,255,255,0.03);font-weight:800}
    .rank{width:40px;text-align:center;font-weight:900}
    .name{font-weight:800}
    .slug{font-size:0.82rem;color:var(--muted)}
    .score{font-weight:900;color:#fff}
    .you{box-shadow:0 8px 18px rgba(100,194,255,0.06);border:1px solid rgba(100,194,255,0.12);background:linear-gradient(90deg, rgba(100,194,255,0.035), rgba(100,194,255,0.015));}
    .small{font-size:0.82rem;color:var(--muted)}

    .leader-footer{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .my-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.02)}
    .signin{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:700}
    .note{font-size:0.82rem;color:#d7f6ff;background:linear-gradient(90deg, rgba(100,194,255,0.03), rgba(255,184,107,0.02));padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}

    /* playful badges */
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:800;font-size:0.78rem}
    .badge.gold{background:linear-gradient(90deg,#ffd97a,#ffb86b);color:#2b1b00}
    .badge.silver{background:linear-gradient(90deg,#c7d9ff,#9fbfff);color:#04233d}
    .badge.bronze{background:linear-gradient(90deg,#ffd6c0,#ffbda0);color:#3b1b00}

    /* Responsive */
    @media (max-width:1020px){.container{grid-template-columns:1fr}.leaderboard{order:2;margin-top:10px}}
  </style>
</head>
<body>
  <div class="container">
    <div>
      <header>
        <div class="logo" onclick="location.reload()">
          <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="logo"/>
          <div class="title">Galaxy â€” Orbit (Play)</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <button id="profileBtn" class="signin">Sign In</button>
          <button id="btnSaveLocal" class="signin" title="Save now">Save (Cloud)</button>
        </div>
      </header>

      <div class="play-card" id="playCard" role="application" aria-label="Orbit game area">
        <div class="play-area">
          <canvas id="playCanvas" class="play-canvas"></canvas>
          <div class="orbit-center"><div id="earthEl" class="earth-game" title="Double-click to sign in">ðŸŒŽ</div></div>
          <div id="hud" class="hud" aria-hidden="false">
            <div>
              <div class="label" id="hudName">Guest</div>
              <div class="muted" id="hudSlug">@guest</div>
            </div>
            <div style="width:14px"></div>
            <div style="text-align:right">
              <div class="label" id="hudCollected">0</div>
              <div class="muted" id="hudHigh">High: 0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <aside class="leaderboard" aria-live="polite">
      <h3>Real-time Leaderboard</h3>
      <div class="small">Top 10 players by High Score â€” updates live (slug field used as username)</div>
      <div style="height:10px"></div>
      <div id="leaders" class="leaders"></div>

      <div class="leader-footer">
        <div class="note">Auto-save: while signed in your high score is automatically saved every <strong>30 seconds</strong>. (You can still click "Save (Cloud)" to force-save immediately.)</div>
        <div class="small">Your current rank (updates after sign-in &amp; save)</div>
        <div id="myRow" class="my-row">Not signed in â€” your rank is hidden. <button id="btnSignIn" class="signin">Sign In</button></div>
      </div>
    </aside>
  </div>

  <!-- Firebase + Game code -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js";
  import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp, query, orderBy, limit, onSnapshot, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

  // --- firebase config (kept same as provided) ---
  const firebaseConfig = {
    apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
    authDomain: "teamgalaxy-77344.firebaseapp.com",
    projectId: "teamgalaxy-77344",
    storageBucket: "teamgalaxy-77344.firebasestorage.app",
    messagingSenderId: "770256225320",
    appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
    measurementId: "G-6C2W9NSNCH"
  };

  const app = initializeApp(firebaseConfig);
  try{ const appCheckProvider = new ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx'); initializeAppCheck(app, { provider: appCheckProvider, isTokenAutoRefreshEnabled: true }); }catch(e){ console.warn('AppCheck failed', e); }

  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // DOM refs
  const playCanvas = document.getElementById('playCanvas');
  const playCard = document.getElementById('playCard');
  const earthEl = document.getElementById('earthEl');
  const hudCollected = document.getElementById('hudCollected');
  const hudHigh = document.getElementById('hudHigh');
  const hudName = document.getElementById('hudName');
  const hudSlug = document.getElementById('hudSlug');
  const leadersEl = document.getElementById('leaders');
  const myRowEl = document.getElementById('myRow');
  const profileBtn = document.getElementById('profileBtn');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSaveLocal = document.getElementById('btnSaveLocal');

  // --- visual confetti (simple) ---
  function createConfettiCanvas(){ const c = document.createElement('canvas'); c.style.position='fixed'; c.style.left='0'; c.style.top='0'; c.style.width='100%'; c.style.height='100%'; c.style.pointerEvents='none'; c.style.zIndex=9999; document.body.appendChild(c); const ctx=c.getContext('2d'); function resize(){ c.width = window.innerWidth; c.height = window.innerHeight; } window.addEventListener('resize', resize); resize(); return {c,ctx,parts:[]}; }
  const confetti = createConfettiCanvas();
  function launchConfettiSimple(count=42){ const {c,ctx,parts} = confetti; for(let i=0;i<count;i++){ parts.push({x:Math.random()*c.width,y:-20+Math.random()*-80,vx:(Math.random()-0.5)*6,vy:Math.random()*6+3,life:1,size:6+Math.random()*8,color:['#ffd166','#06d6a0','#118ab2','#ef476f'][Math.floor(Math.random()*4)]}) } requestAnimationFrame(function frame(){ ctx.clearRect(0,0,c.width,c.height); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.vy+=0.18; p.x+=p.vx; p.y+=p.vy; p.life-=0.01; ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); ctx.restore(); if(p.y>c.height+40||p.life<=0) parts.splice(i,1); } if(parts.length>0) requestAnimationFrame(frame); else ctx.clearRect(0,0,c.width,c.height); }); }

  // --- Game core (from your original, preserved & enhanced) ---
  let DPR = Math.max(1, window.devicePixelRatio||1); let W=0,H=0; const ctx = playCanvas.getContext('2d'); let last=performance.now(); let orbs=[]; let pops=[]; let nextId=1; const MAX_ORBS=32;
  const ORB_TYPES=[{name:'common',chance:0.72,size:18,score:1,color:'#8EE7FF'},{name:'uncommon',chance:0.18,size:26,score:3,color:'#FFD57B'},{name:'rare',chance:0.07,size:34,score:6,color:'#B8FF9A'},{name:'epic',chance:0.03,size:44,score:12,color:'#FF9AD6'}];

  let collected = 0; let high = parseInt(localStorage.getItem('galaxy_high'))||0; let lastSavedHigh = high;
  let currentUser=null; let currentProfile=null;

  function rand(a,b){return a+Math.random()*(b-a);} function pickType(){const r=Math.random();let s=0;for(const t of ORB_TYPES){s+=t.chance;if(r<=s) return t;}return ORB_TYPES[0];}

  function updateHUD(){ hudCollected.textContent = collected; hudHigh.textContent = 'High: ' + high; hudName.textContent = currentProfile?.name || (currentUser?.displayName || 'Guest'); hudSlug.textContent = currentProfile?.slug ? ('@'+currentProfile.slug) : (currentUser ? ('@'+currentUser.uid.slice(0,6)) : '@guest'); }

  function resizeCanvas(){ const rect = playCard.getBoundingClientRect(); const computedWidth = Math.min(rect.width, Math.max(320, window.innerWidth-140)); W = Math.max(320, Math.floor(computedWidth)); H = Math.max(220, Math.floor(rect.height)); playCanvas.style.width = W+'px'; playCanvas.style.height = H+'px'; playCanvas.width = Math.floor(W*DPR); playCanvas.height = Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
  window.addEventListener('resize', resizeCanvas);

  function spawnOrbAt(clientX, clientY){ if(orbs.length>=MAX_ORBS) return; const rect = playCard.getBoundingClientRect(); const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2; const px = clientX || (cx + rand(-160,160)); const py = clientY || (cy + rand(-120,120)); const dx = px-cx, dy = py-cy; const radius = Math.max(72, Math.min(Math.hypot(dx,dy), Math.min(rect.width,rect.height)/2 - 36)); const angle = Math.atan2(dy,dx); const baseSpeed = 0.9 / Math.sqrt(Math.max(1, radius/90)); const speed = (Math.random()<0.5?1:-1)*baseSpeed*(0.6+Math.random()*0.9); const t = pickType(); const orb={id:nextId++,angle,radius,speed,size:t.size*(0.9+Math.random()*0.18),color:t.color,score:t.score,rarity:t.name,rotation:Math.random()*Math.PI*2,rotSpeed:(Math.random()*0.9-0.45)*0.02}; orbs.push(orb); }

  function hitTest(x,y){ let best=null,bestD=Infinity; const rect=playCard.getBoundingClientRect(); const cx=rect.width/2, cy=rect.height/2; for(const o of orbs){ const ox=cx+o.radius*Math.cos(o.angle), oy=cy+o.radius*Math.sin(o.angle); const d=Math.hypot(x-ox,y-oy); const hitR=Math.max(18,o.size*1.6); if(d<=hitR && d<bestD){best=o;bestD=d;} } return best; }

  function collectOrb(o){ if(!o) return; spawnPopForOrb(o); const prev=collected; collected+=o.score; if(collected>high){ high=collected; localStorage.setItem('galaxy_high',high); flashHigh(); playCelebration(); launchConfettiSimple(72); } if(collected%10===0){ launchConfettiSimple(28); playCelebration(); } orbs = orbs.filter(x=>x.id!==o.id); updateHUD(); playCollect(); }

  function spawnPopForOrb(o){ const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2; const x = cx + o.radius * Math.cos(o.angle); const y = cy + o.radius * Math.sin(o.angle); const parts=[]; const rgb = {r:200,g:220,b:255}; const count=Math.min(34,Math.round(8+o.size*1.4)); for(let i=0;i<count;i++){ const ang=Math.random()*Math.PI*2; parts.push({vx:Math.cos(ang)*(0.6+Math.random()*3.2),vy:Math.sin(ang)*(0.6+Math.random()*3.2),size:Math.random()*(o.size*0.8)+0.6,color:`rgba(${rgb.r},${rgb.g},${rgb.b},`}) } pops.push({x,y,parts,life:1,lifeMax:1,speed:42+o.size*6}); }

  function draw(now){ ctx.clearRect(0,0,W,H); drawBackground(now); drawOrbs(now); drawPops(now); drawVignette(); }
  function drawBackground(now){ ctx.save(); const grad = ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0,'rgba(6,10,18,0.20)'); grad.addColorStop(1,'rgba(3,6,12,0.32)'); ctx.fillStyle=grad; ctx.fillRect(0,0,W,H); ctx.restore(); }
  function drawOrbs(now){ const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2; for(const o of orbs){ o.angle += o.speed * ((now-last)/1000); o.rotation += o.rotSpeed; const x = cx + o.radius * Math.cos(o.angle), y = cy + o.radius * Math.sin(o.angle); ctx.save(); ctx.translate(x,y); ctx.rotate(o.rotation*0.12); const glow = ctx.createRadialGradient(0,0,0,0,0,o.size*2.6); glow.addColorStop(0,'rgba(255,255,255,0.08)'); glow.addColorStop(0.6,'rgba(255,255,255,0.02)'); glow.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(0,0,o.size*2.6,0,Math.PI*2); ctx.fill(); ctx.font = Math.max(18,Math.min(56,o.size)) + 'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ðŸ›°ï¸',0,0); if(o.rarity==='epic'||o.rarity==='rare'){ ctx.font='11px Poppins, Arial'; ctx.fillStyle='#fff'; ctx.fillText(o.rarity[0].toUpperCase(), o.size*0.85, -o.size*0.82); } ctx.restore(); o.screenX=x; o.screenY=y; } }
  function drawPops(now){ for(let i=pops.length-1;i>=0;i--){ const p=pops[i]; p.life -= (now-last)/420; const alpha = Math.max(0, p.life / p.lifeMax); for(const part of p.parts){ const px = p.x + part.vx * (1 - alpha) * p.speed; const py = p.y + part.vy * (1 - alpha) * p.speed; const s = Math.max(0.6, part.size * alpha); ctx.fillStyle = part.color + (0.88 * alpha) + ')'; ctx.beginPath(); ctx.ellipse(px,py,s,s,0,0,Math.PI*2); ctx.fill(); } if(p.life<=0) pops.splice(i,1); } }
  function drawVignette(){ const g = ctx.createRadialGradient(W/2,H/2,Math.max(W,H)/6,W/2,H/2,Math.max(W,H)/1.0); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(1,'rgba(0,0,0,0.18)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }

  function loop(now){ requestAnimationFrame(loop); const dt = Math.max(8, now-last); draw(now); last = now; }

  playCard.addEventListener('pointerdown',(e)=>{ if(e.pointerType==='mouse' && e.button!==0) return; const rect = playCard.getBoundingClientRect(); const p={x: e.clientX-rect.left, y: e.clientY-rect.top}; const found = hitTest(p.x,p.y); if(found){ collectOrb(found); return; } spawnOrbAt(e.clientX,e.clientY); });

  // audio
  let audioCtx=null; function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function playTone(freq=420,dur=0.06){ try{ ensureAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.12, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+dur); o.start(now); o.stop(now+dur+0.02);}catch(e){} }
  function playCollect(){ playTone(720,0.05); } function playCelebration(){ try{ ensureAudio(); const now=audioCtx.currentTime; const notes=[880,1100,1320,1760]; notes.forEach((n,i)=>{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=n; o.connect(g); g.connect(audioCtx.destination); const t=now+i*0.07; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.14,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.start(t); o.stop(t+0.26); }); }catch(e){} }
  document.addEventListener('pointerdown', ()=> ensureAudio(), {once:true});

  // small helpers for leaderboard UI
  function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML = html; return e; }

  /* -------------------------
     REAL-TIME LEADERBOARD
     - Top 10 (onSnapshot)
     - Show user's rank (using getCountFromServer)
     - Uses `slug` field for username when present
  --------------------------*/
  const scoresColl = collection(db, 'gameScores');
  function initLeaderboardRealtime(){
    const qTop = query(scoresColl, orderBy('high','desc'), limit(10));
    onSnapshot(qTop, snapshot => {
      const docs = snapshot.docs.map(d => ({ id:d.id, ...(d.data()) }));
      renderTopList(docs);
    });
  }

  function renderTopList(rows){ leadersEl.innerHTML = '';
    rows.forEach((r, idx)=>{
      const isYou = currentUser && currentUser.uid === r.id;
      const row = el('div','leader-row' + (isYou? ' you' : ''));
      if(isYou) row.classList.add('you');

      // avatar: use first letter of slug or name
      const avatarText = (r.slug && r.slug.length>0) ? r.slug.slice(0,2).toUpperCase() : (r.name? r.name.slice(0,2).toUpperCase() : (r.id||'--').slice(0,2).toUpperCase());
      const avatar = el('div','avatar', avatarText);

      // display name and slug (IMPORTANT: use `slug` field specifically for username)
      const displayName = r.name || r.displayName || 'Anonymous';
      const slugText = r.slug ? ('@' + r.slug) : ('@' + (r.id||'anon').slice(0,6));

      const left = el('div','meta');
      const rank = el('div','rank', String(idx+1));
      const nameBlock = el('div',null, `<div class="name">${displayName}</div><div class="slug">${slugText}</div>`);
      left.appendChild(rank); left.appendChild(avatar); left.appendChild(nameBlock);

      const right = el('div','score', String(r.high || 0));
      row.appendChild(left); row.appendChild(right);
      leadersEl.appendChild(row);
    });
  }

  async function updateMyRankUI(){
    if(!currentUser){ myRowEl.innerHTML = 'Not signed in â€” sign in to save & see your exact rank. <button id="btnSignIn2" class="signin">Sign In</button>'; document.getElementById('btnSignIn2').addEventListener('click', doSignIn); return; }
    // read my saved high (if any)
    const myRef = doc(db, 'gameScores', currentUser.uid);
    const mySnap = await getDoc(myRef);
    const myHigh = (mySnap.exists() && mySnap.data().high) ? mySnap.data().high : high;

    // count number of docs with high > myHigh
    const q = query(scoresColl, where('high','>', myHigh));
    try{
      const cntSnap = await getCountFromServer(q);
      const rank = cntSnap.data().count + 1;
      myRowEl.innerHTML = '';
      const left = el('div',null,`<div style="font-weight:800">${currentProfile?.name || currentUser.displayName || 'You'}</div><div class="small">${currentProfile?.slug?('@'+currentProfile.slug):('@'+currentUser.uid.slice(0,6))}</div>`);
      const right = el('div',null,`<div style="font-weight:900">#${rank}</div><div class="small">High: ${myHigh}</div>`);
      myRowEl.appendChild(left); myRowEl.appendChild(right);
      myRowEl.classList.add('you');
    }catch(e){ console.warn('rank calc failed', e); }
  }

  // Listen for changes to my doc and update
  function watchMyDoc(){ if(!currentUser) return; const myRef = doc(db,'gameScores', currentUser.uid); onSnapshot(myRef, snap => { updateMyRankUI(); }); }

  // Save to cloud (user must be signed in)
  async function saveScoreToCloud(force=false){ if(!currentUser){ if(force) alert('Sign in required to save to cloud.'); return; }
    try{
      const ref = doc(db, 'gameScores', currentUser.uid);
      const payload = { high, name: currentProfile?.name || currentUser.displayName || null, slug: currentProfile?.slug || null, lastUpdated: serverTimestamp() };
      await setDoc(ref, payload, { merge:true });
      lastSavedHigh = high;
      if(force) alert('Saved! Leaderboard will update automatically.');
    }catch(e){ console.error('save fail', e); if(force) alert('Save failed.'); }
  }

  // Auto-save every 30 seconds (only when user signed in and high changed)
  setInterval(()=>{
    if(currentUser && high && high !== lastSavedHigh){ saveScoreToCloud(false); }
  }, 30000);

  // Auth UI & wiring
  async function doSignIn(){ try{ await signInWithPopup(auth, provider); }catch(e){ console.warn(e); alert('Sign-in failed'); } }
  profileBtn.addEventListener('click', doSignIn); btnSignIn.addEventListener('click', doSignIn); btnSaveLocal.addEventListener('click', ()=> saveScoreToCloud(true));

  earthEl.addEventListener('dblclick', async ()=>{ if(currentUser){ alert('Signed in as ' + (currentUser.displayName || currentUser.email)); return; } try{ await signInWithPopup(auth, provider); }catch(e){ console.warn(e); alert('Sign-in failed'); } });

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    if(user){ try{ const pRef = doc(db,'usersPrivate', user.uid); const pSnap = await getDoc(pRef); if(pSnap.exists()) currentProfile = pSnap.data(); else currentProfile = { name: user.displayName || null, slug: null }; }catch(e){ currentProfile = { name: user.displayName || null, slug: null }; }
      updateHUD(); updateMyRankUI(); watchMyDoc();
    } else { currentProfile = null; updateHUD(); myRowEl.innerHTML = 'Not signed in â€” sign in to save & see your exact rank. <button id="btnSignIn3" class="signin">Sign In</button>'; document.getElementById('btnSignIn3').addEventListener('click', doSignIn); }
  });

  // initialize leaderboard realtime
  function initLeaderboardRealtime(){ const qTop = query(scoresColl, orderBy('high','desc'), limit(10)); onSnapshot(qTop, snapshot => { const docs = snapshot.docs.map(d => ({ id:d.id, ...(d.data()) })); renderTopList(docs); }); }
  initLeaderboardRealtime();

  /* -------------------------
     init / boot: spawn some orbs + animation
  --------------------------*/
function init(){ DPR = Math.max(1, window.devicePixelRatio||1); resizeCanvas(); const rect = playCard.getBoundingClientRect(); for(let i=0;i<5;i++) spawnOrbAt(rect.left+rect.width/2 + rand(-160,160), rect.top+rect.height/2 + rand(-120,120)); last = performance.now(); requestAnimationFrame(function f(t){ loop(t); }); updateHUD(); }
  window.addEventListener('load', init);

  // persist high locally on unload
  window.addEventListener('beforeunload', ()=>{ localStorage.setItem('galaxy_high', high); });

  </script>

  <!--
    Index suggestion for Firestore (create in Firebase console):

    Collection: gameScores
    Composite index (recommended):
      - Field A: high (descending)
      - Field B: lastUpdated (descending)
    Purpose: speeds up queries that both order by high and may filter/paginate by lastUpdated OR perform more complex queries later. Top-10 (orderBy('high','desc') limit(10)) doesn't strictly need a composite index, but having this composite index allows future combined queries and sorting to be fast.

    Security note: ensure your Firestore security rules allow signed-in users to read the public leaderboard (or create a restricted cloud function endpoint) and allow each user to write only their own gameScores doc (match /gameScores/{uid} -> allow write if request.auth.uid == uid).
  -->

</body>
</html>