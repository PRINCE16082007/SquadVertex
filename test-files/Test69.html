<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fee Management - Students</title>
  <!-- Bootstrap CSS CDN (Bootstrap 4) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Control horizontal overflow */
    .table-responsive { overflow-x: auto; }
    .status-paid { background-color: #d4edda; }
    .status-partial { background-color: #fff3cd; }
    .status-pending { background-color: #f8d7da; }
    /* Optional: limit overall page overflow */
    body { overflow-x: hidden; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">FeeManage</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item active"><a class="nav-link" href="students.html">Students</a></li>
        <li class="nav-item"><a class="nav-link" href="transactions.html">Transactions</a></li>
      </ul>
    </div>
  </nav>

  <!-- Students Management Content -->
  <div class="container mt-4">
    <h3 class="mb-4">Students &amp; Fees Management</h3>
    <!-- Search & Filter Section (optional; you can expand later) -->
    <div class="row mb-3">
      <div class="col-md-3">
        <input type="text" id="student-search" class="form-control" placeholder="Search by Name or No">
      </div>
      <div class="col-md-3">
        <select id="class-filter" class="form-control">
          <option value="">Select Class</option>
          <option value="10">Class 10</option>
          <option value="9">Class 9</option>
          <!-- More as needed -->
        </select>
      </div>
      <div class="col-md-3">
        <select id="stream-filter" class="form-control">
          <option value="">Select Stream</option>
          <option value="Science">Science</option>
          <option value="Commerce">Commerce</option>
          <option value="Arts">Arts</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="vehicle-status-filter" class="form-control">
          <option value="both">Vehicle: Both</option>
          <option value="pending">Vehicle: Pending</option>
          <option value="not_pending">Vehicle: Not Pending</option>
        </select>
      </div>
    </div>
    <!-- Students Table inside a responsive container -->
    <div class="table-responsive">
      <table class="table table-bordered" id="students-table">
        <thead class="thead-dark">
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Father's Name</th>
            <th>Class</th>
            <th>Stream</th>
            <th>Total Fee</th>
            <th>Discount</th>
            <th>Final Total</th>
            <th>Paid</th>
            <th>Pending</th>
            <th>Vehicle Fee Total</th>
            <th>Vehicle Fee Paid</th>
            <th>Vehicle Fee Pending</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Student rows will be injected here -->
        </tbody>
      </table>
    </div>
    <!-- QR Code & UPI Info -->
    <div class="mt-4">
      <h5>Payment Info</h5>
      <p>Scan the QR Code or use UPI ID: <strong>school@upi</strong></p>
      <img src="https://via.placeholder.com/150?text=QR+Code" alt="UPI QR Code">
    </div>
  </div>

  <!-- Student Details Modal (remarks column removed from transactions table) -->
  <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailsModalLabel">Student Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Student Basic Info -->
          <div id="student-basic-info">
            <p><strong>No:</strong> <span id="detail-no"></span></p>
            <p><strong>Name:</strong> <span id="detail-name"></span></p>
            <p><strong>Father's Name:</strong> <span id="detail-father-name"></span></p>
            <p>
              <strong>Class:</strong> <span id="detail-class"></span> | 
              <strong>Stream:</strong> <span id="detail-stream"></span>
            </p>
            <p>
              <strong>Total Fee:</strong> <span id="detail-total-fee"></span> | 
              <strong>Discount:</strong> <span id="detail-discount"></span> | 
              <strong>Final Total:</strong> <span id="detail-final-total"></span>
            </p>
            <p>
              <strong>Paid:</strong> <span id="detail-paid"></span> | 
              <strong>Pending:</strong> <span id="detail-pending"></span>
            </p>
            <p>
              <strong>Vehicle Fee:</strong> Total: <span id="detail-vehicle-total"></span>, 
              Paid: <span id="detail-vehicle-paid"></span>, 
              Pending: <span id="detail-vehicle-pending"></span>
            </p>
          </div>
          <hr>
          <!-- Universal Fee Chart Details -->
          <div id="universal-fee-chart">
            <h5>Universal Fee Chart</h5>
            <p>
              For <strong>Class <span id="ufc-class"></span> - <span id="ufc-stream"></span></strong>:
            </p>
            <ul>
              <li><strong>Fee Amount:</strong> ₹<span id="ufc-fee"></span></li>
              <li><strong>Vehicle Rent:</strong> ₹<span id="ufc-vehicle-fee"></span>
                (<em>Category: <span id="ufc-vehicle-category"></span>, Expected Distance: <span id="ufc-distance"></span> km</em>)
              </li>
              <li><strong>Discount Offered:</strong> ₹<span id="ufc-discount"></span></li>
            </ul>
          </div>
          <hr>
          <!-- Transaction History (remarks column removed) -->
          <h5>Transaction History</h5>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Installment</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Mode</th>
                  <th>Transaction ID</th>
                </tr>
              </thead>
              <tbody id="student-transactions">
                <!-- Transactions will be populated here dynamically -->
              </tbody>
            </table>
          </div>
          <!-- All transactions are stored in the "transactions" document in Firestore -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and Dependencies -->
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- jQuery, Popper, and Bootstrap JS (for Bootstrap 4) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Firebase configuration (use your provided config)
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables to store fetched data
    let systemSettings = {};
    let transactionsData = {}; // assumed structure: { studentTransactions: { "studentId": [ { installment, date, amount, mode, txnId }, ... ] } }

    // Load system settings from Firestore
    function loadSystemSettings() {
      db.collection("001-school").doc("systemSettings").get()
      .then(doc => {
        if (doc.exists) {
          systemSettings = doc.data();
        } else {
          console.error("No system settings found!");
        }
      })
      .catch(err => console.error("Error loading system settings:", err));
    }

    // Load transactions data from Firestore
    function loadTransactionsData() {
      db.collection("001-school").doc("transactions").get()
      .then(doc => {
        if (doc.exists) {
          transactionsData = doc.data();
        } else {
          console.warn("No transactions data found!");
        }
      })
      .catch(err => console.error("Error loading transactions:", err));
    }

    // Load students from the "students" document's "list" subcollection
    function loadStudents() {
      db.collection("001-school").doc("students").collection("list").get()
      .then(querySnapshot => {
        const tbody = document.querySelector("#students-table tbody");
        tbody.innerHTML = ""; // clear table
        querySnapshot.forEach(doc => {
          const student = doc.data();
          // Use srNumber as "No"
          const no = student.srNumber || "";
          const name = student.studentName || "";
          const fatherName = student.fatherName || "";
          const sClass = student.class || "";
          const stream = student.stream || "";

          // Determine base fee from universalFeesChart (match by class and stream)
          let baseFee = 0;
          if(systemSettings.universalFeesChart && Array.isArray(systemSettings.universalFeesChart)) {
            systemSettings.universalFeesChart.forEach(feeRow => {
              if(feeRow.class === sClass && feeRow.stream === stream) {
                baseFee = feeRow.baseFee;
              }
            });
          }
          // For simplicity, assume discount is 0; finalTotal equals baseFee
          const discount = 0;
          const finalTotal = baseFee - discount;

          // Calculate paid amount from transactionsData (if exists)
          let paid = 0;
          // Assume transactionsData.studentTransactions is an object with keys as student document IDs
          // We'll use the document id (e.g. "student00050") as the key.
          const studentId = doc.id;
          if(transactionsData.studentTransactions && transactionsData.studentTransactions[studentId]) {
            transactionsData.studentTransactions[studentId].forEach(tx => {
              paid += tx.amount;
            });
          }
          const pending = finalTotal - paid;

          // For vehicle fee, for now we assume 0 (or you can set up similar logic using systemSettings.vehicleFeesChart)
          const vehicleTotal = 0, vehiclePaid = 0, vehiclePending = 0;

          // Determine status
          let status = (pending <= 0) ? "Paid" : "Partial";

          // Create table row
          const row = document.createElement("tr");
          // Add a status class for coloring (optional)
          row.className = (pending <= 0) ? "status-paid" : "status-partial";

          row.innerHTML = `
            <td>${no}</td>
            <td>${name}</td>
            <td>${fatherName}</td>
            <td>${sClass}</td>
            <td>${stream}</td>
            <td>₹${baseFee}</td>
            <td>₹${discount}</td>
            <td>₹${finalTotal}</td>
            <td>₹${paid}</td>
            <td>₹${pending}</td>
            <td>₹${vehicleTotal}</td>
            <td>₹${vehiclePaid}</td>
            <td>₹${vehiclePending}</td>
            <td>${status}</td>
            <td>
              <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#detailsModal" onclick="loadStudentDetails('${studentId}')">View Details</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(err => console.error("Error loading students:", err));
    }

    // Load student details into the modal
    function loadStudentDetails(studentId) {
      // First, load the specific student document from the students/list subcollection
      db.collection("001-school").doc("students").collection("list").doc(studentId).get()
      .then(doc => {
        if(doc.exists) {
          const student = doc.data();
          document.getElementById("detail-no").innerText = student.srNumber || "";
          document.getElementById("detail-name").innerText = student.studentName || "";
          document.getElementById("detail-father-name").innerText = student.fatherName || "";
          document.getElementById("detail-class").innerText = student.class || "";
          document.getElementById("detail-stream").innerText = student.stream || "";
          
          // Get base fee from universalFeesChart (matching on class and stream)
          let baseFee = 0;
          if(systemSettings.universalFeesChart && Array.isArray(systemSettings.universalFeesChart)) {
            systemSettings.universalFeesChart.forEach(feeRow => {
              if(feeRow.class === student.class && feeRow.stream === student.stream) {
                baseFee = feeRow.baseFee;
              }
            });
          }
          const discount = 0;
          const finalTotal = baseFee - discount;
          
          // Load transactions for this student from transactionsData
          let paid = 0;
          const studentTransactions = (transactionsData.studentTransactions && transactionsData.studentTransactions[studentId]) || [];
          const transTable = document.getElementById("student-transactions");
          transTable.innerHTML = "";
          studentTransactions.forEach((tx, index) => {
            paid += tx.amount;
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${tx.installment || (index + 1)}</td>
              <td>${tx.date || ""}</td>
              <td>₹${tx.amount || 0}</td>
              <td>${tx.mode || ""}</td>
              <td>${tx.txnId || ""}</td>
            `;
            transTable.appendChild(row);
          });
          const pending = finalTotal - paid;
          
          // Populate fee details
          document.getElementById("detail-total-fee").innerText = "₹" + baseFee;
          document.getElementById("detail-discount").innerText = "₹" + discount;
          document.getElementById("detail-final-total").innerText = "₹" + finalTotal;
          document.getElementById("detail-paid").innerText = "₹" + paid;
          document.getElementById("detail-pending").innerText = "₹" + pending;
          // For vehicle fee details, set to 0 (or fetch from student document if available)
          document.getElementById("detail-vehicle-total").innerText = "₹0";
          document.getElementById("detail-vehicle-paid").innerText = "₹0";
          document.getElementById("detail-vehicle-pending").innerText = "₹0";
          
          // Populate Universal Fee Chart details in the modal
          document.getElementById("ufc-class").innerText = student.class || "";
          document.getElementById("ufc-stream").innerText = student.stream || "";
          document.getElementById("ufc-fee").innerText = baseFee;
          // For demonstration, we set vehicle fee details from systemSettings.vehicleFeesChart if available
          if(systemSettings.vehicleFeesChart && systemSettings.vehicleFeesChart.length > 0) {
            // This is a placeholder; you can modify the logic to match a student’s vehicle if needed.
            document.getElementById("ufc-vehicle-fee").innerText = systemSettings.vehicleFeesChart[0].amount || "0";
            document.getElementById("ufc-vehicle-category").innerText = systemSettings.vehicleFeesChart[0].vehicleName || "";
            document.getElementById("ufc-distance").innerText = systemSettings.vehicleFeesChart[0].estimatedDistance || "0";
          } else {
            document.getElementById("ufc-vehicle-fee").innerText = "0";
            document.getElementById("ufc-vehicle-category").innerText = "";
            document.getElementById("ufc-distance").innerText = "0";
          }
          document.getElementById("ufc-discount").innerText = discount;
        } else {
          console.error("Student not found:", studentId);
        }
      })
      .catch(err => console.error("Error loading student details:", err));
    }

    // On page load, fetch all data from Firebase
    window.addEventListener("DOMContentLoaded", () => {
      loadSystemSettings();
      loadTransactionsData();
      // Give a short delay for settings and transactions to load before loading students
      setTimeout(loadStudents, 1000);
    });
  </script>
</body>
</html>