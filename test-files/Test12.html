<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SquadVertex — Posts</title>
  <style>
    /* Minimal modern UI — tweak as you like */
    :root{--bg:#071028;--card:#0b1220;--muted:#8faecf;--accent1:#2563eb;--accent2:#7c3aed;}
    body{margin:0;font-family:Inter,system-ui,Roboto,Segoe UI,Arial;background:var(--bg);color:#e6eef8}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
    .brand{font-weight:800}
    .container{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .meta{color:var(--muted);font-size:13px}
    .title{font-size:18px;font-weight:700;margin:6px 0}
    .snippet{color:#cfe3ff;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center}
    button{cursor:pointer;border:0;padding:8px 10px;border-radius:8px;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .small{font-size:13px;color:var(--muted)}
    .tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .vote{display:inline-flex;gap:6px;align-items:center}
    .count{font-weight:700}
    .actions{margin-top:10px;display:flex;gap:8px}
    .center{display:flex;justify-content:center}
    .link-like{background:transparent;color:#9fb3d6;border:0;cursor:pointer}
    form textarea,input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .comment{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="brand">SquadVertex</div>
    <div id="authArea"><button id="signInBtn">Sign in</button></div>
  </header>

  <div class="container">
    <div id="feedView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Latest Posts</h2>
            <div class="small muted">Sorted by publish time — newest first</div>
          </div>
          <div><button id="refreshBtn" class="btn-ghost">Refresh</button></div>
        </div>
      </div>

      <div id="postsList"></div>
      <div class="center"><button id="loadMoreBtn" class="btn-ghost">Load more</button></div>
    </div>

    <div id="postView" style="display:none">
      <div style="margin-bottom:12px"><button id="backToFeed" class="link-like">← Back to feed</button></div>
      <div id="postContainer"></div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Comments</h3>
        <div id="commentsList" style="max-height:420px;overflow:auto;margin-bottom:8px"></div>

        <div id="commentFormWrap">
          <div class="small muted">Add a comment</div>
          <textarea id="commentInput" placeholder="Say something..."></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="submitComment" class="btn-primary">Post comment</button>
            <button id="clearComment" class="btn-ghost">Clear</button>
            <div id="commentStatus" class="small muted" style="margin-left:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- CONFIG (do not change unless needed) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

    // ---------- Firebase imports (v11.9.0) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js';
    import {
      getFirestore, collection, query, orderBy, limit, startAfter, getDocs,
      doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
      where, serverTimestamp, runTransaction, increment
    } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js';

    // ---------- initialize ----------
    const app = initializeApp(firebaseConfig);
    try {
      initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
        isTokenAutoRefreshEnabled: true
      });
      console.log('App Check initialized');
    } catch(e) { console.warn('App Check problem', e); }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- page-state ----------
    const postsListEl = document.getElementById('postsList');
    const feedView = document.getElementById('feedView');
    const postView = document.getElementById('postView');
    const postContainer = document.getElementById('postContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const backToFeed = document.getElementById('backToFeed');
    const signInBtn = document.getElementById('signInBtn');
    const authArea = document.getElementById('authArea');
    const commentInput = document.getElementById('commentInput');
    const submitComment = document.getElementById('submitComment');
    const commentsList = document.getElementById('commentsList');
    const commentStatus = document.getElementById('commentStatus');
    const clearComment = document.getElementById('clearComment');

    let lastVisible = null;
    const PAGE_SIZE = 8;
    let currentUser = null;
    let currentUserProfile = null; // from /users/{uid} if exists
    let currentPostId = null;
    let commentsUnsub = null;

    // ---------- small helpers ----------
    function timeAgo(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if (diff < 60) return diff + 's';
      if (diff < 3600) return Math.floor(diff/60) + 'm';
      if (diff < 86400) return Math.floor(diff/3600) + 'h';
      return Math.floor(diff/86400) + 'd';
    }
    function snippet(text, n=220){ return text.length>n ? text.slice(0,n)+'…' : text; }

    // ---------- auth ----------
    async function signIn() {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error('Signin error', e); alert('Signin failed'); }
    }
    signInBtn.addEventListener('click', signIn);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        // try read existing users/{uid} doc for name/email
        try {
          const udocRef = doc(db,'users', user.uid);
          const uSnap = await getDoc(udocRef);
          if (uSnap.exists()) {
            currentUserProfile = uSnap.data();
          } else {
            currentUserProfile = { name: user.displayName || null, email: user.email || null };
          }
        } catch(e) { console.warn('users read failed', e); currentUserProfile = { name: user.displayName || null, email: user.email || null }; }
        authArea.innerHTML = `<div style="text-align:right"><div style="font-weight:700">${currentUserProfile?.name || user.email}</div>
          <div class="muted" style="font-size:12px">${currentUserProfile?.email || user.email}</div>
          <button id="signOutBtn" class="btn-ghost" style="margin-top:6px">Sign out</button></div>`;
        document.getElementById('signOutBtn').addEventListener('click', ()=> signOut(auth));
      } else {
        authArea.innerHTML = `<button id="signInBtn">Sign in</button>`;
        document.getElementById('signInBtn').addEventListener('click', signIn);
        currentUserProfile = null;
      }
      // re-render vote buttons to reflect current user's votes if viewing feed/post
      if (currentPostId) renderPostView(currentPostId);
      else { refreshFeed(true); }
    });

    // ---------- routing: if ?postId=... show single post view ----------
    const urlParams = new URLSearchParams(window.location.search);
    const requestedPostId = urlParams.get('postId');

    if (requestedPostId) {
      // show single post page
      feedView.style.display = 'none';
      postView.style.display = 'block';
      currentPostId = requestedPostId;
      renderPostView(requestedPostId);
    } else {
      feedView.style.display = 'block';
      postView.style.display = 'none';
      refreshFeed(true);
    }

    // ---------- FEED: fetch posts (paged) ----------
    async function refreshFeed(reset=false) {
      if (reset) { lastVisible = null; postsListEl.innerHTML = ''; }
      // query
      const postsRef = collection(db, 'posts');
      let q;
      if (!lastVisible) q = query(postsRef, orderBy('createdAt','desc'), limit(PAGE_SIZE));
      else q = query(postsRef, orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));
      try {
        const snaps = await getDocs(q);
        if (snaps.docs.length === 0) {
          if (!lastVisible) postsListEl.innerHTML = '<div class="card small muted">No posts yet — be the first.</div>';
          loadMoreBtn.style.display = 'none';
          return;
        }
        for (const d of snaps.docs) {
          renderPostCard(d.id, d.data());
        }
        lastVisible = snaps.docs[snaps.docs.length - 1];
        // show load more only if returned PAGE_SIZE items
        loadMoreBtn.style.display = snaps.docs.length === PAGE_SIZE ? 'inline-block' : 'none';
      } catch(e){ console.error('feed fetch error', e); postsListEl.innerHTML = '<div class="card small muted">Failed to load posts</div>'; }
    }

    refreshBtn.addEventListener('click', ()=> { lastVisible=null; postsListEl.innerHTML=''; refreshFeed(true); });

    loadMoreBtn.addEventListener('click', ()=> refreshFeed(false));

    function renderPostCard(postId, data) {
      const el = document.createElement('div');
      el.className = 'card';
      const author = data.authorName || data.authorEmail || 'Unknown';
      const created = data.createdAt ? timeAgo(data.createdAt) : '';
      el.innerHTML = `
        <div class="meta">${author} · <span class="muted">${created}</span></div>
        <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
        <div class="snippet">${escapeHTML(snippet(data.body || ''))}</div>
        <div class="tags">${(data.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>
        <div class="actions">
          <div class="vote">
            <button class="link-like upvote" data-id="${postId}">▲</button>
            <div class="count" id="up_${postId}">${data.upvotesCount||0}</div>
            <button class="link-like downvote" data-id="${postId}">▼</button>
            <div class="count" id="down_${postId}">${data.downvotesCount||0}</div>
          </div>
          <div style="margin-left:auto">
            <button class="btn-ghost commentBtn" data-id="${postId}">Comments (${data.commentsCount||0})</button>
            <button class="btn-primary viewBtn" data-id="${postId}">Open</button>
          </div>
        </div>
      `;
      postsListEl.appendChild(el);

      // attach handlers
      el.querySelector('.viewBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.commentBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.upvote').addEventListener('click', ()=> handleVoteClick(postId, 1));
      el.querySelector('.downvote').addEventListener('click', ()=> handleVoteClick(postId, -1));
    }

    function escapeHTML(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function openPostPage(postId) {
      // navigate to same file with ?postId
      const base = window.location.href.split('?')[0];
      window.location.href = base + '?postId=' + postId;
    }

    // ---------- Voting logic (safe per-user using 'votes' collection) ----------
    async function handleVoteClick(postId, delta) {
      if (!currentUser) { alert('Sign in to vote'); return; }
      const uid = currentUser.uid;
      const voteDocRef = doc(db, 'votes', `${postId}_${uid}`);
      const postRef = doc(db, 'posts', postId);

      try {
        await runTransaction(db, async (tx) => {
          const voteSnap = await tx.get(voteDocRef);
          const postSnap = await tx.get(postRef);
          if (!postSnap.exists()) throw 'Post not found';
          let up = postSnap.data().upvotesCount || 0;
          let down = postSnap.data().downvotesCount || 0;

          if (!voteSnap.exists()) {
            // create vote
            tx.set(voteDocRef, { postId, userId: uid, vote: delta, createdAt: serverTimestamp() });
            if (delta === 1) up++; else down++;
          } else {
            const prev = voteSnap.data().vote || 0;
            if (prev === delta) {
              // undo
              tx.delete(voteDocRef);
              if (delta === 1) up = Math.max(0, up-1); else down = Math.max(0, down-1);
            } else {
              // switch
              tx.update(voteDocRef, { vote: delta, updatedAt: serverTimestamp() });
              if (delta === 1) { up++; down = Math.max(0, down-1); }
              else { down++; up = Math.max(0, up-1); }
            }
          }
          tx.update(postRef, { upvotesCount: up, downvotesCount: down });
        });
        // update UI quickly by refetching either the single post view or the feed counts
        if (currentPostId === postId) renderPostView(postId);
        else refreshFeed(true);
      } catch(e) { console.error('vote failed', e); alert('Vote failed'); }
    }

    // ---------- POST VIEW (single post + comments) ----------
    backToFeed.addEventListener('click', ()=> {
      const base = window.location.href.split('?')[0];
      window.location.href = base; // go back to feed
    });

    async function renderPostView(postId) {
      currentPostId = postId;
      // clear previous
      postContainer.innerHTML = '<div class="card small muted">Loading post…</div>';
      commentsList.innerHTML = '';
      if (commentsUnsub) commentsUnsub();

      try {
        const postRef = doc(db,'posts',postId);
        const pSnap = await getDoc(postRef);
        if (!pSnap.exists()) { postContainer.innerHTML = '<div class="card small muted">Post not found</div>'; return; }
        const data = pSnap.data();
        const author = data.authorName || data.authorEmail || 'Unknown';
        const created = data.createdAt ? timeAgo(data.createdAt) : '';
        postContainer.innerHTML = `
          <div class="card">
            <div class="meta">${escapeHTML(author)} · <span class="muted">${created}</span></div>
            <div class="title">${escapeHTML(data.title || 'Untitled')}</div>
            <div style="margin-top:10px">${escapeHTML(data.body || '')}</div>
            <div class="tags">${(data.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>

            <div style="margin-top:12px" class="actions">
              <div class="vote">
                <button id="pvUp" class="link-like">▲</button>
                <div id="pvUpCount" class="count">${data.upvotesCount||0}</div>
                <button id="pvDown" class="link-like">▼</button>
                <div id="pvDownCount" class="count">${data.downvotesCount||0}</div>
              </div>
              <div style="margin-left:auto">
                <button id="openExternal" class="btn-ghost">Open raw</button>
              </div>
            </div>
          </div>
        `;

        // bind vote handlers and show user's current vote visually
        document.getElementById('pvUp').addEventListener('click', ()=> handleVoteClick(postId, 1));
        document.getElementById('pvDown').addEventListener('click', ()=> handleVoteClick(postId, -1));
        document.getElementById('openExternal').addEventListener('click', ()=> alert('This would open a dedicated post page if you host one separately.'));

        // fetch and highlight user's vote (if logged in)
        if (currentUser) {
          try {
            const voteSnap = await getDoc(doc(db,'votes', `${postId}_${currentUser.uid}`));
            const prev = voteSnap.exists() ? (voteSnap.data().vote||0) : 0;
            highlightVoteButtons(prev);
          } catch(e){ console.warn('vote read failed', e); }
        } else highlightVoteButtons(0);

        // subscribe to comments in real-time
        const commentsRef = collection(db, 'posts', postId, 'comments');
        const commentsQuery = query(commentsRef, orderBy('createdAt','asc'));
        commentsUnsub = onSnapshot(commentsQuery, (snap) => {
          commentsList.innerHTML = '';
          snap.forEach(docSnap => {
            const c = docSnap.data();
            const cEl = document.createElement('div');
            cEl.className = 'comment';
            cEl.innerHTML = `<div class="small muted">${escapeHTML(c.authorName||'Anonymous')} · ${c.createdAt ? timeAgo(c.createdAt) : ''}</div>
              <div style="margin-top:6px">${escapeHTML(c.body||'')}</div>`;
            commentsList.appendChild(cEl);
          });
        });

      } catch(e) { console.error('render post error', e); postContainer.innerHTML = '<div class="card small muted">Failed to load post</div>'; }
    }

    function highlightVoteButtons(v) {
      const up = document.getElementById('pvUp'), down = document.getElementById('pvDown');
      if (!up || !down) return;
      up.style.fontWeight = v === 1 ? '900' : '700';
      down.style.fontWeight = v === -1 ? '900' : '700';
    }

    // ---------- comments: add ----------
    clearComment.addEventListener('click', ()=> commentInput.value='');

    submitComment.addEventListener('click', async () => {
      if (!currentUser) { alert('Sign in to comment'); return; }
      const text = (commentInput.value || '').trim();
      if (!text) { commentStatus.textContent = 'Type your comment'; return; }
      commentStatus.textContent = 'Posting...';
      submitComment.disabled = true;
      try {
        const commentsRef = collection(db, 'posts', currentPostId, 'comments');
        await addDoc(commentsRef, {
          body: text,
          authorId: currentUser.uid,
          authorName: currentUserProfile?.name || currentUser.email || null,
          createdAt: serverTimestamp(),
          upvotesCount: 0
        });
        // increment commentsCount on post
        await updateDoc(doc(db,'posts',currentPostId), { commentsCount: increment(1) });
        commentInput.value = '';
        commentStatus.textContent = 'Posted';
      } catch(e) {
        console.error('post comment failed', e);
        commentStatus.textContent = 'Failed';
      } finally { submitComment.disabled = false; setTimeout(()=>commentStatus.textContent='',1200); }
    });

    // ---------- initial render for feed view ----------
    function showFeed() {
      feedView.style.display = 'block';
      postView.style.display = 'none';
    }
    function showPost() {
      feedView.style.display = 'none';
      postView.style.display = 'block';
    }
    // ensure proper view shown depending on currentPostId
    if (currentPostId) { showPost(); } else { showFeed(); }

  </script>
</body>
</html>