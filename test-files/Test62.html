<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SchoolMS - Admin & Settings</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Flatpickr CSS for multi-date holiday selection -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      .admin-section {
        margin-top: 20px;
      }
      .schedule-section {
        margin-top: 30px;
        border: 1px solid #dee2e6;
        padding: 20px;
        border-radius: 5px;
      }
      .period-row {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .section-title {
        margin-top: 30px;
        margin-bottom: 15px;
      }
      .readonly-duration {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <!-- Navbar (same on all pages) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SchoolMS</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="admissions.html">Admissions</a></li>
            <li class="nav-item"><a class="nav-link" href="staff.html">Staff</a></li>
            <li class="nav-item"><a class="nav-link" href="attendance.html">Attendance</a></li>
            <li class="nav-item"><a class="nav-link" href="classes.html">Classes</a></li>
            <li class="nav-item"><a class="nav-link" href="exams.html">Exams</a></li>
            <li class="nav-item"><a class="nav-link" href="library.html">Library</a></li>
            <li class="nav-item"><a class="nav-link" href="transport.html">Transport</a></li>
            <li class="nav-item"><a class="nav-link" href="hostel.html">Hostel</a></li>
            <li class="nav-item"><a class="nav-link" href="communications.html">Communications</a></li>
            <li class="nav-item"><a class="nav-link" href="inventory.html">Inventory</a></li>
            <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
            <li class="nav-item active"><a class="nav-link" href="admin.html">Admin</a></li>
            <li class="nav-item"><a class="nav-link" href="reports.html">Reports</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Admin & Settings Section -->
    <div class="container admin-section">
      <h2>Admin & Settings Dashboard</h2>
      <div class="row mb-4">
        <!-- System Settings -->
        <div class="col-md-6">
          <h4>System Settings</h4>
          <form id="settings-form">
            <div class="mb-3">
              <label for="school-name" class="form-label">School Name</label>
              <input type="text" class="form-control" id="school-name" value="ABC Public School" required />
            </div>
            <div class="mb-3">
              <label for="academic-year" class="form-label">Academic Year</label>
              <input type="text" class="form-control" id="academic-year" value="2024-2025" required />
            </div>
            <div class="mb-3">
              <label for="contact-email" class="form-label">Contact Email</label>
              <input type="email" class="form-control" id="contact-email" value="school@gmail.com" required />
            </div>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </form>
          <div id="settings-status" class="mt-2"></div>
        </div>
        <!-- (User management table omitted for brevity) -->
      </div>

      <!-- Schedule Planner Section -->
      <div class="schedule-section">
        <h3 class="section-title">Attendance Schedule & Period Planner</h3>
        <form id="schedule-form">
          <!-- Attendance Sessions -->
          <h5>Attendance Sessions</h5>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="session1-start" class="form-label">Session 1 Start Time</label>
              <input type="time" class="form-control" id="session1-start" required />
            </div>
            <div class="col-md-4">
              <label for="session1-end" class="form-label">Session 1 End Time</label>
              <input type="time" class="form-control" id="session1-end" required />
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch mt-4">
                <input class="form-check-input" type="checkbox" id="session1-enabled" checked />
                <label class="form-check-label" for="session1-enabled">Enable Session 1</label>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="session2-start" class="form-label">Session 2 Start Time</label>
              <input type="time" class="form-control" id="session2-start" required />
            </div>
            <div class="col-md-4">
              <label for="session2-end" class="form-label">Session 2 End Time</label>
              <input type="time" class="form-control" id="session2-end" required />
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch mt-4">
                <input class="form-check-input" type="checkbox" id="session2-enabled" />
                <label class="form-check-label" for="session2-enabled">Enable Session 2</label>
              </div>
            </div>
          </div>

          <!-- Holiday Calendar -->
          <h5>Holiday Calendar</h5>
          <div class="mb-3">
            <label for="holiday-dates" class="form-label">Select Holidays</label>
            <input type="text" class="form-control" id="holiday-dates" placeholder="Select holidays" />
          </div>

          <!-- Dynamic Period Management -->
          <h5>Period Schedule</h5>
          <div class="mb-3">
            <label for="num-periods" class="form-label">Number of Periods (excluding half-day)</label>
            <select id="num-periods" class="form-select">
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
            <div class="form-text">Default: 4 periods before half-day and 4 periods after half-day. You can adjust later.</div>
          </div>
          <div id="periods-container">
            <!-- Period rows will be generated dynamically -->
          </div>
          <button type="button" class="btn btn-secondary mb-3" id="add-period-btn">Add Period Row</button>
          <hr />
          <!-- Bells & Special Timings -->
          <h5>Bells & Special Timings</h5>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="first-bell" class="form-label">First Bell Time</label>
              <input type="time" class="form-control" id="first-bell" required />
            </div>
            <div class="col-md-4">
              <label for="second-bell" class="form-label">Second Bell Time</label>
              <input type="time" class="form-control" id="second-bell" required />
            </div>
            <div class="col-md-4">
              <label for="prayer-time" class="form-label">Prayer Time</label>
              <input type="time" class="form-control" id="prayer-time" required />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="holiday-start" class="form-label">Holiday Start Time</label>
              <input type="time" class="form-control" id="holiday-start" required />
            </div>
            <div class="col-md-6">
              <label for="holiday-end" class="form-label">Holiday End Time</label>
              <input type="time" class="form-control" id="holiday-end" required />
            </div>
          </div>

          <!-- Module Controls -->
          <h5>Module Controls</h5>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="control-attendance" checked />
            <label class="form-check-label" for="control-attendance">Enable Attendance Module</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="control-admissions" checked />
            <label class="form-check-label" for="control-admissions">Enable Admissions Module</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="control-exams" checked />
            <label class="form-check-label" for="control-exams">Enable Exams Module</label>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Save Schedule</button>
        </form>
        <div id="schedule-status" class="mt-3"></div>
      </div>
    </div>

    <!-- Flatpickr JS for holiday calendar -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Initialize Flatpickr for holiday selection
      flatpickr("#holiday-dates", {
        mode: "multiple",
        dateFormat: "Y-m-d"
      });

      // Dynamic Period Row Generation
      const periodsContainer = document.getElementById("periods-container");
      const numPeriodsSelect = document.getElementById("num-periods");
      function generatePeriodRows(num) {
        periodsContainer.innerHTML = "";
        // Create rows for "morning" session periods
        for (let i = 1; i <= num; i++) {
          periodsContainer.innerHTML += `
            <div class="period-row" data-period="${i}">
              <h6>Period ${i}</h6>
              <div class="row">
                <div class="col-md-2">
                  <label class="form-label">Start Time</label>
                  <input type="time" class="form-control period-start" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">End Time</label>
                  <input type="time" class="form-control period-end" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Duration (min)</label>
                  <input type="number" class="form-control period-duration readonly-duration" readonly />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Teacher</label>
                  <select class="form-select period-teacher" required>
                    <option value="">Select Teacher</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Subject</label>
                  <select class="form-select period-subject" required>
                    <option value="">Select Subject</option>
                  </select>
                </div>
              </div>
            </div>
          `;
        }
      }
      // On page load, generate default rows based on selected number
      generatePeriodRows(parseInt(numPeriodsSelect.value));
      numPeriodsSelect.addEventListener("change", function () {
        generatePeriodRows(parseInt(this.value));
        populateAllTeacherDropdowns(); // re-populate teacher dropdowns
      });
      // Allow manual addition of a period row
      document.getElementById("add-period-btn").addEventListener("click", function () {
        const currentCount = periodsContainer.querySelectorAll(".period-row").length;
        const newPeriod = currentCount + 1;
        const newRow = document.createElement("div");
        newRow.className = "period-row";
        newRow.setAttribute("data-period", newPeriod);
        newRow.innerHTML = `
          <h6>Period ${newPeriod}</h6>
          <div class="row">
            <div class="col-md-2">
              <label class="form-label">Start Time</label>
              <input type="time" class="form-control period-start" required />
            </div>
            <div class="col-md-2">
              <label class="form-label">End Time</label>
              <input type="time" class="form-control period-end" required />
            </div>
            <div class="col-md-2">
              <label class="form-label">Duration (min)</label>
              <input type="number" class="form-control period-duration readonly-duration" readonly />
            </div>
            <div class="col-md-3">
              <label class="form-label">Teacher</label>
              <select class="form-select period-teacher" required>
                <option value="">Select Teacher</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Subject</label>
              <select class="form-select period-subject" required>
                <option value="">Select Subject</option>
              </select>
            </div>
          </div>
        `;
        periodsContainer.appendChild(newRow);
        populateTeacherDropdown(newRow.querySelector(".period-teacher"));
      });

      // Auto-calculate duration when start or end time changes
      document.addEventListener("change", function (e) {
        if (e.target.classList.contains("period-start") || e.target.classList.contains("period-end")) {
          const row = e.target.closest(".period-row");
          const start = row.querySelector(".period-start").value;
          const end = row.querySelector(".period-end").value;
          if (start && end) {
            const startTime = new Date("1970-01-01T" + start + "Z");
            const endTime = new Date("1970-01-01T" + end + "Z");
            let diff = (endTime - startTime) / 60000; // minutes difference
            if (diff < 0) diff += 24 * 60; // handle crossing midnight
            row.querySelector(".period-duration").value = diff;
          }
        }
      });

      // Populate teacher dropdowns by fetching teacher records from Firestore
      function populateAllTeacherDropdowns() {
        const teacherSelects = document.querySelectorAll(".period-teacher");
        teacherSelects.forEach(sel => populateTeacherDropdown(sel));
      }
      function populateTeacherDropdown(selectElement) {
        // Clear current options
        selectElement.innerHTML = `<option value="">Select Teacher</option>`;
        db.collection("001-school").doc("teachers").collection("list")
          .get()
          .then(snapshot => {
            snapshot.forEach(doc => {
              const teacherData = doc.data();
              // Assume teacherData has: teacherId and subjects (array)
              const opt = document.createElement("option");
              opt.value = teacherData.teacherId;
              opt.text = teacherData.teacherId + " - " + teacherData.staffName;
              selectElement.appendChild(opt);
            });
          })
          .catch(err => console.error("Error fetching teachers:", err));
      }
      // When teacher selection changes, populate corresponding subject dropdown
      document.addEventListener("change", function(e) {
        if (e.target.classList.contains("period-teacher")) {
          const teacherId = e.target.value;
          const row = e.target.closest(".period-row");
          const subjectSelect = row.querySelector(".period-subject");
          // Clear current subject options
          subjectSelect.innerHTML = `<option value="">Select Subject</option>`;
          if (teacherId) {
            // Fetch teacher document
            db.collection("001-school").doc("teachers").collection("list").doc(teacherId)
              .get()
              .then(doc => {
                if (doc.exists) {
                  const data = doc.data();
                  const subjects = data.subjects || [];
                  subjects.forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.text = sub;
                    subjectSelect.appendChild(opt);
                  });
                }
              })
              .catch(err => console.error("Error fetching teacher subjects:", err));
          }
        }
      });
      // Initially populate teacher dropdowns for existing period rows
      populateAllTeacherDropdowns();

      // Schedule Form Submission
      document.getElementById("schedule-form").addEventListener("submit", function (e) {
        e.preventDefault();
        // Build periods array from dynamic rows
        const periodRows = document.querySelectorAll("#periods-container .period-row");
        const periods = [];
        periodRows.forEach(row => {
          const periodNumber = row.getAttribute("data-period");
          // For each period, read start, end, duration, teacher and subject
          const startTime = row.querySelector(".period-start").value;
          const endTime = row.querySelector(".period-end").value;
          const duration = parseInt(row.querySelector(".period-duration").value);
          const teacher = row.querySelector(".period-teacher").value.trim();
          const subject = row.querySelector(".period-subject").value.trim();
          periods.push({
            period: Number(periodNumber),
            startTime,
            endTime,
            duration,
            teacher,
            subject,
            type: "class"
          });
        });
        // Sessions data
        const scheduleData = {
          session1: {
            start: document.getElementById("session1-start").value,
            end: document.getElementById("session1-end").value,
            enabled: document.getElementById("session1-enabled").checked
          },
          session2: {
            start: document.getElementById("session2-start").value,
            end: document.getElementById("session2-end").value,
            enabled: document.getElementById("session2-enabled").checked
          },
          // Holidays: read from Flatpickr (returns an array of Date objects; convert to YYYY-MM-DD strings)
          holidays: flatpickr.parseDate(document.getElementById("holiday-dates").value, "Y-m-d", "en") 
                     ? flatpickr.formatDate(document.getElementById("holiday-dates")._flatpickr.selectedDates[0], "Y-m-d")
                     : [], // For multiple dates, flatpickr.selectedDates is an array
          periods,
          bells: {
            firstBell: document.getElementById("first-bell").value,
            secondBell: document.getElementById("second-bell").value,
            prayerTime: document.getElementById("prayer-time")