<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SLN Chat - DeepSeek Edition</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6f42c1;
      --accent: #ffc107;
      --transition-time: 0.3s;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 16px;
      --affirmation-opacity: 0.9;
    }

    body {
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color var(--transition-time) ease;
      overflow: hidden;
    }

    /* Theme Variables */
    body.dark {
      --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --text: #e0e0e0;
      --header: rgba(44, 44, 61, 0.9);
      --input: #2d2d3f;
      --message-bg: #2a2a3a;
      --user-message-bg: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      --user-message-text: #1a1a1a;
      --border: #3d3d50;
      --hover: #3a3a4d;
      --theme-icon: #ffc107;
      --theme-bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233d3d50' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    body.candle {
      --bg: linear-gradient(135deg, #3e2723 0%, #5d4037 100%);
      --text: #f8f0e3;
      --header: rgba(90, 65, 50, 0.9);
      --input: #7b5e57;
      --message-bg: #5a4a42;
      --user-message-bg: linear-gradient(135deg, #e9b44c 0%, #d49a2c 100%);
      --user-message-text: #2d1a12;
      --border: #8b6d63;
      --hover: #6d544b;
      --theme-icon: #e9b44c;
      --theme-bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238b6d63' fill-opacity='0.1'%3E%3Cpath d='M54 54v4H4v-4H0v-6h6v-6h6v6h6v-6h6v6h6v-6h6v6h6v-6h6v6h6v-6h6v6h6v-6h-6v-6h6v6h4v6h-4zm-6-12V0h-6v42h6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    body.rain {
      --bg: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      --text: #e3f0f8;
      --header: rgba(52, 86, 110, 0.9);
      --input: #4a708a;
      --message-bg: #3a546b;
      --user-message-bg: linear-gradient(135deg, #4da1a9 0%, #2c7873 100%);
      --user-message-text: #0a1929;
      --border: #5a7a94;
      --hover: #4a6580;
      --theme-icon: #4da1a9;
      --theme-bg-pattern: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%235a7a94' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    body.blank {
      --bg: linear-gradient(135deg, #fafafa 0%, #eef2f7 100%);
      --text: #333;
      --header: rgba(224, 224, 224, 0.9);
      --input: #f5f5f5;
      --message-bg: #eeeeee;
      --user-message-bg: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      --user-message-text: #155724;
      --border: #ddd;
      --hover: #e9e9e9;
      --theme-icon: #28a745;
      --theme-bg-pattern: none;
    }

    body {
      background: var(--bg);
      background-image: var(--theme-bg-pattern);
      background-attachment: fixed;
    }

    /* Header Styles */
    .header-bar {
      background: var(--header) !important;
      backdrop-filter: blur(8px);
      padding: 0.8rem 1.5rem;
      box-shadow: var(--shadow);
      z-index: 100;
      transition: all var(--transition-time);
      border-bottom: 1px solid var(--border);
    }

    /* Mode Banner */
    .mode-banner {
      text-align: center;
      padding: 0.6rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all var(--transition-time);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      backdrop-filter: blur(4px);
    }

    .mode-chat { background: rgba(25, 135, 84, 0.85); color: #fff; }
    .mode-ritual { background: rgba(13, 110, 253, 0.85); color: #fff; }

    /* Chat Box */
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 1rem 6rem;
      display: flex;
      flex-direction: column;
      transition: background-color var(--transition-time);
    }

    /* Message Styles */
    .msg-wrapper {
      display: flex;
      align-items: flex-end;
      margin-bottom: 1.25rem;
      animation: fadeIn 0.3s ease;
      transition: opacity 1.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-wrapper.user { justify-content: flex-end; }

    .message {
      padding: 0.85rem 1.2rem;
      border-radius: var(--border-radius);
      max-width: 85%;
      word-break: break-word;
      background: var(--message-bg);
      color: var(--text);
      box-shadow: var(--shadow);
      position: relative;
      transition: all var(--transition-time);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .user .message {
      background: var(--user-message-bg);
      color: var(--user-message-text);
      border-radius: var(--border-radius) var(--border-radius) 0 var(--border-radius);
    }

    .ai .message {
      border-radius: var(--border-radius) var(--border-radius) var(--border-radius) 0;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      object-fit: cover;
      margin: 0 0.5rem;
      background: var(--accent);
      transition: all var(--transition-time);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--user-message-text);
      font-weight: bold;
      font-size: 14px;
    }

    /* Input Area */
    .input-area {
      background: var(--input);
      padding: 1.2rem;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      transition: all var(--transition-time);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(8px);
    }

    .input-area textarea {
      resize: none;
      border-radius: 0.8rem;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      padding: 0.8rem 1.2rem;
      height: auto;
      min-height: 46px;
      max-height: 150px;
      transition: all var(--transition-time);
    }

    .input-area textarea:focus {
      box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.2);
      border-color: var(--primary);
      outline: none;
    }

    /* Placeholder Animation */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    #chatInput::placeholder {
      animation: pulse 2s infinite;
    }

    /* Button Styles */
    .btn {
      border-radius: 0.8rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* Copy Button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s ease;
      cursor: pointer;
      color: var(--text);
      z-index: 10;
    }

    .message:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Privacy Notice */
    .privacy-notice {
      position: fixed;
      bottom: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      max-width: 300px;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .privacy-notice summary {
      cursor: pointer;
      outline: none;
      font-weight: 500;
    }

    .privacy-notice p {
      margin: 0.5rem 0 0;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    /* Session Info */
    .session-info {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.3);
      padding: 3px 8px;
      border-radius: 12px;
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    /* Toast for copy */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(40, 40, 40, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 24px;
      z-index: 2000;
      animation: fadeInOut 2s forwards;
      backdrop-filter: blur(5px);
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 10px); }
      20% { opacity: 1; transform: translate(-50%, 0); }
      80% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -10px); }
    }

    /* Micro-interactions */
    .btn-micro {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-micro:hover {
      transform: scale(1.05);
    }

    .btn-micro:active {
      transform: scale(0.95);
    }

    /* Swipe indicator */
    .swipe-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 193, 7, 0.2);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: none;
      z-index: 1000;
      backdrop-filter: blur(5px);
      border: 1px solid var(--accent);
    }

    /* Theme transition */
    body.theme-transition {
      transition: background-color 0.6s ease, color 0.6s ease;
    }

    /* Welcome message */
    .welcome-message {
      text-align: center;
      padding: 1.5rem;
      max-width: 600px;
      margin: 0 auto;
      color: var(--accent);
      font-size: 1.1rem;
      font-weight: 500;
      border-bottom: 1px dashed var(--accent);
      margin-bottom: 1rem;
      background: rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
    }
    
    /* Status Indicator */
    .status-indicator {
      position: fixed;
      bottom: 130px;
      right: 20px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      z-index: 2000;
    }
    .status-connected { background-color: #4caf50; }
    .status-disconnected { background-color: #f44336; }
    
    /* Session chain info */
    .chain-info {
      position: fixed;
      bottom: 100px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      z-index: 100;
      max-width: 200px;
      backdrop-filter: blur(5px);
    }
    
    /* Affirmations window */
    .affirmation-window {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #f8f8f8;
      padding: 12px 24px;
      border-radius: 30px;
      font-family: 'Georgia', serif;
      font-size: 1rem;
      text-align: center;
      z-index: 1500;
      opacity: 0;
      transition: opacity 2s ease-in-out;
      max-width: 80%;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Sound controls */
    .sound-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }
    
    .sound-toggle {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }
    
    .sound-toggle:hover {
      transform: scale(1.1);
      background: rgba(50, 50, 50, 0.8);
    }
    
    .sound-options {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      backdrop-filter: blur(5px);
      transform: translateY(20px);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    
    .sound-options.active {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }
    
    .sound-option {
      background: transparent;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 15px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
    }
    
    .sound-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .sound-option.active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Star reaction */
    .star-reaction {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0;
      z-index: 10;
    }
    
    .message:hover .star-reaction {
      opacity: 1;
    }
    
    .star-reaction.active {
      color: #FFD700;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
      opacity: 1;
    }
    
    .star-glow {
      animation: glow 1.5s ease;
    }
    
    @keyframes glow {
      0% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Faded messages */
    .faded {
      opacity: 0.3 !important;
    }
    
    /* Theme icon */
    .theme-icon {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--theme-icon);
      font-size: 20px;
      z-index: 100;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Improved message area */
    .message-content {
      padding-right: 30px;
      min-height: 30px;
    }
    
    /* Scrollbar styling */
    .chat-box::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-box::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    
    .chat-box::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    
    /* Send button */
    #sendBtn {
      min-width: 46px;
      height: 46px;
    }
  </style>
</head>
<body class="dark">
  <!-- Theme Icon -->
  <div class="theme-icon" id="themeIcon">
    <i class="fas fa-moon"></i>
  </div>
  
  <div class="content d-flex flex-column" style="height:100vh">
    <!-- Affirmations Window -->
    <div id="affirmationWindow" class="affirmation-window">
      <div id="affirmationText"></div>
    </div>
    
    <!-- Swipe Indicator -->
    <div class="swipe-indicator">
      <i class="fas fa-arrow-down me-2"></i>Swipe down to clear chat
    </div>

    <!-- Status Indicator -->
    <div id="statusIndicator" class="status-indicator status-connected" title="Connected"></div>

    <!-- Session Info -->
    <div class="session-info">
      Soulprint: <span id="soulprint"></span>
    </div>
    
    <!-- Session Chain Info -->
    <div class="chain-info">
      <i class="fas fa-link me-1"></i>Linked to main ID: <span id="mainIdDisplay"></span>
    </div>
    
    <!-- Sound Controls -->
    <div class="sound-controls">
      <button id="soundToggle" class="sound-toggle">
        <i class="fas fa-music"></i>
      </button>
      <div id="soundOptions" class="sound-options">
        <button class="sound-option" data-sound="rain">
          <i class="fas fa-cloud-rain"></i> Rainfall
        </button>
        <button class="sound-option" data-sound="fire">
          <i class="fas fa-fire"></i> Fireplace
        </button>
        <button class="sound-option" data-sound="lofi">
          <i class="fas fa-headphones"></i> Lo-fi
        </button>
        <button class="sound-option active" data-sound="silence">
          <i class="fas fa-volume-mute"></i> Silence
        </button>
      </div>
    </div>

    <!-- Top Bar -->
    <div id="headerBar" class="header-bar d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <div class="me-3">
          <i class="fas fa-brain fs-4" style="color: var(--accent);"></i>
        </div>
        <select id="modeSelect" class="form-select form-select-sm me-2 btn-micro">
          <option value="chat">Chat (Private)</option>
          <option value="ritual">Ritual (Public)</option>
        </select>
        <select id="themeSelect" class="form-select form-select-sm btn-micro">
          <option value="dark" selected>Night Sky</option>
          <option value="candle">Warm Candle</option>
          <option value="rain">Rain Window</option>
          <option value="blank">Blank Page</option>
        </select>
      </div>
      <div>
        <button id="panicBtn" class="btn btn-sm btn-outline-danger btn-micro">
          <i class="fas fa-trash-alt me-1"></i>Clear
        </button>
      </div>
    </div>
    <div id="modeBanner" class="mode-banner mode-chat">
      <i class="fas fa-lock me-2"></i>Private Chat Mode
    </div>

    <div id="chatBox" class="chat-box flex-grow-1">
      <div id="welcomeMessage" class="welcome-message">
        <i class="fas fa-spinner fa-spin me-2"></i>Starting your session...
      </div>
    </div>

    <div class="text-center my-2 text-muted" style="font-size:.8rem">
      Messages powered by Firebase Firestore
    </div>

    <div id="inputArea" class="input-area">
      <div class="input-group">
        <textarea
          id="chatInput"
          class="form-control"
          placeholder="Type what you feel..."
          rows="1"
        ></textarea>
        <button id="sendBtn" class="btn btn-primary ms-2 btn-micro">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Privacy Notice -->
  <div class="privacy-notice">
    <details>
      <summary>Privacy Notice</summary>
      <p>üïäÔ∏è "This space respects your silence. We don't store names, emails, or personal details. Every chat is a session of the soul ‚Äî anonymous, ephemeral, and safe. For security and alignment, your session IDs are recorded but never traced to you."</p>
    </details>
  </div>

  <script>
    // Apply theme transition class
    document.body.classList.add('theme-transition');
    
    // Status indicator
    const statusIndicator = document.getElementById('statusIndicator');
    
    // Simulated Firebase init
    // In a real implementation, you would initialize Firebase here
    
    // Session management with main ID and session chains
    let mainId = localStorage.getItem('sln_mainId');
    let sessionId = sessionStorage.getItem('sln_sessionId');
    let userId = null;
    let unsubscribe = null;
    let welcomedPrivate = false;
    let publicChatLoaded = false;

    // Generate a unique ID
    function generateUniqueId(prefix = '') {
      return prefix + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Initialize IDs
    if (!mainId) {
      mainId = generateUniqueId('main-');
      localStorage.setItem('sln_mainId', mainId);
    }
    
    // Display main ID (first 8 chars)
    document.getElementById('mainIdDisplay').textContent = mainId.substring(0, 8) + '...';

    function startNewSession() {
      const oldSessionId = sessionId;
      
      // Generate new session ID
      sessionId = generateUniqueId('soul-');
      
      // Save to sessionStorage
      sessionStorage.setItem('sln_sessionId', sessionId);
      
      // Generate new user ID
      userId = 'SilentSoul' + Math.floor(Math.random() * 1000 + 1);
      
      // Update UI
      document.getElementById('soulprint').textContent = sessionId.substring(0, 8) + '...';
      document.getElementById('welcomeMessage').innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Starting your session...`;
      
      // Reset flags
      welcomedPrivate = false;
      publicChatLoaded = false;
      
      return sessionId;
    }

    // Initialize session
    if (!sessionId) {
      startNewSession();
    } else {
      // If session exists, generate user ID
      userId = 'SilentSoul' + Math.floor(Math.random() * 1000 + 1);
      document.getElementById('soulprint').textContent = sessionId.substring(0, 8) + '...';
    }

    // Elements
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const modeSelect = document.getElementById('modeSelect');
    const themeSelect = document.getElementById('themeSelect');
    const panicBtn = document.getElementById('panicBtn');
    const swipeIndicator = document.querySelector('.swipe-indicator');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const themeIcon = document.getElementById('themeIcon');

    // Theme switcher
    function applyTheme() {
      const theme = themeSelect.value;
      document.body.classList.remove('dark', 'candle', 'rain', 'blank');
      document.body.classList.add(theme);
      
      // Update theme icon
      const icons = {
        dark: 'fa-moon',
        candle: 'fa-fire',
        rain: 'fa-cloud-rain',
        blank: 'fa-file-alt'
      };
      
      themeIcon.innerHTML = `<i class="fas ${icons[theme]}"></i>`;
    }

    themeSelect.addEventListener('change', function() {
      // Add temporary class for smooth transition
      document.body.classList.add('theme-changing');
      setTimeout(() => {
        applyTheme();
        document.body.classList.remove('theme-changing');
      }, 10);
    });

    applyTheme();

    // Auto-resize textarea
    function autoResize() {
      chatInput.style.height = 'auto';
      chatInput.style.height = (chatInput.scrollHeight) + 'px';

      // Limit max height
      if (chatInput.scrollHeight > 150) {
        chatInput.style.overflowY = 'auto';
      } else {
        chatInput.style.overflowY = 'hidden';
      }
    }

    chatInput.addEventListener('input', autoResize);

    // Send message on Ctrl+Enter
    chatInput.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // Censor abusive words
    const abusiveWords = ['abuse', 'hate', 'stupid', 'idiot', 'fool', 'dumb', 'moron', 'retard', 'crap', 'shit', 'fuck', 'asshole', 'bitch', 'bastard'];
    function censor(text) {
      const pattern = new RegExp(`\\b(${abusiveWords.join('|')})\\b`, 'gi');
      return text.replace(pattern, match => '*'.repeat(match.length));
    }

    // Welcome logic
    function showWelcomePrivate() {
      if (!welcomedPrivate) {
        // Client-side only, not stored in Firestore
        addMessage('EXELIS', `Welcome, ${userId}. I'm here to listen. Share what's on your mind.`, 'ai', false);
        welcomedPrivate = true;
      }
    }

    // Panic mode (clear UI)
    function panicMode() {
      // Clear chat UI
      chatBox.innerHTML = '<div id="welcomeMessage" class="welcome-message"><i class="fas fa-spinner fa-spin me-2"></i>Starting new session...</div>';

      // Clear input
      chatInput.value = '';
      autoResize();

      // Start a new session
      startNewSession();

      // If in private mode, show welcome again
      if (modeSelect.value === 'chat') {
        setTimeout(showWelcomePrivate, 500);
      } else {
        publicChatLoaded = false;
        loadMessages();
      }

      // Show confirmation
      showToast('Chat cleared. New session started.');
    }

    panicBtn.addEventListener('click', panicMode);

    // Swipe detection for panic mode
    let touchStartY = 0;

    chatBox.addEventListener('touchstart', function(e) {
      touchStartY = e.changedTouches[0].screenY;
      swipeIndicator.style.display = 'block';
    });

    chatBox.addEventListener('touchmove', function(e) {
      const touchY = e.changedTouches[0].screenY;
      const diff = touchY - touchStartY;

      // Show indicator if swiping down
      if (diff > 50) {
        swipeIndicator.style.display = 'block';
      } else {
        swipeIndicator.style.display = 'none';
      }
    });

    chatBox.addEventListener('touchend', function(e) {
      const touchEndY = e.changedTouches[0].screenY;
      const diff = touchEndY - touchStartY;

      // If swipe down more than 100px, trigger panic mode
      if (diff > 100) {
        panicMode();
      }

      swipeIndicator.style.display = 'none';
    });

    // Firestore listeners
    function loadMessages() {
      chatBox.innerHTML = '<div id="welcomeMessage" class="welcome-message"><i class="fas fa-spinner fa-spin me-2"></i>Loading messages...</div>';

      if (modeSelect.value === 'chat') {
        // Private mode
        setTimeout(() => {
          chatBox.innerHTML = '';
          showWelcomePrivate();
        }, 500);
      } else {
        // Public mode
        setTimeout(() => {
          chatBox.innerHTML = '';
          addMessage('EXELIS', `Welcome to public chat. Share your thoughts with others.`, 'ai', false);
          publicChatLoaded = true;
        }, 500);
      }
    }

    modeSelect.addEventListener('change', function() {
      // Update banner
      if (modeSelect.value === 'chat') {
        document.getElementById('modeBanner').className = 'mode-banner mode-chat';
        document.getElementById('modeBanner').innerHTML = '<i class="fas fa-lock me-2"></i>Private Chat Mode';
      } else {
        document.getElementById('modeBanner').className = 'mode-banner mode-ritual';
        document.getElementById('modeBanner').innerHTML = '<i class="fas fa-users me-2"></i>Public Chat Mode';
      }

      loadMessages();
    });

    // Send message
    function sendMessage() {
      const txt = chatInput.value.trim();
      if (!txt) return;

      const censoredText = censor(txt);

      // Add message to UI immediately
      addMessage(userId, censoredText, 'user', false);

      chatInput.value = '';
      autoResize();
      
      // Simulate AI response
      setTimeout(() => {
        const responses = [
          "I understand how you feel. Tell me more.",
          "That's an interesting perspective. What makes you think that?",
          "I appreciate you sharing that with me. How does that make you feel?",
          "Thank you for opening up. Would you like to explore this further?",
          "I'm here to listen. Is there anything else you'd like to share?",
          "Your thoughts are valid and important. Let's continue this conversation.",
          "I sense there's more to this. Would you like to elaborate?",
          "That's a meaningful insight. How did you come to that realization?"
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addMessage('EXELIS', randomResponse, 'ai', true);
      }, 1000 + Math.random() * 1000);
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Message counter for impermanence mode
    let messageCount = 0;

    // Add message to UI
    function addMessage(uid, text, cls, animate) {
      // Remove welcome message if present
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage && welcomeMessage.parentNode === chatBox) {
        chatBox.removeChild(welcomeMessage);
      }

      const w = document.createElement('div');
      w.className = `msg-wrapper ${cls}`;
      if (animate) w.style.animation = 'fadeIn 0.3s ease';

      // Add unique ID for star reactions
      const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
      w.dataset.id = messageId;

      const img = document.createElement('div');
      img.className = 'avatar';
      img.textContent = uid.substring(0, 2);

      const m = document.createElement('div');
      m.className = 'message';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = text;
      m.appendChild(messageContent);

      // Add copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.innerHTML = '<i class="fas fa-copy fa-xs"></i>';
      copyBtn.title = 'Copy message';
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(text);
        showToast('Message copied to clipboard');
      });
      m.appendChild(copyBtn);

      // Add star reaction button
      const starBtn = document.createElement('button');
      starBtn.className = 'star-reaction';
      starBtn.innerHTML = '<i class="far fa-star"></i>';
      starBtn.title = 'Star this message';
      starBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        starBtn.classList.add('active', 'star-glow');
        starBtn.innerHTML = '<i class="fas fa-star"></i>';
        localStorage.setItem(`star-${messageId}`, 'true');

        // Remove animation class after it completes
        setTimeout(() => {
          starBtn.classList.remove('star-glow');
        }, 1500);
      });
      m.appendChild(starBtn);

      // Check if this message was already starred
      if (localStorage.getItem(`star-${messageId}`)) {
        starBtn.classList.add('active');
        starBtn.innerHTML = '<i class="fas fa-star"></i>';
      }

      if (cls === 'user') {
        w.append(m, img);
      } else {
        w.append(img, m);
      }

      chatBox.appendChild(w);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Auto-star user messages after 30 seconds
      if (cls === 'user') {
        setTimeout(() => {
          if (!localStorage.getItem(`star-${messageId}`)) {
            starBtn.classList.add('active', 'star-glow');
            starBtn.innerHTML = '<i class="fas fa-star"></i>';
            localStorage.setItem(`star-${messageId}`, 'true');

            setTimeout(() => {
              starBtn.classList.remove('star-glow');
            }, 1500);
          }
        }, 30000);
      }

      // Impermanence mode - message fading
      messageCount++;

      // Fade messages after 10 messages
      if (messageCount > 10) {
        const messages = chatBox.querySelectorAll('.msg-wrapper');

        // Fade messages beyond the last 25
        if (messages.length > 25) {
          const fadeCount = messages.length - 25;
          for (let i = 0; i < fadeCount; i++) {
            messages[i].classList.add('faded');
          }
        }
      }

      // Remove messages beyond 50
      if (messages.length > 50) {
        chatBox.removeChild(messages[0]);
      }
    }

    // Show toast notification
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        document.body.removeChild(toast);
      }, 2000);
    }

    // Affirmations system
    const affirmations = [
      "You are not late to your own life.",
      "Even heavy hearts can float again.",
      "You're doing better than you think.",
      "Your presence is a gift to the world.",
      "Breathe in courage, breathe out fear.",
      "Softness is not weakness.",
      "You are enough, exactly as you are.",
      "Your story is still being written.",
      "It's okay to rest and begin again.",
      "You are a universe of possibilities."
    ];

    function showAffirmation() {
      const affirmationWindow = document.getElementById('affirmationWindow');
      const affirmationText = document.getElementById('affirmationText');

      // Select random affirmation
      const randomIndex = Math.floor(Math.random() * affirmations.length);
      affirmationText.textContent = affirmations[randomIndex];

      // Fade in
      affirmationWindow.style.opacity = '1';

      // Fade out after 8 seconds
      setTimeout(() => {
        affirmationWindow.style.opacity = '0';
      }, 8000);
    }

    // Show first affirmation after 1 minute, then every 3-5 minutes
    setTimeout(() => {
      showAffirmation();
      setInterval(showAffirmation, (180 + Math.random() * 120) * 1000);
    }, 60000);

    // Sound system
    const soundToggle = document.getElementById('soundToggle');
    const soundOptions = document.getElementById('soundOptions');
    let currentSound = null;
    let audioElement = null;

    // Sound files (using small public URLs)
    const soundFiles = {
      rain: 'https://assets.mixkit.co/sfx/preview/mixkit-rain-loop-1244.mp3',
      fire: 'https://assets.mixkit.co/sfx/preview/mixkit-crackling-fireplace-1193.mp3',
      lofi: 'https://assets.mixkit.co/sfx/preview/mixkit-very-slow-wind-1252.mp3'
    };

    // Play sound
    function playSound(sound) {
      if (!soundFiles[sound]) return;

      stopSound();

      // Create audio element
      audioElement = new Audio(soundFiles[sound]);
      audioElement.loop = true;
      audioElement.volume = 0.3;
      audioElement.play()
        .catch(error => console.log('Audio playback error:', error));
      
      currentSound = sound;
    }

    // Stop sound
    function stopSound() {
      if (audioElement) {
        audioElement.pause();
        audioElement = null;
        currentSound = null;
      }
    }

    // Toggle sound options
    soundToggle.addEventListener('click', () => {
      soundOptions.classList.toggle('active');
    });

    // Handle sound selection
    document.querySelectorAll('.sound-option').forEach(option => {
      option.addEventListener('click', () => {
        const sound = option.dataset.sound;

        // Update active state
        document.querySelectorAll('.sound-option').forEach(opt => {
          opt.classList.remove('active');
        });
        option.classList.add('active');

        // Handle sound
        if (sound === 'silence') {
          stopSound();
        } else {
          playSound(sound);
        }
      });
    });

    // Initialize
    setTimeout(() => {
      loadMessages();
      if (modeSelect.value === 'chat') {
        showWelcomePrivate();
      }
    }, 1000);
  </script>
</body>
</html>
