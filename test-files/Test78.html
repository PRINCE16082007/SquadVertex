<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin – SquadVertex Video Control</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1rem; }
    #login, #controls { margin-bottom: 2rem; }
    button { margin: .25rem; padding: .5rem 1rem; }
    input { margin: .5rem 0; padding: .5rem; width: 100%; box-sizing: border-box; }
    .video-card { display: flex; align-items: center; border: 1px solid #ddd; padding: .5rem; margin: .5rem 0; }
    .video-card img { width: 120px; height: 68px; object-fit: cover; margin-right: 1rem; }
    .video-meta { flex: 1; }
    .video-actions button { margin-right: .5rem; }
    #previewContainer { margin-top: 1rem; }
  </style>

  <!-- Wistia Player script -->
  <script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <h1>🎮 SquadVertex Admin Panel</h1>

  <!-- 1) Google Sign-In -->
  <div id="login">
    <button id="btnGoogle">🔑 Sign in with Google</button>
  </div>

  <!-- 2) Controls & Video List -->
  <div id="controls" style="display:none;">

    <!-- Add new Wistia ID -->
    <h2>Add Video</h2>
    <input id="addVideoId" placeholder="Enter new Wistia Video ID">
    <button id="btnAddVideo">➕ Add to Event</button>

    <p>
      <strong>Total videos:</strong>
      <span id="totalCount">0</span>
      <button id="btnClearActive">🛑 Clear Active</button>
    </p>

    <div id="videoList"></div>
    <div id="previewContainer"></div>
  </div>

  <script>
  // ── 1) Init Firebase ─────────────────────────────────────────────────────────
    // Firebase initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  const EVENT_ID   = 'SpringLaunch2025';
  const eventRef   = db.collection('events').doc(EVENT_ID);
  const authUsers  = db.collection('authUsers');

  let videoList   = [];
  let currentVideo= null;

  // ── 2) Google Sign-In & Admin Check ─────────────────────────────────────────
  document.getElementById('btnGoogle').onclick = async () => {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const { user } = await auth.signInWithPopup(provider);

      // Check authUsers/{email} exists
      const adminDoc = await authUsers.doc(user.email).get();
      if (!adminDoc.exists) throw new Error('You are not authorized.');

      // Show controls
      document.getElementById('login').style.display    = 'none';
      document.getElementById('controls').style.display = 'block';
      initAdmin();
    } catch (e) {
      alert('Auth failed: ' + e.message);
    }
  };

  // ── 3) Initialize Admin Listeners ───────────────────────────────────────────
  function initAdmin() {
    // Listen for videoList array changes
    eventRef.onSnapshot(snap => {
      videoList = snap.data()?.videoList || [];
      renderList();
    });
    // Listen for activeVideo
    eventRef.collection('settings').doc('activeVideo')
      .onSnapshot(snap => {
        currentVideo = snap.data()?.videoId || null;
        renderList(); // update active indicators
      });

    // Clear active video
    document.getElementById('btnClearActive').onclick = () =>
      eventRef.collection('settings').doc('activeVideo')
        .set({ videoId: '', setAt: Date.now() });

    // Add new video
    document.getElementById('btnAddVideo').onclick = async () => {
      const vid = document.getElementById('addVideoId').value.trim();
      if (!vid) return alert('Enter a Video ID');
      await eventRef.update({
        videoList: FieldValue.arrayUnion(vid)
      });
      document.getElementById('addVideoId').value = '';
    };
  }

  // ── 4) Render Video Roster ──────────────────────────────────────────────────
  async function renderList() {
    const container = document.getElementById('videoList');
    container.innerHTML = '';
    document.getElementById('totalCount').innerText = videoList.length;

    for (const vid of videoList) {
      // Fetch oEmbed metadata
      let meta = { title: vid, thumbnail_url: '' };
      try {
        const r = await fetch(`https://fast.wistia.com/oembed?url=https://home.wistia.com/medias/${vid}`);
        meta = await r.json();
      } catch {}

      // Fetch votes & comment count
      const [voteSnap, commentsSnap] = await Promise.all([
        eventRef.collection('votes').doc(vid).get(),
        eventRef.collection('comments').where('videoId','==',vid).get()
      ]);
      const votes = voteSnap.exists? voteSnap.data() : { likes:0, dislikes:0 };
      const commentsCount = commentsSnap.size;

      // Video card
      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
        <img src="${meta.thumbnail_url}" alt="${meta.title}">
        <div class="video-meta">
          <h3>${meta.title}</h3>
          <p><strong>ID:</strong> ${vid}</p>
          <p>👍 ${votes.likes}   👎 ${votes.dislikes}   💬 ${commentsCount}</p>
        </div>
      `;

      // Actions
      const actions = document.createElement('div');
      actions.className = 'video-actions';
      // Set active
      const btnSet = document.createElement('button');
      btnSet.innerText = (vid === currentVideo) ? '✅ Active' : '▶️ Set Active';
      btnSet.onclick = () => {
        eventRef.collection('settings').doc('activeVideo')
          .set({ videoId: vid, setAt: Date.now() });
      };
      // Preview
      const btnPlay = document.createElement('button');
      btnPlay.innerText = '🔍 Preview';
      btnPlay.onclick = () => previewVideo(vid);
      // Remove
      const btnRemove = document.createElement('button');
      btnRemove.innerText = '🗑️ Remove';
      btnRemove.onclick = async () => {
        const newList = videoList.filter(x => x !== vid);
        await eventRef.update({ videoList: newList });
      };

      actions.append(btnSet, btnPlay, btnRemove);
      card.append(actions);
      container.append(card);
    }
  }

  // ── 5) Preview Embed ─────────────────────────────────────────────────────────
  function previewVideo(vid) {
    document.getElementById('previewContainer').innerHTML = `
      <h2>Preview: ${vid}</h2>
      <div class="wistia_embed wistia_async_${vid}" style="width:640px;height:360px;"></div>
    `;
  }
  </script>
</body>
</html>