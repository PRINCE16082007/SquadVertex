<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin – SquadVertex Video Control</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1rem; }
    #controls { margin-bottom: 2rem; }
    button { margin: .25rem; padding: .5rem 1rem; }
    input { margin: .5rem 0; padding: .5rem; width: 100%; box-sizing: border-box; }
    .video-card { display: flex; align-items: center; border: 1px solid #ddd; padding: .5rem; margin: .5rem 0; }
    .video-card img { width: 120px; height: 68px; object-fit: cover; margin-right: 1rem; }
    .video-meta { flex: 1; }
    .video-actions button { margin-right: .5rem; }
    #previewContainer { margin-top: 1rem; }
  </style>

  <!-- Wistia Player -->
  <script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <h1>🎮 SquadVertex Admin Panel</h1>

  <!-- Controls & Video List (always visible) -->
  <div id="controls">

    <!-- Add new Wistia ID -->
    <h2>Add Video</h2>
    <input id="addVideoId" placeholder="Enter new Wistia Video ID">
    <button id="btnAddVideo">➕ Add to Event</button>

    <p>
      <strong>Total videos:</strong>
      <span id="totalCount">0</span>
      <button id="btnClearActive">🛑 Clear Active</button>
    </p>

    <div id="videoList"></div>
    <div id="previewContainer"></div>
  </div>

  <script>
  // ── 1) Initialize Firebase & Firestore ────────────────────────────────────────
    // Firebase initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
  };
  firebase.initializeApp(firebaseConfig);
  const db          = firebase.firestore();
  const FieldValue  = firebase.firestore.FieldValue;

  // Constants & refs
  const EVENT_ID = 'SpringLaunch2025';
  const eventRef = db.collection('events').doc(EVENT_ID);

  let videoList    = [];
  let currentVideo = null;

  // ── 2) Initialize admin listeners on page load ───────────────────────────────
  window.addEventListener('DOMContentLoaded', () => {
    // Listen for videoList changes
    eventRef.onSnapshot(snap => {
      videoList = snap.data()?.videoList || [];
      renderList();
    });
    // Listen for activeVideo
    eventRef.collection('settings').doc('activeVideo')
      .onSnapshot(snap => {
        currentVideo = snap.data()?.videoId || null;
        renderList();
      });

    // Clear active video button
    document.getElementById('btnClearActive').onclick = () => {
      eventRef.collection('settings').doc('activeVideo')
        .set({ videoId:'', setAt: Date.now() });
    };

    // Add video button
    document.getElementById('btnAddVideo').onclick = async () => {
      const vid = document.getElementById('addVideoId').value.trim();
      if (!vid) return alert('Enter a Video ID');
      await eventRef.update({
        videoList: FieldValue.arrayUnion(vid)
      });
      document.getElementById('addVideoId').value = '';
    };
  });

  // ── 3) Render video roster ───────────────────────────────────────────────────
  async function renderList() {
    const container = document.getElementById('videoList');
    container.innerHTML = '';
    document.getElementById('totalCount').innerText = videoList.length;

    for (const vid of videoList) {
      // oEmbed metadata
      let meta = { title: vid, thumbnail_url: '' };
      try {
        const r = await fetch(`https://fast.wistia.com/oembed?url=https://home.wistia.com/medias/${vid}`);
        meta = await r.json();
      } catch {}

      // Votes & comments counts
      const [vSnap, cSnap] = await Promise.all([
        eventRef.collection('votes').doc(vid).get(),
        eventRef.collection('comments').where('videoId','==',vid).get()
      ]);
      const votes = vSnap.exists ? vSnap.data() : { likes:0, dislikes:0 };
      const commentsCount = cSnap.size;

      // Build card
      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
        <img src="${meta.thumbnail_url}" alt="${meta.title}">
        <div class="video-meta">
          <h3>${meta.title}</h3>
          <p><strong>ID:</strong> ${vid}</p>
          <p>👍 ${votes.likes}   👎 ${votes.dislikes}   💬 ${commentsCount}</p>
        </div>
      `;

      // Actions
      const actions = document.createElement('div');
      actions.className = 'video-actions';

      const btnSet = document.createElement('button');
      btnSet.innerText = (vid === currentVideo) ? '✅ Active' : '▶️ Set Active';
      btnSet.onclick = () => {
        eventRef.collection('settings').doc('activeVideo')
          .set({ videoId: vid, setAt: Date.now() });
      };

      const btnPlay = document.createElement('button');
      btnPlay.innerText = '🔍 Preview';
      btnPlay.onclick = () => previewVideo(vid);

      const btnRemove = document.createElement('button');
      btnRemove.innerText = '🗑️ Remove';
      btnRemove.onclick = async () => {
        const newList = videoList.filter(x => x !== vid);
        await eventRef.update({ videoList: newList });
      };

      actions.append(btnSet, btnPlay, btnRemove);
      card.append(actions);
      container.append(card);
    }
  }

  // ── 4) Preview embed ─────────────────────────────────────────────────────────
  function previewVideo(vid) {
    document.getElementById('previewContainer').innerHTML = `
      <h2>Preview: ${vid}</h2>
      <div class="wistia_embed wistia_async_${vid}" style="width:640px;height:360px;"></div>
    `;
  }
  </script>
</body>
</html>