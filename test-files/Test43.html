<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LightExam ‚Äî Minimal Exam Builder</title>
<style>
  :root{font-family:Inter,system-ui,Segoe UI,Arial; --gap:8px}
  body{margin:12px;background:#f7f8fb;color:#111;font-size:14px}
  .wrap{max-width:1000px;margin:0 auto;padding:14px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px;box-shadow:0 4px 20px rgba(15,20,40,0.05)}
  h1{margin:0 0 6px;font-size:18px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  label{font-size:12px;color:#555}
  input[type=text],select,textarea{padding:6px;border-radius:5px;border:1px solid #dde5f0;background:#fff;min-width:140px;font-size:13px}
  textarea{min-height:50px;resize:vertical}
  button{padding:6px 10px;border-radius:6px;border:0;background:#0b5fff;color:#fff;cursor:pointer;font-size:13px}
  .muted{color:#666;font-size:12px}
  .controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .section{border:1px dashed #e0e7ff;padding:8px;border-radius:6px;margin-top:8px;background:#fff}
  .sec-items{margin-top:6px}
  .item{display:flex;gap:6px;align-items:flex-start;margin-bottom:6px}
  .item input[type=text]{flex:1}
  .small{font-size:11px;padding:5px 7px}
  .preview{border-top:1px solid #eee;margin-top:10px;padding-top:10px}
  .preview-output{background:#fff;padding:14px;border-radius:6px;box-shadow:0 3px 8px rgba(18,20,40,0.02)}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .danger{background:#ff5a5a}
  .secondary{background:#6b7280}
  .flex{display:flex;gap:6px}
  select.small{padding:5px}
  .watermark{position:absolute;right:10px;top:6px;opacity:.06;font-weight:800;font-size:52px;transform:rotate(-25deg);pointer-events:none}
  .compact-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>LightExam ‚Äî Minimal Exam Builder</h1>
    <div class="muted">Light, offline, teacher-focused ‚Äî built for quick papers.</div>
  </div>

  <!-- Header meta -->
  <div class="compact-grid">
    <div>
      <label>School name</label>
      <input id="meta-school" type="text" placeholder="Ex: Modern High School">
    </div>
    <div>
      <label>Exam name</label>
      <input id="meta-exam" type="text" placeholder="Ex: Term 1 - Science">
    </div>
    <div>
      <label>Subject</label>
      <input id="meta-subject" type="text" placeholder="Ex: Biology">
    </div>
    <div>
      <label>Time / Duration</label>
      <input id="meta-time" type="text" placeholder="Ex: 1h 30m">
    </div>
    <div>
      <label>Total marks</label>
      <input id="meta-marks" type="text" placeholder="Ex: 80">
    </div>
  </div>

  <div class="controls">
    <div class="flex">
      <select id="add-type" class="small">
        <option value="mcq">MCQ (Multiple choice)</option>
        <option value="short">Short answer</option>
        <option value="long">Long answer</option>
        <option value="match">Match / Fill</option>
        <option value="fill">Fill in the Blanks</option>
      </select>
      <button id="btn-add">Add Section</button>
    </div>

    <div class="flex" style="margin-left:auto">
      <button id="btn-save" class="small">üíæ Save</button>
      <button id="btn-load" class="small secondary">üìÇ Load</button>
      <button id="btn-preview" class="small">üëÅÔ∏è Preview</button>
      <button id="btn-export-pdf" class="small">üñ® Print PDF</button>
      <button id="btn-export-doc" class="small">üìÑ Download DOC</button>
      <button id="btn-clear" class="small danger">CLEAR</button>
    </div>
  </div>

  <div id="sections-container" style="margin-top:12px"></div>

  <div class="preview" id="preview-area" style="display:none">
    <h3>Preview</h3>
    <div class="preview-output" id="preview-output"></div>
  </div>

  <div style="margin-top:10px;color:#777;font-size:12px">
    Tip: Save often. Teacher-friendly blocks ‚Äî add, reorder (future), and export. Keep it lightweight.
  </div>
</div>

<script>
(function(){
  // util
  const uid = () => 's-' + Math.random().toString(36).slice(2,9);
  const STORAGE_KEY = 'examBuilderData';

  // initial model
  let model = {
    meta: {school:'', exam:'', subject:'', time:'', marks:''},
    sections: []
  };

  // DOM refs
  const cont = document.getElementById('sections-container');
  const metaInputs = {
    school: document.getElementById('meta-school'),
    exam: document.getElementById('meta-exam'),
    subject: document.getElementById('meta-subject'),
    time: document.getElementById('meta-time'),
    marks: document.getElementById('meta-marks')
  };
  const previewArea = document.getElementById('preview-area');
  const previewOutput = document.getElementById('preview-output');

  // load saved meta to inputs
  function bindMetaToInputs(){
    metaInputs.school.value = model.meta.school || '';
    metaInputs.exam.value = model.meta.exam || '';
    metaInputs.subject.value = model.meta.subject || '';
    metaInputs.time.value = model.meta.time || '';
    metaInputs.marks.value = model.meta.marks || '';
  }
  function collectMetaFromInputs(){
    model.meta.school = metaInputs.school.value;
    model.meta.exam = metaInputs.exam.value;
    model.meta.subject = metaInputs.subject.value;
    model.meta.time = metaInputs.time.value;
    model.meta.marks = metaInputs.marks.value;
  }

  // section render
  function renderSections(){
    cont.innerHTML = '';
    model.sections.forEach((sec, si) => {
      const el = document.createElement('div');
      el.className = 'section';
      el.dataset.id = sec.id;
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${si+1}. ${sec.title || (sec.type.toUpperCase())}</strong>
            <div class="muted" style="font-size:11px">${sec.type}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="small" data-action="add-item">+ item</button>
            <button class="small" data-action="remove-section" style="background:#ff7b7b">remove</button>
          </div>
        </div>
        <div style="margin-top:6px">
          <input type="text" class="sec-title" placeholder="Section title (optional)" value="${escapeHtml(sec.title || '')}">
        </div>
        <div class="sec-items"></div>
      `;
      // items container
      const itemsC = el.querySelector('.sec-items');
      sec.items.forEach((it, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        if (sec.type === 'mcq') {
          itemDiv.innerHTML = `
            <input type="text" class="qtext" placeholder="Question text" value="${escapeHtml(it.q || '')}">
            <input type="text" class="opt0" placeholder="Option A" value="${escapeHtml((it.options && it.options[0])||'')}">
            <input type="text" class="opt1" placeholder="Option B" value="${escapeHtml((it.options && it.options[1])||'')}">
            <input type="text" class="opt2" placeholder="Option C" value="${escapeHtml((it.options && it.options[2])||'')}">
            <input type="text" class="opt3" placeholder="Option D" value="${escapeHtml((it.options && it.options[3])||'')}">
            <button class="small" data-action="remove-item">‚úñ</button>
          `;
        } else if (sec.type === 'short' || sec.type === 'long') {
          itemDiv.innerHTML = `
            <input type="text" class="qtext" placeholder="Question text" value="${escapeHtml(it.q || '')}">
            <input type="text" class="marks" placeholder="Marks" style="width:60px" value="${escapeHtml(it.marks||'')}">
            <button class="small" data-action="remove-item">‚úñ</button>
          `;
        } else if (sec.type === 'match') {
          itemDiv.innerHTML = `
            <input type="text" class="qtext" placeholder="LHS" value="${escapeHtml(it.left||'')}">
            <input type="text" class="anstext" placeholder="RHS" value="${escapeHtml(it.right||'')}">
            <button class="small" data-action="remove-item">‚úñ</button>
          `;
        } else if (sec.type === 'fill') {
          itemDiv.innerHTML = `
            <input type="text" class="qtext" placeholder="Question with blanks (use ______ for blanks)" value="${escapeHtml(it.q || '')}" style="flex:1">
            <button class="small" data-action="remove-item">‚úñ</button>
          `;
        }
        itemsC.appendChild(itemDiv);
      });

      // attach events
      el.querySelector('.sec-title').addEventListener('input', e => {
        sec.title = e.target.value;
        saveModelToLocal();
      });
      el.addEventListener('click', e => {
        const a = e.target.dataset.action;
        if (a === 'add-item') {
          addItemToSection(sec.id);
        } else if (a === 'remove-section') {
          model.sections = model.sections.filter(s=>s.id !== sec.id);
          saveModelToLocal();
          renderSections();
        } else if (a === 'remove-item') {
          // find parent item index
          const itemDiv = e.target.closest('.item');
          const idx = Array.from(itemsC.children).indexOf(itemDiv);
          if (idx > -1) {
            sec.items.splice(idx,1);
            saveModelToLocal();
            renderSections();
          }
        }
      });

      // small live sync on change for item fields
      el.addEventListener('input', e => {
        const itemDiv = e.target.closest('.item');
        if (!itemDiv) return;
        const idx = Array.from(itemsC.children).indexOf(itemDiv);
        if (idx === -1) return;
        const it = sec.items[idx];
        if (!it) return;
        if (sec.type === 'mcq') {
          it.q = itemDiv.querySelector('.qtext').value;
          it.options = [
            itemDiv.querySelector('.opt0').value,
            itemDiv.querySelector('.opt1').value,
            itemDiv.querySelector('.opt2').value,
            itemDiv.querySelector('.opt3').value,
          ];
        } else if (sec.type === 'short' || sec.type === 'long') {
          it.q = itemDiv.querySelector('.qtext').value;
          it.marks = itemDiv.querySelector('.marks').value;
        } else if (sec.type === 'match') {
          it.left = itemDiv.querySelector('.qtext').value;
          it.right = itemDiv.querySelector('.anstext').value;
        } else if (sec.type === 'fill') {
          it.q = itemDiv.querySelector('.qtext').value;
        }
        saveModelToLocal();
      });

      cont.appendChild(el);
    });
  }

  function addSection(type){
    const newSec = {
      id: uid(),
      type: type,
      title: '',
      items: []
    };
    // seed with one sample item
    if (type === 'mcq') newSec.items.push({q:'', options:['','','','']});
    else if (type === 'short') newSec.items.push({q:'', marks:''});
    else if (type === 'long') newSec.items.push({q:'', marks:''});
    else if (type === 'match') newSec.items.push({left:'', right:''});
    else if (type === 'fill') newSec.items.push({q:''});
    model.sections.push(newSec);
    saveModelToLocal();
    renderSections();
  }

  function addItemToSection(secId){
    const s = model.sections.find(x=>x.id===secId);
    if (!s) return;
    if (s.type === 'mcq') s.items.push({q:'', options:['','','','']});
    else if (s.type === 'short') s.items.push({q:'', marks:''});
    else if (s.type === 'long') s.items.push({q:'', marks:''});
    else if (s.type === 'match') s.items.push({left:'', right:''});
    else if (s.type === 'fill') s.items.push({q:''});
    saveModelToLocal();
    renderSections();
  }

  // local storage
  function saveModelToLocal(){
    collectMetaFromInputs();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(model));
    flash('Saved ‚úÖ');
  }
  function loadModelFromLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) { flash('No saved exam found'); return; }
    try {
      model = JSON.parse(raw);
      bindMetaToInputs();
      renderSections();
      flash('Loaded ‚úÖ');
    } catch(e){
      flash('Invalid saved data');
    }
  }
  function clearAll(){
    if (!confirm('Clear all sections and metadata?')) return;
    model = {meta:{school:'',exam:'',subject:'',time:'',marks:''}, sections:[]};
    localStorage.removeItem(STORAGE_KEY);
    bindMetaToInputs();
    renderSections();
    previewArea.style.display='none';
  }

  // preview / export
  function buildExamHtml(options={forPrint:false}){
    collectMetaFromInputs();
    const meta = model.meta;
    const parts = [];
    parts.push(`<div style="font-family:Arial,Helvetica,sans-serif;color:#111">`);
    parts.push(`<div style="text-align:center;margin-bottom:12px">
      <div style="font-size:18px;font-weight:700">${escapeHtml(meta.school||'')}</div>
      <div style="font-size:15px;margin-top:4px">${escapeHtml(meta.exam||'')} ‚Äî ${escapeHtml(meta.subject||'')}</div>
      <div style="font-size:12px;margin-top:5px">${escapeHtml(meta.time||'')} | Total Marks: ${escapeHtml(meta.marks||'')}</div>
    </div>`);
    parts.push('<hr style="border:none;border-top:1px solid #ddd;margin:8px 0 14px">');

    model.sections.forEach((s, si) => {
      parts.push(`<div style="margin-bottom:10px"><strong>${si+1}. ${escapeHtml(s.title || s.type.toUpperCase())}</strong></div>`);
      if (s.type === 'mcq') {
        s.items.forEach((it, i) => {
          parts.push(`<div style="margin:5px 0">${si+1}.${i+1} ${escapeHtml(it.q || '')}</div>`);
          parts.push(`<ul style="margin-top:3px;margin-bottom:6px">`+
            `<li>A. ${escapeHtml((it.options&&it.options[0])||'')}</li>`+
            `<li>B. ${escapeHtml((it.options&&it.options[1])||'')}</li>`+
            `<li>C. ${escapeHtml((it.options&&it.options[2])||'')}</li>`+
            `<li>D. ${escapeHtml((it.options&&it.options[3])||'')}</li>`+
          `</ul>`);
        });
      } else if (s.type === 'short') {
        s.items.forEach((it, i) => {
          parts.push(`<div style="margin:5px 0">${si+1}.${i+1} ${escapeHtml(it.q || '')} <span style="font-size:11px;color:#666">(${escapeHtml(it.marks||'') } marks)</span></div>`);
          parts.push(`<div style="height:30px;border-bottom:1px dashed #ccc;margin:5px 0"></div>`);
        });
      } else if (s.type === 'long') {
        s.items.forEach((it, i) => {
          parts.push(`<div style="margin:5px 0">${si+1}.${i+1} ${escapeHtml(it.q || '')} <span style="font-size:11px;color:#666">(${escapeHtml(it.marks||'') } marks)</span></div>`);
          parts.push(`<div style="height:100px;border:1px dashed #eee;margin:5px 0;padding:5px;background:#fafafa"></div>`);
        });
      } else if (s.type === 'match') {
        parts.push('<table style="width:100%;border-collapse:collapse;margin:5px 0">');
        const maxRows = s.items.length;
        for (let r=0;r<maxRows;r++){
          const it = s.items[r] || {};
          parts.push(`<tr><td style="padding:3px;border-bottom:1px solid #f0f0f0">${escapeHtml(it.left||'')}</td><td style="padding:3px;border-bottom:1px solid #f0f0f0">${escapeHtml(it.right||'')}</td></tr>`);
        }
        parts.push('</table>');
      } else if (s.type === 'fill') {
        s.items.forEach((it, i) => {
          // Replace underscores with a blank line for printing
          const displayText = escapeHtml(it.q || '').replace(/_{3,}/g, '<span style="border-bottom:1px solid #000; padding:0 20px"> </span>');
          parts.push(`<div style="margin:5px 0">${si+1}.${i+1} ${displayText}</div>`);
        });
      }
    });

    // footer
    parts.push('<div style="margin-top:20px;font-size:11px;color:#666">Signature: ___________________ &nbsp;&nbsp; Date: __________</div>');
    parts.push('</div>');
    // watermark only for print
    const watermark = options.forPrint ? `<div style="position:fixed;right:10px;top:120px;opacity:.05;font-size:80px;transform:rotate(-30deg);font-weight:800">SCHOOL</div>` : '';
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Exam</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111;line-height:1.4}</style>
      </head><body>${watermark}${parts.join('')}</body></html>`;
    return html;
  }

  function showPreview(){
    const html = buildExamHtml({forPrint:false});
    previewOutput.innerHTML = html.replace(/<!doctype html>.*<body[^>]*>|<\/body><\/html>/gi,'');
    previewArea.style.display='block';
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  function exportPdf(){
    const html = buildExamHtml({forPrint:true});
    const blob = new Blob([html], {type: 'application/pdf'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (model.meta.exam || 'exam') + '.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportDoc(){
    const html = buildExamHtml({forPrint:false});
    // Create a more Word-friendly format
    const docContent = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" 
            xmlns:w="urn:schemas-microsoft-com:office:word" 
            xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta charset="utf-8">
        <title>${model.meta.exam || 'Exam'}</title>
        <style>
          body { font-family: Arial, sans-serif; }
          ul { margin: 0; padding-left: 20px; }
        </style>
      </head>
      <body>
        ${html.replace(/<!doctype html>.*<body[^>]*>|<\/body><\/html>/gi,'')}
      </body>
      </html>
    `;
    
    const blob = new Blob([docContent], {type: 'application/msword'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (model.meta.exam || 'exam') + '.doc';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // helper UI feedback
  function flash(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.right = '14px';
    el.style.bottom = '14px';
    el.style.background = '#0b5fff';
    el.style.color = '#fff';
    el.style.padding = '8px 12px';
    el.style.borderRadius = '6px';
    el.style.boxShadow = '0 4px 12px rgba(11,95,255,0.1)';
    el.style.zIndex = '1000';
    document.body.appendChild(el);
    setTimeout(()=> el.style.opacity = '0.0', 1800);
    setTimeout(()=> el.remove(), 2400);
  }

  // utils
  function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // initial bind
  document.getElementById('btn-add').addEventListener('click', ()=>{
    const t = document.getElementById('add-type').value;
    addSection(t);
  });
  document.getElementById('btn-save').addEventListener('click', saveModelToLocal);
  document.getElementById('btn-load').addEventListener('click', loadModelFromLocal);
  document.getElementById('btn-clear').addEventListener('click', clearAll);
  document.getElementById('btn-preview').addEventListener('click', showPreview);
  document.getElementById('btn-export-pdf').addEventListener('click', exportPdf);
  document.getElementById('btn-export-doc').addEventListener('click', exportDoc);

  // load existing on open
  (function init(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try { model = JSON.parse(raw); } catch(e){ /* ignore */ }
    }
    bindMetaToInputs();
    renderSections();
  })();

})();
</script>
</body>
</html>