<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>reCaptcha v3 + App Check + Firestore demo</title>

  <!-- Replace RECAPTCHA_SITE_KEY below when instructed -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:24px; background:#0b1220; color:#e6eef8; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:20px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); max-width:920px; margin:auto; }
    h1 { margin:0 0 8px 0; font-size:20px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#1f6feb; color:white; cursor:pointer; font-weight:600; }
    button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); }
    .status { margin-top:12px; padding:10px; border-radius:8px; background:rgba(0,0,0,0.35); font-size:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:#dff; }
    /* debug window */
    #debug {
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: 320px;
      max-height: 46vh;
      overflow:auto;
      background: rgba(4,6,12,0.9);
      border: 1px solid rgba(255,255,255,0.04);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      font-size:13px;
      z-index: 9999;
    }
    #debug h3 { margin:0 0 6px 0; font-size:13px; color:#a8d1ff; }
    .log { margin-bottom:6px; color:#cfefff; }
    .warn { color:#ffd9a8; }
    .err { color:#ffb4b4; }
    .small { font-size:12px; color:#9fb6d9; }
    .kv { display:flex; gap:8px; }
    .kv span:first-child { color:#9fb6d9; min-width:80px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>reCaptcha v3 + App Check + Firestore demo</h1>
    <p class="small">This page initializes App Check (ReCaptcha V3 provider), signs in anonymously, shows UID, and fetches <code>test/test1 -> name</code>. Logs appear in the debug window.</p>

    <div class="row">
      <button id="btn-recaptcha">Get reCaptcha token</button>
      <button id="btn-init">Init Firebase + AppCheck</button>
      <button id="btn-signin">Sign in anonymously</button>
      <button id="btn-fetch" class="ghost">Fetch "name" from Firestore</button>
      <button id="btn-clear" class="ghost">Clear logs</button>
    </div>

    <div class="status" id="status">
      <div class="kv"><span>App:</span><span id="app-state" class="mono">not initialized</span></div>
      <div class="kv"><span>Auth UID:</span><span id="uid" class="mono">—</span></div>
      <div class="kv"><span>Firestore name:</span><span id="f-name" class="mono">—</span></div>
      <div style="margin-top:8px;" class="small">Open console for more details, but this debug window shows the important bits.</div>
    </div>
  </div>

  <div id="debug" aria-live="polite">
    <h3>DEBUG</h3>
    <div id="log-area"></div>
  </div>

  <script type="module">
    // --------- REPLACE THESE VALUES ---------
    // Replace the firebaseConfig object with your project values.
    const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
  };

    // Replace with your reCaptcha v3 site key (used both by grecaptcha and App Check provider)
    const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";
    // ----------------------------------------

    // Import only what we need from Firebase v11.9.0 (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // UI refs
    const logArea = document.getElementById('log-area');
    const appStateEl = document.getElementById('app-state');
    const uidEl = document.getElementById('uid');
    const fnameEl = document.getElementById('f-name');

    function log(msg, level = 'info'){
      const d = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.className = 'log ' + (level === 'warn' ? 'warn' : level === 'err' ? 'err' : '');
      el.textContent = `[${d}] ${msg}`;
      logArea.prepend(el);
      console.log(msg);
    }

    function setStatusApp(s){
      appStateEl.textContent = s;
    }

    // state holders
    let app, appCheck, auth, db;

    // Initialize Firebase + App Check
    document.getElementById('btn-init').addEventListener('click', () => initFirebase());
    async function initFirebase(){
      try{
        log('Initializing Firebase app...');
        app = initializeApp(firebaseConfig);
        setStatusApp('firebase initialized');

        // App Check with reCaptcha v3 provider
        log('Initializing App Check with ReCaptchaV3Provider...');
        appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
          isTokenAutoRefreshEnabled: true
        });
        setStatusApp('App Check init done');

        // auth + firestore
        auth = getAuth(app);
        db = getFirestore(app);

        // Observe auth state
        onAuthStateChanged(auth, user => {
          if (user) {
            log(`Auth: signed in (uid: ${user.uid})`);
            uidEl.textContent = user.uid;
          } else {
            log('Auth: not signed in');
            uidEl.textContent = '—';
          }
        });

        log('Firebase + AppCheck ready.');
      }catch(err){
        log('Init error: ' + (err.message || err), 'err');
      }
    }

    // Sign in anonymously
    document.getElementById('btn-signin').addEventListener('click', async () => {
      if (!auth){
        log('Auth not initialized. Click "Init Firebase + AppCheck" first.', 'warn');
        return;
      }
      try{
        log('Signing in anonymously...');
        const res = await signInAnonymously(auth);
        log('Anonymous sign-in successful. UID: ' + res.user.uid);
      }catch(err){
        log('Sign-in error: ' + (err.message || err), 'err');
      }
    });

    // Fetch name from test/test1
    document.getElementById('btn-fetch').addEventListener('click', async () => {
      if (!db){
        log('Firestore not initialized. Click "Init Firebase + AppCheck" first.', 'warn');
        return;
      }
      try{
        log('Reading doc test/test1 ...');
        const dRef = doc(db, 'test', 'test1');
        const snap = await getDoc(dRef);
        if (!snap.exists()){
          log('Document does not exist at test/test1', 'warn');
          fnameEl.textContent = 'not found';
          return;
        }
        const data = snap.data();
        log('Fetched document fields: ' + JSON.stringify(data));
        const name = data.name ?? '(no name field)';
        fnameEl.textContent = name;
      }catch(err){
        log('Firestore read error: ' + (err.message || err), 'err');
      }
    });

    // Get a direct reCaptcha token (grecaptcha.execute) for debugging / verification
    document.getElementById('btn-recaptcha').addEventListener('click', async () => {
      if (typeof grecaptcha === 'undefined') {
        log('grecaptcha not loaded. Check reCaptcha script include and site key.', 'err');
        return;
      }
      try{
        log('Requesting reCaptcha v3 token (action: demo) ...');
        grecaptcha.ready(() => {
          grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'demo'}).then(token => {
            log('Got reCaptcha token (short preview): ' + token.slice(0,24) + '... (length ' + token.length + ')');
            // In production: send token to your server for verification if needed.
          }).catch(e => {
            log('grecaptcha.execute error: ' + e, 'err');
          });
        });
      }catch(e){
        log('reCaptcha error: ' + e, 'err');
      }
    });

    // clear logs
    document.getElementById('btn-clear').addEventListener('click', ()=> logArea.innerHTML = '');

    // Auto-init? no — user requested explicit flow; comment out to auto-init on load.
    // initFirebase();

    // Helpful tips logged to window
    log('Demo loaded. Click "Init Firebase + AppCheck" to start the combo flow.');
    log('Note: If App Check enforcement is ON, make sure this origin is registered in Firebase App Check or use monitor mode for testing.');
  </script>
</body>
</html>