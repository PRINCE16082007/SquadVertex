<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - TeamGalaxy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    html,body { height: 100%; }
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e0e0ff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden; /* avoid horizontal scroll from big blobs */
    }

    /* subtle starfield behind everything */
    body::before{
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(2px 2px at 12% 10%, rgba(255,255,255,0.10), transparent),
        radial-gradient(1.5px 1.5px at 70% 30%, rgba(255,255,255,0.07), transparent),
        radial-gradient(1px 1px at 42% 78%, rgba(255,255,255,0.05), transparent);
      opacity: 0.8;
      z-index: 0;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(10, 10, 35, 0.95);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid #5a4fcf;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      position: sticky;
      top: 0;
      z-index: 60;
    }

    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: #8a7cff;
      letter-spacing: 1.5px;
      text-shadow: 0 0 10px rgba(138, 124, 255, 0.5);
      background: linear-gradient(45deg, #8a7cff, #d66efd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-buttons { display: flex; gap: 1rem; }
    .btn {
      padding: 0.7rem 1.4rem;
      border-radius: 8px;
      border: 1px solid rgba(138,124,255,0.3);
      background: rgba(20,20,40,0.5);
      cursor:pointer; font-weight:600; transition: all .25s ease; font-size: .95rem; color:#b1a6ff;
      backdrop-filter: blur(10px);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106,90,249,0.08); }

    /* Layout container */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      flex: 1;
      position: relative;
      z-index: 30; /* above background decorations */
    }

    /* HERO wrapper that provides side space visually */
    .profile-hero {
      position: relative;
      padding: 2rem 0 3rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 2rem;
    }

    /* PROFILE CARD - slightly reduced width so sides exist */
    .profile-card {
      background: rgba(20, 20, 40, 0.95);
      border-radius: 20px;
      padding: 3rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      border: 1px solid rgba(90,79,207,0.9);
      backdrop-filter: blur(8px);
      margin-bottom: 2rem;
      width: min(920px, 100%); /* keep it narrower than page so sides remain */
      position: relative;
      z-index: 40;
      overflow: visible;
    }

    /* add soft glowing nebula blobs behind the card to fill sides */
    .profile-card::before,
    .profile-card::after {
      content: "";
      position: absolute;
      width: 700px;
      height: 420px;
      border-radius: 50%;
      filter: blur(90px);
      opacity: 0.9;
      z-index: -1;
      pointer-events: none;
      transform: translate3d(0,0,0);
      will-change: transform, opacity;
    }

    .profile-card::before {
      left: calc(-50vw + 160px); /* pushes glow left into side space */
      top: -60px;
      background: radial-gradient(circle at 30% 30%, rgba(106,90,249,0.95), rgba(134, 99, 255,0.55) 35%, transparent 60%);
      animation: float-blob 10s ease-in-out infinite;
    }
    .profile-card::after {
      right: calc(-50vw + 160px); /* pushes glow right into side space */
      bottom: -40px;
      background: radial-gradient(circle at 70% 70%, rgba(214, 110, 253,0.9), rgba(138,124,255,0.45) 30%, transparent 60%);
      animation: float-blob-2 12s ease-in-out infinite;
    }

    @keyframes float-blob {
      0% { transform: translateY(0) scale(1); opacity: .95; }
      50% { transform: translateY(-20px) scale(1.02); opacity: .8; }
      100% { transform: translateY(0) scale(1); opacity: .95; }
    }
    @keyframes float-blob-2 {
      0% { transform: translateY(0) scale(1); opacity: .85; }
      50% { transform: translateY(18px) scale(1.03); opacity: .7; }
      100% { transform: translateY(0) scale(1); opacity: .85; }
    }

    /* subtle diagonal pattern that sits behind the entire hero area */
    .hero-pattern {
      position: absolute;
      inset: 0;
      z-index: 35;
      pointer-events: none;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(225deg, rgba(255,255,255,0.01) 1px, transparent 1px);
      background-size: 40px 40px;
      mix-blend-mode: overlay;
      opacity: 0.6;
    }

    /* small constellation SVG (positioned center-right) */
    .constellation {
      position: absolute;
      right: 3%;
      top: 20%;
      width: 280px;
      height: 220px;
      z-index: 34;
      pointer-events: none;
      opacity: 0.6;
      transform: translateZ(0);
    }

    /* PROFILE CONTENT inside card (no big changes to your classes) */
    .profile-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
    .profile-photo { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #6a5af9; background: linear-gradient(45deg,#6a5af9,#d66efd); display:flex; align-items:center; justify-content:center; font-size:4rem; box-shadow: 0 8px 30px rgba(106,90,249,0.24); }
    .profile-info { flex: 1; min-width: 300px; }
    .profile-name { font-size: 2.5rem; font-weight: bold; color: #ffffff; margin-bottom: .5rem; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
    .profile-slug { font-size: 1.3rem; color: #b1a6ff; margin-bottom: .8rem; display:flex; align-items:center; gap:.5rem; }

    .verified-badge { display:inline-block; background: linear-gradient(45deg,#6a5af9,#d66efd); color:white; padding:.3rem 1rem; border-radius:20px; font-size:1rem; font-weight:bold; box-shadow: 0 0 10px rgba(106,90,249,0.3); }
    .join-date, .email { color:#a0a0d0; font-size:1.1rem; margin: .3rem 0; }

    .profile-actions { position: absolute; top: 2rem; right: 2rem; z-index:45; }

    .bio-section { margin: 2.5rem 0; }
    .section-title { font-size: 1.5rem; font-weight:600; color:#d0c4ff; margin-bottom:1.5rem; padding-bottom:.8rem; border-bottom:2px solid #5a4fcf; display:flex; align-items:center; gap:.8rem; }
    .bio-text { line-height:1.7; color:#c0c0e0; font-size:1.15rem; }

    .profile-stats { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:2rem; margin-top:2.5rem; }
    .stat-card { background: rgba(40,40,70,0.6); padding:2rem; border-radius:15px; text-align:center; border:1px solid #5a4fcf; transition: transform .3s ease; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-value { font-size:2.5rem; font-weight:bold; color:#8a7cff; margin-bottom:.8rem; text-shadow:0 0 10px rgba(138,124,255,0.3); }
    .stat-label { color:#b1a6ff; font-size:1.1rem; }

    /* posts / comments unchanged (kept concise here) */
    .posts-section { background: rgba(20,20,40,0.85); border-radius:20px; padding:3rem; box-shadow:0 15px 35px rgba(0,0,0,0.4); border:1px solid #5a4fcf; backdrop-filter: blur(10px); margin-top: 2rem; }
    .posts-grid { display:grid; grid-template-columns: 1fr; gap:2rem; margin-top:2rem; }
    .post-card { background: rgba(30,30,50,0.7); border-radius:15px; padding:1.8rem; border:1px solid #5a4fcf; }
    .post-title { font-size:1.4rem; font-weight:600; color:#fff; margin-bottom:.8rem; }
    .post-body { color:#c0c0e0; line-height:1.6; margin-bottom:1.2rem; font-size:1rem; }

    /* footer kept similar */
    .footer { background: rgba(10,10,35,0.95); padding:3rem 2rem 2rem; margin-top:3rem; border-top:1px solid #5a4fcf; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index:30; }
    .footer-content { max-width:1200px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:3rem; }
    .rocket-frame { margin-top:2rem; padding:1.5rem; border:2px solid #5a4fcf; border-radius:12px; background: rgba(20,20,40,0.5); position:relative; overflow:hidden; }
    .rocket-text { font-size:1.8rem; font-weight:bold; color:#8a7cff; text-align:center; text-shadow:0 0 15px rgba(138,124,255,0.6); background: linear-gradient(45deg,#8a7cff,#d66efd,#8a7cff); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation: shimmer 3s linear infinite; }

    @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }

    /* Loading overlay stars kept */
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg,#0f0c29,#302b63,#24243e); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; transition: opacity .5s ease; }
    .loading-overlay.hidden { opacity:0; pointer-events:none; }
    .loading-message { font-size:1.8rem; color:#e0e0ff; margin-bottom:2rem; text-align:center; font-weight:600; text-shadow:0 0 10px rgba(138,124,255,0.5); }

    .stars-container { position: relative; width: 300px; height: 300px; }
    .star { position:absolute; background-color:white; border-radius:50%; animation: twinkle var(--duration) infinite ease-in-out; }
    @keyframes twinkle { 0%,100%{opacity:.2;} 50%{opacity:1;} }

    /* Responsive tweaks */
    @media (max-width: 1024px) {
      .profile-card::before, .profile-card::after { display: none; } /* hide large blobs on smaller desktops/tablets */
      .constellation { right: 5%; top: 18%; width: 200px; height: 160px; }
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 1.2rem; padding: 1.2rem; }
      .profile-header { flex-direction: column; text-align: center; }
      .profile-actions { position: static; margin-top: 1.5rem; text-align: center; }
      .footer-content { grid-template-columns: 1fr; }
      .profile-card, .posts-section { padding: 2rem 1.5rem; width: 100%; }
      .profile-name { font-size: 2rem; }
      .hero-pattern { display:none; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-message">Building your profile, wait for a second...</div>
    <div class="stars-container" id="starsContainer"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="logo">GalaxyWeb</div>
    <div class="header-buttons">
      <button class="btn btn-settings">Settings</button>
      <button class="btn btn-logout">Log Out</button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- profile hero (decorations live here, card stays centered) -->
    <div class="profile-hero">
      <div class="hero-pattern" aria-hidden="true"></div>

      <!-- constellation svg for visual interest on the side -->
      <svg class="constellation" viewBox="0 0 300 220" aria-hidden="true">
        <g fill="none" stroke="rgba(200,190,255,0.14)" stroke-width="1.2" stroke-linecap="round">
          <path d="M20 140 L70 90 L120 110 L170 60 L230 90" stroke-dasharray="6 6">
            <animate attributeName="stroke-dashoffset" from="0" to="36" dur="8s" repeatCount="indefinite"/>
          </path>
        </g>
        <g fill="rgba(255,255,255,0.85)">
          <circle cx="20" cy="140" r="2.4"/><circle cx="70" cy="90" r="2.6"/><circle cx="120" cy="110" r="2.2"/><circle cx="170" cy="60" r="2.8"/><circle cx="230" cy="90" r="2.3"/>
        </g>
      </svg>

      <!-- THIS must keep id="profile-content" so your JS continues to work -->
      <div id="profile-content">
        <div class="loading">Loading profile...</div>
      </div>
    </div>

    <div id="posts-section"></div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-left">
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">
          TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together ‚Äî join now to explore the Galaxy!
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-links">
          <a href="../legal/privacy_policy.html">Privacy Policy</a>
          <a href="../legal/terms_and_conditions.html">Terms & Conditions</a>
          <a href="../about_us.html">About</a>
        </div>
        <div class="rocket-frame">
          <div class="rocket-text">üöÄ ROCKET üöÄ</div>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const profileContent = document.getElementById('profile-content');
    const postsSection = document.getElementById('posts-section');
    const logoutBtn = document.querySelector('.btn-logout');
    const settingsBtn = document.querySelector('.btn-settings');

    // Create stars for loading overlay
    function createStars() {
      const container = document.getElementById('starsContainer');
      container.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.classList.add('star');

        const x = Math.random() * 100;
        const y = Math.random() * 100;
        star.style.left = `${x}%`;
        star.style.top = `${y}%`;

        const size = Math.random() * 3 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;

        const duration = Math.random() * 3 + 2;
        star.style.setProperty('--duration', `${duration}s`);

        container.appendChild(star);
      }
    }

    // Format date, formatNumber, timeAgo (unchanged)
    function formatDate(dateValue) {
      if (!dateValue) return '';
      if (dateValue && dateValue.seconds !== undefined) {
        const date = new Date(dateValue.seconds * 1000);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else if (dateValue instanceof Date) {
        return dateValue.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      } else {
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) return 'Invalid Date';
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }
    function timeAgo(dateValue) {
      if (!dateValue) return 'Just now';
      let date;
      if (dateValue && dateValue.seconds !== undefined) date = new Date(dateValue.seconds * 1000);
      else if (dateValue instanceof Date) date = dateValue;
      else { date = new Date(dateValue); if (isNaN(date.getTime())) return 'Invalid Date'; }
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + ' years ago';
      interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + ' months ago';
      interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + ' days ago';
      interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + ' hours ago';
      interval = seconds / 60; if (interval > 1) return Math.floor(interval) + ' minutes ago';
      return Math.floor(seconds) + ' seconds ago';
    }

    // Load profile data etc. (unchanged)
    async function loadProfile() {
      const user = auth.currentUser;
      if (!user) {
        profileContent.innerHTML = '<div class="loading">Please log in to view your profile.</div>';
        return;
      }
      try {
        const docRef = doc(db, 'usersPrivate', user.uid);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          profileContent.innerHTML = '<div class="loading">Profile not found.</div>';
          return;
        }
        const data = docSnap.data();
        renderProfile(data);
        await loadUserPosts(user.uid);
      } catch (error) {
        console.error('Error loading profile:', error);
        profileContent.innerHTML = '<div class="loading">Error loading profile.</div>';
      }
    }

    async function loadUserPosts(userId) {
      try {
        const q = query(collection(db, 'posts'), where('authorId', '==', userId), orderBy('createdAt', 'desc'), limit(3));
        const querySnapshot = await getDocs(q);
        const posts = [];
        querySnapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
        renderPosts(posts);
      } catch (error) {
        console.error('Error loading posts:', error);
        postsSection.innerHTML = '<div class="loading">Error loading posts.</div>';
      }
    }

    function renderProfile(data) {
      profileContent.innerHTML = `
        <div class="profile-card">
          <div class="profile-actions">
            <button class="btn-share" id="shareBtn">Share Profile</button>
          </div>

          <div class="profile-header">
            <img src="${data.profilePhotoUrl || 'https://via.placeholder.com/150'}" alt="Profile Photo" class="profile-photo">
            <div class="profile-info">
              <h1 class="profile-name">${data.name || 'Unknown User'}</h1>
              <div class="profile-slug">${data.slug ? '@' + data.slug : ''}${data.verified ? '<span class="verified-badge">‚úì Verified</span>' : ''}</div>
              <div class="join-date">Joined: ${formatDate(data.joinDate)}</div>
              <div class="email">${data.email || ''}</div>
            </div>
          </div>

          <div class="bio-section">
            <h2 class="section-title">Bio</h2>
            <p class="bio-text">${data.bio || 'No bio available.'}</p>
          </div>

          <div class="profile-stats">
            <div class="stat-card">
              <div class="stat-value">${formatNumber(data.publicPostCount || 0)}</div>
              <div class="stat-label">Public Posts</div>
            </div>
          </div>
        </div>
      `;

      // share button
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) {
        shareBtn.addEventListener('click', () => {
          if (data.slug) {
            const shareUrl = `https://teamgalaxyinteractive-cmd.github.io/teamgalaxy/public_data_manager/public_user_profile.html?=${data.slug}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert('Profile URL copied to clipboard!'))
              .catch(err => { console.error('Failed to copy:', err); alert('Failed to copy URL.'); });
          } else alert('No profile slug available for sharing.');
        });
      }
    }

    async function renderPosts(posts) {
      if (posts.length === 0) {
        postsSection.innerHTML = '<div class="loading">No posts found.</div>';
        return;
      }
      let postsHTML = `<div class="posts-section"><h2 class="section-title">Recent Posts</h2><div class="posts-grid">`;
      for (const post of posts) {
        const commentsQuery = query(collection(db, 'posts', post.id, 'comments'), orderBy('createdAt', 'desc'), limit(3));
        const commentsSnapshot = await getDocs(commentsQuery);
        const comments = []; commentsSnapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
        postsHTML += `
          <div class="post-card">
            <h3 class="post-title">${post.title || 'Untitled Post'}</h3>
            <p class="post-body">${post.body || 'No content available.'}</p>
            <div class="post-meta">
              <span class="post-author">By ${post.authorName || 'Anonymous'}</span>
              <span class="post-time">${timeAgo(post.createdAt)}</span>
            </div>
            <div class="post-meta">
              <span>üëç ${formatNumber(post.upvotesCount || 0)}</span>
              <span>üëé ${formatNumber(post.downvotesCount || 0)}</span>
              <span>üí¨ ${formatNumber(post.commentsCount || 0)}</span>
            </div>
            ${comments.length > 0 ? `
              <div class="comments-section">
                <h4>Recent Comments</h4>
                <div class="comments-grid">
                  ${comments.map(comment => `
                    <div class="comment-card">
                      <div class="comment-header">
                        <span class="comment-author">${comment.authorName || 'Anonymous'}</span>
                        <span class="comment-time">${timeAgo(comment.createdAt)}</span>
                      </div>
                      <p class="comment-body">${comment.body || ''}</p>
                    </div>
                  `).join('')}
                </div>
              </div>` : ''}
          </div>`;
      }
      postsHTML += `</div><div class="post-actions"><button class="btn-post" id="explore-btn">Explore</button><button class="btn-post" id="show-all-btn">Show All Posts</button></div></div>`;
      postsSection.innerHTML = postsHTML;
      document.getElementById('explore-btn').addEventListener('click', () => { window.location.href = '../posts.html'; });
      document.getElementById('show-all-btn').addEventListener('click', () => { window.location.href = 'user_posts.html'; });
    }

    onAuthStateChanged(auth, (user) => {
      if (user) loadProfile();
      else { profileContent.innerHTML = '<div class="loading">Please log in to view your profile.</div>'; postsSection.innerHTML = ''; }
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => { window.location.href = 'index.html'; }).catch(err => { console.error('Sign out error:', err); alert('Error signing out.'); });
    });
    settingsBtn.addEventListener('click', () => { window.location.href = 'settings.html'; });

    // loading overlay behavior + stars
    window.addEventListener('load', () => {
      createStars();
      setTimeout(() => loadingOverlay.classList.add('hidden'), 3000);
    });
  </script>
</body>
</html>