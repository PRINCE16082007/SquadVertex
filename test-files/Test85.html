<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Professional Seating Layout Print View</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { margin: 0; font-size: 28px; }
    .instructions { font-size: 14px; color: #555; margin-top: 5px; }
    #controls { margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
    label { font-weight: bold; }
    select, button { padding: 8px 12px; font-size: 14px; }
    button { cursor: pointer; }
    .room { margin-bottom: 40px; }
    .room h2 { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    table { border-collapse: collapse; margin-bottom: 20px; width: 100%; }
    table, td, th { border: 1px solid #333; }
    td { width: 120px; height: 120px; text-align: center; vertical-align: middle; padding: 5px; }
    /* Print specific styles */
    @media print {
      #controls { display: none; }
      body { margin: 10mm; }
    }
  </style>
</head>
<body>
  <header>
    <h1>School Seating Layout</h1>
    <div class="instructions">
      Use the options below to select a print template. Click "Print" for a printer-friendly version.
    </div>
  </header>

  <div id="controls">
    <label for="templateSelect">Template:</label>
    <select id="templateSelect">
      <option value="1">Name Only</option>
      <option value="2">Name + Class</option>
      <option value="3">Name + Class + Stream</option>
      <option value="4">Name + Class + Stream + Subjects</option>
      <option value="5">Name + Father Name</option>
    </select>
    <button onclick="window.print()">Print</button>
  </div>

  <div id="printArea">Loading seating layoutsâ€¦</div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global objects to store fetched data
    let students = {};
    let rooms = [];
    let fileData = null;
    
    // Template generator: returns HTML for a seat given a student and the selected template
    function generateSeatContent(student, templateId) {
      if (!student) return "";
      switch (templateId) {
        case "1":
          return `<strong>${student.name}</strong>`;
        case "2":
          return `<strong>${student.name}</strong><br>${student.class}`;
        case "3":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}`;
        case "4":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}<br>${Array.isArray(student.subjects) ? student.subjects.join(", ") : ""}`;
        case "5":
          return `<strong>${student.name}</strong><br>Father: ${student.fatherName || "N/A"}`;
        default:
          return `<strong>${student.name}</strong>`;
      }
    }

    async function loadPrintView() {
      try {
        // Fetch students from the collection "001-school/students/list"
        const studentsSnap = await db.collection("001-school").doc("students").collection("list").get();
        studentsSnap.docs.forEach(doc => {
          const data = doc.data();
          students[doc.id] = {
            name: data.studentName,
            class: data.class,
            stream: data.stream,
            subjects: data.subjects,
            fatherName: data.fatherName,
            gender: data.gender
          };
        });

        // Fetch room file(s) from "001-school/rooms/files"
        const filesSnap = await db.collection("001-school").doc("rooms").collection("files").get();
        if (filesSnap.empty) {
          document.getElementById("printArea").innerText = "No room files found.";
          return;
        }
        // Use the first file for printing
        const fileDoc = filesSnap.docs[0];
        fileData = fileDoc.data();
        const fileId = fileDoc.id;
        
        // Fetch room layouts from the selected file
        const layoutsSnap = await db.collection("001-school").doc("rooms").collection("files").doc(fileId).collection("layouts").get();
        rooms = layoutsSnap.docs.map(doc => doc.data());
        
        renderPrintView();
      } catch (e) {
        console.error("Error loading print view:", e);
        document.getElementById("printArea").innerText = "Error loading seating layouts.";
      }
    }
    
    function renderPrintView() {
      const templateId = document.getElementById("templateSelect").value;
      let html = `<h1 style="text-align:center;">${fileData.name} - Seating Layout</h1>`;
      
      rooms.forEach(room => {
        html += `<div class="room">
          <h2>${room.name} (${room.type})</h2>
          <table>`;
        for (let i = 0; i < room.rows; i++) {
          html += "<tr>";
          for (let j = 0; j < room.cols; j++) {
            const index = i * room.cols + j;
            let seatContent = "";
            if (room.seating && room.seating[index]) {
              const studentId = room.seating[index];
              if (students[studentId]) {
                seatContent = generateSeatContent(students[studentId], templateId);
              }
            }
            html += `<td>${seatContent}</td>`;
          }
          html += "</tr>";
        }
        html += `</table></div>`;
      });
      document.getElementById("printArea").innerHTML = html;
    }
    
    // Listen for template selection changes
    document.getElementById("templateSelect").addEventListener("change", renderPrintView);
    
    loadPrintView();
  </script>
</body>
</html>