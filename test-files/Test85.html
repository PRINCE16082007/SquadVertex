<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Professional Seating Layout Print View</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { margin: 0; font-size: 28px; }
    .instructions { font-size: 14px; color: #555; margin-top: 5px; }
    #branding { margin-bottom: 20px; text-align: center; }
    #branding img { max-height: 80px; }
    #controls { margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: center; }
    label { font-weight: bold; }
    select, input[type="checkbox"], button { padding: 8px 12px; font-size: 14px; }
    button { cursor: pointer; }
    #printArea { margin-top: 20px; }
    .room-container { border: 1px solid #333; padding: 15px; margin-bottom: 40px; width: 100%; max-width: 900px; }
    .room-container h2 { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    table { border-collapse: collapse; margin-bottom: 10px; width: 100%; }
    table, td, th { border: 1px solid #333; }
    td { width: 120px; height: 120px; text-align: center; vertical-align: middle; padding: 5px; }
    .print-room-btn { margin-top: 10px; }
    /* Black & White printing: if the toggle is enabled, add a grayscale filter */
    .bw { filter: grayscale(100%); }
    /* Print-specific styles */
    @media print {
      #controls, header { display: none; }
      body { margin: 10mm; }
      .print-room-btn { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div id="branding">
      <!-- School branding: logo and name will be inserted here -->
    </div>
    <h1>School Seating Layout - Print View</h1>
    <div class="instructions">
      Select a file and template below. For each room, use its individual "Print Room" button for a printer‑friendly version.  
      You can toggle between color and black &amp; white printing as desired.
    </div>
  </header>
  
  <div id="controls">
    <label for="fileSelect">Select File:</label>
    <select id="fileSelect"></select>
    
    <label for="templateSelect">Template:</label>
    <select id="templateSelect">
      <option value="1">Name Only</option>
      <option value="2">Name + Class</option>
      <option value="3">Name + Class + Stream</option>
      <option value="4">Name + Class + Stream + Subjects</option>
      <option value="5">Name + Father Name</option>
    </select>
    
    <label for="bwToggle">Black &amp; White:</label>
    <input type="checkbox" id="bwToggle">
    
    <button onclick="window.print()">Print All</button>
  </div>
  
  <div id="printArea">Loading seating layouts…</div>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let systemSettings = {};   // To store schoolName and logoUrl
    let students = {};         // Object mapping studentId -> student details
    let files = [];            // Array of file objects: { id, name }
    let rooms = [];            // Array of room objects for the selected file

    // Fetch system settings (e.g., schoolName and logoUrl) from Firestore collection "systemSettings"
    async function loadSystemSettings() {
      try {
        const settingsDoc = await db.collection("systemSettings").doc("school").get();
        if (settingsDoc.exists) {
          systemSettings = settingsDoc.data();
        } else {
          systemSettings = { schoolName: "Your School Name", logoUrl: "" };
        }
        renderBranding();
      } catch (e) {
        console.error("Error loading system settings:", e);
        systemSettings = { schoolName: "Your School Name", logoUrl: "" };
        renderBranding();
      }
    }

    // Render the branding container with school logo and name
    function renderBranding() {
      const brandingDiv = document.getElementById("branding");
      let logoHTML = systemSettings.logoUrl ? `<img src="${systemSettings.logoUrl}" alt="School Logo">` : "";
      brandingDiv.innerHTML = `
        ${logoHTML}
        <h2>${systemSettings.schoolName}</h2>
      `;
    }

    // Load students from "001-school/students/list" and map studentName -> name
    async function loadStudents() {
      try {
        const studentsSnap = await db.collection("001-school").doc("students").collection("list").get();
        studentsSnap.docs.forEach(doc => {
          const data = doc.data();
          students[doc.id] = {
            name: data.studentName,
            class: data.class,
            stream: data.stream,
            subjects: data.subjects,
            fatherName: data.fatherName,
            gender: data.gender
          };
        });
      } catch (e) {
        console.error("Error loading students:", e);
      }
    }

    // Load available files from "001-school/rooms/files" and populate fileSelect dropdown
    async function loadFiles() {
      try {
        const filesSnap = await db.collection("001-school").doc("rooms").collection("files").get();
        files = filesSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
        const fileSelect = document.getElementById("fileSelect");
        fileSelect.innerHTML = files.map(f => `<option value="${f.id}">${f.name}</option>`).join("");
        // Load rooms for the first file by default
        if (files.length > 0) {
          loadRooms(files[0].id);
        } else {
          document.getElementById("printArea").innerText = "No room files found.";
        }
      } catch (e) {
        console.error("Error loading files:", e);
        document.getElementById("printArea").innerText = "Error loading room files.";
      }
    }

    // Load rooms from the selected file ("001-school/rooms/files/{fileId}/layouts")
    async function loadRooms(fileId) {
      try {
        const layoutsSnap = await db.collection("001-school").doc("rooms").collection("files").doc(fileId).collection("layouts").get();
        rooms = layoutsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderPrintView();
      } catch (e) {
        console.error("Error loading rooms:", e);
        document.getElementById("printArea").innerText = "Error loading seating layouts.";
      }
    }

    // Generate seat content based on template selection
    function generateSeatContent(student, templateId) {
      if (!student) return "";
      switch (templateId) {
        case "1":
          return `<strong>${student.name}</strong>`;
        case "2":
          return `<strong>${student.name}</strong><br>${student.class}`;
        case "3":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}`;
        case "4":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}<br>${Array.isArray(student.subjects) ? student.subjects.join(", ") : ""}`;
        case "5":
          return `<strong>${student.name}</strong><br>Father: ${student.fatherName || "N/A"}`;
        default:
          return `<strong>${student.name}</strong>`;
      }
    }

    // Render the print view for all rooms using the selected file and template
    function renderPrintView() {
      const templateId = document.getElementById("templateSelect").value;
      const isBW = document.getElementById("bwToggle").checked;
      let html = "";
      if (rooms.length === 0) {
        html = "No room layouts found for this file.";
      } else {
        rooms.forEach(room => {
          html += `<div class="room-container ${isBW ? 'bw' : ''}">
            <h2>${room.name} (${room.type})</h2>
            <table>`;
          for (let i = 0; i < room.rows; i++) {
            html += "<tr>";
            for (let j = 0; j < room.cols; j++) {
              const index = i * room.cols + j;
              let seatContent = "";
              if (room.seating && room.seating[index]) {
                const studentId = room.seating[index];
                if (students[studentId]) {
                  seatContent = generateSeatContent(students[studentId], templateId);
                }
              }
              html += `<td>${seatContent}</td>`;
            }
            html += "</tr>";
          }
          html += `</table>
            <button class="print-room-btn" onclick="printRoom('${room.id}')">Print This Room</button>
          </div>`;
        });
      }
      document.getElementById("printArea").innerHTML = html;
    }

    // Print only a specific room by opening a new window with that room's HTML
    function printRoom(roomId) {
      const templateId = document.getElementById("templateSelect").value;
      const isBW = document.getElementById("bwToggle").checked;
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;
      
      let roomHtml = `<html>
      <head>
        <title>Print Room: ${room.name}</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
          h2 { text-align: center; }
          table { border-collapse: collapse; margin: auto; }
          table, td { border: 1px solid #333; }
          td { width: 120px; height: 120px; text-align: center; vertical-align: middle; padding: 5px; }
          ${isBW ? "body { filter: grayscale(100%); }" : ""}
        </style>
      </head>
      <body>
        <h2>${systemSettings.schoolName}</h2>
        <div style="text-align:center; margin-bottom:10px;">
          ${systemSettings.logoUrl ? `<img src="${systemSettings.logoUrl}" alt="School Logo" style="max-height:80px;">` : ""}
        </div>
        <h2>${room.name} (${room.type})</h2>
        <table>`;
      for (let i = 0; i < room.rows; i++) {
        roomHtml += "<tr>";
        for (let j = 0; j < room.cols; j++) {
          const index = i * room.cols + j;
          let seatContent = "";
          if (room.seating && room.seating[index]) {
            const studentId = room.seating[index];
            if (students[studentId]) {
              seatContent = generateSeatContent(students[studentId], templateId);
            }
          }
          roomHtml += `<td>${seatContent}</td>`;
        }
        roomHtml += "</tr>";
      }
      roomHtml += `</table>
      <script>
        window.onload = function() { window.print(); }
      <\/script>
      </body></html>`;
      
      const printWindow = window.open("", "PrintWindow", "width=900,height=700");
      printWindow.document.write(roomHtml);
      printWindow.document.close();
    }

    // Event listeners for control changes
    document.getElementById("fileSelect").addEventListener("change", function() {
      loadRooms(this.value);
    });
    document.getElementById("templateSelect").addEventListener("change", renderPrintView);
    document.getElementById("bwToggle").addEventListener("change", renderPrintView);

    // Initialize by loading system settings, students, then files
    async function initialize() {
      await loadSystemSettings();
      await loadStudents();
      await loadFiles();
    }
    initialize();
  </script>
</body>
</html>