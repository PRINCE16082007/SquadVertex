<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Print Seating Layout</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2 { margin: 0 0 10px 0; }
    .room { margin-bottom: 30px; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    table, td, th { border: 1px solid #000; }
    td { width: 120px; height: 120px; text-align: center; vertical-align: middle; padding: 5px; }
    /* Hide print button when printing */
    @media print {
      button { display: none; }
    }
  </style>
</head>
<body>
  <button onclick="window.print()">Print</button>
  <div id="printArea">Loading seating layoutsâ€¦</div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // Initialize Firebase using your config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadPrintView() {
      try {
        // Fetch students from "001-school/students/list"
        const studentsSnap = await db.collection("001-school").doc("students").collection("list").get();
        const students = {};
        studentsSnap.docs.forEach(doc => {
          const data = doc.data();
          // Map studentName to name
          students[doc.id] = {
            name: data.studentName,
            class: data.class,
            gender: data.gender,
            subjects: data.subjects
          };
        });

        // Fetch room file(s) from "001-school/rooms/files"
        const filesSnap = await db.collection("001-school").doc("rooms").collection("files").get();
        if (filesSnap.empty) {
          document.getElementById("printArea").innerText = "No room files found.";
          return;
        }
        // For simplicity, use the first file
        const fileDoc = filesSnap.docs[0];
        const fileData = fileDoc.data();
        const fileId = fileDoc.id;
        
        // Fetch room layouts from the selected file
        const layoutsSnap = await db.collection("001-school").doc("rooms").collection("files").doc(fileId).collection("layouts").get();
        let html = `<h1>${fileData.name} - Seating Layout</h1>`;
        layoutsSnap.docs.forEach(layoutDoc => {
          const room = layoutDoc.data();
          html += `<div class="room">
            <h2>${room.name} (${room.type})</h2>
            <table>`;
          for (let i = 0; i < room.rows; i++) {
            html += "<tr>";
            for (let j = 0; j < room.cols; j++) {
              const index = i * room.cols + j;
              let seatContent = "";
              if (room.seating && room.seating[index]) {
                const studentId = room.seating[index];
                if (students[studentId]) {
                  seatContent = `<strong>${students[studentId].name}</strong><br>${students[studentId].class}`;
                }
              }
              html += `<td>${seatContent}</td>`;
            }
            html += "</tr>";
          }
          html += `</table>
          </div>`;
        });
        document.getElementById("printArea").innerHTML = html;
      } catch (e) {
        console.error("Error loading print view:", e);
        document.getElementById("printArea").innerText = "Error loading seating layouts.";
      }
    }
    
    loadPrintView();
  </script>
</body>
</html>