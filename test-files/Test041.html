<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invoice Generator | Galaxy Designs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ===== GLOBAL ===== */
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:#0b0f1a;
  color:#fff;
}
.container{
  max-width:780px;
  margin:40px auto;
  padding:20px;
}
h1{
  text-align:center;
  margin-bottom:30px;
}
.card{
  background:#131a2a;
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
}
input,textarea,select{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:8px;
  border:none;
  outline:none;
  font-size:15px;
}
textarea{min-height:90px}
button{
  width:100%;
  padding:15px;
  font-size:17px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  background:linear-gradient(135deg,#6c5ce7,#00cec9);
  color:#fff;
}
.footer-note{
  text-align:center;
  font-size:12px;
  opacity:.6;
  margin-top:20px;
}
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ§¾ Invoice Generator</h1>

  <div class="card">
    <h3>Customer</h3>
    <input id="c_name" placeholder="Customer Name">
    <input id="c_email" placeholder="Customer Email">
    <textarea id="c_address" placeholder="Customer Address (Country mandatory)"></textarea>
  </div>

  <div class="card">
    <h3>Product</h3>
    <input id="item_name" placeholder="Product Description">
    <input id="item_price" type="number" placeholder="Price (â‚¬)">
  </div>

  <div class="card">
    <h3>Payment</h3>
    <select id="payment_method">
      <option>Wise</option>
      <option>PayPal</option>
      <option>Stripe</option>
      <option>Bank Transfer</option>
    </select>
  </div>

  <button id="generate">Generate Invoice (PDF)</button>

  <div class="footer-note">
    France Micro-Entrepreneur â€¢ VAT Exempt â€¢ Audit-Safe
  </div>
</div>

<!-- ===== FIREBASE + LOGIC ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
import {
  getFirestore,
  doc,
  runTransaction,
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

/* ðŸ” SAME FIREBASE CREDENTIALS */
        const firebaseConfig = {
            apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
            authDomain: "teamgalaxy-77344.firebaseapp.com",
            projectId: "teamgalaxy-77344",
            storageBucket: "teamgalaxy-77344.firebasestorage.app",
            messagingSenderId: "770256225320",
            appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
            measurementId: "G-6C2W9NSNCH"
        };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   INVOICE NUMBER (NO GAPS)
========================= */
async function generateInvoiceNumber(){
  const year = new Date().getFullYear();
  const ref = doc(db,"invoice_counters",String(year));

  return await runTransaction(db,async(tx)=>{
    const snap = await tx.get(ref);
    let next = snap.exists() ? snap.data().count + 1 : 1;
    tx.set(ref,{ count: next });
    return `GD-${year}-${String(next).padStart(3,"0")}`;
  });
}

/* =========================
   PDF GENERATION
========================= */
function generatePDF(data){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 15;

  pdf.setFontSize(18);
  pdf.text("FACTURE",105,y,{align:"center"});

  pdf.setFontSize(10);
  y+=10;
  pdf.text(`Invoice No: ${data.invoice_number}`,14,y);
  pdf.text(`Issue Date: ${data.issue_date}`,150,y);

  y+=10;
  pdf.text("Seller:",14,y);
  y+=5;
  pdf.text("Galaxy Designs",14,y);
  pdf.text("Entrepreneur Individuel",14,y+=5);
  pdf.text("SIRET: 123 456 789 00014",14,y+=5);
  pdf.text("France",14,y+=5);

  y+=10;
  pdf.text("Bill To:",14,y);
  y+=5;
  pdf.text(data.customer_name,14,y);
  pdf.text(data.customer_address,14,y+=5);

  y+=10;
  pdf.text("Description",14,y);
  pdf.text("Amount (â‚¬)",160,y);
  y+=3;
  pdf.line(14,y,195,y);

  y+=8;
  pdf.text(data.items[0].name,14,y);
  pdf.text(`â‚¬${data.total_amount}`,160,y);

  y+=15;
  pdf.text(`TOTAL: â‚¬${data.total_amount}`,14,y);

  y+=15;
  pdf.setFontSize(9);
  pdf.text("TVA non applicable, art. 293 B du CGI",14,y);
  y+=5;
  pdf.text(
    "Le client renonce expressÃ©ment Ã  son droit de rÃ©tractation pour ce contenu numÃ©rique fourni immÃ©diatement aprÃ¨s paiement.",
    14,y,{maxWidth:180}
  );

  pdf.save(`${data.invoice_number}.pdf`);
}

/* =========================
   MAIN FLOW
========================= */
document.getElementById("generate").onclick = async ()=>{
  if(!c_name.value || !item_price.value){
    alert("Missing required fields");
    return;
  }

  const invoiceNumber = await generateInvoiceNumber();
  const issueDate = new Date();

  const invoiceData = {
    invoice_number: invoiceNumber,
    issue_date: issueDate.toISOString(),
    issue_year: issueDate.getFullYear(),
    customer: {
      name: c_name.value,
      email: c_email.value,
      address: c_address.value
    },
    items: [{
      name: item_name.value,
      quantity: 1,
      unit_price: Number(item_price.value)
    }],
    totals: {
      subtotal: Number(item_price.value),
      vat_rate: 0,
      vat_amount: 0,
      total: Number(item_price.value),
      currency: "EUR"
    },
    payment: {
      method: payment_method.value,
      status: "paid"
    },
    legal: {
      vat_exemption: "TVA non applicable, art. 293 B du CGI",
      withdrawal_waiver: true
    },
    file_sent_status: false,
    created_at: serverTimestamp()
  };

  await addDoc(collection(db,"invoices"),invoiceData);
  generatePDF({
    invoice_number: invoiceNumber,
    issue_date: issueDate.toISOString().split("T")[0],
    customer_name: invoiceData.customer.name,
    customer_address: invoiceData.customer.address,
    total_amount: invoiceData.totals.total,
    items: invoiceData.items
  });
};
</script>

</body>
</html>