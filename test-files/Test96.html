<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fee Management - Payments</title>
    <!-- Bootstrap CSS (Bootstrap 4) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
      /* Prevent horizontal overflow */
      .table-responsive { overflow-x: auto; }
      body { overflow-x: hidden; }
      /* Style for vehicle eligibility icon */
      .vehicle-eligible-icon {
        font-size: 1.2em;
        margin-left: 5px;
      }
      /* Navbar override if needed */
      .navbar-brand {
        font-weight: bold;
        font-size: 1.5rem;
      }
      .navbar-nav .nav-link.active {
        position: relative;
        color: #fff;
        background-color: #007bff;
        border-radius: 5px;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
      }
      .navbar-nav .nav-link.active::before {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border-radius: 5px;
        border: 2px solid rgba(0, 123, 255, 0.6);
        opacity: 0.7;
        animation: glow 1.5s infinite alternate;
      }
      @keyframes glow {
        from {
          box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
        }
        to {
          box-shadow: 0 0 16px rgba(0, 123, 255, 0.8);
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SchoolMS</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="../admin_dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../admission/admission.html">Admissions</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Staff <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../attendance/attendance.html">Attendance</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Classes <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="fees_module.html">Payment Module</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../exams.html">Exams</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../library/library.html">Library</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" tabindex="-1" aria-disabled="true">
                Transport <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../hostel/hostel.html">Hostel</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Communications <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Inventory <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../events/events.html">Events</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../admin_panel/admin_panel.html">Admin &amp; Settings panel</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Reports <span class="bi bi-lock"></span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <h3 class="mb-4">Add Payment, Apply Discount &amp; Manage Vehicle Fee</h3>
      <!-- Sorting & Filter Options -->
      <div class="row mb-3">
        <div class="col-md-3">
          <input type="text" id="student-search" class="form-control" placeholder="Search by Name or SR Number">
        </div>
        <div class="col-md-3">
          <select id="class-filter" class="form-control">
            <option value="">Select Class</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="stream-filter" class="form-control">
            <option value="">Select Stream</option>
            <option value="Science">Science</option>
            <option value="Commerce">Commerce</option>
            <option value="Arts">Arts</option>
            <option value="Agriculture">Agriculture</option>
            <option value="Nothing">Nothing</option>
          </select>
        </div>
      </div>
      <!-- Students Table in a responsive container -->
      <div class="table-responsive">
        <table class="table table-bordered" id="students-table">
          <thead class="thead-dark">
            <tr>
              <th>SR Number</th>
              <th>Name</th>
              <th>Father's Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Student rows will be dynamically loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1" role="dialog" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="payment-form">
            <div class="modal-header">
              <h5 class="modal-title" id="addPaymentModalLabel">Add Payment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Hidden field to store student ID -->
              <input type="hidden" id="payment-student-id">
              <div class="form-group">
                <label for="payment-amount">Amount Paid</label>
                <input type="number" class="form-control" id="payment-amount" required>
              </div>
              <div class="form-group">
                <label for="payment-type">Payment For</label>
                <select class="form-control" id="payment-type">
                  <option value="school fee" selected>School Fee</option>
                  <option value="vehicle fee">Vehicle Fee</option>
                </select>
              </div>
              <div class="form-group">
                <label for="payment-mode">Payment Mode</label>
                <select class="form-control" id="payment-mode">
                  <option value="Cash">Cash</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="Cheque">Cheque</option>
                </select>
              </div>
              <div class="form-group">
                <label for="transaction-id">Transaction ID (optional)</label>
                <input type="text" class="form-control" id="transaction-id">
              </div>
              <div class="form-group">
                <label for="payment-remarks">Remarks</label>
                <textarea class="form-control" id="payment-remarks"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Payment</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Give Discount Modal -->
    <div class="modal fade" id="giveDiscountModal" tabindex="-1" role="dialog" aria-labelledby="giveDiscountModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="discount-form">
            <div class="modal-header">
              <h5 class="modal-title" id="giveDiscountModalLabel">Give Discount</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p class="text-danger">Note: This action is allowed for admin only.</p>
              <input type="hidden" id="discount-student-id">
              <div class="form-group">
                <label for="discount-amount">Discount Amount</label>
                <input type="number" class="form-control" id="discount-amount" required>
              </div>
              <div class="form-group">
                <label for="admin-password">Admin Password</label>
                <input type="password" class="form-control" id="admin-password" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Apply Discount</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalLabel">Student Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Student Basic Info -->
            <div id="student-basic-info">
              <p><strong>SR Number:</strong> <span id="detail-sr"></span></p>
              <p><strong>Name:</strong> <span id="detail-name"></span></p>
              <p><strong>Father's Name:</strong> <span id="detail-father"></span></p>
              <p>
                <strong>Class:</strong> <span id="detail-class"></span> | 
                <strong>Stream:</strong> <span id="detail-stream"></span>
              </p>
              <p>
                <strong>School Fee:</strong> Base Fee: <span id="detail-base-fee"></span>, Discount: <span id="detail-discount"></span>, Final: <span id="detail-final-school"></span>
              </p>
              <p>
                <strong>Vehicle Fee:</strong> <span id="detail-vehicle-fee"></span>
              </p>
              <p>
                <strong>Total Fee:</strong> <span id="detail-total-fee"></span>
              </p>
              <p>
                <strong>Payments:</strong> School Fee Paid: <span id="detail-school-paid"></span>, Vehicle Fee Paid: <span id="detail-vehicle-paid"></span>
              </p>
              <p>
                <strong>Pending:</strong> School Fee Pending: <span id="detail-school-pending"></span>, Vehicle Fee Pending: <span id="detail-vehicle-pending"></span>
              </p>
            </div>
            <hr>
            <!-- Universal Fee Chart Details -->
            <div id="universal-fee-chart">
              <h5>Universal Fee Chart</h5>
              <p>
                For <strong>Class <span id="ufc-class"></span> - <span id="ufc-stream"></span></strong>:
              </p>
              <ul>
                <li><strong>Fee Amount:</strong> â‚¹<span id="ufc-fee"></span></li>
                <li><strong>Vehicle Rent:</strong> <span id="ufc-vehicle-fee"></span></li>
                <li><strong>Discount Offered:</strong> â‚¹<span id="ufc-discount"></span></li>
              </ul>
            </div>
            <hr>
            <!-- Transaction History -->
            <h5>Transaction History</h5>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Mode</th>
                    <th>Transaction ID</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody id="student-transactions">
                  <!-- Payment records will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Vehicle Fee Modal -->
    <div class="modal fade" id="vehicleFeeModal" tabindex="-1" role="dialog" aria-labelledby="vehicleFeeModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="vehicle-fee-form">
            <div class="modal-header">
              <h5 class="modal-title" id="vehicleFeeModalLabel">Vehicle Fee Management</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Hidden field for student ID -->
              <input type="hidden" id="vehicle-student-id">
              <!-- Changed eligibility to a checkbox -->
              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="vehicle-eligible-checkbox">
                  <label class="form-check-label" for="vehicle-eligible-checkbox">Eligible for Vehicle Fee</label>
                </div>
              </div>
              <!-- Vehicle details section (will be shown if eligibility checkbox is checked) -->
              <div id="vehicle-details-section" style="display:none;">
                <div class="form-group">
                  <label for="vehicle-select">Select Vehicle</label>
                  <select class="form-select" id="vehicle-select">
                    <option value="">Select Vehicle</option>
                    <!-- Options populated dynamically from systemSettings.vehicleFeesChart -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="vehicle-location">Select Location</label>
                  <select class="form-select" id="vehicle-location">
                    <option value="">Select Location</option>
                    <!-- Options based on selected vehicle -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="vehicle-rent">Rent Amount (per month)</label>
                  <input type="text" class="form-control" id="vehicle-rent" readonly>
                </div>
                <div class="form-group">
                  <label>Fee Option</label>
                  <div>
                    <input type="radio" name="vehicle-fee-option" id="fee-option-fixed" value="fixed" checked>
                    <label for="fee-option-fixed">Fixed Amount</label>
                  </div>
                  <div>
                    <input type="radio" name="vehicle-fee-option" id="fee-option-months" value="months">
                    <label for="fee-option-months">Calculate by Months</label>
                  </div>
                </div>
                <div class="form-group" id="fixed-amount-section">
                  <label for="vehicle-fixed-amount">Fixed Amount</label>
                  <input type="number" class="form-control" id="vehicle-fixed-amount" placeholder="Enter fixed amount">
                </div>
                <!-- Months checkboxes instead of a multi-select dropdown -->
                <div class="form-group" id="months-checkboxes" style="display:none;">
                  <label>Select Months</label>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="January" id="month-January">
                    <label class="form-check-label" for="month-January">January</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="February" id="month-February">
                    <label class="form-check-label" for="month-February">February</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="March" id="month-March">
                    <label class="form-check-label" for="month-March">March</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="April" id="month-April">
                    <label class="form-check-label" for="month-April">April</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="May" id="month-May">
                    <label class="form-check-label" for="month-May">May</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="June" id="month-June">
                    <label class="form-check-label" for="month-June">June</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="July" id="month-July">
                    <label class="form-check-label" for="month-July">July</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="August" id="month-August">
                    <label class="form-check-label" for="month-August">August</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="September" id="month-September">
                    <label class="form-check-label" for="month-September">September</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="October" id="month-October">
                    <label class="form-check-label" for="month-October">October</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="November" id="month-November">
                    <label class="form-check-label" for="month-November">November</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input month-checkbox" value="December" id="month-December">
                    <label class="form-check-label" for="month-December">December</label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="vehicle-last-update">Last Update</label>
                  <input type="text" class="form-control" id="vehicle-last-update" readonly>
                </div>
              </div>
              <div class="mt-3">
                <p><strong>Instructions:</strong> If the student is eligible for vehicle fee, check the eligibility box and then choose the appropriate vehicle and location. The rent amount (per month) will be autoâ€‘displayed based on your selection. Next, choose your fee option. For a fixed fee, enter the custom amount; for calculation by months, select the months (using the checkboxes) and the amount will be computed as (rent per month Ã— number of months). The last update details are shown below.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Vehicle Fee</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Firebase and Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      // Firebase configuration â€“ replace with your provided config
      const firebaseConfig = {
        apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiNItnejUsjj2DhA",
        authDomain: "squadvertex2007.firebaseapp.com",
        projectId: "squadvertex2007",
        storageBucket: "squadvertex2007.appspot.com",
        messagingSenderId: "168905083514",
        appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let systemSettings = {};

      // Load system settings (including universalFeesChart, vehicleFeesChart, masterPassword, etc.)
      function loadSystemSettings() {
        db.collection("001-school").doc("systemSettings").get()
          .then(doc => {
            if (doc.exists) {
              systemSettings = doc.data();
              // Populate vehicle dropdown options from systemSettings.vehicleFeesChart
              if(systemSettings.vehicleFeesChart && Array.isArray(systemSettings.vehicleFeesChart)) {
                const vehicleSelect = document.getElementById("vehicle-select");
                vehicleSelect.innerHTML = '<option value="">Select Vehicle</option>';
                const uniqueVehicles = {};
                systemSettings.vehicleFeesChart.forEach(item => {
                  uniqueVehicles[item.vehicleName.trim()] = item;
                });
                for (const vehicle in uniqueVehicles) {
                  const option = document.createElement("option");
                  option.value = vehicle;
                  option.textContent = vehicle;
                  vehicleSelect.appendChild(option);
                }
              }
            } else {
              console.error("System settings not found!");
            }
          })
          .catch(err => console.error("Error loading system settings:", err));
      }

      // Load all vehicle fee records as a map (studentId => record)
      function loadAllVehicleRecords() {
        return db.collection("001-school").doc("vehicleTransactions").collection("records").get()
          .then(snapshot => {
            const vehicleMap = {};
            snapshot.forEach(doc => {
              vehicleMap[doc.id] = doc.data();
            });
            return vehicleMap;
          })
          .catch(err => {
            console.error("Error loading vehicle records:", err);
            return {};
          });
      }

      // Load students from "001-school/students/list" and mark those with vehicle eligibility
      function loadStudents() {
        loadAllVehicleRecords().then(vehicleMap => {
          db.collection("001-school").doc("students").collection("list").get()
            .then(querySnapshot => {
              const tbody = document.querySelector("#students-table tbody");
              tbody.innerHTML = "";
              querySnapshot.forEach(doc => {
                const student = doc.data();
                const studentId = doc.id;
                const srNumber = student.srNumber || "";
                const name = student.studentName || "";
                const fatherName = student.fatherName || "";
                const row = document.createElement("tr");
                row.setAttribute("data-class", student.class || "");
                row.setAttribute("data-stream", student.stream || "");
                let vehicleIcon = "";
                if (vehicleMap[studentId] && vehicleMap[studentId].eligible === "Yes") {
                  vehicleIcon = ' <span class="vehicle-eligible-icon" title="Vehicle Eligible">ðŸš—</span>';
                }
                row.innerHTML = `
                  <td>${srNumber}${vehicleIcon}</td>
                  <td>${name}</td>
                  <td>${fatherName}</td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="openPaymentModal('${studentId}')">Add Payment</button>
                    <button class="btn btn-sm btn-info" onclick="viewDetails('${studentId}')">View Details</button>
                    <button class="btn btn-sm btn-warning" onclick="openDiscountModal('${studentId}')">Give Discount</button>
                    <button class="btn btn-sm btn-success" onclick="openVehicleFeeModal('${studentId}')">Vehicle Fee</button>
                  </td>
                `;
                tbody.appendChild(row);
              });
            })
            .catch(err => console.error("Error loading students:", err));
        });
      }

      // Filtering function for student table
      function applyFilters() {
        const searchFilter = document.getElementById("student-search").value.toLowerCase();
        const classFilter = document.getElementById("class-filter").value;
        const streamFilter = document.getElementById("stream-filter").value;
        const rows = document.querySelectorAll("#students-table tbody tr");
        rows.forEach(row => {
          const sr = row.cells[0].textContent.toLowerCase();
          const name = row.cells[1].textContent.toLowerCase();
          const studentClass = row.getAttribute("data-class");
          const studentStream = row.getAttribute("data-stream");
          if ((sr.includes(searchFilter) || name.includes(searchFilter)) &&
              (classFilter === "" || studentClass === classFilter) &&
              (streamFilter === "" || studentStream === streamFilter)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }
      document.getElementById("student-search").addEventListener("input", applyFilters);
      document.getElementById("class-filter").addEventListener("change", applyFilters);
      document.getElementById("stream-filter").addEventListener("change", applyFilters);

      // Open Payment Modal â€“ set student ID
      function openPaymentModal(studentId) {
        document.getElementById("payment-student-id").value = studentId;
        document.getElementById("payment-form").reset();
        $("#addPaymentModal").modal("show");
      }

      // Handle Payment Form Submission â€“ store payment document in:
      // 001-school/transactions/class{studentClass}/{studentId}/payments
      document.getElementById("payment-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const studentId = document.getElementById("payment-student-id").value;
        const amount = parseFloat(document.getElementById("payment-amount").value);
        const paymentType = document.getElementById("payment-type").value;
        const mode = document.getElementById("payment-mode").value;
        const txnId = document.getElementById("transaction-id").value;
        const remarks = document.getElementById("payment-remarks").value;

        const payment = {
          installment: 0,
          date: new Date().toLocaleDateString(),
          amount: amount,
          paymentType: paymentType,
          mode: mode,
          txnId: txnId,
          remarks: remarks,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("001-school").doc("students").collection("list").doc(studentId).get()
          .then(doc => {
            if (doc.exists) {
              const student = doc.data();
              const studentClass = student.class;
              db.collection("001-school").doc("transactions")
                .collection("class" + studentClass)
                .doc(studentId)
                .collection("payments")
                .add(payment)
                .then(() => {
                  alert("Payment added successfully!");
                  $("#addPaymentModal").modal("hide");
                })
                .catch(err => {
                  console.error("Error saving payment:", err);
                  alert("Error saving payment: " + err.message);
                });
            } else {
              alert("Student record not found!");
            }
          })
          .catch(err => {
            console.error("Error fetching student record:", err);
            alert("Error fetching student record: " + err.message);
          });
      });

      // Open Discount Modal â€“ set student ID
      function openDiscountModal(studentId) {
        document.getElementById("discount-student-id").value = studentId;
        document.getElementById("discount-form").reset();
        $("#giveDiscountModal").modal("show");
      }

      // Handle Discount Form Submission â€“ update student's discount
      document.getElementById("discount-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const studentId = document.getElementById("discount-student-id").value;
        const discountAmount = parseFloat(document.getElementById("discount-amount").value);
        const adminPassword = document.getElementById("admin-password").value;
        if (systemSettings.masterPassword && adminPassword === systemSettings.masterPassword) {
          const studentRef = db.collection("001-school").doc("students").collection("list").doc(studentId);
          studentRef.update({
            discount: firebase.firestore.FieldValue.increment(discountAmount)
          })
          .then(() => {
            alert("Discount applied successfully!");
            $("#giveDiscountModal").modal("hide");
          })
          .catch(err => {
            console.error("Error applying discount:", err);
            alert("Error applying discount: " + err.message);
          });
        } else {
          alert("Incorrect admin password!");
        }
      });

      // Open Vehicle Fee Modal â€“ set student ID and load existing record if available.
      function openVehicleFeeModal(studentId) {
        document.getElementById("vehicle-student-id").value = studentId;
        // Instead of resetting the form, we load existing data (if any) so that the modal stays static.
        db.collection("001-school").doc("vehicleTransactions").collection("records").doc(studentId).get()
          .then(doc => {
            if(doc.exists){
              const data = doc.data();
              // Set eligibility checkbox based on stored value ("Yes" means eligible)
              if(data.eligible === "Yes") {
                document.getElementById("vehicle-eligible-checkbox").checked = true;
                document.getElementById("vehicle-details-section").style.display = "block";
                // Populate vehicle details if available
                if(data.vehicleData) {
                  document.getElementById("vehicle-select").value = data.vehicleData.vehicle || "";
                  document.getElementById("vehicle-location").value = data.vehicleData.location || "";
                  // Update rent field using systemSettings data if possible
                  if(data.vehicleData.vehicle) {
                    const selectedVehicle = data.vehicleData.vehicle;
                    if(systemSettings.vehicleFeesChart && Array.isArray(systemSettings.vehicleFeesChart)) {
                      const matchingEntries = systemSettings.vehicleFeesChart.filter(item => item.vehicleName.trim() === selectedVehicle);
                      if(matchingEntries.length > 0) {
                        document.getElementById("vehicle-rent").value = "â‚¹" + matchingEntries[0].amount;
                      }
                    }
                  }
                  // Set fee option radio buttons and corresponding input/checkboxes
                  if(data.vehicleData.feeOption === "fixed"){
                    document.getElementById("fee-option-fixed").checked = true;
                    document.getElementById("fixed-amount-section").style.display = "block";
                    document.getElementById("months-checkboxes").style.display = "none";
                    document.getElementById("vehicle-fixed-amount").value = data.vehicleData.fixedAmount || "";
                  } else if(data.vehicleData.feeOption === "months"){
                    document.getElementById("fee-option-months").checked = true;
                    document.getElementById("fixed-amount-section").style.display = "none";
                    document.getElementById("months-checkboxes").style.display = "block";
                    // Set the month checkboxes based on stored months array
                    const storedMonths = data.vehicleData.months || [];
                    document.querySelectorAll(".month-checkbox").forEach(cb => {
                      cb.checked = storedMonths.includes(cb.value);
                    });
                  }
                }
              } else {
                document.getElementById("vehicle-eligible-checkbox").checked = false;
                document.getElementById("vehicle-details-section").style.display = "none";
              }
              document.getElementById("vehicle-last-update").value = data.lastUpdated || "";
            } else {
              // No existing record â€“ clear form fields
              document.getElementById("vehicle-fee-form").reset();
              document.getElementById("vehicle-details-section").style.display = "none";
              document.getElementById("vehicle-last-update").value = "";
            }
            $("#vehicleFeeModal").modal("show");
          })
          .catch(err => {
            console.error("Error loading vehicle fee record:", err);
            $("#vehicleFeeModal").modal("show");
          });
      }

      // Show/hide vehicle details based on eligibility checkbox
      document.getElementById("vehicle-eligible-checkbox").addEventListener("change", function() {
        if (this.checked) {
          document.getElementById("vehicle-details-section").style.display = "block";
        } else {
          document.getElementById("vehicle-details-section").style.display = "none";
        }
      });

      // When vehicle is selected, populate location and rent
      document.getElementById("vehicle-select").addEventListener("change", function() {
        const selectedVehicle = this.value;
        const locationSelect = document.getElementById("vehicle-location");
        locationSelect.innerHTML = '<option value="">Select Location</option>';
        let rentAmount = "";
        if(systemSettings.vehicleFeesChart && Array.isArray(systemSettings.vehicleFeesChart)) {
          const matchingEntries = systemSettings.vehicleFeesChart.filter(item => item.vehicleName.trim() === selectedVehicle);
          matchingEntries.forEach(item => {
            const option = document.createElement("option");
            option.value = item.destination;
            option.textContent = item.destination;
            locationSelect.appendChild(option);
          });
          if(matchingEntries.length === 1) {
            rentAmount = matchingEntries[0].amount;
            document.getElementById("vehicle-rent").value = "â‚¹" + rentAmount;
          }
        }
      });

      // When location is selected, update rent if necessary
      document.getElementById("vehicle-location").addEventListener("change", function() {
        const selectedVehicle = document.getElementById("vehicle-select").value;
        const selectedLocation = this.value;
        if(systemSettings.vehicleFeesChart && Array.isArray(systemSettings.vehicleFeesChart)) {
          const match = systemSettings.vehicleFeesChart.find(item => item.vehicleName.trim() === selectedVehicle && item.destination === selectedLocation);
          if(match) {
            document.getElementById("vehicle-rent").value = "â‚¹" + match.amount;
          }
        }
      });

      // Toggle fee option sections in Vehicle Fee Modal
      document.getElementById("fee-option-fixed").addEventListener("change", function(){
        if(this.checked){
          document.getElementById("fixed-amount-section").style.display = "block";
          document.getElementById("months-checkboxes").style.display = "none";
        }
      });
      document.getElementById("fee-option-months").addEventListener("change", function(){
        if(this.checked){
          document.getElementById("fixed-amount-section").style.display = "none";
          document.getElementById("months-checkboxes").style.display = "block";
        }
      });

      // Handle Vehicle Fee Form Submission â€“ store record in "001-school/vehicleTransactions/records/{studentId}"
      document.getElementById("vehicle-fee-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const studentId = document.getElementById("vehicle-student-id").value;
        let eligible = "No";
        if(document.getElementById("vehicle-eligible-checkbox").checked){
          eligible = "Yes";
        }
        let vehicleData = {};
        if (eligible === "Yes") {
          const vehicle = document.getElementById("vehicle-select").value;
          const location = document.getElementById("vehicle-location").value;
          const rent = document.getElementById("vehicle-rent").value.replace("â‚¹", "");
          const feeOption = document.querySelector('input[name="vehicle-fee-option"]:checked').value;
          vehicleData = { vehicle, location, feeOption };
          if(feeOption === "fixed"){
            const fixedAmount = parseFloat(document.getElementById("vehicle-fixed-amount").value) || 0;
            vehicleData.fixedAmount = fixedAmount;
          } else if(feeOption === "months"){
            const months = [];
            document.querySelectorAll(".month-checkbox").forEach(cb => {
              if(cb.checked){
                months.push(cb.value);
              }
            });
            vehicleData.months = months;
            vehicleData.rent = parseFloat(rent);
          }
        }
        const record = {
          eligible,
          vehicleData,
          lastUpdated: new Date().toLocaleString(),
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        // Vehicle fee data is stored in: 001-school/vehicleTransactions/records/{studentId}
        db.collection("001-school").doc("vehicleTransactions")
          .collection("records").doc(studentId).set(record, { merge: true })
          .then(() => {
            alert("Vehicle fee record saved successfully!");
            loadStudents();
            $("#vehicleFeeModal").modal("hide");
          })
          .catch(err => {
            console.error("Error saving vehicle fee record:", err);
            alert("Error saving vehicle fee record: " + err.message);
          });
      });

      // View Details â€“ fetch student details, payments, and vehicle fee record; then calculate final fees
      function viewDetails(studentId) {
        db.collection("001-school").doc("students").collection("list").doc(studentId).get()
          .then(doc => {
            if (doc.exists) {
              const student = doc.data();
              // Populate basic student info
              document.getElementById("detail-sr").innerText = student.srNumber || "";
              document.getElementById("detail-name").innerText = student.studentName || "";
              document.getElementById("detail-father").innerText = student.fatherName || "";
              document.getElementById("detail-class").innerText = student.class || "";
              document.getElementById("detail-stream").innerText = student.stream || "";
              // Compute school fee from universalFeesChart
              let baseFee = 0;
              if (systemSettings.universalFeesChart && Array.isArray(systemSettings.universalFeesChart)) {
                systemSettings.universalFeesChart.forEach(feeRow => {
                  if (feeRow.class === student.class && feeRow.stream === student.stream) {
                    baseFee = feeRow.baseFee;
                  }
                });
              }
              const discount = student.discount || 0;
              const finalSchoolFee = baseFee - discount;
              // Load payment records and separate by type
              db.collection("001-school").doc("transactions")
                .collection("class" + student.class)
                .doc(studentId)
                .collection("payments")
                .orderBy("timestamp", "asc")
                .get()
                .then(querySnapshot => {
                  let schoolPaid = 0, vehiclePaid = 0;
                  const transTable = document.getElementById("student-transactions");
                  transTable.innerHTML = "";
                  querySnapshot.forEach((paymentDoc, index) => {
                    const tx = paymentDoc.data();
                    let txDate = tx.date;
                    if (tx.timestamp && tx.timestamp.toDate) {
                      txDate = tx.timestamp.toDate().toLocaleDateString();
                    }
                    if(tx.paymentType === "school fee"){
                      schoolPaid += tx.amount;
                    } else if(tx.paymentType === "vehicle fee"){
                      vehiclePaid += tx.amount;
                    }
                    const row = document.createElement("tr");
                    row.innerHTML = `
                      <td>${txDate}</td>
                      <td>â‚¹${tx.amount || 0}</td>
                      <td>${tx.mode || ""}</td>
                      <td>${tx.txnId || ""}</td>
                      <td>${tx.paymentType || "school fee"}</td>
                    `;
                    transTable.appendChild(row);
                  });
                  // Now load vehicle fee record and compute vehicle fee total
                  db.collection("001-school").doc("vehicleTransactions")
                    .collection("records").doc(studentId).get()
                    .then(vehicleDoc => {
                      let vehicleFeeTotal = 0;
                      let vRec = null;
                      if (vehicleDoc.exists) {
                        vRec = vehicleDoc.data();
                        if(vRec.eligible === "Yes" && vRec.vehicleData) {
                          if(vRec.vehicleData.feeOption === "fixed"){
                            vehicleFeeTotal = vRec.vehicleData.fixedAmount || 0;
                          } else if(vRec.vehicleData.feeOption === "months"){
                            const rent = parseFloat(vRec.vehicleData.rent) || 0;
                            const monthsCount = vRec.vehicleData.months ? vRec.vehicleData.months.length : 0;
                            vehicleFeeTotal = rent * monthsCount;
                          }
                        }
                      }
                      const totalFee = finalSchoolFee + vehicleFeeTotal;
                      const schoolPending = finalSchoolFee - schoolPaid;
                      const vehiclePending = vehicleFeeTotal - vehiclePaid;
                      // Populate modal details
                      document.getElementById("detail-base-fee").innerText = "â‚¹" + baseFee;
                      document.getElementById("detail-discount").innerText = "â‚¹" + discount;
                      document.getElementById("detail-final-school").innerText = "â‚¹" + finalSchoolFee;
                      document.getElementById("detail-vehicle-fee").innerText = "â‚¹" + vehicleFeeTotal;
                      document.getElementById("detail-total-fee").innerText = "â‚¹" + totalFee;
                      document.getElementById("detail-school-paid").innerText = "â‚¹" + schoolPaid;
                      document.getElementById("detail-vehicle-paid").innerText = "â‚¹" + vehiclePaid;
                      document.getElementById("detail-school-pending").innerText = "â‚¹" + schoolPending;
                      document.getElementById("detail-vehicle-pending").innerText = "â‚¹" + vehiclePending;
                      // Universal Fee Chart section
                      document.getElementById("ufc-class").innerText = student.class || "";
                      document.getElementById("ufc-stream").innerText = student.stream || "";
                      document.getElementById("ufc-fee").innerText = baseFee;
                      if(vRec && vRec.eligible === "Yes" && vRec.vehicleData){
                        document.getElementById("ufc-vehicle-fee").innerText = "â‚¹" + vehicleFeeTotal;
                      } else {
                        document.getElementById("ufc-vehicle-fee").innerText = "N/A";
                      }
                      document.getElementById("ufc-discount").innerText = discount;
                      $("#detailsModal").modal("show");
                    })
                    .catch(err => {
                      console.error("Error loading vehicle fee record:", err);
                      alert("Error loading vehicle fee record: " + err.message);
                    });
                })
                .catch(err => {
                  console.error("Error loading payments:", err);
                  alert("Error loading payments: " + err.message);
                });
            } else {
              console.error("Student not found:", studentId);
            }
          })
          .catch(err => {
            console.error("Error loading student details:", err);
            alert("Error loading student details: " + err.message);
          });
      }

      // Utility: Generate student document ID using SR number (padded to 5 digits)
      function generateStudentDocId(srNumber) {
        return "student" + srNumber.toString().padStart(5, "0");
      }

      // Initialize page: load system settings then students
      window.addEventListener("DOMContentLoaded", function() {
        loadSystemSettings();
        loadStudents();
      });
    </script>
  </body>
</html>