<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Template Selector — SquadVertex</title>

  <!-- COMPAT SDKs (required) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7dd3fc;--muted:#94a3b8}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#061223 0%, #071425 100%)}
    .wrap{max-width:760px;margin:40px auto;padding:20px}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 20px;color:var(--muted)}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:8px;background:linear-gradient(90deg,#0ea5a4,#60a5fa);display:flex;align-items:center;justify-content:center;color:#021; font-weight:700}
    button.btn{background:var(--accent);border:0;color:#022;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px;margin-top:18px}
    @media(min-width:700px){ .grid{grid-template-columns:repeat(3,1fr)} }
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px;min-height:240px}
    .card img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .meta .name{font-weight:700}
    .actions{display:flex;gap:8px}
    .selectedBadge{background:#10b981;color:#022;padding:6px;border-radius:8px;font-weight:700}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .debug{font-family:monospace;background:#031426;padding:10px;border-radius:8px;color:#9be7ff;margin-top:14px;white-space:pre-wrap;font-size:12px}
    .confirm-row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Choose Your Template</h1>
        <p class="lead">Pick one template. This action writes to Firestore under <code>users/&lt;UID&gt;/profile_template/selection</code>.</p>
      </div>

      <div class="user" id="userBlock">
        <div class="avatar" id="avatar">SV</div>
        <div>
          <div id="who">Not signed in</div>
          <div style="font-size:12px;color:var(--muted)"> <span id="uidShort"></span> </div>
        </div>
        <div style="margin-left:12px">
          <button id="signBtn" class="btn">Sign in (Google)</button>
        </div>
      </div>
    </div>

    <!-- Templates -->
    <div id="grid" class="grid" aria-live="polite">
      <!-- cards injected by JS, static fallback below -->
      <noscript>
        <div style="color:#f88;padding:12px;border-radius:8px;background:#2b0b0b">JavaScript is required to select and save templates.</div>
      </noscript>
    </div>

    <div class="status" id="status">Status: idle</div>

    <div id="debug" class="debug" aria-live="polite" style="display:none"></div>
  </div>

  <script>
  /* Minimal single-file selector
     - Uses compat SDKs (head includes them)
     - Saves to Firestore at users/{uid}/profile_template/selection
     - No anonymous auth
     - Try popup; fallback to redirect
  */

  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
  };

  // ====== UI Refs ======
  const signBtn = document.getElementById('signBtn');
  const grid = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const debug = document.getElementById('debug');
  const avatar = document.getElementById('avatar');
  const who = document.getElementById('who');
  const uidShort = document.getElementById('uidShort');

  // ====== TEMPLATES ======
  const T = {
    templateA: { id:'templateA', name:'Soft Pink', img:'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=800&q=60' },
    templateB: { id:'templateB', name:'Dark Minimal', img:'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=800&q=60' },
    templateC: { id:'templateC', name:'Nature Green', img:'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=800&q=60' },
  };

  // ====== state ======
  let firebaseReady = false;
  let db = null;
  let auth = null;
  let currentUser = null;
  let currentSelection = null;

  // ====== utilities ======
  function dlog(...args){ debug.style.display='block'; debug.textContent = new Date().toLocaleTimeString() + ' › ' + args.map(a=> (typeof a==='object'?JSON.stringify(a):String(a))).join(' ') + '\n' + debug.textContent; }
  function setStatus(s){ statusEl.textContent = 'Status: ' + s; }
  function safeInit(){
    try {
      if (!window.firebase) {
        dlog('window.firebase missing — include compat SDKs in head');
        setStatus('Firebase SDK missing');
        return false;
      }
      if (!firebase.apps || firebase.apps.length===0) {
        firebase.initializeApp(firebaseConfig);
        dlog('firebase.initializeApp()');
      } else dlog('firebase already inited');
      if (!firebase.auth || !firebase.firestore) {
        dlog('compat modules missing (auth/firestore)', 'error');
        setStatus('Firebase SDK mismatch');
        return false;
      }
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseReady = true;
      dlog('Firebase ready (auth + firestore)');
      return true;
    } catch(e){
      dlog('init error', e.message || e);
      setStatus('Firebase init error');
      return false;
    }
  }

  // Render cards
  function renderCards(){
    grid.innerHTML = '';
    Object.values(T).forEach(t=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.template = t.id;
      card.innerHTML = `
        <div class="meta"><div class="name">${t.name}</div><div>${currentSelection===t.id?'<span class="selectedBadge">Selected</span>':''}</div></div>
        <img src="${t.img}" alt="${t.name}">
        <div style="flex:1"></div>
        <div class="confirm-row">
          <button class="ghost btn-preview">Preview</button>
          <button class="ghost btn-copy">Copy Link</button>
          <button class="btn btn-use" ${currentSelection===t.id? 'disabled' : ''}>${currentSelection===t.id? 'Current' : 'Use This Template'}</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  // Delegated clicks
  function attachDelegation(){
    grid.addEventListener('click', async (ev)=>{
      const preview = ev.target.closest('.btn-preview');
      const copy = ev.target.closest('.btn-copy');
      const use = ev.target.closest('.btn-use');
      const card = ev.target.closest('.card');
      if (!card) return;
      const tpl = card.dataset.template;
      if (preview){ window.open('about:blank','_blank').location = 'https://squadvertex2007.web.app/preview/' + (tpl.slice(-1)); return; }
      if (copy){ navigator.clipboard?.writeText(location.origin + '/preview/' + tpl).then(()=> { setStatus('Preview link copied'); }).catch(()=>setStatus('Copy failed')); return; }
      if (use){
        if (!currentUser){ setStatus('Sign in required'); return; }
        if (currentSelection === tpl){ setStatus('Already selected'); return; }
        // quick confirm
        if (!confirm('Use "' + T[tpl].name + '"? This will be saved and cannot be undone here.')) return;
        await saveSelection(tpl);
      }
    });
  }

  // Save selection to Firestore
  async function saveSelection(tplId){
    if (!firebaseReady || !db || !currentUser) { setStatus('Not ready to save'); return; }
    setStatus('Saving selection...');
    dlog('Saving', tplId);
    const ref = db.collection('users').doc(currentUser.uid).collection('profile_template').doc('selection');
    const payload = {
      template_id: tplId,
      selected_at: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      await ref.set(payload, { merge:true });
      currentSelection = tplId;
      renderCards();
      setStatus('Saved: ' + tplId);
      dlog('Save OK', payload);
    } catch (err) {
      console.error(err);
      dlog('Save error: ' + (err.message||err));
      if (err && err.code === 'permission-denied') {
        setStatus('Permission denied — check Firestore rules');
      } else {
        setStatus('Save failed');
      }
    }
  }

  // load selection
  async function loadSelection(){
    if (!firebaseReady || !db || !currentUser) return;
    setStatus('Loading selection...');
    dlog('Fetching selection for', currentUser.uid);
    try {
      const ref = db.collection('users').doc(currentUser.uid).collection('profile_template').doc('selection');
      const snap = await ref.get();
      if (snap.exists){
        currentSelection = snap.data().template_id;
        setStatus('Loaded selection: ' + currentSelection);
        dlog('Loaded doc', snap.data());
      } else {
        currentSelection = null;
        setStatus('No selection yet');
        dlog('No selection doc');
      }
      renderCards();
    } catch (err){
      dlog('Load error: ' + (err.message||err));
      if (err && err.code === 'permission-denied') setStatus('Permission denied — check rules');
      else setStatus('Load failed');
      renderCards();
    }
  }

  // auth handling
  async function initAuth(){
    if (!safeInit()) return;
    attachDelegation();
    renderCards();
    setStatus('Ready');

    auth.onAuthStateChanged(async (u)=>{
      if (u){
        currentUser = u;
        who.textContent = u.displayName || u.email || ('User-'+u.uid.slice(0,6));
        uidShort.textContent = u.uid ? u.uid.slice(0,8) : '';
        avatar.textContent = (u.displayName ? u.displayName[0].toUpperCase() : 'SV');
        dlog('Auth: signed in', u.uid);
        await loadSelection();
      } else {
        currentUser = null;
        who.textContent = 'Not signed in';
        uidShort.textContent = '';
        avatar.textContent = 'SV';
        dlog('Auth: signed out');
        renderCards();
      }
    });

    signBtn.addEventListener('click', async ()=>{
      if (!firebaseReady) { setStatus('Firebase not ready'); return; }
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        setStatus('Signing in...');
      } catch (err) {
        dlog('Popup failed: ' + (err.message||err),'warn');
        // fallback to redirect
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithRedirect(provider);
          setStatus('Redirecting for sign-in...');
        } catch (e){
          dlog('Redirect failed: ' + (e.message||e));
          setStatus('Sign-in failed');
        }
      }
    });
  }

  // run
  initAuth();

  // Expose some things for quick debugging in console (optional)
  window.__SVX = { T, saveSelection, loadSelection, db };

  </script>
</body>