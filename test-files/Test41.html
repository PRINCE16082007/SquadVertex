<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SquadVertex — Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css ">
  <style>
    /* THEME: yellow / orange / black (based on your earlier header) */
    :root{
      --bg: #0b0a0b;             /* deep black background */
      --panel: #111218;          /* panels/cards */
      --muted: #bdb6a9;
      --accent-yellow: #fab84f;  /* main yellow */
      --accent-orange: #e08b2f;  /* secondary orange */
      --accent-strong: #ffd66b;
      --text: #f5f2ea;
      --border: rgba(255,255,255,0.04);
      --hover: rgba(255, 200, 100, 0.06);
      --card-shadow: rgba(0,0,0,0.6);
    }

    html,body{ height:100%; margin:0; padding:0; font-family: 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }

    /* Star canvas sits behind everything */
    canvas#starfield {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      display:block;
      background: linear-gradient(180deg, #07060a 0%, #0b0a0f 60%, #0f0e12 100%);
    }

    /* faint nebula layer for depth */
    .nebula {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background-image: radial-gradient(1200px 600px at 10% 20%, rgba(250,184,79,0.04), transparent),
                        radial-gradient(1000px 500px at 90% 80%, rgba(224,139,47,0.03), transparent);
    }

    /* HEADER (copied/adjusted from your previous header style but tuned) */
    .top-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:80px;
      padding:0 20px;
      box-sizing:border-box;
      position:sticky;
      top:0;
      z-index:1000;
      background: linear-gradient(180deg, rgba(13,12,12,0.95), rgba(18,16,12,0.88));
      border-bottom: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(8px);
      /* crucial: allow dropdowns outside header */
      overflow: visible;
    }

    .logo-title {
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:800;
      font-size:1.35rem;
      color:var(--text);
      white-space:nowrap;
    }
    .logo-title img { height:46px; filter: drop-shadow(0 0 8px rgba(250,184,79,0.28)); border-radius:8px; }

    .nav-buttons {
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
    }

    .nav-btn, .profile-btn, .create-btn {
      background:none;
      border:0;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      color:var(--text);
      font-weight:600;
      transition:all .18s ease;
      font-family: 'Poppins', sans-serif;
    }
    .nav-btn:hover, .profile-btn:hover { background: var(--hover); color:var(--accent-strong); }

    /* Create Post button style — bright yellow/orange */
    .create-btn {
      background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange));
      color:#111;
      box-shadow: 0 6px 18px rgba(250,184,79,0.12);
      border: 1px solid rgba(255,255,255,0.06);
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
    }
    .create-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(224,139,47,0.14); }

    .hamburger {
      display:none;
      background:none; border:0; color:var(--text);
      font-size:1.2rem; padding:8px; cursor:pointer;
    }

    .more-options { position:relative; }
    .dropdown-content {
      display:none;
      position:absolute;
      right:0;
      top:56px;
      min-width:180px;
      background: linear-gradient(180deg, rgba(18,16,12,0.98), rgba(22,18,12,0.96));
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      z-index:1200;
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .dropdown-content a {
      display:block;
      padding:10px 12px;
      text-decoration:none;
      color:var(--text);
      font-weight:600;
      border-bottom:1px solid rgba(255,255,255,0.02);
    }
    .dropdown-content a:hover { background: rgba(250,184,79,0.06); color:var(--accent-strong); }

    .profile-menu { right:24px; display:none; position:absolute; top:56px; min-width:160px; z-index:1200; }

    /* container / cards */
    .container {
      max-width:900px; margin: 2rem auto; padding: 0 1.5rem; position:relative; z-index:2;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-radius:10px;
      padding:1.5rem;
      margin-bottom:1.25rem;
      border:1px solid var(--border);
      box-shadow: 0 8px 30px var(--card-shadow);
    }
    h2 { margin:0; color:var(--accent-strong); }

    /* small adjustments for tags/buttons */
    .btn-primary { background:transparent; color:var(--accent-strong); border-radius:8px; padding:8px 12px; border:1px solid rgba(255,255,255,0.02); }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--muted); padding:8px 10px; border-radius:8px; }
    .link-like { background:transparent; color:var(--accent-strong); border:0; cursor:pointer; }

    .small { font-size:0.9rem; color:var(--muted); }
    .muted { color:var(--muted); }
    .avatar { width:2rem; height:2rem; border-radius:50%; background:var(--accent-yellow); color:#111; display:flex; align-items:center; justify-content:center; font-weight:700; }

    /* Create post modal */
    .modal-backdrop {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000;
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.7));
    }
    .modal {
      width:min(720px, 94%); background:var(--panel); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    .modal h3 { margin:0 0 10px 0; color:var(--accent-strong); }
    .modal .row { gap:10px; }

    form input, form textarea {
      width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text);
      box-sizing:border-box; font-family:inherit; font-size:0.95rem;
    }
    .modal .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    /* responsive */
    @media (max-width: 780px) {
      .hamburger { display:block; }
      .nav-buttons { display:none; position:absolute; top:80px; right:0; background:rgba(12,12,12,0.98); flex-direction:column; padding:12px; gap:10px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.6); width:90%; }
      .nav-buttons.show { display:flex; }
    }
  </style>
</head>
<body>
  <!-- starfield canvas and subtle nebula -->
  <canvas id="starfield" aria-hidden="true"></canvas>
  <div class="nebula" aria-hidden="true"></div>

  <!-- Header (converted to your previous look) -->
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="hamburger" id="hamburgerBtn" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
      <div class="logo-title">
        <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="Logo">
        <div style="line-height:1">SquadVertex</div>
      </div>
    </div>

    <div id="navButtons" class="nav-buttons">
      <button class="nav-btn" onclick="location.href='index.html'">Home</button>
      <button class="nav-btn" onclick="location.href='about_us.html'">Team Galaxy</button>

      <div class="more-options" id="moreOptions" style="position:relative">
        <button class="nav-btn" id="moreBtn">More <span style="opacity:.8">▾</span></button>
        <div class="dropdown-content" id="moreDropdown">
          <a href="galaxy_blogs.html">Blog</a>
          <a href="galaxy_studio.html">Galaxy Design</a>
          <a href="galaxy_portfolio.html">Portfolio</a>
        </div>
      </div>

      <!-- Create Post -->
      <button id="createPostBtn" class="create-btn" title="Create a new post"><i class="fa-solid fa-plus"></i> Create Post</button>

      <!-- profile button -->
      <button id="profileBtn" class="profile-btn" title="Profile"><i class="fa-solid fa-user"></i></button>
      <div id="profileMenu" class="dropdown-content profile-menu" style="right:0;">
        <a href="#" id="profileLink">Profile</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>

    <div id="authArea">
      <button id="signInBtn" class="btn-primary">Sign in</button>
    </div>
  </div>

  <div class="container">
    <div id="feedView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Latest Posts</h2>
            <div class="small muted">Sorted by publish time — newest first</div>
          </div>
          <div><button id="refreshBtn" class="btn-ghost"><i class="fas fa-sync-alt"></i> Refresh</button></div>
        </div>
      </div>

      <div id="postsList"></div>
      <div class="center"><button id="loadMoreBtn" class="btn-ghost">Load more</button></div>
    </div>

    <div id="postView" style="display:none">
      <div style="margin-bottom:1rem;"><button id="backToFeed" class="link-like"><i class="fas fa-arrow-left"></i> Back to feed</button></div>
      <div id="postContainer"></div>

      <div class="card" style="margin-top:1rem">
        <h3 style="margin:0 0 0.5rem 0">Comments</h3>
        <div id="commentsList" style="max-height:420px;overflow:auto;margin-bottom:0.5rem"></div>

        <div id="commentFormWrap">
          <div class="small muted">Add a comment</div>
          <textarea id="commentInput" placeholder="Say something..."></textarea>
          <div style="margin-top:0.5rem;display:flex;gap:0.5rem">
            <button id="submitComment" class="btn-primary">Post comment</button>
            <button id="clearComment" class="btn-ghost">Clear</button>
            <div id="commentStatus" class="small muted" style="margin-left:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div id="createModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3>Create a new post</h3>
      <form id="createPostForm">
        <div class="row" style="flex-direction:column">
          <input id="newTitle" placeholder="Title" required />
          <textarea id="newBody" rows="6" placeholder="Write your post..." required></textarea>
          <input id="newTags" placeholder="Tags (comma separated)" />
        </div>
        <div class="actions">
          <button type="button" id="cancelCreate" class="btn-ghost">Cancel</button>
          <button type="submit" id="submitCreate" class="create-btn"><i class="fa-solid fa-paper-plane"></i> Publish</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // ---------- CONFIG (do not change unless needed) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const RECAPTCHA_SITE_KEY = "6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx";

    // ---------- Firebase imports (v11.9.0) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js ';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js ';
    import {
      getFirestore, collection, query, orderBy, limit, startAfter, getDocs,
      doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
      where, serverTimestamp, runTransaction, increment
    } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js ';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js ';

    // ---------- initialize ----------
    const app = initializeApp(firebaseConfig);
    try {
      initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
        isTokenAutoRefreshEnabled: true
      });
      console.log('App Check initialized');
    } catch(e) { console.warn('App Check problem', e); }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- page-state ----------
    const postsListEl = document.getElementById('postsList');
    const feedView = document.getElementById('feedView');
    const postView = document.getElementById('postView');
    const postContainer = document.getElementById('postContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const backToFeed = document.getElementById('backToFeed');
    const signInBtn = document.getElementById('signInBtn');
    const authArea = document.getElementById('authArea');
    const commentInput = document.getElementById('commentInput');
    const submitComment = document.getElementById('submitComment');
    const commentsList = document.getElementById('commentsList');
    const commentStatus = document.getElementById('commentStatus');
    const clearComment = document.getElementById('clearComment');

    // header elements
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navButtons = document.getElementById('navButtons');
    const moreBtn = document.getElementById('moreBtn');
    const moreOptions = document.getElementById('moreOptions');
    const moreDropdown = document.getElementById('moreDropdown');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const createPostBtn = document.getElementById('createPostBtn');

    // create post modal elements
    const createModalBackdrop = document.getElementById('createModalBackdrop');
    const createForm = document.getElementById('createPostForm');
    const newTitle = document.getElementById('newTitle');
    const newBody = document.getElementById('newBody');
    const newTags = document.getElementById('newTags');
    const cancelCreate = document.getElementById('cancelCreate');
    const submitCreate = document.getElementById('submitCreate');

    let lastVisible = null;
    const PAGE_SIZE = 8;
    let currentUser = null;
    let currentUserProfile = null; // from /users/{uid} if exists
    let currentPostId = null;
    let commentsUnsub = null;
    let isVoting = false;

    // ---------- small helpers ----------
    function timeAgo(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if (diff < 60) return diff + 's';
      if (diff < 3600) return Math.floor(diff/60) + 'm';
      if (diff < 86400) return Math.floor(diff/3600) + 'h';
      return Math.floor(diff/86400) + 'd';
    }
    function snippet(text, n=220){ return text.length>n ? text.slice(0,n)+'…' : text; }
    function escapeHTML(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
    function getInitials(name) { return name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U'; }

    // ---------- header: interactions (hamburger, dropdowns, profile) ----------
    hamburgerBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      navButtons.classList.toggle('show');
    });
    // close mobile nav on outside click
    window.addEventListener('click', (e)=>{
      if (!hamburgerBtn.contains(e.target) && !navButtons.contains(e.target)) navButtons.classList.remove('show');
    });

    // More dropdown toggle
    moreBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      moreDropdown.style.display = moreDropdown.style.display === 'block' ? 'none' : 'block';
    });
    window.addEventListener('click', (e)=> {
      if (!moreOptions.contains(e.target)) moreDropdown.style.display = 'none';
    });

    // profile menu
    profileBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
    });
    window.addEventListener('click', (e)=> {
      if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) profileMenu.style.display = 'none';
    });

    // Create post modal open/close
    createPostBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      // require login to create — but still open modal so user can see form then prompt sign in on submit
      createModalBackdrop.style.display = 'flex';
    });
    cancelCreate.addEventListener('click', ()=> { createModalBackdrop.style.display = 'none'; createForm.reset(); });

    // clicking backdrop closes modal
    createModalBackdrop.addEventListener('click', (e)=>{
      if (e.target === createModalBackdrop) { createModalBackdrop.style.display = 'none'; createForm.reset(); }
    });

    // ---------- Create Post submit handler (writes to Firestore) ----------
    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { alert('Sign in to create posts'); return; }
      const title = (newTitle.value || '').trim();
      const body = (newBody.value || '').trim();
      const tags = (newTags.value || '').split(',').map(t => t.trim()).filter(Boolean);

      if (!title || !body) { alert('Title and body are required'); return; }

      submitCreate.disabled = true;
      submitCreate.textContent = 'Publishing...';

      try {
        await addDoc(collection(db,'posts'), {
          title,
          body,
          tags,
          authorId: currentUser.uid,
          authorName: currentUserProfile?.name || currentUser.email || null,
          createdAt: serverTimestamp(),
          upvotesCount: 0,
          downvotesCount: 0,
          commentsCount: 0
        });
        // success UI
        createModalBackdrop.style.display = 'none';
        createForm.reset();
        // refresh feed to show new post
        lastVisible = null;
        refreshFeed(true);
      } catch(err){
        console.error('create post failed', err);
        alert('Failed to create post');
      } finally {
        submitCreate.disabled = false;
        submitCreate.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Publish';
      }
    });

    // ---------- auth & UI switching ----------
    async function signIn() {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error('Signin error', e); alert('Signin failed'); }
    }
    signInBtn.addEventListener('click', signIn);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        try {
          const uSnap = await getDoc(doc(db,'users', user.uid));
          if (uSnap.exists()) currentUserProfile = uSnap.data();
          else currentUserProfile = { name: user.displayName || null, email: user.email || null };
        } catch(e){ console.warn('users read failed', e); currentUserProfile = { name: user.displayName || null, email: user.email || null }; }

        authArea.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div style="font-weight:700">${currentUserProfile?.name || user.email}</div>
              <div class="muted" style="font-size:0.8rem">${currentUserProfile?.email || user.email}</div>
            </div>
            <button id="signOutBtn" class="btn-ghost">Sign out</button>
          </div>
        `;
        document.getElementById('signOutBtn').addEventListener('click', ()=> signOut(auth));
      } else {
        authArea.innerHTML = `<button id="signInBtn" class="btn-primary">Sign in</button>`;
        document.getElementById('signInBtn').addEventListener('click', signIn);
        currentUserProfile = null;
      }
      if (currentPostId) renderPostView(currentPostId);
      else refreshFeed(true);
    });

    // ---------- starfield canvas: natural/random twinkle ----------
    (function createStarfield(){
      const canvas = document.getElementById('starfield');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth;
      let h = canvas.height = innerHeight;
      const DPR = Math.max(1, devicePixelRatio || 1);
      canvas.width = innerWidth * DPR;
      canvas.height = innerHeight * DPR;
      ctx.scale(DPR, DPR);
      w = innerWidth; h = innerHeight;

      const stars = [];
      const STAR_COUNT = Math.floor((w*h)/7000) + 60; // scale with area
      for (let i=0;i<STAR_COUNT;i++){
        stars.push({
          x: Math.random()*w,
          y: Math.random()*h,
          r: Math.random()*1.4 + 0.3,
          alpha: Math.random()*0.9 + 0.1,
          twinkleSpeed: Math.random()*0.02 + 0.004,
          phase: Math.random()*Math.PI*2
        });
      }

      function draw(){
        ctx.clearRect(0,0,w,h);
        // subtle parallax nebula-ish gradient overlay (canvas draws faint)
        const g = ctx.createLinearGradient(0,0,0,h);
        g.addColorStop(0, 'rgba(255,230,180,0.02)');
        g.addColorStop(1, 'rgba(255,160,60,0.01)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        for (let s of stars){
          // twinkle
          s.phase += s.twinkleSpeed;
          const a = s.alpha * (0.6 + 0.4*Math.sin(s.phase));
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,255,255,${a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      draw();

      // responsive
      window.addEventListener('resize', () => {
        canvas.width = innerWidth * DPR;
        canvas.height = innerHeight * DPR;
        ctx.setTransform(DPR,0,0,DPR,0,0);
      });
    })();

    // ---------- FEED logic (same as before) ----------
    // Show skeleton loaders
    function renderPostSkeletons(count) {
      let skeletonsHtml = '';
      for (let i = 0; i < count; i++) {
        skeletonsHtml += `
          <div class="card post-skeleton">
            <div class="meta" style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <div class="avatar" style="width:2rem;height:2rem;font-size:0.85rem"></div>
              <div style="width:160px;height:12px;background:rgba(255,255,255,0.03);border-radius:6px"></div>
            </div>
            <div style="width:70%;height:18px;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:8px"></div>
            <div style="height:12px;width:90%;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:6px"></div>
            <div style="height:12px;width:60%;background:rgba(255,255,255,0.02);border-radius:6px"></div>
          </div>
        `;
      }
      postsListEl.innerHTML = skeletonsHtml;
    }

    // initial view logic (routing)
    const urlParams = new URLSearchParams(window.location.search);
    const requestedPostId = urlParams.get('postId');

    if (requestedPostId) {
      feedView.style.display = 'none';
      postView.style.display = 'block';
      currentPostId = requestedPostId;
      renderPostView(requestedPostId);
    } else {
      feedView.style.display = 'block';
      postView.style.display = 'none';
      refreshFeed(true);
    }

    async function refreshFeed(reset=false) {
      if (reset) { lastVisible = null; renderPostSkeletons(4); }
      const postsRef = collection(db, 'posts');
      let q;
      if (!lastVisible) q = query(postsRef, orderBy('createdAt','desc'), limit(PAGE_SIZE));
      else q = query(postsRef, orderBy('createdAt','desc'), startAfter(lastVisible), limit(PAGE_SIZE));
      try {
        const snaps = await getDocs(q);
        if (snaps.docs.length === 0) {
          if (!lastVisible) postsListEl.innerHTML = '<div class="card small muted">No posts yet — be the first.</div>';
          loadMoreBtn.style.display = 'none';
          return;
        }
        postsListEl.innerHTML = '';
        for (const d of snaps.docs) renderPostCard(d.id,d.data());
        lastVisible = snaps.docs[snaps.docs.length - 1];
        loadMoreBtn.style.display = snaps.docs.length === PAGE_SIZE ? 'inline-block' : 'none';
      } catch(e){ console.error('feed fetch error', e); postsListEl.innerHTML = '<div class="card small muted">Failed to load posts</div>'; }
    }
    refreshBtn.addEventListener('click', ()=> { lastVisible=null; refreshFeed(true); });
    loadMoreBtn.addEventListener('click', ()=> refreshFeed(false));

    function renderPostCard(postId, data) {
      const el = document.createElement('div');
      el.className = 'card';
      const author = data.authorName || data.authorEmail || 'Unknown';
      const created = data.createdAt ? timeAgo(data.createdAt) : '';
      el.innerHTML = `
        <div class="meta">
          <div class="avatar" style="width:1.5rem;height:1.5rem;font-size:0.7rem">${getInitials(author)}</div>
          <div style="margin-left:8px">${escapeHTML(author)} · <span class="muted">${created}</span></div>
        </div>
        <div class="title" style="margin-top:10px;margin-bottom:6px;color:var(--text)">${escapeHTML(data.title || 'Untitled')}</div>
        <div class="snippet" style="color:var(--muted)">${escapeHTML(snippet(data.body || ''))}</div>
        <div class="tags">${(data.tags || []).map(t => `<span class="tag" style="background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;margin-right:6px;color:var(--muted);font-size:0.8rem">${escapeHTML(t)}</span>`).join('')}</div>
        <div class="actions" style="margin-top:12px">
          <div class="vote">
            <button class="link-like upvote" data-id="${postId}">▲</button>
            <div class="count" id="up_${postId}">${data.upvotesCount||0}</div>
            <button class="link-like downvote" data-id="${postId}">▼</button>
            <div class="count" id="down_${postId}">${data.downvotesCount||0}</div>
          </div>
          <div style="margin-left:auto">
            <button class="btn-ghost commentBtn" data-id="${postId}"><i class="far fa-comment"></i> Comments (${data.commentsCount||0})</button>
            <button class="create-btn viewBtn" data-id="${postId}" style="padding:8px 12px;font-size:0.95rem">View Post</button>
          </div>
        </div>
      `;
      postsListEl.appendChild(el);

      el.querySelector('.viewBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.commentBtn').addEventListener('click', ()=> openPostPage(postId));
      el.querySelector('.upvote').addEventListener('click', ()=> handleVoteClick(postId, 1));
      el.querySelector('.downvote').addEventListener('click', ()=> handleVoteClick(postId, -1));
    }

    function openPostPage(postId) {
      const base = window.location.href.split('?')[0];
      window.location.href = base + '?postId=' + postId;
    }

    // Voting logic (same as before)
    async function handleVoteClick(postId, delta) {
      if (isVoting) return;
      if (!currentUser) { alert('Sign in to vote'); return; }
      const uid = currentUser.uid;
      const voteDocRef = doc(db, 'votes', `${postId}_${uid}`);
      const postRef = doc(db, 'posts', postId);
      isVoting = true;
      const voteButtons = document.querySelectorAll(`.upvote[data-id="${postId}"], .downvote[data-id="${postId}"]`);
      voteButtons.forEach(btn => btn.classList.add('vote-loading'));
      try {
        await runTransaction(db, async (tx) => {
          const voteSnap = await tx.get(voteDocRef);
          const postSnap = await tx.get(postRef);
          if (!postSnap.exists()) throw 'Post not found';
          let up = postSnap.data().upvotesCount || 0;
          let down = postSnap.data().downvotesCount || 0;
          if (!voteSnap.exists()) {
            tx.set(voteDocRef, { postId, userId: uid, vote: delta, createdAt: serverTimestamp() });
            if (delta === 1) up++; else down++;
          } else {
            const prev = voteSnap.data().vote || 0;
            if (prev === delta) {
              tx.delete(voteDocRef);
              if (delta === 1) up = Math.max(0, up-1); else down = Math.max(0, down-1);
            } else {
              tx.update(voteDocRef, { vote: delta, updatedAt: serverTimestamp() });
              if (delta === 1) { up++; down = Math.max(0, down-1); } else { down++; up = Math.max(0, up-1); }
            }
          }
          tx.update(postRef, { upvotesCount: up, downvotesCount: down });
        });
        if (currentPostId === postId) renderPostView(postId);
        else refreshFeed(true);
      } catch(e){ console.error('vote failed', e); alert('Vote failed'); }
      finally {
        isVoting = false;
        const vb = document.querySelectorAll(`.upvote[data-id="${postId}"], .downvote[data-id="${postId}"]`);
        vb.forEach(btn => btn.classList.remove('vote-loading'));
      }
    }

    // ---------- POST VIEW (single post + comments) ----------
    backToFeed.addEventListener('click', ()=> { const base = window.location.href.split('?')[0]; window.location.href = base; });

    async function renderPostView(postId) {
      currentPostId = postId;
      // skeleton
      postContainer.innerHTML = '<div class="card">Loading...</div>';
      try {
        const postRef = doc(db,'posts',postId);
        const pSnap = await getDoc(postRef);
        if (!pSnap.exists()) { postContainer.innerHTML = '<div class="card small muted">Post not found</div>'; return; }
        const data = pSnap.data();
        const author = data.authorName || data.authorEmail || 'Unknown';
        const created = data.createdAt ? timeAgo(data.createdAt) : '';
        postContainer.innerHTML = `
          <div class="card">
            <div class="meta">
              <div class="avatar">${getInitials(author)}</div>
              <div style="margin-left:8px">${escapeHTML(author)} · <span class="muted">${created}</span></div>
            </div>
            <div class="title" style="margin-top:10px">${escapeHTML(data.title || 'Untitled')}</div>
            <div style="margin-top:0.75rem; line-height:1.8">${escapeHTML(data.body || '').replace(/\n/g,'<br>')}</div>
            <div class="tags">${(data.tags||[]).map(t=>`<span class="tag" style="background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;margin-right:6px;color:var(--muted);font-size:0.8rem">${escapeHTML(t)}</span>`).join('')}</div>
            <div style="margin-top:12px" class="actions">
              <div class="vote">
                <button id="pvUp" class="link-like">▲</button>
                <div id="pvUpCount" class="count">${data.upvotesCount||0}</div>
                <button id="pvDown" class="link-like">▼</button>
                <div id="pvDownCount" class="count">${data.downvotesCount||0}</div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('pvUp').addEventListener('click', ()=> handleVoteClick(postId,1));
        document.getElementById('pvDown').addEventListener('click', ()=> handleVoteClick(postId,-1));

        if (currentUser) {
          try {
            const voteSnap = await getDoc(doc(db,'votes', `${postId}_${currentUser.uid}`));
            const prev = voteSnap.exists() ? (voteSnap.data().vote||0) : 0;
            highlightVoteButtons(prev);
          } catch(e){ console.warn('vote read failed', e); }
        } else highlightVoteButtons(0);

        // comments subscription
        const commentsRef = collection(db, 'posts', postId, 'comments');
        const commentsQuery = query(commentsRef, orderBy('createdAt','asc'));
        if (commentsUnsub) commentsUnsub(); // cleanup previous
        commentsUnsub = onSnapshot(commentsQuery, (snap) => {
          commentsList.innerHTML = '';
          if (snap.empty) {
            commentsList.innerHTML = '<div class="small muted" style="padding: 1rem; text-align: center;">No comments yet</div>';
            return;
          }
          snap.forEach(docSnap => {
            const c = docSnap.data();
            const cEl = document.createElement('div');
            cEl.className = 'comment';
            cEl.innerHTML = `
              <div class="meta" style="display:flex;gap:8px;align-items:center">
                <div class="avatar" style="width:1.25rem;height:1.25rem;font-size:0.6rem">${getInitials(c.authorName||'Anonymous')}</div>
                <div>${escapeHTML(c.authorName||'Anonymous')} · <span class="muted">${c.createdAt ? timeAgo(c.createdAt) : ''}</span></div>
              </div>
              <div style="margin-top:0.5rem">${escapeHTML(c.body||'').replace(/\n/g, '<br>')}</div>`;
            commentsList.appendChild(cEl);
          });
        }, (error) => {
          console.error('Comments subscription error:', error);
          commentsList.innerHTML = '<div class="small muted" style="padding: 1rem;">Failed to load comments</div>';
        });

      } catch(e){ console.error('render post error', e); postContainer.innerHTML = '<div class="card small muted">Failed to load post</div>'; }
    }

    function highlightVoteButtons(v) {
      const up = document.getElementById('pvUp');
      const down = document.getElementById('pvDown');
      if (!up || !down) return;
      up.style.color = v === 1 ? 'var(--accent-strong)' : 'var(--muted)';
      down.style.color = v === -1 ? 'var(--accent-strong)' : 'var(--muted)';
      up.style.fontWeight = v === 1 ? '900' : '600';
      down.style.fontWeight = v === -1 ? '900' : '600';
    }

    // ---------- comments: add ----------
    clearComment.addEventListener('click', ()=> commentInput.value='');

    submitComment.addEventListener('click', async () => {
      if (!currentUser) { alert('Sign in to comment'); return; }
      const text = (commentInput.value || '').trim();
      if (!text) { commentStatus.textContent = 'Type your comment'; return; }
      commentStatus.textContent = 'Posting...';
      submitComment.disabled = true;
      try {
        const commentsRef = collection(db, 'posts', currentPostId, 'comments');
        await addDoc(commentsRef, {
          body: text,
          authorId: currentUser.uid,
          authorName: currentUserProfile?.name || currentUser.email || null,
          createdAt: serverTimestamp(),
          upvotesCount: 0
        });
        await updateDoc(doc(db,'posts',currentPostId), { commentsCount: increment(1) });
        commentInput.value = ''; commentStatus.textContent = 'Posted';
      } catch(e) {
        console.error('post comment failed', e);
        commentStatus.textContent = 'Failed';
      } finally {
        submitComment.disabled = false;
        setTimeout(()=>commentStatus.textContent='',1200);
      }
    });

    // ---------- initial render for feed view ----------
    function showFeed() { feedView.style.display='block'; postView.style.display='none'; }
    function showPost() { feedView.style.display='none'; postView.style.display='block'; }
    if (currentPostId) showPost(); else showFeed();

    // Expose refreshFeed globally in case other widgets call it
    window.refreshFeed = refreshFeed;

    // END of module
  </script>
</body>
</html>