<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Picture Upload + Editor (Overwrite)</title>
  <style>
    :root{--bg:#111;--card:#191919;--muted:#555;--accent:#6ee7b7}
    html,body{height:100%;}
    body { 
      background: var(--bg); color: #fff; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      display: flex; flex-direction: column; align-items: center; padding: 20px; gap:10px;
    }
    h1{margin:0 0 6px 0;font-weight:600}
    .row{display:flex;gap:8px;align-items:center}
    input, button { margin: 6px; padding: 10px 12px; border-radius:8px; border:1px solid #222; background: #121212; color:#fff }
    button.primary{background:var(--accent); color:#062; border: none}
    #preview {
      width: 180px; height: 180px; margin-top: 8px;
      background: #222; display: flex; align-items: center; justify-content: center;
      border: 2px dashed var(--muted);
      border-radius: 50%;
      overflow: hidden;
      position:relative;
    }
    #preview img { width:100%; height:100%; object-fit:cover }
    .hidden { display: none }
    #authError { color: #ff6b6b }
    /* Editor modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999;
      background:linear-gradient(0deg, rgba(0,0,0,0.6), rgba(0,0,0,0.6));
      padding:20px;
    }
    .modal.show{display:flex}
    .editor-card{background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.6); display:flex; gap:12px; align-items:flex-start}
    .editor-canvas{width:360px; height:360px; background:#000; border-radius:8px; touch-action:none}
    .editor-controls{display:flex; flex-direction:column; gap:8px}
    .controls-row{display:flex; gap:6px}
    .small{padding:8px 10px; font-size:14px}
    .muted{color:var(--muted); font-size:13px}
    .hint{font-size:13px; color:var(--muted)}
    @media (max-width:720px){
      .editor-card{flex-direction:column}
      .editor-canvas{width:300px;height:300px}
    }
  </style>
</head>
<body>
  <h1>Set Profile Picture</h1>
  <div class="row">
    <div id="authError" class="hidden">Please login first!</div>
  </div>

  <input id="fileInput" type="file" accept="image/*" />
  <button id="editBtn" class="hidden">Edit Selected Image</button>
  <button id="uploadBtn" class="hidden primary">Upload New Picture (Overwrite)</button>

  <div id="preview">
    <span>Fetching profile...</span>
  </div>

  <!-- Editor modal -->
  <div id="editorModal" class="modal">
    <div class="editor-card">
      <canvas id="editorCanvas" class="editor-canvas" width="360" height="360"></canvas>
      <div class="editor-controls">
        <div class="controls-row">
          <button id="zoomIn" class="small">Zoom +</button>
          <button id="zoomOut" class="small">Zoom -</button>
          <button id="rotateLeft" class="small">âŸ²</button>
          <button id="rotateRight" class="small">âŸ³</button>
        </div>
        <div class="controls-row">
          <button id="reset" class="small">Reset</button>
          <button id="apply" class="small primary">Apply & Close</button>
          <button id="cancel" class="small">Cancel</button>
        </div>
        <div class="hint">Drag image to reposition. Use mouse wheel / pinch to zoom. Rotate with buttons. When happy, hit Apply.</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK 11.9.0 (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>

  <script>
    // CONFIG - unchanged
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };

    // Your Supabase edge function that handles upload/delete
    const SUPABASE_URL = 'https://dvjihjkyenzkacviywgk.supabase.co';
    const FUNCTION_URL = 'https://dvjihjkyenzkacviywgk.functions.supabase.co/upload-image';

    // DOM
    const fileInput = document.getElementById('fileInput');
    const editBtn = document.getElementById('editBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const preview = document.getElementById('preview');
    const authError = document.getElementById('authError');

    // Editor elems
    const editorModal = document.getElementById('editorModal');
    const editorCanvas = document.getElementById('editorCanvas');
    const ctx = editorCanvas.getContext('2d');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const rotateLeft = document.getElementById('rotateLeft');
    const rotateRight = document.getElementById('rotateRight');
    const resetBtn = document.getElementById('reset');
    const applyBtn = document.getElementById('apply');
    const cancelBtn = document.getElementById('cancel');

    // Init firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Editor state
    let img = null;
    let imgURL = null;
    let pos = {x:0,y:0};
    let dragging = false;
    let startPtr = null;
    let scale = 1;
    let angle = 0;

    // edited image dataURL to upload
    window.__editedImageDataURL = null;

    // Auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        fileInput.classList.remove('hidden');
        editBtn.classList.remove('hidden');
        uploadBtn.classList.remove('hidden');

        // show current profile pic if present
        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${user.uid}.png?v=${Date.now()}`;
        preview.innerHTML = `<img src="${publicUrl}" alt="Profile Picture" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22180%22 height=%22180%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23555%22 stroke-width=%221.5%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/><path d=%22M12 8v4%22/><circle cx=%2212%22 cy=%2216%22 r=%221%22/></svg>';'>`;
      } else {
        authError.classList.remove('hidden');
        preview.innerHTML = '<span>ðŸ”’ Login required</span>';
      }
    });

    // Load file into img for editor
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (f.size > 6 * 1024 * 1024) {
        alert('File too large (max ~6MB for local editing)');
        return;
      }
      if (imgURL) URL.revokeObjectURL(imgURL);
      imgURL = URL.createObjectURL(f);
      img = new Image();
      img.onload = () => {
        scale = Math.min(1, Math.max(0.2, Math.min(editorCanvas.width / img.width, editorCanvas.height / img.height))) * 1.4;
        angle = 0; pos = {x:0,y:0};
        drawEditor();
      };
      img.src = imgURL;
      // optionally auto-open editor after selecting
      editorModal.classList.add('show');
    });

    // Editor controls
    editBtn.addEventListener('click', () => {
      if (!img) return alert('Please select an image first');
      editorModal.classList.add('show');
    });
    zoomIn.addEventListener('click', () => { scale *= 1.12; drawEditor(); });
    zoomOut.addEventListener('click', () => { scale /= 1.12; drawEditor(); });
    rotateLeft.addEventListener('click', () => { angle -= Math.PI/18; drawEditor(); });
    rotateRight.addEventListener('click', () => { angle += Math.PI/18; drawEditor(); });
    resetBtn.addEventListener('click', () => { scale = 1; angle = 0; pos = {x:0,y:0}; drawEditor(); });
    cancelBtn.addEventListener('click', () => { editorModal.classList.remove('show'); });

    applyBtn.addEventListener('click', async () => {
      if (!img) { editorModal.classList.remove('show'); return; }
      const outSize = 360;
      const out = document.createElement('canvas');
      out.width = outSize; out.height = outSize;
      const outCtx = out.getContext('2d');
      outCtx.save();
      outCtx.translate(outSize/2 + pos.x, outSize/2 + pos.y);
      outCtx.rotate(angle);
      outCtx.scale(scale, scale);
      outCtx.drawImage(img, -img.width/2, -img.height/2);
      outCtx.restore();

      // circular mask
      const circ = document.createElement('canvas');
      circ.width = outSize; circ.height = outSize;
      const cctx = circ.getContext('2d');
      cctx.save();
      cctx.beginPath();
      cctx.arc(outSize/2, outSize/2, outSize/2, 0, Math.PI*2);
      cctx.closePath();
      cctx.clip();
      cctx.drawImage(out, 0, 0);
      cctx.restore();

      const dataURL = circ.toDataURL('image/png');

      // show preview
      preview.innerHTML = `<img src="${dataURL}" alt="Profile Picture">`;
      window.__editedImageDataURL = dataURL;

      editorModal.classList.remove('show');
      try{ if (imgURL) URL.revokeObjectURL(imgURL); } catch(e){}
    });

    function drawEditor(){
      const w = editorCanvas.width; const h = editorCanvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
      if (!img) {
        ctx.fillStyle = '#333'; ctx.font = '16px system-ui'; ctx.textAlign='center'; ctx.fillText('No image', w/2, h/2);
        return;
      }
      ctx.save();
      ctx.translate(w/2 + pos.x, h/2 + pos.y);
      ctx.rotate(angle);
      ctx.scale(scale, scale);
      ctx.drawImage(img, -img.width/2, -img.height/2);
      ctx.restore();

      // circle guide
      ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,0.6)';
      ctx.arc(w/2, h/2, Math.min(w,h)/2 - 4, 0, Math.PI*2); ctx.stroke();

      // overlay outside circle
      ctx.save();
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.beginPath();
      ctx.rect(0,0,w,h);
      ctx.arc(w/2, h/2, Math.min(w,h)/2 - 4, 0, Math.PI*2, true);
      ctx.fill('evenodd');
      ctx.restore();
    }

    // pointer drag
    editorCanvas.addEventListener('pointerdown', (ev)=>{
      if (!img) return;
      dragging = true; startPtr = {x: ev.clientX, y: ev.clientY};
      editorCanvas.setPointerCapture(ev.pointerId);
    });
    editorCanvas.addEventListener('pointermove', (ev)=>{
      if (!dragging) return;
      const dx = ev.clientX - startPtr.x; const dy = ev.clientY - startPtr.y;
      startPtr = {x: ev.clientX, y: ev.clientY};
      pos.x += dx; pos.y += dy; drawEditor();
    });
    editorCanvas.addEventListener('pointerup', (ev)=>{ dragging=false; try{editorCanvas.releasePointerCapture(ev.pointerId);}catch(e){} });
    editorCanvas.addEventListener('pointercancel', ()=>{ dragging=false });

    editorCanvas.addEventListener('wheel', (ev)=>{
      ev.preventDefault();
      const delta = -ev.deltaY;
      const factor = 1 + (delta>0?0.06:-0.06);
      scale *= factor; scale = Math.max(0.12, Math.min(8, scale));
      drawEditor();
    }, {passive:false});
    drawEditor();

    // ---- NEW: robust overwrite upload logic ----
    async function postUploadPayload(payload, method = 'POST') {
      try {
        const res = await fetch(FUNCTION_URL, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(()=>({ ok: res.ok, status: res.status }));
        return { ok: res.ok, status: res.status, body: json };
      } catch (err) {
        return { ok: false, error: err.message || err };
      }
    }

    // main upload handler tries upsert, then delete+upload fallback
    uploadBtn.addEventListener('click', async ()=>{
      try {
        const user = auth.currentUser;
        if (!user) throw new Error('User not authenticated');

        let dataURL = window.__editedImageDataURL;
        if (!dataURL) {
          const f = fileInput.files && fileInput.files[0];
          if (!f) return alert('Please select and/or edit an image before uploading');
          dataURL = await new Promise((res)=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(f); });
        }

        const base64 = dataURL.split(',')[1];
        const fileName = `${user.uid}.png`;

        // 1) Try upload with upsert:true (preferred)
        console.log('Attempting upload with upsert=true');
        let try1 = await postUploadPayload({ fileName, base64, upsert: true }, 'POST');

        // If success => done
        if (try1.ok && (!try1.body || !try1.body.error)) {
          console.log('Upload succeeded (upsert).', try1.body);
          const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
          preview.innerHTML = `<img src="${newUrl}" alt="Profile Picture">`;
          alert('Profile picture updated successfully!');
          return;
        }

        // If server responded with conflict / resource exists, attempt delete->upload
        const serverMessage = (try1.body && (try1.body.error || try1.body.message)) || (try1.error || JSON.stringify(try1.body));
        console.warn('First upload attempt failed:', serverMessage, try1);

        // Detect a "resource already exists" style problem:
        const existsErr = (serverMessage && /resource\s+already\s+exists|already exists|exists|409/i.test(String(serverMessage)));

        if (existsErr || try1.status === 409) {
          console.log('Resource exists. Attempting delete then re-upload...');
          // 2) try DELETE (ask function to delete existing file). Many edge functions accept DELETE {fileName}
          const del = await postUploadPayload({ fileName }, 'DELETE');
          if (!del.ok) {
            console.warn('Delete attempt returned non-ok:', del);
            // proceed anyway to try upload again (sometimes delete endpoint returns 200 with body.error)
          } else {
            console.log('Delete request OK:', del);
          }

          // 3) retry upload (POST without upsert flag)
          const retry = await postUploadPayload({ fileName, base64 }, 'POST');
          if (retry.ok && (!retry.body || !retry.body.error)) {
            console.log('Re-upload succeeded after delete.', retry.body);
            const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
            preview.innerHTML = `<img src="${newUrl}" alt="Profile Picture">`;
            alert('Profile picture replaced successfully!');
            return;
          } else {
            // final failure
            console.error('Re-upload failed:', retry);
            throw new Error((retry.body && (retry.body.error || retry.body.message)) || retry.error || 'Upload failed after delete');
          }
        } else {
          // Some other error: try a plain POST once more (no upsert)
          console.log('Attempting fallback upload (no upsert)');
          const fallback = await postUploadPayload({ fileName, base64 }, 'POST');
          if (fallback.ok && (!fallback.body || !fallback.body.error)) {
            const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
            preview.innerHTML = `<img src="${newUrl}" alt="Profile Picture">`;
            alert('Profile picture updated successfully (fallback)!');
            return;
          }
          console.error('Fallback upload failed:', fallback);
          throw new Error((fallback.body && (fallback.body.error || fallback.body.message)) || fallback.error || 'Upload failed');
        }

      } catch (e) {
        console.error('Upload error:', e);
        alert(`Failed to upload: ${e.message || e}`);
      }
    });

    // helper: double-click preview to open editor (if present)
    preview.addEventListener('dblclick', ()=>{ if (img) editorModal.classList.add('show'); else if(!auth.currentUser) alert('Login required'); });

  </script>
</body>
</html>