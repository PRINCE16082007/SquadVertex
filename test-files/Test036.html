<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Galaxy ‚Äî About (with Orbit Mini-Game)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css " />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ---------- Base (kept mostly unchanged, but tightened layout) ---------- */
    :root { --accent:#64c2ff; --muted:#bfeaff; --bg1:#181f2b; --card:#181f2b; }
    html,body { height:100%; }
    body { 
      background: var(--bg1);
      color: #fff; 
      margin: 0; 
      font-family: Arial, sans-serif; 
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Stars background */
    .stars { position: fixed; inset:0; pointer-events:none; z-index:-1; }

    .star { position:absolute; background-color:white; border-radius:50%; animation:twinkle var(--dur,5s) infinite ease-in-out; }
    @keyframes twinkle {0%,100%{opacity:0.2}50%{opacity:1}}

    /* Top bar (unchanged look) */
    .top-bar {
      display:flex; align-items:center; justify-content:space-between;
      height:72px; background:rgba(16,23,36,0.85); padding:0 18px;
      backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,0.06);
      position:sticky; top:0; z-index:120; box-sizing:border-box;
    }
    .logo-title { display:flex; gap:10px; align-items:center; font-family:Montserrat, sans-serif; font-weight:700; color:#fff; font-size:1.25rem; cursor:pointer; }
    .logo-title img{ height:46px; filter:drop-shadow(0 0 8px rgba(97,218,251,0.7)); }

    .nav-buttons { display:flex; gap:12px; align-items:center; }
    .nav-btn, .profile-btn { background:none; border:none; color:#e0e0e0; padding:6px 10px; border-radius:8px; cursor:pointer; font-family:Poppins, sans-serif; font-weight:500; }
    .nav-btn:hover, .profile-btn:hover { color:var(--accent); background:rgba(255,255,255,0.03); }

    /* Tighten page width and reduce big side gaps */
    .page-inner { max-width:1140px; margin: 12px auto 36px; padding: 0 18px; box-sizing:border-box; }

    /* Replace previous large blank area with compact game area */
    .orbit-playground { height:300px; margin: 14px 0 18px; }
    .play-card { position:relative; height:100%; border-radius:12px; overflow:hidden; background: linear-gradient(180deg, rgba(6,10,18,0.55), rgba(3,6,12,0.55)); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 12px 36px rgba(0,0,0,0.55); }

    /* Canvas covers whole card, keep non-intrusive */
    .play-canvas { position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none; z-index:1; }

    /* Earth centered & fixed */
    .orbit-center { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:6; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
    .earth-game {
      width:112px; height:112px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:48px; cursor:default;
      box-shadow: 0 10px 28px rgba(4,12,28,0.6), inset -6px -4px 20px rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.04);
      background: radial-gradient(circle at 28% 24%, rgba(255,255,255,0.03), rgba(0,0,0,0.22));
      -webkit-user-select:none; user-select:none;
    }

    /* HUD relocated bottom-right: cleaner layout, icons grouped */
    .hud-small {
      position:absolute; right:14px; bottom:14px; z-index:18; background:rgba(6,10,18,0.6);
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04);
      display:flex; gap:12px; align-items:center; backdrop-filter:blur(6px);
    }
    .hud-col { display:flex; flex-direction:column; gap:2px; min-width:78px; }
    .hud .label { font-weight:700; color:#fff; font-size:0.95rem; }
    .hud .muted { color:var(--muted); font-size:0.78rem; }

    .controls { display:flex; gap:8px; align-items:center; }
    .ctrl-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; color:#bfeaff; cursor:pointer; font-weight:700; }
    .ctrl-btn:hover { background:rgba(100,194,255,0.06); color:#fff; transform:translateY(-2px); transition:all .16s ease; }

    /* compact layout for mobile */
    @media (max-width:720px){
      .page-inner { padding:0 12px; max-width:100%; }
      .earth-game { width:84px; height:84px; font-size:36px; }
      .orbit-playground{ height:260px; }
      .hud-small { right:10px; bottom:10px; padding:8px; }
    }

    /* About sections: keep original but reduce top gap to bring content closer */
    .about-main { max-width:1100px; margin: 24px auto 50px; padding-top: 8px; position:relative; }
    .about-section { background: rgba(24,31,43,0.98); border-radius: 12px; box-shadow: 0 8px 24px #20294429; padding: 34px 40px; margin-bottom:28px; }
    .about-flex-row { display:flex; gap:28px; align-items:flex-start; flex-wrap:wrap; }
    .about-img-left, .about-img-right { width:220px; height:300px; }
    .about-img-inline { width:100%; height:300px; max-width:820px; }

    /* Confetti canvas overlay */
    #confettiCanvas { position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:220; }

    /* tiny polish */
    .small-muted { color: #a8bcd6; font-size:0.92rem; }
  </style>
</head>
<body>
  <!-- Stars background (dom-only) -->
  <div class="stars" id="stars"></div>

  <div class="top-bar">
    <div class="logo-title" onclick="window.location.href='dashboard.html'">
      <img src="https://dl.dropboxusercontent.com/scl/fi/ulfs6ygkeyvr4mar8bkuz/galaxwbewh.png?rlkey=jq9buj80ny6et6jfbfpiuf14l&st=lwkqobqi&dl=0" alt="Logo">
      GalaxyWeb
    </div>

    <div class="nav-buttons">
      <button class="nav-btn" onclick="window.location.href='dashboard.html'">Home</button>
      <button class="nav-btn" onclick="window.location.href='about_us.html'">Team Galaxy</button>
      <div style="position:relative;">
        <button class="nav-btn">More ‚ñº</button>
        <div class="dropdown-content" style="right:0;top:46px;">
          <a href="galaxy_blogs.html">Blog</a>
          <a href="galaxy_portfolio.html">Portfolio</a>
          <a href="posts.html">Posts</a>
          <a href="community_chat.html">Community Chat</a>
          <a href="galaxy_studio.html">Galaxy Design</a>
        </div>
      </div>

      <button id="profileBtn" class="profile-btn" title="Sign In">Sign In</button>
      <div id="profileMenu" class="dropdown-content" style="right:30px; display:none;">
        <a href="/teamgalaxy/user_management/user_profile.html" id="profileLink">Profile</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>
  </div>

  <div class="page-inner">

    <!-- Orbit Play module (replaces the big blank slot) -->
    <div class="orbit-playground">
      <div class="play-card" id="playCard" aria-label="Orbit playground">
        <canvas id="playCanvas" class="play-canvas" aria-hidden="true"></canvas>

        <div class="orbit-center">
          <div class="earth-game" id="earthEl" title="Double-click to sign in / view profile">üåé</div>
        </div>

        <div class="hud-small hud" id="hud">
          <div class="hud-col">
            <div class="label" id="hudName">Guest</div>
            <div class="muted" id="hudSlug">@guest</div>
          </div>

          <div class="hud-col">
            <div class="label" id="hudCollected">0</div>
            <div class="muted" id="hudHigh">High: 0</div>
          </div>

          <div class="controls" style="min-width:170px;">
            <button class="ctrl-btn" id="btnSpawn" title="Spawn orbs">Spawn</button>
            <button class="ctrl-btn" id="btnClear" title="Clear orbs">Clear</button>
            <button class="ctrl-btn" id="btnSave" title="Save high score">Save</button>
            <button class="ctrl-btn" id="btnDownload" title="Download score image">Download</button>
          </div>
        </div>
      </div>
    </div>

    <!-- About content sections (kept mostly unchanged) -->
    <div class="about-main">

      <div class="about-section">
        <div class="about-flex-row">
          <div class="about-img-container about-img-left">
            <img src="https://dl.dropboxusercontent.com/scl/fi/4r0o3ymhfol2ndauy5bwb/IMG_20251108_205841.png?rlkey=hagnr2tms6hzf36vc0qgldu4e&st=czyyqfdb&dl=0" alt="Team Galaxy" />
          </div>
          <div class="about-flex-text">
            <h2>What is Team Galaxy?</h2>
            Est. May 2025<br><br>
            Team Galaxy shines brightly on the competitive stage of World of Tanks Blitz. Our mission is to showcase our skills, push our limits, and aim for the top. With a strong and united roster, we make our mark not only in tournaments but in every battle we fight.<br><br>
            But Team Galaxy isn't just about victory ‚Äî it's about having fun, too! Our custom ranking system makes clan missions more exciting and creates a sense of friendly competition among members. Whether you want to fight at the highest level or just relax and enjoy the game with friends, you'll always find your place here.<br><br>
            In Galaxy, every member is a star. üåå
          </div>
        </div>
      </div>

      <div class="about-section">
        <div class="about-flex-row">
          <div class="about-flex-text">
            <h2>Clan Events & Activities</h2>
            At Team Galaxy, we believe that a clan should be more than just a tag next to your name ‚Äî it should be an experience. That's why we host exclusive member-only events designed to bring our community closer and keep the game exciting.<br><br>
            One of our biggest traditions is turning weekly clan missions into a fun competition. Members earn stars by completing missions, and these stars contribute to a long-term leaderboard. The higher you climb, the more rewards you can win ‚Äî from in-game gifts to special Galaxy merchandise.<br><br>
            These events are perfect for both competitive warriors and laid-back tankers who just want to enjoy the ride while working toward something rewarding.
          </div>
          <div class="about-img-container about-img-right">
            <img src="https://dl.dropboxusercontent.com/scl/fi/g4wq4m8pkzd32dc7g79dt/1762616781.png?rlkey=m4ctngnu14zl6lffhbw5lvexz&st=bbrct8s5&dl=0" alt="Clan Event" />
          </div>
        </div>
      </div>

      <div class="about-section">
        <h2>How to Apply</h2>
        <div class="about-img-container about-img-inline">
          <img src="https://dl.dropboxusercontent.com/scl/fi/extuxsxwz66h4kxz8apek/IMG_20251108_212726.jpg?rlkey=xw6xxxqtx62ahy9bikj0em3i3&st=34gxu7oj&dl=0" alt="Apply Clan" />
        </div>
        <div>
          Currently, we operate one main clan that welcomes both competitive and casual players.<br><br>
          <strong>Competitive Player Requirements:</strong>
          <ul>
            <li>2400+ WN8 (last 30 days)</li>
            <li>5,000+ total battles</li>
            <li>60%+ overall win rate</li>
          </ul>
          <strong>Casual Player Requirements:</strong>
          <ul>
            <li>10,000+ total battles</li>
            <li>60%+ overall win rate</li>
          </ul>
          <br>
          If you meet the requirements, simply reach out to us through our official Discord or in-game contact. Our recruitment officers will review your stats and chat with you before inviting you to join.<br><br>
          üí° Coming Soon: We are planning to launch our second clan to welcome even more players into the Galaxy family. Stay tuned for updates!
        </div>
      </div>

      <div class="about-section">
        <div class="about-flex-row">
          <div class="about-img-container about-img-left">
            <img src="https://dl.dropboxusercontent.com/scl/fi/2o26yjla61had31bwpcqh/IMG_20251108_213648.jpg?rlkey=dh5e6uqjquk7bb8jnaofxixt5&st=mt7scwa4&dl=0" alt="Team Philosophy" />
          </div>
          <div class="about-flex-text">
            <h2>Our Playstyle & Philosophy</h2>
            At Team Galaxy, we believe that victory is built on teamwork, strategy, and trust. We don't just play ‚Äî we play smart, fast, and as one. Every battle is a chance to learn, improve, and grow stronger together.<br><br>
            Our philosophy is simple: push your limits, respect your team, and enjoy the game. Whether we're fighting for the top spot in a tournament or just having a relaxed evening in platoon, we bring the same passion and dedication to every match.<br><br>
            We value communication, adaptability, and the drive to become better ‚Äî because in the Galaxy, every star shines brighter when united. üåå
          </div>
        </div>
      </div>

      <div class="about-section">
        <h2>Achievements & Journey</h2>
        <div class="about-flex-row">
          <div class="about-flex-text">
            Since our formation in May 2025, Team Galaxy has quickly built a name for itself in the Blitz community. While our sights are set on the biggest stages, we've already dominated numerous smaller-scale tournaments and community events ‚Äî proving that our teamwork and skill can consistently bring home the win.<br><br>
            <strong>Highlights so far:</strong>
            <ul>
              <li>Multiple weekly and community tournament victories.</li>
              <li>Strong performance in clan mission challenges and internal competitions.</li>
              <li>Established a solid and active roster of both competitive and casual players.</li>
              <li>Launched our Galaxy Mission Challenge, turning weekly clan missions into a fun, rewarding contest.</li>
            </ul>
            Our journey is just beginning ‚Äî and each win, no matter the size, brings us closer to our ultimate goal: competing and triumphing at the highest levels.
          </div>
          <div class="about-img-container about-img-right">
            <img src="https://dl.dropboxusercontent.com/scl/fi/athrvawp9mjtjc6psfxhv/1762616303.png?rlkey=4wwayymq6wn1632tquut9fn55&st=f10ldv4f&dl=0" alt="Galaxy Journey" />
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer class="footer" style="min-height:180px; padding:30px 18px;">
    <div style="max-width:1140px;margin:0 auto;display:flex;gap:30px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;">
      <div style="flex:1 1 320px;">
        <div class="footer-about-title">About TeamGalaxy</div>
        <div class="footer-about-text">TeamGalaxy is an innovative gaming and creative community, united by passion and the spirit of collaboration. We host tournaments, share design ideas, and grow talents together ‚Äî join now to explore the Galaxy!</div>
        <div style="display:flex;gap:16px;margin-top:8px;">
          <a href="https://x.com/teamgalaxy_wotb" class="small-muted"><i class="fab fa-twitter"></i></a>
          <a href="#" class="small-muted"><i class="fab fa-facebook"></i></a>
          <a href="#" class="small-muted"><i class="fab fa-instagram"></i></a>
          <a href="#" class="small-muted"><i class="fab fa-youtube"></i></a>
          <a href="https://discord.gg/26pSCyMRPM" class="small-muted"><i class="fab fa-discord"></i></a>
        </div>
      </div>
      <div style="flex:0 0 280px;">
        <div class="footer-links">
          <a href="legal/privacy_policy.html">Privacy Policy</a>
          <a href="legal/terms_and_conditions.html">Terms & Conditions</a>
          <a href="about_us.html">About</a>
        </div>
        <div style="margin-top:14px;color:#fff;font-size:0.95rem">
          <div style="margin-bottom:6px"><i class="fa-solid fa-location-dot" style="color:#fab84f;margin-right:8px"></i>44 Galaxy St, Universe City</div>
          <div><i class="fa-solid fa-phone" style="color:#afeafd;margin-right:8px"></i>+91-9876543210</div>
        </div>
      </div>
    </div>
  </footer>

  <!-- confetti canvas -->
  <canvas id="confettiCanvas" aria-hidden="true"></canvas>

  <!-- ReCAPTCHA (kept but hidden badge) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>

  <!-- Script: game + confetti + fixes -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app-check.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // ---------- Firebase init (unchanged) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const app = initializeApp(firebaseConfig);
    try {
      const appCheckProvider = new ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
      initializeAppCheck(app, { provider: appCheckProvider, isTokenAutoRefreshEnabled: true });
    } catch(e){ console.warn('AppCheck init failed', e); }
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // ---------- DOM refs ----------
    const playCanvas = document.getElementById('playCanvas');
    const playCard = document.getElementById('playCard');
    const earthEl = document.getElementById('earthEl');
    const hudName = document.getElementById('hudName');
    const hudSlug = document.getElementById('hudSlug');
    const hudCollected = document.getElementById('hudCollected');
    const hudHigh = document.getElementById('hudHigh');
    const btnSpawn = document.getElementById('btnSpawn');
    const btnClear = document.getElementById('btnClear');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const logoutLink = document.getElementById('logoutLink');
    const profileLink = document.getElementById('profileLink');

    const confettiCanvas = document.getElementById('confettiCanvas');
    const confettiCtx = confettiCanvas.getContext('2d');

    // ---------- state & constants ----------
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    let W = 0, H = 0;
    const ctx = playCanvas.getContext('2d');
    let last = performance.now();
    let orbs = [], pops = [];
    let nextId = 1;
    const MAX_ORBS = 28;
    const ORB_TYPES = [
      { name:'common', chance:0.75, size:18, score:1, color:'#8EE7FF' },
      { name:'uncommon', chance:0.18, size:26, score:3, color:'#FFD57B' },
      { name:'rare', chance:0.06, size:34, score:6, color:'#B8FF9A' },
      { name:'epic', chance:0.01, size:44, score:12, color:'#FF9AD6' }
    ];

    // local storage keys (only high score persisted)
    const LS_HIGH = 'galaxy_high';

    // score state: current always starts from 0; high loads from storage
    let collected = 0;
    let high = parseInt(localStorage.getItem(LS_HIGH)) || 0;

    // milestone tracking
    let lastMilestone = 0; // avoid repeating same milestone triggers

    // auth state
    let currentUser = null;
    let currentProfile = null;

    // ---------- helpers ----------
    function rand(a,b){ return a + Math.random()*(b-a); }
    function pickType(){ const r=Math.random(); let s=0; for(const t of ORB_TYPES){ s+=t.chance; if(r <= s) return t; } return ORB_TYPES[0]; }
    function hexToRgb(hex){ const s = hex.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }
    function updateHUD(){ hudCollected.textContent = collected; hudHigh.textContent = 'High: ' + high; hudName.textContent = currentProfile?.name || (currentUser?.displayName || 'Guest'); hudSlug.textContent = currentProfile?.slug ? ('@' + currentProfile.slug) : (currentUser ? ('@' + currentUser.uid.slice(0,6)) : '@guest'); updateProfileButton(); }

    // ---------- canvas sizing ----------
    function resizeCanvas(){
      const rect = playCard.getBoundingClientRect();
      W = Math.max(240, Math.floor(rect.width));
      H = Math.max(200, Math.floor(rect.height));
      playCanvas.style.width = W + 'px'; playCanvas.style.height = H + 'px';
      playCanvas.width = Math.floor(W * DPR); playCanvas.height = Math.floor(H * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);
      // confetti canvas covers full window
      confettiCanvas.width = Math.floor(window.innerWidth * DPR);
      confettiCanvas.height = Math.floor(window.innerHeight * DPR);
      confettiCtx.setTransform(DPR,0,0,DPR,0,0);
      initStars();
    }
    window.addEventListener('resize', resizeCanvas);

    // starfield for play-card
    let stars = [];
    function initStars(){
      stars.length = 0;
      const count = Math.max(12, Math.round((W*H)/90000));
      for(let i=0;i<count;i++) stars.push({ x:Math.random()*W, y:Math.random()*H, s:Math.random()*1.6+0.4, phase:Math.random()*Math.PI*2 });
    }

    // ---------- orbs spawn/collect ----------
    function spawnOrbAt(clientX, clientY){
      if (orbs.length >= MAX_ORBS) return;
      const rect = playCard.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const px = clientX || (cx + rand(-140,140));
      const py = clientY || (cy + rand(-90,90));
      const dx = px - cx; const dy = py - cy;
      const radius = Math.max(72, Math.min(Math.hypot(dx,dy), Math.min(rect.width, rect.height)/2 - 36));
      const angle = Math.atan2(dy, dx);
      const baseSpeed = 0.8 / Math.sqrt(Math.max(1, radius/90));
      const speed = (Math.random() < 0.5 ? 1 : -1) * baseSpeed * (0.6 + Math.random()*0.9);
      const t = pickType();
      const orb = {
        id: nextId++,
        angle, radius, speed,
        size: t.size * (0.9 + Math.random()*0.18),
        color: t.color, score: t.score, rarity: t.name,
        rotation: Math.random()*Math.PI*2,
        rotSpeed: (Math.random()*0.9-0.45)*0.02
      };
      orbs.push(orb);
    }

    function toLocalCoords(clientX, clientY){
      const rect = playCard.getBoundingClientRect();
      return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function hitTest(x,y){
      let best=null, bestD=Infinity;
      const rect = playCard.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      for(const o of orbs){
        const ox = cx + o.radius * Math.cos(o.angle), oy = cy + o.radius * Math.sin(o.angle);
        const d = Math.hypot(x-ox, y-oy);
        const hitR = Math.max(18, o.size*1.6);
        if (d <= hitR && d < bestD){ best = o; bestD = d; }
      }
      return best;
    }

    function collectOrb(o){
      if(!o) return;
      spawnPopForOrb(o);
      collected += o.score;
      // milestone trigger: every 50 points (but once per milestone)
      const milestoneTick = Math.floor(collected / 50) * 50;
      if (milestoneTick > 0 && milestoneTick !== lastMilestone){
        lastMilestone = milestoneTick;
        triggerSmallConfetti();
        playMelody('milestone');
      }
      // high score check
      if (collected > high){
        high = collected;
        localStorage.setItem(LS_HIGH, high);
        triggerConfetti();
        playMelody('win');
      } else {
        // small tick sound
        playMelody('tick');
      }
      orbs = orbs.filter(x => x.id !== o.id);
      updateHUD();
    }

    function spawnPopForOrb(o){
      const rect = playCard.getBoundingClientRect(); const cx = rect.width/2, cy = rect.height/2;
      const x = cx + o.radius * Math.cos(o.angle); const y = cy + o.radius * Math.sin(o.angle);
      const rgb = hexToRgb(o.color);
      const parts = []; const count = Math.min(26, Math.round(6 + o.size*1.2));
      for(let i=0;i<count;i++){
        const ang = Math.random()*Math.PI*2;
        parts.push({ vx: Math.cos(ang)*(0.6 + Math.random()*2.6), vy: Math.sin(ang)*(0.6 + Math.random()*2.6), size: Math.random()*(o.size*0.6)+0.6, color: `rgba(${rgb.r},${rgb.g},${rgb.b},` });
      }
      pops.push({ x,y, parts, life:1, lifeMax:1, speed: 42 + o.size*6 });
    }

    // ---------- drawing ----------
    function drawBackground(now){
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      for(const s of stars){
        const a = 0.22 + 0.18*Math.abs(Math.sin(now/1200 + s.phase));
        ctx.fillStyle = `rgba(210,235,255,${a})`;
        ctx.beginPath(); ctx.ellipse(s.x, s.y, s.s, s.s, 0,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    function drawOrbs(now, dt){
      const rect = playCard.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      for(const o of orbs){
        o.angle += o.speed * (dt/1000);
        o.rotation += o.rotSpeed;
        const x = cx + o.radius * Math.cos(o.angle), y = cy + o.radius * Math.sin(o.angle);
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(o.rotation * 0.12);
        // glow
        ctx.beginPath();
        const grad = ctx.createRadialGradient(0,0,0,0,0,o.size*1.9);
        grad.addColorStop(0, 'rgba(255,255,255,0.08)');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = grad;
        ctx.arc(0,0,o.size*1.9,0,Math.PI*2); ctx.fill();
        // emoji 'üõ∞Ô∏è' representation
        const fontSize = Math.max(14, Math.min(56, o.size));
        ctx.font = `${fontSize}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üõ∞Ô∏è', 0, 0);
        if (o.rarity === 'epic' || o.rarity === 'rare'){
          ctx.font = '10px Poppins, Arial';
          ctx.fillStyle = '#fff';
          ctx.fillText(o.rarity[0].toUpperCase(), o.size*0.85, -o.size*0.8);
        }
        ctx.restore();
        o.screenX = x; o.screenY = y;
      }
    }

    function drawPops(now, dt){
      ctx.save();
      for(let i=pops.length-1;i>=0;i--){
        const p = pops[i];
        p.life -= dt / 400;
        const alpha = Math.max(0, p.life / p.lifeMax);
        for(const part of p.parts){
          const px = p.x + part.vx * (1 - alpha) * p.speed;
          const py = p.y + part.vy * (1 - alpha) * p.speed;
          const s = Math.max(0.6, part.size * alpha);
          ctx.fillStyle = part.color + (0.85 * alpha) + ')';
          ctx.beginPath(); ctx.ellipse(px, py, s, s, 0,0,Math.PI*2); ctx.fill();
        }
        if (p.life <= 0) pops.splice(i,1);
      }
      ctx.restore();
    }

    function drawVignette(){
      const g = ctx.createRadialGradient(W/2, H/2, Math.max(W,H)/6, W/2, H/2, Math.max(W,H)/1.0);
      g.addColorStop(0,'rgba(255,255,255,0)');
      g.addColorStop(1,'rgba(0,0,0,0.20)');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    }

    function loop(now){
      requestAnimationFrame(loop);
      const dt = Math.max(8, now - last);
      last = now;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = 'rgba(6,8,12,0.12)'; ctx.fillRect(0,0,W,H);
      drawBackground(now);
      drawOrbs(now, dt);
      drawPops(now, dt);
      drawVignette();
    }

    // ---------- input handling ----------
    playCard.addEventListener('pointerdown', (e)=> {
      if(e.pointerType === 'mouse' && e.button !== 0) return;
      const p = toLocalCoords(e.clientX, e.clientY);
      const found = hitTest(p.x, p.y);
      if(found){ collectOrb(found); return; }
      spawnOrbAt(e.clientX, e.clientY);
    });

    // ---------- control buttons ----------
    btnSpawn.addEventListener('click', ()=> { for(let i=0;i<3;i++) spawnOrbAt(); });
    btnClear.addEventListener('click', ()=> { orbs=[]; pops=[]; ctx.clearRect(0,0,W,H); updateHUD(); });
    btnDownload.addEventListener('click', downloadScoreImage);
    btnSave.addEventListener('click', saveScoreToCloud);

    // ---------- audio (tones and victory melody) ----------
    let audioCtx = null;
    function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playTone(freq=440, dur=0.08, type='sine'){
      try{
        ensureAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq;
        o.connect(g); g.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        g.gain.setValueAtTime(0.001, now);
        g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        o.start(now); o.stop(now + dur + 0.02);
      }catch(e){}
    }

    function playMelody(kind='tick'){
      try{
        ensureAudio();
        if(kind === 'win'){
          // short celebratory arpeggio
          playTone(780, 0.08); setTimeout(()=>playTone(980,0.08),80); setTimeout(()=>playTone(1200,0.12),180);
        } else if(kind === 'milestone'){
          playTone(640,0.08); setTimeout(()=>playTone(740,0.08),80);
        } else {
          playTone(520,0.06,'triangle');
        }
      }catch(e){ console.warn('audio err', e); }
    }
    document.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });

    // ---------- confetti effect ----------
    let confettiParticles = [];
    let confettiRaf = null;
    function triggerConfetti(){
      spawnConfetti(140);
      runConfetti(3000);
    }
    function triggerSmallConfetti(){ spawnConfetti(40); runConfetti(1800); }
    function spawnConfetti(n){
      confettiParticles = confettiParticles.concat(Array.from({length:n}, ()=> {
        const w = window.innerWidth, h = window.innerHeight;
        return {
          x: rand(0,w), y: rand(-60,h/2),
          vx: rand(-120,120)/100, vy: rand(30,240)/100,
          r: rand(6,14), rot: rand(0,Math.PI*2), vr: rand(-0.2,0.2),
          color: `hsl(${Math.round(rand(160,320))} ${Math.round(rand(60,95))}% ${Math.round(rand(50,70))}%)`,
          life: 1
        };
      }));
    }

    function runConfetti(duration=2500){
      const start = performance.now();
      if(confettiRaf) cancelAnimationFrame(confettiRaf);
      function tick(now){
        const t = now - start;
        const dt = 16;
        confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
        confettiParticles.forEach(p=>{
          p.x += p.vx * (dt/16) * 2;
          p.y += p.vy * (dt/16) * 2;
          p.vy += 0.02 * (dt/16);
          p.rot += p.vr;
          confettiCtx.save();
          confettiCtx.translate(p.x, p.y);
          confettiCtx.rotate(p.rot);
          confettiCtx.fillStyle = p.color;
          confettiCtx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
          confettiCtx.restore();
        });
        confettiParticles = confettiParticles.filter(p => p.y < window.innerHeight + 80);
        if(t < duration || confettiParticles.length){
          confettiRaf = requestAnimationFrame(tick);
        } else {
          confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
          cancelAnimationFrame(confettiRaf);
          confettiRaf = null;
        }
      }
      confettiRaf = requestAnimationFrame(tick);
    }

    // ---------- download image generation ----------
    function downloadScoreImage(){
      const w = 1400, h = 760;
      const c = document.createElement('canvas'); c.width = w; c.height = h;
      const g = c.getContext('2d');
      // background
      const grad = g.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, '#041426'); grad.addColorStop(1, '#061428');
      g.fillStyle = grad; g.fillRect(0,0,w,h);
      // stars
      for(let i=0;i<180;i++){ g.fillStyle = 'rgba(200,230,255,' + (0.02 + Math.random()*0.07) + ')'; const x=Math.random()*w,y=Math.random()*h,s= Math.random()*2.4; g.beginPath(); g.ellipse(x,y,s,s,0,0,Math.PI*2); g.fill(); }
      // glass panel
      g.fillStyle = 'rgba(8,14,22,0.66)'; roundRect(g, 64, 84, w-128, h-188, 20); g.fill();
      // planet badge
      const cx = 160, cy = 320, cr = 120;
      const pg = g.createRadialGradient(cx-40, cy-30, 10, cx, cy, cr);
      pg.addColorStop(0, '#9ee6ff'); pg.addColorStop(0.5, '#6abcf1'); pg.addColorStop(1, '#12334f');
      g.fillStyle = pg; g.beginPath(); g.arc(cx, cy, cr, 0, Math.PI*2); g.fill();
      g.font = '92px serif'; g.textAlign='center'; g.textBaseline='middle'; g.fillText('üåé', cx, cy);
      // header text
      g.font = '700 44px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText('Team Galaxy ‚Äî Orbit Score Card', 420, 140);
      // display name + slug
      const displayName = currentProfile?.name || (currentUser?.displayName || 'Guest');
      const slug = currentProfile?.slug ? ('@' + currentProfile.slug) : (currentUser ? ('@' + currentUser.uid.slice(0,8)) : '@guest');
      g.font = '600 28px Poppins, Arial'; g.fillStyle = '#bfeaff'; g.fillText(displayName, 420, 210);
      g.font = '500 20px Poppins, Arial'; g.fillStyle = '#9fd8ff'; g.fillText(slug, 420, 246);
      // big stats
      g.font = '700 88px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText(String(high), 420, 380);
      g.font = '500 20px Poppins, Arial'; g.fillStyle = '#9fd8ff'; g.fillText('High Score', 420, 420);
      g.font = '700 38px Poppins, Arial'; g.fillStyle = '#fff'; g.fillText('Collected: ' + collected, 420, 520);
      g.font = '400 14px Poppins, Arial'; g.fillStyle = 'rgba(255,255,255,0.65)'; g.fillText('Generated: ' + new Date().toLocaleString(), w-300, h-56);
      // satellites emojis
      g.font = '28px serif'; g.fillStyle='#d7f6ff'; [[w-240,220],[w-160,340],[w-220,420]].forEach(p=>g.fillText('üõ∞Ô∏è', p[0], p[1]));
      c.toBlob(function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'galaxy-score-' + Date.now() + '.png';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }, 'image/png');
    }
    function roundRect(g, x, y, w, h, r){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath(); }

    // ---------- save to firestore ----------
    async function saveScoreToCloud(){
      if (!currentUser){ alert('Sign in to save to cloud (click Sign In or double-click the Earth).'); return; }
      try{
        const uid = currentUser.uid;
        const ref = doc(db, 'gameScores', uid);
        const payload = { collected: collected, high: high, lastUpdated: serverTimestamp(), clientTs: new Date().toISOString() };
        await setDoc(ref, payload, { merge: true });
        alert('Saved to cloud.');
      }catch(e){ console.error('save fail', e); alert('Save failed.'); }
    }

    // ---------- small UI: profile button & earth double click ----------
    function updateProfileButton(){
      try {
        const u = currentUser;
        if (!profileBtn) return;
        if (u) {
          if (u.photoURL) {
            profileBtn.innerHTML = `<img src="${u.photoURL}" alt="Profile" style="width:36px;height:36px;border-radius:50%;">`;
          } else {
            profileBtn.innerHTML = `<i class="fa-solid fa-user"></i>`;
          }
          profileBtn.title = u.displayName || u.email || "Profile";
        } else {
          profileBtn.innerHTML = 'Sign In';
          profileBtn.title = 'Sign In';
        }
      } catch(e){ console.warn('updateProfileBtn err', e); }
    }

    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const liveUser = auth.currentUser;
      if (!liveUser) { window.location.href = "/teamgalaxy/legal/sign_up.html"; return; }
      if (!profileMenu) return;
      profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
    });
    window.addEventListener('click', ()=> { if(profileMenu) profileMenu.style.display = 'none'; });
    logoutLink.addEventListener('click', (e)=> { e.preventDefault(); signOut(auth).then(()=>{ alert('Signed out'); }).catch(()=>{}); });
    profileLink.addEventListener('click', (e)=> { e.preventDefault(); if(!auth.currentUser) window.location.href = "/teamgalaxy/legal/sign_up.html"; else window.location.href = "/teamgalaxy/user_management/user_profile.html"; });

    earthEl.addEventListener('dblclick', async () => {
      if (currentUser){ alert('Signed in as ' + (currentUser.displayName || currentUser.email)); return; }
      try{ await signInWithPopup(auth, provider); alert('Signed in'); }catch(e){ console.warn(e); alert('Sign-in failed'); }
    });

    // ---------- auth state sync: load usersPrivate for slug & name ----------
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user){
        try {
          const privRef = doc(db, 'usersPrivate', user.uid);
          const privSnap = await (await fetchUserDoc(privRef)); // read via helper to avoid issues in some envs
          if (privSnap) currentProfile = privSnap;
          else currentProfile = { name: user.displayName || null, slug: null };
        } catch(e){
          console.warn('usersPrivate read failed', e);
          currentProfile = { name: user.displayName || null, slug: null };
        }
      } else {
        currentProfile = null;
      }
      updateHUD();
    });

    // Helper wrapper: try getDoc fallback ‚Äî using getDoc directly is fine but keep safe
    async function fetchUserDoc(docRef){
      try {
        // Use Firestore get via dynamic import (we already imported setDoc/serverTimestamp earlier)
        // But simpler: use getDoc from module if available. We'll attempt to import getDoc lazily.
        const { getDoc } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js");
        const snap = await getDoc(docRef);
        return snap.exists() ? snap.data() : null;
      } catch(e){
        console.warn('fetchUserDoc fallback error', e);
        return null;
      }
    }

    // ---------- confetti canvas sizing ----------
    function resizeConfettiCanvas(){
      confettiCanvas.width = Math.floor(window.innerWidth * DPR);
      confettiCanvas.height = Math.floor(window.innerHeight * DPR);
      confettiCtx.setTransform(DPR,0,0,DPR,0,0);
    }
    window.addEventListener('resize', resizeConfettiCanvas);

    // ---------- init & boot ----------
    function init(){
      DPR = Math.max(1, window.devicePixelRatio || 1);
      // ensure current score starts from 0
      collected = 0;
      high = parseInt(localStorage.getItem(LS_HIGH)) || 0;
      resizeCanvas();
      resizeConfettiCanvas();
      const rect = playCard.getBoundingClientRect();
      for(let i=0;i<6;i++) spawnOrbAt(rect.left + rect.width/2 + rand(-140,140), rect.top + rect.height/2 + rand(-90,90));
      updateHUD();
      last = performance.now();
      requestAnimationFrame(loop);
    }

    // ---------- start ----------
    window.addEventListener('load', init);
    window.addEventListener('beforeunload', ()=> { localStorage.setItem(LS_HIGH, high); });

    // small utility to ensure touches for mobile trigger audio early
    document.addEventListener('touchstart', ()=> ensureAudio(), { once:true });

  </script>
</body>
</html>