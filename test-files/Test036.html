<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Settings - TeamGalaxy</title>
  <style>
    /* ==== RESTORED STYLING (your original) ==== */
    :root { --overlay-color: rgba(34, 16, 80, 0.06); }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma, Geneva, Verdana, sans-serif}
    html,body{height:100%}
    body{ background: linear-gradient(135deg,#0f0c29,#302b63,#24243e); color:#e0e0ff; min-height:100vh; display:flex; flex-direction:column; position:relative; overflow-x:hidden; }
    .bg-layer{ position:fixed; inset:0; z-index:-4; background-image:url('https://dl.dropboxusercontent.com/scl/fi/1csa5jjslfhutldgd4in9/IMG_20251116_113654.png?rlkey=p2jqe4ngtw8z2id5rpqspw9sb&st=grvkp8p9&dl=0'); background-position:center; background-size:cover; background-repeat:no-repeat; filter:brightness(0.55) saturate(0.95); transition:filter .35s ease; }
    .bg-overlay{ position:fixed; inset:0; z-index:-3; background:var(--overlay-color); pointer-events:none; mix-blend-mode:multiply; }
    #bgStars{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:-2; pointer-events:none; display:block; }
    .shimmer-layer{ position:fixed; inset:0; z-index:-1; pointer-events:none; background:linear-gradient(120deg, rgba(255,255,255,0.00) 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.00) 60%); background-size:300% 300%; opacity:0.10; mix-blend-mode:screen; animation:shimmer-move 10s linear infinite; filter:blur(6px); }
    @keyframes shimmer-move { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .header{ display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:rgba(10,10,35,0.95); backdrop-filter: blur(15px); border-bottom:1px solid #5a4fcf; box-shadow:0 4px 20px rgba(0,0,0,0.4); position:sticky; top:0; z-index:100; }
    .logo{ font-size:2rem; font-weight:bold; color:#8a7cff; letter-spacing:1.5px; text-shadow:0 0 10px rgba(138,124,255,0.5); background:linear-gradient(45deg,#8a7cff,#d66efd); -webkit-background-clip:text; -webkit-text-fill-color:transparent; cursor:pointer; }
    .header-buttons{ display:flex; gap:1rem; }
    .btn{ padding:.7rem 1.4rem; border-radius:8px; border:1px solid rgba(138,124,255,0.3); background:rgba(20,20,40,0.5); cursor:pointer; font-weight:600; transition:all .3s ease; font-size:.95rem; color:#b1a6ff; backdrop-filter: blur(10px); }
    .btn:hover{ background:rgba(30,30,60,0.7); border:1px solid rgba(138,124,255,0.6); box-shadow:0 0 15px rgba(138,124,255,0.2); }
    .container{ max-width:900px; margin:2rem auto; padding:0 1.5rem; flex:1; position:relative; z-index:2; }
    .settings-card{ background:rgba(20,20,40,0.55); border-radius:20px; padding:3rem; box-shadow:0 15px 35px rgba(0,0,0,0.45); border:1px solid rgba(90,79,207,0.9); backdrop-filter: blur(10px); width:100%; position:relative; }
    .settings-header{ display:flex; align-items:center; gap:2rem; margin-bottom:2.5rem; flex-wrap:wrap; }
    .profile-photo-container{ width:150px; height:150px; border-radius:50%; object-fit:cover; border:4px solid #6a5af9; background:linear-gradient(45deg,#6a5af9,#d66efd); display:flex; align-items:center; justify-content:center; font-size:4rem; box-shadow:0 0 20px rgba(106,90,249,0.3); position:relative; overflow:hidden; cursor:pointer; }
    .profile-photo-container img{ width:100%; height:100%; border-radius:50%; object-fit:cover; display:block; }
    .settings-info{ flex:1; min-width:300px; }
    .settings-title{ font-size:2.5rem; font-weight:bold; color:#ffffff; margin-bottom:.5rem; text-shadow:0 0 10px rgba(255,255,255,0.2); }
    .settings-subtitle{ font-size:1.1rem; color:#b1a6ff; margin-bottom:1rem; }
    .form-group{ margin-bottom:2rem; }
    .form-label{ display:block; margin-bottom:.5rem; color:#d0c4ff; font-weight:500; font-size:1.1rem; }
    .form-input{ width:100%; padding:1rem; border-radius:10px; border:1px solid rgba(138,124,255,0.3); background:rgba(30,30,60,0.6); color:#e0e0ff; font-size:1rem; transition:all .3s ease; backdrop-filter: blur(10px); }
    .form-input:focus{ outline:none; border:1px solid rgba(138,124,255,0.6); box-shadow:0 0 15px rgba(138,124,255,0.2); }
    .form-textarea{ width:100%; padding:1rem; border-radius:10px; border:1px solid rgba(138,124,255,0.3); background:rgba(30,30,60,0.6); color:#e0e0ff; font-size:1rem; transition:all .3s ease; backdrop-filter: blur(10px); min-height:120px; resize:vertical; }
    .save-btn{ padding:1rem 2.5rem; border-radius:10px; border:1px solid rgba(138,124,255,0.3); background:linear-gradient(45deg,#6a5af9,#d66efd); cursor:pointer; font-weight:600; transition:all .3s ease; font-size:1.1rem; color:white; backdrop-filter: blur(10px); width:100%; margin-top:1rem; }
    .save-btn:hover{ background:linear-gradient(45deg,#7a6af9,#e67fdd); box-shadow:0 0 20px rgba(106,90,249,0.4); }
    .info-box{ background:rgba(30,30,60,0.5); border-radius:15px; padding:1.5rem; margin-bottom:2rem; border:1px solid rgba(138,124,255,0.3); }
    .status-message{ margin-top:1rem; padding:.8rem; border-radius:8px; text-align:center; font-weight:500; display:none; }
    .status-success{ background:rgba(40,167,69,0.2); border:1px solid rgba(40,167,69,0.3); color:#28a745; display:block; }
    .status-error{ background:rgba(220,53,69,0.2); border:1px solid rgba(220,53,69,0.3); color:#dc3545; display:block; }
    .editor-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; background: rgba(0,0,0,0.6); padding:20px; }
    .editor-modal.show{ display:flex; }
    .editor-panel{ width:min(920px,96%); background:#0e0b16; padding:16px; border-radius:12px; display:flex; gap:16px; align-items:flex-start; box-shadow:0 10px 60px rgba(0,0,0,0.75); border:1px solid rgba(120,86,250,0.12); }
    .editor-left{ display:flex; flex-direction:column; gap:12px; }
    .editor-canvas{ width:360px; height:360px; background:#000; border-radius:8px; touch-action:none; display:block; }
    .editor-controls{ display:flex; flex-direction:column; gap:8px; min-width:220px; }
    .small-btn{ padding:8px 10px; border-radius:8px; border:1px solid #222; background:#121212; color:#fff; cursor:pointer; }
    .small-primary{ background:linear-gradient(45deg,#6a5af9,#d66efd); color:#fff; border:none; }
    .muted{ color:#a0a0d0; font-size:13px; }
    .details-box{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(100,90,200,0.08); color:#dbe0ff; font-size:13px; line-height:1.4; max-height:360px; overflow:auto; }
    .modal-actions{ margin-top:8px; display:flex; gap:8px; align-items:center; }
    .close-x{ position:absolute; right:18px; top:14px; background:transparent; border:none; color:#ddd; font-size:20px; cursor:pointer; }
    @media (max-width:880px){ .editor-panel{ flex-direction:column; align-items:center; } .editor-canvas{ width:320px; height:320px; } }
  </style>
</head>
<body>
  <!-- BACKGROUNDS -->
  <div class="bg-layer" aria-hidden="true"></div>
  <div class="bg-overlay" aria-hidden="true"></div>
  <canvas id="bgStars" aria-hidden="true"></canvas>
  <div class="shimmer-layer" aria-hidden="true"></div>

  <!-- LOADING OVERLAY (RESTORED) -->
  <div class="loading-overlay" id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);">
    <div class="loading-message" style="font-size:1.8rem;color:#e0e0ff;margin-bottom:1.2rem;font-weight:700;text-shadow:0 0 10px rgba(138,124,255,0.5);">Loading settings...</div>
    <div class="stars-container" id="starsContainer" style="position:relative;width:240px;height:240px;"></div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <div class="logo" onclick="location.href='../dashboard.html'">GalaxyWeb</div>
    <div class="header-buttons">
      <button class="btn btn-profile">Profile</button>
      <button class="btn btn-logout">Log Out</button>
    </div>
  </header>

  <!-- MAIN -->
  <div class="container">
    <div class="settings-card">
      <div class="settings-header">
        <div class="profile-photo-container" id="photoWrapper" title="Click to change profile photo (one-time)">
          <img src="https://via.placeholder.com/150" alt="Profile Photo" id="currentPhoto">
        </div>

        <div class="settings-info">
          <h1 class="settings-title">Settings</h1>
          <p class="settings-subtitle">Manage your profile information</p>

          <div id="uploadControls" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <!-- visible controls kept minimal â€” main flow via modal -->
            <div id="oneTimeNote" style="color:#a0a0d0;font-size:.9rem;">You can change profile photo only once â€” upload will lock it.</div>
          </div>
        </div>
      </div>

      <form id="settingsForm">
        <div class="form-group">
          <label class="form-label">Display Name</label>
          <input type="text" id="nameInput" class="form-input" placeholder="Enter your display name">
        </div>

        <div class="form-group">
          <label class="form-label">Username Slug</label>
          <input type="text" id="slugInput" class="form-input" placeholder="Enter your username slug (e.g., john_doe)">
        </div>

        <!-- hidden managed field -->
        <div class="form-group" style="display:none;">
          <label class="form-label">Profile Photo URL</label>
          <input type="text" id="photoUrlInput" class="form-input" placeholder="(auto-managed)">
        </div>

        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="bioInput" class="form-textarea" placeholder="Tell us about yourself..."></textarea>
        </div>

        <div class="info-box">
          <h3 class="info-title">Verified Badge</h3>
          <p class="info-text">The verified badge will be introduced later. Currently, it is only available to select members.</p>
        </div>

        <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer" style="background:rgba(10,10,35,0.95); padding:3rem 2rem 2rem; margin-top:3rem; border-top:1px solid #5a4fcf; box-shadow:0 -4px 20px rgba(0,0,0,0.3); z-index:2;">
    <div class="footer-content" style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:3rem;">
      <div>
        <div style="font-size:1.1rem;color:#8a7cff;margin-bottom:1rem;font-weight:600;">About TeamGalaxy</div>
        <div style="color:#a0a0d0;line-height:1.6;font-size:.9rem;">TeamGalaxy is an innovative gaming and creative community â€” join now to explore the Galaxy!</div>
      </div>
      <div>
        <div style="display:flex;flex-direction:column;gap:.8rem;">
          <a href="../legal/privacy_policy.html" style="color:#a0a0d0;text-decoration:none;">Privacy Policy</a>
          <a href="../legal/terms_and_conditions.html" style="color:#a0a0d0;text-decoration:none;">Terms & Conditions</a>
          <a href="../about_us.html" style="color:#a0a0d0;text-decoration:none;">About</a>
        </div>
        <div class="rocket-frame" style="margin-top:2rem;padding:1.5rem;border:2px solid #5a4fcf;border-radius:12px;background:rgba(20,20,40,0.5);">
          <div style="font-size:1.8rem;font-weight:bold;color:#8a7cff;text-align:center;">ðŸš€ ROCKET ðŸš€</div>
        </div>
      </div>
    </div>
  </footer>

  <!-- EDITOR MODAL (opens when image clicked) -->
  <div id="editorModal" class="editor-modal" role="dialog" aria-hidden="true">
    <div class="editor-panel" role="document" aria-label="Profile photo editor">
      <button class="close-x" id="modalCloseBtn" title="Close">âœ•</button>
      <div class="editor-left">
        <canvas id="editorCanvas" class="editor-canvas" width="360" height="360"></canvas>
        <div style="display:flex;gap:8px;">
          <input id="fileInput" type="file" accept="image/*" style="color:#fff" />
          <button id="applyBtnModal" class="small-primary small-btn">Apply Preview</button>
        </div>
      </div>

      <div class="editor-controls">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="zoomIn" class="small-btn">Zoom +</button>
          <button id="zoomOut" class="small-btn">Zoom -</button>
          <button id="rotateLeft" class="small-btn">âŸ²</button>
          <button id="rotateRight" class="small-btn">âŸ²</button>
          <button id="resetBtn" class="small-btn">Reset</button>
        </div>

        <div class="details-box" id="detailsBox">
          <strong>Upload details & notes</strong>
          <p style="margin-top:8px;color:#cfd7ff;">
            â€¢ You can change your profile photo only <strong>once</strong>. After successful upload, it will be locked. <br/>
            â€¢ Upload will attempt a single server upsert. If server rejects with "resource exists", the upload will stop. <br/>
            â€¢ We will store the final public URL in Firestore under <code>profilePhotoUrl</code>, and set <code>profilePhotoLocked: true</code>.
          </p>
          <hr style="opacity:.06;margin:8px 0"/>
          <div id="modalMessages" style="font-size:13px;color:#a9b6ff;"></div>
        </div>

        <div class="modal-actions">
          <button id="confirmUploadBtn" class="small-primary small-btn">Upload & Lock (one-time)</button>
          <button id="cancelModalBtn" class="small-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // config
    const firebaseConfig = {
      apiKey: "AIzaSyD0Yv_bQjxi2_kjzPR4XHOlaB7Sb6NRVUc",
      authDomain: "teamgalaxy-77344.firebaseapp.com",
      projectId: "teamgalaxy-77344",
      storageBucket: "teamgalaxy-77344.firebasestorage.app",
      messagingSenderId: "770256225320",
      appId: "1:770256225320:web:5a363ebd757de6cde3a11d",
      measurementId: "G-6C2W9NSNCH"
    };
    const SUPABASE_URL = 'https://dvjihjkyenzkacviywgk.supabase.co';
    const FUNCTION_URL = 'https://dvjihjkyenzkacviywgk.functions.supabase.co/upload-image';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const loadingOverlay = document.getElementById('loadingOverlay');
    const starsContainer = document.getElementById('starsContainer');
    const currentPhoto = document.getElementById('currentPhoto');
    const nameInput = document.getElementById('nameInput');
    const slugInput = document.getElementById('slugInput');
    const photoUrlInput = document.getElementById('photoUrlInput');
    const bioInput = document.getElementById('bioInput');
    const settingsForm = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    const statusMessage = document.getElementById('statusMessage');
    const logoutBtn = document.querySelector('.btn-logout');
    const profileBtn = document.querySelector('.btn-profile');
    const oneTimeNote = document.getElementById('oneTimeNote');

    // modal/editor
    const editorModal = document.getElementById('editorModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const fileInput = document.getElementById('fileInput');
    const editorCanvas = document.getElementById('editorCanvas');
    const ctx = editorCanvas.getContext('2d');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const rotateLeft = document.getElementById('rotateLeft');
    const rotateRight = document.getElementById('rotateRight');
    const resetBtn = document.getElementById('resetBtn');
    const applyBtnModal = document.getElementById('applyBtnModal');
    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const modalMessages = document.getElementById('modalMessages');
    const detailsBox = document.getElementById('detailsBox');

    // state
    let img = null;
    let imgURL = null;
    let pos = { x:0, y:0 };
    let dragging = false;
    let lastPointer = null;
    let scale = 1;
    let angle = 0;
    window.__editedImageDataURL = null;
    let profilePhotoLocked = false;
    let currentUser = null;

    // small helpers
    function showStatus(msg, type='success') {
      statusMessage.textContent = msg;
      statusMessage.className = 'status-message';
      if (type === 'success') statusMessage.classList.add('status-success');
      else statusMessage.classList.add('status-error');
      statusMessage.style.display = 'block';
      setTimeout(()=> statusMessage.style.display = 'none', 5000);
    }

    // loading stars for overlay
    function createLoadingStars() {
      const container = starsContainer;
      if (!container) return;
      container.innerHTML = '';
      for (let i=0;i<30;i++){
        const star = document.createElement('div');
        star.className = 'star';
        const x = Math.random()*100, y = Math.random()*100;
        star.style.left = x + '%'; star.style.top = y + '%';
        const size = Math.random()*3 + 1;
        star.style.width = size + 'px'; star.style.height = size + 'px';
        const duration = Math.random()*3 + 2;
        star.style.setProperty('--duration', duration + 's');
        container.appendChild(star);
      }
    }

    // background stars (kept)
    function initBgStars() {
      const canvas = document.getElementById('bgStars');
      if (!canvas) return;
      const ctx2 = canvas.getContext('2d');
      let w = canvas.width = window.innerWidth;
      let h = canvas.height = window.innerHeight;
      const BASE_DENSITY = 0.00022;
      const LAYERS = [{depth:0.25,count:1.0,r:[0.25,0.8]},{depth:0.6,count:0.6,r:[0.6,1.6]},{depth:1.2,count:0.25,r:[1.4,3.5]}];
      let stars = [], shooting = [], mouseX = w/2, mouseY = h/2;

      function rand(min,max){ return Math.random()*(max-min)+min; }
      function randColor(){ const t=Math.random(); if(t<0.10) return 'rgba(255,235,200,'; if(t<0.6) return 'rgba(255,255,255,'; if(t<0.8) return 'rgba(200,220,255,'; return 'rgba(230,240,255,'; }

      function createStars(){
        stars = [];
        for (let li=0; li<LAYERS.length; li++){
          const layer = LAYERS[li];
          const count = Math.round(w*h*BASE_DENSITY*layer.count);
          for (let i=0;i<count;i++){
            const r = rand(layer.r[0], layer.r[1]);
            stars.push({ x:Math.random()*w, y:Math.random()*h, baseX:0, baseY:0, r, layer:li, depth:layer.depth, tw:Math.random()*Math.PI*2, tws:(Math.random()*0.02+0.005)*(1/layer.depth), alpha:Math.random()*0.7+0.2, color:randColor() });
          }
        }
        stars.forEach(s=>{ s.baseX = s.x; s.baseY = s.y; });
      }

      function spawn() {
        const startX = Math.random()<0.6 ? -50 : w+50;
        const startY = Math.random()*h*0.6;
        const velX = (startX<0)? rand(600,1200) : rand(-1200,-600);
        const velY = rand(60,220)*(Math.random()<0.5?1:-1);
        const len = rand(220,520);
        shooting.push({ x:startX, y:startY, vx:velX/1000, vy:velY/1000, life:0, len, max:rand(600,1200), op:0.95 });
      }

      function maybe() { if(Math.random()<0.025) spawn(); setTimeout(maybe, rand(1000,4000)); }
      maybe();

      function onResize(){ w=canvas.width=innerWidth; h=canvas.height=innerHeight; createStars(); }
      window.addEventListener('resize', throttle(onResize,150));
      window.addEventListener('mousemove',(e)=>{ mouseX=e.clientX; mouseY=e.clientY; });

      let last = performance.now();
      function frame(now){
        const dt = now - last; last = now; ctx2.clearRect(0,0,w,h);
        const vign = ctx2.createRadialGradient(w/2,h/2,Math.max(w,h)/8,w/2,h/2,Math.max(w,h)/1.1);
        vign.addColorStop(0,'rgba(255,255,255,0)'); vign.addColorStop(1,'rgba(0,0,0,0.16)');
        ctx2.fillStyle = vign; ctx2.fillRect(0,0,w,h);

        for (let li=0; li<LAYERS.length; li++){
          for (let i=0;i<stars.length;i++){
            const s = stars[i]; if(s.layer!==li) continue;
            s.tw += s.tws*(dt/16.67);
            const tval = (Math.sin(s.tw)+1)/2;
            const alpha = s.alpha * (0.35 + 0.65 * tval);
            const px = (mouseX - w/2) * (0.0005 * s.r) * (1/s.depth);
            const py = (mouseY - h/2) * (0.0005 * s.r) * (1/s.depth);
            const drawX = s.baseX + px + Math.sin((i + now*0.00002) * (0.0002 * s.depth)) * 0.4;
            const drawY = s.baseY + py + Math.cos((i + now*0.00003) * (0.0003 * s.depth)) * 0.4;

            if (s.r > 1.2) {
              const g = ctx2.createRadialGradient(drawX,drawY,0,drawX,drawY,s.r*6);
              g.addColorStop(0, s.color + alpha + ')'); g.addColorStop(0.4, s.color + (alpha*0.6) + ')'); g.addColorStop(1, s.color + '0)');
              ctx2.fillStyle = g; ctx2.fillRect(drawX - s.r*6, drawY - s.r*6, s.r*12, s.r*12);
            }
            ctx2.beginPath(); ctx2.globalAlpha = alpha; ctx2.fillStyle = s.color + Math.min(1,alpha) + ')'; ctx2.arc(drawX, drawY, s.r, 0, Math.PI*2); ctx2.fill(); ctx2.globalAlpha = 1;
          }
        }

        for (let i=shooting.length-1;i>=0;i--){
          const sh = shooting[i]; sh.x += sh.vx*dt; sh.y += sh.vy*dt; sh.life += dt;
          ctx2.save(); ctx2.globalCompositeOperation = 'lighter';
          const grad = ctx2.createLinearGradient(sh.x,sh.y, sh.x - sh.vx*10, sh.y - sh.vy*10);
          grad.addColorStop(0, `rgba(255,255,255,${sh.op})`); grad.addColorStop(0.3, `rgba(200,220,255,${sh.op*0.8})`); grad.addColorStop(1, `rgba(255,255,255,0)`);
          ctx2.strokeStyle = grad; ctx2.lineWidth = 2.8; ctx2.beginPath(); ctx2.moveTo(sh.x,sh.y); ctx2.lineTo(sh.x - sh.vx*sh.len, sh.y - sh.vy*sh.len); ctx2.stroke();
          const head = ctx2.createRadialGradient(sh.x,sh.y,0,sh.x,sh.y,6); head.addColorStop(0, `rgba(255,255,255,${sh.op})`); head.addColorStop(0.7, `rgba(200,220,255,${sh.op*0.6})`); head.addColorStop(1,'rgba(255,255,255,0)');
          ctx2.fillStyle = head; ctx2.beginPath(); ctx2.arc(sh.x,sh.y,3,0,Math.PI*2); ctx2.fill(); ctx2.restore();
          if (sh.life > sh.max || sh.x < -600 || sh.x > w + 600 || sh.y < -600 || sh.y > h + 600) shooting.splice(i,1);
        }

        requestAnimationFrame(frame);
      }

      function createStars() { stars = []; for(let li=0;li<LAYERS.length;li++){ const layer=LAYERS[li]; const count=Math.round(w*h*BASE_DENSITY*layer.count); for(let i=0;i<count;i++){ const r=rand(layer.r[0],layer.r[1]); stars.push({x:Math.random()*w,y:Math.random()*h,baseX:0,baseY:0,r,layer:li,depth:layer.depth,tw:Math.random()*Math.PI*2,tws:(Math.random()*0.02+0.005)*(1/layer.depth),alpha:Math.random()*0.7+0.2,color:randColor()}); } } stars.forEach(s=>{ s.baseX=s.x; s.baseY=s.y; }); }
      function rand(min,max){return Math.random()*(max-min)+min;}
      createStars(); requestAnimationFrame(frame);
      setTimeout(spawn, rand(800,2500));
    }

    // editor drawing
    function drawEditor(){
      const w = editorCanvas.width, h = editorCanvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
      if (!img) { ctx.fillStyle = '#333'; ctx.font='16px system-ui'; ctx.textAlign='center'; ctx.fillText('No image', w/2, h/2); return; }
      ctx.save();
      ctx.translate(w/2 + pos.x, h/2 + pos.y);
      ctx.rotate(angle);
      ctx.scale(scale, scale);
      ctx.drawImage(img, -img.width/2, -img.height/2);
      ctx.restore();
      ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,0.6)';
      ctx.arc(w/2, h/2, Math.min(w,h)/2 - 4, 0, Math.PI*2); ctx.stroke();
      ctx.save(); ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.beginPath(); ctx.rect(0,0,w,h); ctx.arc(w/2,h/2,Math.min(w,h)/2 - 4,0,Math.PI*2,true); ctx.fill('evenodd'); ctx.restore();
    }

    // pointer handlers
    editorCanvas.addEventListener('pointerdown',(ev)=>{ if(!img) return; dragging=true; lastPointer={x:ev.clientX,y:ev.clientY}; editorCanvas.setPointerCapture(ev.pointerId); });
    editorCanvas.addEventListener('pointermove',(ev)=>{ if(!dragging) return; const dx = ev.clientX - lastPointer.x; const dy = ev.clientY - lastPointer.y; lastPointer = {x:ev.clientX,y:ev.clientY}; pos.x += dx; pos.y += dy; drawEditor(); });
    editorCanvas.addEventListener('pointerup',(ev)=>{ dragging=false; try{ editorCanvas.releasePointerCapture(ev.pointerId); }catch(e){} });
    editorCanvas.addEventListener('pointercancel',()=>{ dragging=false; });
    editorCanvas.addEventListener('wheel',(ev)=>{ ev.preventDefault(); const delta=-ev.deltaY; const f=1+(delta>0?0.06:-0.06); scale*=f; scale=Math.max(0.12,Math.min(8,scale)); drawEditor(); },{passive:false});

    zoomIn.addEventListener('click', ()=>{ scale*=1.12; drawEditor(); });
    zoomOut.addEventListener('click', ()=>{ scale/=1.12; drawEditor(); });
    rotateLeft.addEventListener('click', ()=>{ angle -= Math.PI/18; drawEditor(); });
    rotateRight.addEventListener('click', ()=>{ angle += Math.PI/18; drawEditor(); });
    resetBtn.addEventListener('click', ()=>{ scale=1; angle=0; pos={x:0,y:0}; drawEditor(); });

    // file input -> load image into editor
    fileInput.addEventListener('change',(e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (f.size > 6*1024*1024) { alert('File too large (max ~6MB for local editing)'); return; }
      if (imgURL) try{ URL.revokeObjectURL(imgURL); }catch(e){}
      imgURL = URL.createObjectURL(f);
      img = new Image();
      img.onload = ()=> { scale = Math.min(1, Math.max(0.2, Math.min(editorCanvas.width / img.width, editorCanvas.height / img.height))) * 1.4; angle = 0; pos = {x:0,y:0}; drawEditor(); };
      img.src = imgURL;
    });

    // apply preview button inside modal
    applyBtnModal.addEventListener('click', ()=>{
      if (!img) return alert('Select an image first');
      const outSize = 360;
      const out = document.createElement('canvas'); out.width = outSize; out.height = outSize;
      const outCtx = out.getContext('2d');
      outCtx.save(); outCtx.translate(outSize/2 + pos.x, outSize/2 + pos.y); outCtx.rotate(angle); outCtx.scale(scale, scale); outCtx.drawImage(img, -img.width/2, -img.height/2); outCtx.restore();
      const circ = document.createElement('canvas'); circ.width = outSize; circ.height = outSize; const cctx = circ.getContext('2d');
      cctx.save(); cctx.beginPath(); cctx.arc(outSize/2, outSize/2, outSize/2, 0, Math.PI*2); cctx.closePath(); cctx.clip(); cctx.drawImage(out,0,0); cctx.restore();
      const dataURL = circ.toDataURL('image/png');
      window.__editedImageDataURL = dataURL;
      modalMessages.innerHTML = '<div style="color:#bfffc9">Preview ready â€” click "Upload & Lock" to upload and lock the photo.</div>';
      // quick show preview in main UI (soft)
      currentPhoto.src = dataURL;
    });

    // helper: POST upsert only once
    async function postUploadUpsert(fileName, base64) {
      try {
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ fileName, base64, upsert: true })
        });
        let body = null;
        try { body = await res.json(); } catch(e){ body = { ok: res.ok, status: res.status }; }
        return { ok: res.ok, status: res.status, body };
      } catch (err) { return { ok:false, error: err.message || String(err) }; }
    }

    // upload + lock
    confirmUploadBtn.addEventListener('click', async ()=>{
      try {
        if (!currentUser) return alert('Not authenticated');
        const docRef = doc(db, 'usersPrivate', currentUser.uid);
        // re-read lock state
        const snap = await getDoc(docRef);
        if (snap.exists() && snap.data().profilePhotoLocked) {
          profilePhotoLocked = true;
          editorModal.classList.remove('show');
          showStatus('Profile photo is already locked. You cannot change it again.', 'error');
          return;
        }

        const confirmed = window.confirm('Important â€” You will be able to change your profile picture ONLY ONCE. Proceed to upload and lock?');
        if (!confirmed) return;

        let dataURL = window.__editedImageDataURL;
        if (!dataURL) {
          alert('Please create a preview by selecting an image and clicking "Apply Preview" first.');
          return;
        }

        const base64 = dataURL.split(',')[1];
        const fileName = `${currentUser.uid}.png`;

        modalMessages.innerHTML = '<div style="color:#bde0ff">Uploading... please wait.</div>';

        const attempt = await postUploadUpsert(fileName, base64);

        if (attempt.ok && (!attempt.body || !attempt.body.error)) {
          const newUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}?v=${Date.now()}`;
          // update firestore (set lock)
          await updateDoc(docRef, {
            profilePhotoUrl: newUrl,
            profilePhotoLocked: true,
            profilePhotoLockedAt: serverTimestamp()
          });
          photoUrlInput.value = newUrl;
          currentPhoto.src = newUrl;
          profilePhotoLocked = true;
          modalMessages.innerHTML = '<div style="color:#bfffc9">Uploaded & locked successfully!</div>';
          editorModal.classList.remove('show');
          oneTimeNote.textContent = 'Profile photo is locked â€” you cannot change it again.';
          oneTimeNote.style.color = '#ffc9c9';
          showStatus('Profile photo uploaded and locked!', 'success');
          return;
        }

        // if server says exists -> show clear message, no retries
        const msg = (attempt.body && (attempt.body.error || attempt.body.message)) || attempt.error || `HTTP ${attempt.status}`;
        if (/resource\s+already\s+exists|already exists|exists|409/i.test(String(msg))) {
          modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload blocked: resource already exists on server. No further attempts will be made.</div>`;
          showStatus('Upload blocked: resource already exists on server.', 'error');
          console.warn('Upload blocked:', msg, attempt);
          return;
        }

        modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload failed: ${String(msg)}</div>`;
        showStatus(`Upload failed: ${String(msg)}`, 'error');

      } catch (e) {
        console.error('Upload exception:', e);
        modalMessages.innerHTML = `<div style="color:#ffc9c9">Upload exception: ${e.message || e}</div>`;
        showStatus(`Upload failed: ${e.message || e}`, 'error');
      }
    });

    // open modal when clicking image (if not locked)
    currentPhoto.addEventListener('click', async ()=>{
      if (!currentUser) return alert('Login required');
      if (profilePhotoLocked) { showStatus('Profile photo is locked â€” cannot change it.', 'error'); return; }
      modalMessages.innerHTML = ''; // reset
      detailsBox.scrollTop = 0;
      editorModal.classList.add('show');
      editorModal.setAttribute('aria-hidden','false');
    });

    // close modal buttons
    modalCloseBtn.addEventListener('click', ()=>{ editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); });
    cancelModalBtn.addEventListener('click', ()=>{ editorModal.classList.remove('show'); editorModal.setAttribute('aria-hidden','true'); });

    // profile save
    async function updateProfile() {
      if (!currentUser) return;
      const name = nameInput.value.trim();
      const slug = slugInput.value.trim();
      const photoUrl = photoUrlInput.value.trim();
      const bio = bioInput.value.trim();
      if (!name || !slug) { showStatus('Name and slug are required.', 'error'); return; }
      try {
        saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
        const docRef = doc(db, 'usersPrivate', currentUser.uid);
        await updateDoc(docRef, {
          name, slug,
          profilePhotoUrl: photoUrl || null,
          bio,
          termsAccepted: true,
          termsTimestamp: serverTimestamp()
        });
        if (photoUrl) currentPhoto.src = photoUrl;
        showStatus('Profile updated successfully!', 'success');
      } catch (err) {
        console.error('Error updating profile:', err);
        showStatus('Error saving profile data.', 'error');
      } finally { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
    }

    settingsForm.addEventListener('submit', (e)=>{ e.preventDefault(); updateProfile(); });

    // load profile
    async function loadProfile() {
      if (!currentUser) return;
      try {
        const docRef = doc(db, 'usersPrivate', currentUser.uid);
        const snap = await getDoc(docRef);
        if (!snap.exists()) { showStatus('Profile not found.', 'error'); return; }
        const data = snap.data();
        currentPhoto.src = data.profilePhotoUrl || 'https://via.placeholder.com/150';
        nameInput.value = data.name || '';
        slugInput.value = data.slug || '';
        photoUrlInput.value = data.profilePhotoUrl || '';
        bioInput.value = data.bio || '';
        profilePhotoLocked = !!data.profilePhotoLocked;
        if (profilePhotoLocked) {
          oneTimeNote.textContent = 'Profile photo is locked â€” you cannot change it again.';
          oneTimeNote.style.color = '#ffc9c9';
        } else {
          oneTimeNote.textContent = 'Click your profile photo to open the upload modal. You can change only once.';
          oneTimeNote.style.color = '#a0a0d0';
        }
      } catch (e) {
        console.error('Error load profile:', e);
        showStatus('Error loading profile', 'error');
      }
    }

    // auth
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { location.href = 'index.html'; return; }
      currentUser = user;
      await loadProfile();
      setTimeout(()=> loadingOverlay.classList.add('hidden'), 900);
    });

    // logout/profile btns
    logoutBtn.addEventListener('click', ()=> signOut(auth).then(()=> location.href='index.html').catch(err=> { console.error(err); showStatus('Error signing out.', 'error'); }));
    profileBtn.addEventListener('click', ()=> location.href='user_profile.html');

    // init visuals
    window.addEventListener('load', ()=>{ createLoadingStars(); initBgStars(); drawEditor(); });

    // small throttle helper used in bg stars
    function throttle(fn, wait) { let time = Date.now(); return function(){ if ((time + wait - Date.now()) < 0) { fn(); time = Date.now(); } } }

  </script>
</body>
</html>