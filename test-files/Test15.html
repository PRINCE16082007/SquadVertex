<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SV Schedule Tracker</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/schedule_tracker/girls_schedule_tracker/manifest.json">
  <link rel="icon" sizes="192x192" href="/schedule_tracker/girls_schedule_tracker/android-chrome-192x192.png">
  <link rel="apple-touch-icon" href="/schedule_tracker/girls_schedule_tracker/android-chrome-512x512.png">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Pacifico&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #ff758c;
      --secondary-color: #ffafcc;
      --background-light: #fff5f5;
      --background-gradient: linear-gradient(135deg, var(--background-light), #ffe3e3);
      --text-dark: #333;
      --text-light: #fff;
      --border-color: #eee;
      --shadow-light: rgba(255, 118, 117, 0.2);
      --shadow-medium: rgba(255, 117, 140, 0.4);
      --shadow-dark: rgba(0, 0, 0, 0.1);
    }

    body {
      background: var(--background-gradient);
      font-family: 'Nunito', sans-serif;
      margin: 0;
      min-height: 100vh;
      position: relative;
      padding-bottom: 80px; /* Space for footer */
      color: var(--text-dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .header {
      text-align: center;
      padding: 3rem 2rem;
      background: url('https://dl.dropboxusercontent.com/scl/fi/oziie1cuoaos20i7oltqs/watercolor-sugar-cotton-clouds-background_52683-80661.webp?rlkey=iwqo0vylo0mnmqy24l0uyjjkr&st=laffzrxs&dl=0') center/cover;
      border-radius: 20px;
      margin-bottom: 2.5rem;
      box-shadow: 0 8px 32px var(--shadow-light);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.3); /* Soft overlay */
      border-radius: 20px;
    }

    .header h1 {
      font-family: 'Pacifico', cursive;
      font-size: 3.5rem;
      color: var(--primary-color);
      text-shadow: 2px 2px 6px rgba(255, 77, 109, 0.3);
      margin: 0;
      position: relative;
      z-index: 1;
    }

    .user-info {
      text-align: right;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      color: #666;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    .user-info .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .btn {
      background: var(--text-light);
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
      padding: 0.8rem 1.5rem;
      border-radius: 30px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover {
      background: var(--primary-color);
      color: var(--text-light);
      box-shadow: 0 4px 15px var(--shadow-medium);
      transform: translateY(-2px);
    }

    .btn:disabled {
        background: #ccc;
        color: #999;
        border-color: #999;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--text-light);
      padding: 2.5rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal h3 {
      margin-top: 0;
      color: var(--primary-color);
      font-family: 'Pacifico', cursive;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .modal label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-size: 1rem;
      font-weight: 700;
      color: #555;
    }

    .modal input[type="text"],
    .modal input[type="time"],
    .modal input[type="date"] {
      width: calc(100% - 20px);
      padding: 0.8rem 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .modal input[type="text"]:focus,
    .modal input[type="time"]:focus,
    .modal input[type="date"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 117, 140, 0.2);
    }

    .modal .actions {
      text-align: right;
      margin-top: 2rem;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #999;
      transition: color 0.3s ease;
    }

    .close-btn:hover {
      color: var(--primary-color);
    }

    .quote-container {
      background: rgba(255, 255, 255, 0.9);
      padding: 2rem;
      border-radius: 15px;
      margin: 2.5rem 0;
      border: 2px solid var(--primary-color);
      text-align: center;
      box-shadow: 0 4px 20px var(--shadow-light);
    }

    .quote {
      font-family: 'Great Vibes', cursive;
      font-size: 2.5rem;
      color: #ff4d6d;
      text-shadow: 2px 2px 4px rgba(255, 77, 109, 0.2);
      margin: 0;
      line-height: 1.3;
    }

    .streak-box, .chart-container, .gallery, .task-list, .consistency-score {
      margin: 2.5rem 0;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .streak-box {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--text-light);
      text-align: center;
      box-shadow: 0 8px 30px rgba(255, 118, 117, 0.4);
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }

    .streak-box span {
      font-size: 2.5rem;
      font-family: 'Pacifico', cursive;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    .streak-info {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .streak-info div {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background: var(--text-light);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .day-header {
        font-weight: 700;
        text-align: center;
        padding-bottom: 0.5rem;
        color: var(--primary-color);
    }

    .day-cell {
      padding: 10px 5px;
      text-align: center;
      border-radius: 8px;
      background: #ffe8ec;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: #666;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .day-cell:hover:not(.locked-day):not(.empty-day) {
        background: #ffd6e0;
        transform: translateY(-2px);
    }

    .completed-day {
      background: var(--primary-color);
      color: var(--text-light);
      box-shadow: 0 2px 10px rgba(255, 117, 140, 0.3);
    }

    .missed-day {
        background: #ddd;
        color: #888;
    }

    .locked-day {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .empty-day {
        background: transparent;
        cursor: default;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .gallery img {
      width: 100%;
      height: 280px;
      object-fit: cover;
      border-radius: 15px;
      transition: transform .3s, box-shadow .3s;
      box-shadow: 0 8px 24px var(--shadow-dark);
    }

    .gallery img:hover {
      transform: scale(1.03);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .task-list, .routine-list {
      background: var(--text-light);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 20px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .task-list h2, .routine-list h2 {
        font-family: 'Pacifico', cursive;
        color: var(--primary-color);
        text-align: center;
        margin-top: 0;
        margin-bottom: 1.5rem;
    }

    .task-item, .routine-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }

    .task-item:last-child, .routine-item:last-child {
      border-bottom: none;
    }

    .task-item:hover, .routine-item:hover {
        background-color: #fffafb;
    }

    .task-checkbox, .routine-checkbox {
      margin-right: 1.2rem;
      min-width: 20px; /* Ensure consistent size */
      min-height: 20px;
      accent-color: var(--primary-color); /* Style checkbox */
      cursor: pointer;
    }

    .task-content, .routine-content {
      flex-grow: 1;
      font-size: 1.05rem;
    }

    .task-content strong {
        color: #555;
    }

    .task-actions button, .routine-actions button {
      margin-left: 0.8rem;
      background: none;
      border: 1px solid var(--primary-color);
      border-radius: 8px;
      padding: 0.5rem 0.9rem;
      cursor: pointer;
      color: var(--primary-color);
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .task-actions button:hover, .routine-actions button:hover {
      background: var(--primary-color);
      color: var(--text-light);
      box-shadow: 0 2px 8px rgba(255, 117, 140, 0.3);
    }

    .footer {
      text-align: center;
      padding: 1.5rem;
      font-family: 'Nunito', sans-serif;
      color: #888;
      margin-top: 3rem;
      position: absolute;
      bottom: 0;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      border-top: 1px solid #eee;
    }

    .consistency-score {
        text-align: center;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .consistency-score span {
        font-size: 2rem;
        font-family: 'Pacifico', cursive;
        color: #ff4d6d;
    }

    /* Retro Entry Modal specific styles */
    .retro-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 1.5rem;
    }

    .retro-day-cell {
        padding: 8px;
        text-align: center;
        border-radius: 6px;
        background: #f0f0f0;
        cursor: pointer;
        font-size: 0.9rem;
        border: 1px solid #ddd;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .retro-day-cell:hover {
        background: #e0e0e0;
    }

    .retro-day-cell.missed {
        background: #ffe0e6; /* Light pink for missed */
        border-color: #ffc2d4;
    }

    .retro-day-cell.marked {
        background: #c2f0c2; /* Light green for marked */
        border-color: #aae0aa;
    }

    .retro-day-cell.locked {
        background: #ccc;
        border-color: #bbb;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .retro-day-cell.selected-retro {
        background: var(--primary-color) !important;
        color: var(--text-light);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 117, 140, 0.4);
    }

    .retro-modal-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
    }

    .retro-status-select {
        display: block;
        width: calc(100% - 20px);
        padding: 0.8rem 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
        margin-top: 1rem;
        background-color: var(--text-light);
    }
  </style>
</head>
<body>
  <div class="auth-container" id="authContainer" style="display:none; text-align:center; padding:3rem;">
    <button class="btn" id="signInBtn">Sign in with Google üå∏</button>
  </div>

  <div class="container" id="mainContainer" style="display:none;">
    <div class="user-info" id="userInfo"></div>
    <div class="header"><h1>üåπ My Eternal Growth Journey üåπ</h1></div>

    <div style="text-align:center; margin-bottom:2rem;">
      <button class="btn" id="addTaskBtn">Add Task üìù</button>
      <button class="btn" id="addRoutineBtn">Add Routine ‚ú®</button>
    </div>

    <div class="task-list" id="taskList">
        <h2>Daily Tasks</h2>
        <div id="tasksContainer"></div>
    </div>

    <div class="routine-list" id="routineList">
        <h2>My Routines</h2>
        <div id="routinesContainer"></div>
    </div>

    <div class="quote-container animate__animated animate__fadeIn"><p class="quote" id="dynamicQuote"></p></div>

    <div class="streak-box">
      <div class="streak-info">
          <div>üî• Current Streak: <span id="currentStreak">0</span> days</div>
          <div>üå∏ Longest Streak: <span id="longestStreak">0</span> days</div>
      </div>
      <button class="btn" id="markBtn">Mark Today üíñ</button>
      <div id="markWarning" style="color:#ffee00; font-size:0.9rem; margin-top:0.5rem; display:none;"></div>
    </div>

    <div class="consistency-score">
        Consistency: <span id="consistencyScore">0</span>% (<span id="daysActive">0</span> out of <span id="totalDaysRange">0</span> days)
    </div>

    <div class="calendar" id="calendar"></div>

    <div class="chart-container">
        <h2>Last 30 Days Progress</h2>
        <canvas id="progressChart"></canvas>
    </div>

    <div class="gallery" id="gallery">
        <h2>Inspiration Gallery</h2>
    </div>
  </div>

  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <button class="close-btn" id="closeTaskModal">&times;</button>
      <h3>Add / Edit Task</h3>
      <label for="taskTime">Time</label>
      <input type="time" id="taskTime">
      <label for="taskDuration">Duration (e.g., 30m, 1h 30m)</label>
      <input type="text" id="taskDuration" placeholder="e.g. 30m">
      <label for="taskDesc">Description</label>
      <input type="text" id="taskDesc" placeholder="What is your task?">
      <div class="actions"><button class="btn" id="saveTaskBtn">Save Task</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="routineModal">
    <div class="modal">
      <button class="close-btn" id="closeRoutineModal">&times;</button>
      <h3>Add Routine</h3>
      <label for="routineDesc">Routine</label>
      <input type="text" id="routineDesc" placeholder="e.g. No phone after 9pm">
      <div class="actions"><button class="btn" id="saveRoutineBtn">Save Routine</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="retroEntryModal">
    <div class="modal">
      <button class="close-btn" id="closeRetroModal">&times;</button>
      <h3>Fill Missed Days</h3>
      <p>You missed attendance for <span id="missedDaysCount">X</span> days. Select a day to update its status.</p>
      <div class="retro-calendar-grid" id="retroCalendarGrid"></div>
      <select id="retroStatusSelect" class="retro-status-select">
          <option value="">Select Status</option>
          <option value="Yes">Mark as Completed</option>
          <option value="No">Mark as Skipped</option>
      </select>
      <div class="retro-modal-actions">
          <button class="btn" id="saveRetroStatusBtn">Update Day</button>
          <button class="btn" id="cancelRetroBtn">Later</button>
      </div>
    </div>
  </div>

  <div class="footer">SquadVertex ¬© 2024 - Cultivating Eternal Growth</div>

<script type="module">
    // Firebase configuration & imports
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3",
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, getDoc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentDate = new Date(); // This will always be today's date for marking attendance
    let chart;
    let editingTaskId = null;
    let selectedRetroDate = null;

    const GRACE_PERIOD_DAYS = 7; // Days within which a missed day can be edited

    const quotes = [
      "No matter what we build‚Äîlet's never forget who we‚Äôre building it for.",
      "Some people seek peace in silence. I found mine in a smile I‚Äôve never met.",
      "You are my today and all of my tomorrows.",
      "In your light I learn how to love. In your beauty, how to make poems.",
      "I love you not because of who you are, but because of who I am when I am with you.",
      "Every atom of my being is in love with every atom of yours.",
      "I would rather spend one lifetime with you, than face all the ages of this world alone.",
      "Your love is my eternal motivation to grow better every day üå∏"
    ];

    // --- Utility Functions ---
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function diffDays(date1, date2) {
        const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
        const firstDate = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const secondDate = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.round(Math.abs((firstDate - secondDate) / oneDay));
    }

    function showModal(modalElement) {
        modalElement.classList.add('active');
    }

    function hideModal(modalElement) {
        modalElement.classList.remove('active');
    }

    // --- Auth state listener ---
    onAuthStateChanged(auth, async user => {
      if (user) {
        editingTaskId = null;
        document.getElementById('mainContainer').style.display = 'block';
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('userInfo').innerHTML = `üë§ ${user.email} <button class="btn" id="signOutBtn">Sign out</button>`;
        document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
        await initApp(user);
      } else {
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
      }
    });

    document.getElementById('signInBtn').addEventListener('click', () => signInWithPopup(auth, provider));

    // --- App Initialization ---
    async function initApp(user) {
      showRandomQuote();
      initChart();
      await autoFillMissingAttendance(user.uid);
      await renderCalendar(user.uid);
      await updateStreakDisplay(user.uid);
      loadGallery();
      await loadTasks(user.uid);
      await loadRoutines(user.uid);
      checkAndToggleMarkButton(user.uid);
    }

    function showRandomQuote() {
      document.getElementById('dynamicQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
    }

    function initChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line', data: { labels: [], datasets: [{ label: 'Daily Completion (Last 30 Days)', data: [], borderColor: '#ff758c', tension: 0.3, fill: true, backgroundColor: 'rgba(255, 117, 140, 0.2)' }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.1, /* To show difference between 0 and 1 clearly */
                    ticks: {
                        callback: function(value, index, values) {
                            return value === 1 ? 'Complete' : value === 0 ? 'Missed' : '';
                        },
                        font: { size: 12, family: 'Nunito' },
                        color: '#666'
                    },
                    grid: { display: false }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10, family: 'Nunito' }, color: '#666' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Status: ${context.raw === 1 ? 'Completed' : 'Missed'}`;
                        }
                    }
                }
            }
        }
      });
    }

    // --- Attendance Tracking and Display ---

    async function autoFillMissingAttendance(uid) {
        const today = new Date();
        today.setHours(0,0,0,0); // Normalize today to start of day

        const recordsRef = collection(db, 'users', uid, 'dailyRecords');
        const q = query(recordsRef, orderBy('date', 'desc'));
        const lastRecordSnap = await getDocs(q);

        let lastRecordedDate = null;
        if (!lastRecordSnap.empty) {
            lastRecordedDate = new Date(lastRecordSnap.docs[0].data().date);
            lastRecordedDate.setHours(0,0,0,0);
        } else {
            // If no records, start from 30 days ago, or app launch date
            lastRecordedDate = addDays(today, -30); // Or the very first day the user created account
            lastRecordedDate.setHours(0,0,0,0);
        }

        const missingDates = [];
        let tempDate = addDays(lastRecordedDate, 1);

        while (tempDate < today) {
            const dateStr = formatDate(tempDate);
            const existsSnap = await getDocs(query(recordsRef, where('date', '==', dateStr)));
            if (existsSnap.empty) {
                await addDoc(recordsRef, {
                    date: dateStr,
                    status: "Missed",
                    reason: "No data submitted"
                });
                missingDates.push(dateStr);
            }
            tempDate = addDays(tempDate, 1);
        }

        if (missingDates.length > 0) {
            showRetroEntryPrompt(uid, missingDates);
        }
    }

    async function showRetroEntryPrompt(uid, missedDates) {
        document.getElementById('missedDaysCount').innerText = missedDates.length;
        const retroCalendarGrid = document.getElementById('retroCalendarGrid');
        retroCalendarGrid.innerHTML = '';
        document.getElementById('retroStatusSelect').value = '';
        selectedRetroDate = null; // Reset selected date

        const today = new Date();
        const todayStr = formatDate(today);

        missedDates.forEach(dateStr => {
            const cell = document.createElement('div');
            cell.classList.add('retro-day-cell');
            cell.textContent = new Date(dateStr).getDate();
            cell.dataset.date = dateStr;

            const dateObj = new Date(dateStr);
            const daysAgo = diffDays(today, dateObj);

            if (missedDates.includes(dateStr)) {
                cell.classList.add('missed');
            }

            if (daysAgo > GRACE_PERIOD_DAYS) {
                cell.classList.add('locked');
                cell.title = 'Cannot edit dates older than 7 days.';
            } else {
                cell.addEventListener('click', () => {
                    document.querySelectorAll('.retro-day-cell').forEach(c => c.classList.remove('selected-retro'));
                    cell.classList.add('selected-retro');
                    selectedRetroDate = dateStr;
                    // Optional: Pre-fill status if known from existing record (if any)
                    // For auto-filled, it's always 'Missed' so we don't pre-fill value
                });
            }
            retroCalendarGrid.appendChild(cell);
        });

        showModal(document.getElementById('retroEntryModal'));
    }

    document.getElementById('saveRetroStatusBtn').addEventListener('click', async () => {
        if (!selectedRetroDate) {
            alert('Please select a day to update.');
            return;
        }
        const status = document.getElementById('retroStatusSelect').value;
        if (!status) {
            alert('Please select a status (Completed/Skipped).');
            return;
        }

        const user = auth.currentUser;
        if (!user) return;

        const recordsRef = collection(db, 'users', user.uid, 'dailyRecords');
        const q = query(recordsRef, where('date', '==', selectedRetroDate));
        const snap = await getDocs(q);

        if (!snap.empty) {
            await updateDoc(snap.docs[0].ref, { status: status });
            alert(`Updated ${selectedRetroDate} to ${status}.`);
        } else {
            await addDoc(recordsRef, { date: selectedRetroDate, status: status });
            alert(`Added ${selectedRetroDate} as ${status}.`);
        }

        hideModal(document.getElementById('retroEntryModal'));
        await renderCalendar(user.uid);
        await updateStreakDisplay(user.uid);
        selectedRetroDate = null; // Reset for next use
    });

    document.getElementById('cancelRetroBtn').addEventListener('click', () => {
        hideModal(document.getElementById('retroEntryModal'));
    });


    async function renderCalendar(uid) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);

      const startOfMonthStr = formatDate(firstDayOfMonth);
      const endOfMonthStr = formatDate(lastDayOfMonth);

      const recordsRef = collection(db, 'users', uid, 'dailyRecords');
      const snap = await getDocs(query(recordsRef, where('date', '>=', startOfMonthStr), where('date', '<=', endOfMonthStr)));
      const dailyRecordsMap = new Map();
      snap.docs.forEach(d => dailyRecordsMap.set(d.data().date, d.data().status));

      const cal = document.getElementById('calendar');
      cal.innerHTML = '';

      // Day headers
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
        const h = document.createElement('div');
        h.textContent = d;
        h.className = 'day-header';
        cal.appendChild(h);
      });

      // Empty cells for the start of the month
      for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'day-cell empty-day';
        cal.appendChild(emptyCell);
      }

      const today = new Date();
      today.setHours(0,0,0,0);

      for (let d = 1; d <= lastDayOfMonth.getDate(); d++) {
        const dateObj = new Date(year, month, d);
        const dateStr = formatDate(dateObj);
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.textContent = d;
        cell.dataset.date = dateStr;

        const recordStatus = dailyRecordsMap.get(dateStr);
        if (recordStatus === 'Yes') {
          cell.classList.add('completed-day');
        } else if (recordStatus === 'No' || recordStatus === 'Missed') {
          cell.classList.add('missed-day');
        }

        const daysAgo = diffDays(today, dateObj);
        if (daysAgo > GRACE_PERIOD_DAYS && dateObj < today) { // Only lock past days
            cell.classList.add('locked-day');
            cell.title = 'Cannot edit dates older than 7 days.';
        } else {
            cell.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                const confirmUpdate = confirm(`Do you want to change the status for ${dateStr}?`);
                if (confirmUpdate) {
                    const newStatus = prompt('Enter new status ("Yes" for completed, "No" for skipped):', recordStatus === 'Yes' ? 'Yes' : 'No');
                    if (newStatus === 'Yes' || newStatus === 'No') {
                        const recSnap = await getDocs(query(recordsRef, where('date', '==', dateStr)));
                        if (!recSnap.empty) {
                            await updateDoc(recSnap.docs[0].ref, { status: newStatus });
                        } else {
                            await addDoc(recordsRef, { date: dateStr, status: newStatus });
                        }
                        await renderCalendar(user.uid);
                        await updateStreakDisplay(user.uid);
                    } else if (newStatus !== null) {
                        alert('Invalid status. Please enter "Yes" or "No".');
                    }
                }
            });
        }

        cal.appendChild(cell);
      }
    }


    async function updateStreakDisplay(uid) {
        const recordsRef = collection(db, 'users', uid, 'dailyRecords');
        const q = query(recordsRef, orderBy('date', 'asc')); // Order by date ascending for streak calculation
        const dataSnap = await getDocs(q);
        const allRecords = dataSnap.docs.map(d => d.data());

        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;

        const today = formatDate(new Date());
        const sortedRecords = allRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

        for (let i = 0; i < sortedRecords.length; i++) {
            const record = sortedRecords[i];
            if (record.status === 'Yes') {
                tempStreak++;
            } else {
                if (tempStreak > longestStreak) {
                    longestStreak = tempStreak;
                }
                tempStreak = 0;
            }

            // If it's the last record and today's date, then this is current streak
            if (record.date === today && record.status === 'Yes') {
                currentStreak = tempStreak;
            }
        }
        if (tempStreak > longestStreak) {
            longestStreak = tempStreak;
        }

        // Calculate current streak considering consecutive days up to today
        let checkDate = new Date();
        checkDate.setHours(0,0,0,0);
        let currentTempStreak = 0;
        for (let i = 0; i < sortedRecords.length; i++) {
            const recordDate = new Date(sortedRecords[sortedRecords.length - 1 - i].date);
            recordDate.setHours(0,0,0,0);

            if (recordDate.getTime() === checkDate.getTime() && sortedRecords[sortedRecords.length - 1 - i].status === 'Yes') {
                currentTempStreak++;
                checkDate = addDays(checkDate, -1);
            } else if (recordDate.getTime() < checkDate.getTime()) {
                 // If the record date is older than expected, and it's not today, break
                if (recordDate.getTime() !== addDays(checkDate, -1).getTime() || sortedRecords[sortedRecords.length - 1 - i].status === 'Missed') {
                    break;
                }
            } else if (recordDate.getTime() > checkDate.getTime()) {
                // If record date is newer than current checkDate (future), skip
                continue;
            } else { // status is 'No' or 'Missed' for the current day
                break;
            }
        }
        currentStreak = currentTempStreak;


        document.getElementById('currentStreak').textContent = currentStreak;
        document.getElementById('longestStreak').textContent = longestStreak;

        // Update Chart (Last 30 days)
        const chartLabels = [];
        const chartData = [];
        const thirtyDaysAgo = addDays(new Date(), -29); // Start 29 days before today to get 30 days total
        thirtyDaysAgo.setHours(0,0,0,0);

        let tempChartDate = new Date(thirtyDaysAgo);
        const recordsMap = new Map(allRecords.map(rec => [rec.date, rec.status]));

        while (tempChartDate <= new Date()) {
            const dateStr = formatDate(tempChartDate);
            chartLabels.push(dateStr.substring(5)); // Month-Day
            const status = recordsMap.get(dateStr);
            chartData.push(status === 'Yes' ? 1 : 0);
            tempChartDate = addDays(tempChartDate, 1);
        }

        chart.data.labels = chartLabels;
        chart.data.datasets[0].data = chartData;
        chart.update();

        // Calculate and display Consistency Score
        const totalDaysInChartRange = chartLabels.length;
        const daysActive = chartData.filter(status => status === 1).length;
        const consistency = totalDaysInChartRange > 0 ? ((daysActive / totalDaysInChartRange) * 100).toFixed(0) : 0;

        document.getElementById('consistencyScore').textContent = consistency;
        document.getElementById('daysActive').textContent = daysActive;
        document.getElementById('totalDaysRange').textContent = totalDaysInChartRange;
    }


    function loadGallery() {
      const imgs = [
        'https://dl.dropboxusercontent.com/scl/fi/ubuq43gztfhz1i2j4k7yr/photo-1553702446-4a0cfb5781f8.jpeg?rlkey=ub9rfam3ragt1we52e007lwhy&st=9ca7jqkw&dl=0',
        'https://dl.dropboxusercontent.com/scl/fi/k19l9mjmc2nk5zohbiby9/photo-1531512073830-ba890ca4eba2.jpeg?rlkey=vypt87g0aix4wp8r20hzn5qs4&st=zawqet25&dl=0',
        'https://dl.dropboxusercontent.com/scl/fi/9svcemu34ehcmzbgofwtp/photo-1612824857666-f4b20bc92aa7.jpeg?rlkey=2qb8wezugwslyoekau5d8otrl&st=jm0crqoa&dl=0',
      ];
      const g = document.getElementById('gallery');
      g.innerHTML = '<h2>Inspiration Gallery</h2>'; // Keep the heading
      imgs.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        g.appendChild(img);
      });
    }

    // --- Modal and Form Handlers ---
    const taskModal = document.getElementById('taskModal');
    const routineModal = document.getElementById('routineModal');
    const retroEntryModal = document.getElementById('retroEntryModal');

    document.getElementById('addTaskBtn').onclick = () => {
        editingTaskId = null;
        document.getElementById('taskTime').value = '';
        document.getElementById('taskDuration').value = '';
        document.getElementById('taskDesc').value = '';
        showModal(taskModal);
    };
    document.getElementById('addRoutineBtn').onclick = () => {
        document.getElementById('routineDesc').value = '';
        showModal(routineModal);
    };

    document.getElementById('closeTaskModal').onclick = () => hideModal(taskModal);
    document.getElementById('closeRoutineModal').onclick = () => hideModal(routineModal);
    document.getElementById('closeRetroModal').onclick = () => hideModal(retroEntryModal);

    // Save Task
    document.getElementById('saveTaskBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;
      const today = formatDate(currentDate); // Tasks are always for today
      const data = {
          time: document.getElementById('taskTime').value,
          duration: document.getElementById('taskDuration').value,
          desc: document.getElementById('taskDesc').value,
          done: false, // New tasks are not done by default
          date: today
      };
      if (editingTaskId) {
          await updateDoc(doc(db, 'users', user.uid, 'tasks', editingTaskId), data);
      } else {
          await addDoc(collection(db, 'users', user.uid, 'tasks'), data);
      }
      editingTaskId = null;
      hideModal(taskModal);
      await loadTasks(user.uid);
      checkAndToggleMarkButton(user.uid);
    };

    // Save Routine
    document.getElementById('saveRoutineBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;
      const today = formatDate(currentDate);
      await addDoc(collection(db, 'users', user.uid, 'rules'), {
          desc: document.getElementById('routineDesc').value,
          date: today, // Routines are daily and tied to today
          active: false
      });
      hideModal(routineModal);
      await loadRoutines(user.uid);
      checkAndToggleMarkButton(user.uid);
    };

    // --- Task and Routine Loading and Management ---
    async function checkAndToggleMarkButton(uid) {
        const today = formatDate(currentDate);
        const tasksSnap = await getDocs(query(collection(db, 'users', uid, 'tasks'), where('date','==',today)));
        const routinesSnap = await getDocs(query(collection(db, 'users', uid, 'rules'), where('date','==',today)));

        const allTasksDone = tasksSnap.docs.every(d => d.data().done);
        const allRoutinesActive = routinesSnap.docs.every(d => d.data().active);

        const markBtn = document.getElementById('markBtn');
        const markWarning = document.getElementById('markWarning');

        if (allTasksDone && allRoutinesActive) {
            markBtn.disabled = false;
            markWarning.style.display = 'none';
        } else {
            markBtn.disabled = true;
            markWarning.style.display = 'block';
            markWarning.textContent = 'Please complete all tasks and routines to mark today!';
        }
    }

    // Load Tasks
    async function loadTasks(uid) {
      const today = formatDate(currentDate); // Load tasks for today only
      const snap = await getDocs(query(collection(db,'users',uid,'tasks'), where('date', '==', today), orderBy('time')));
      const tasksContainer = document.getElementById('tasksContainer');
      tasksContainer.innerHTML='';
      if (snap.empty) {
          tasksContainer.innerHTML = '<p style="text-align:center; color:#888;">No tasks for today. Add some to get started!</p>';
      }
      snap.docs.forEach(d=>{
        const t=d.data();
        const item=document.createElement('div');
        item.className='task-item';
        item.innerHTML=`
          <input type="checkbox" class="task-checkbox" data-id="${d.id}" ${t.done?'checked':''}>
          <div class="task-content">
            <strong>${t.time}</strong> - ${t.desc} (${t.duration})
          </div>
          <div class="task-actions">
            <button class="edit-btn" data-id="${d.id}">‚úèÔ∏è</button>
            <button class="delete-btn" data-id="${d.id}">üóëÔ∏è</button>
          </div>
        `;
        tasksContainer.appendChild(item);

        item.querySelector('.task-checkbox').addEventListener('change',async e=>{
            await updateDoc(doc(db,'users',uid,'tasks',e.target.dataset.id),{done:e.target.checked});
            checkAndToggleMarkButton(uid);
        });
      });

      tasksContainer.addEventListener('click',async e=>{
        const target = e.target;
        if(target.classList.contains('delete-btn')){
          if(confirm('Are you sure you want to delete this task?')){
            await deleteDoc(doc(db,'users',uid,'tasks',target.dataset.id));
            loadTasks(uid);
            checkAndToggleMarkButton(uid);
          }
        }
        if(target.classList.contains('edit-btn')){
          const rec=await getDoc(doc(db,'users',uid,'tasks',target.dataset.id));
          const t=rec.data();
          editingTaskId=target.dataset.id;
          document.getElementById('taskTime').value=t.time;
          document.getElementById('taskDuration').value=t.duration;
          document.getElementById('taskDesc').value=t.desc;
          showModal(taskModal);
        }
      });
    }

    // Load Routines
    async function loadRoutines(uid) {
      const today = formatDate(currentDate); // Load routines for today only
      const snap = await getDocs(query(collection(db,'users',uid,'rules'), where('date', '==', today), orderBy('date')));
      const routinesContainer = document.getElementById('routinesContainer');
      routinesContainer.innerHTML='';
      if (snap.empty) {
          routinesContainer.innerHTML = '<p style="text-align:center; color:#888;">No routines set for today. Time to build some good habits!</p>';
      }
      snap.docs.forEach(d=>{
        const r=d.data();
        const item=document.createElement('div');
        item.className='routine-item';
        item.innerHTML=`
          <input type="checkbox" class="routine-checkbox" data-id="${d.id}" ${r.active?'checked':''}>
          <div class="routine-content">${r.desc}</div>
          <div class="routine-actions">
            <button class="delete-btn" data-id="${d.id}">üóëÔ∏è</button>
          </div>
        `;
        routinesContainer.appendChild(item);
        item.querySelector('.routine-checkbox').addEventListener('change',async e=>{
            await updateDoc(doc(db,'users',uid,'rules',e.target.dataset.id),{active:e.target.checked});
            checkAndToggleMarkButton(uid);
        });
      });
      routinesContainer.addEventListener('click',async e=>{
        const target = e.target;
        if(target.classList.contains('delete-btn')){
          if(confirm('Are you sure you want to delete this routine?')){
            await deleteDoc(doc(db,'users',uid,'rules',target.dataset.id));
            loadRoutines(uid);
            checkAndToggleMarkButton(uid);
          }
        }
      });
    }

    // Mark Today
    document.getElementById('markBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;
      const today = formatDate(currentDate);

      // Re-validate just in case button state wasn't updated
      const tasksSnap = await getDocs(query(collection(db, 'users', user.uid, 'tasks'), where('date','==',today)));
      const routinesSnap = await getDocs(query(collection(db, 'users', user.uid, 'rules'), where('date','==',today)));

      const allTasksDone = tasksSnap.docs.every(d => d.data().done);
      const allRoutinesActive = routinesSnap.docs.every(d => d.data().active);

      if (!allTasksDone || !allRoutinesActive) {
          alert('Please complete all tasks and routines before marking today!');
          checkAndToggleMarkButton(user.uid); // Ensure button state is correct
          return;
      }

      await runTransaction(db, async (transaction) => {
        const recQuery = query(collection(db,'users',user.uid,'dailyRecords'),where('date','==',today));
        const recSnap = await transaction.get(recQuery);

        if (recSnap.empty) {
          transaction.set(doc(collection(db,'users',user.uid,'dailyRecords')),{date:today,status:'Yes'});
        } else {
          transaction.update(recSnap.docs[0].ref,{status:'Yes'});
        }
      });

      alert('Today marked as completed! Keep up the great work! ‚ú®');
      await updateStreakDisplay(user.uid);
      await renderCalendar(user.uid);
      checkAndToggleMarkButton(user.uid);
    };

  </script>
</body>
</html>
