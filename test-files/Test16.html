<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Template C — SquadVertex</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#48bb78;--muted:#6b7280}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .channel-banner{height:220px;background-size:cover;background-position:center;display:flex;align-items:end;padding:18px;position:relative;border-bottom:6px solid rgba(0,0,0,0.06)}
    .container{max-width:1100px;margin:-70px auto 60px;padding:0 20px}
    .channel-details{display:flex;gap:20px;align-items:center;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(16,24,40,0.06)}
    .channel-logo{width:96px;height:96px;border-radius:12px;object-fit:cover;background:#eee;display:block}
    .channel-name{font-size:22px;margin:0}
    .channel-tagline{color:var(--muted);margin:6px 0}
    .channel-description{margin:8px 0 0;color:#333}
    .social-media{margin-left:auto;display:flex;gap:10px}
    .social-media a{display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit}
    .nav-buttons{display:flex;gap:10px;justify-content:center;margin:18px 0}
    .nav-button{padding:10px 14px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .section-title{font-size:18px;margin:0 0 8px}
    .shorts-grid,.replays-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .shorts-item,.replays-item{background:#fff;border-radius:8px;height:120px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .video-placeholder{color:var(--muted)}
    .top-contributors{background:#fff;padding:16px;border-radius:12px;min-height:220px}
    footer{padding:26px 20px;text-align:center;color:var(--muted);margin-top:40px}
    .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s linear infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    @media(max-width:900px){ .main{grid-template-columns:1fr} .shorts-grid,.replays-grid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div id="channel-banner" class="channel-banner" style="background-image: linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url('https://images.unsplash.com/photo-1508766206392-8bd5cf550d1b?auto=format&fit=crop&w=1400&q=60');">
  </div>

  <div class="container">
    <div class="channel-details">
      <img id="channel-logo" class="channel-logo" src="https://www.squadvertex.great-site.net/assets/default-logo.png" alt="logo">
      <div>
        <h1 id="channel-name" class="channel-name">SquadVertex</h1>
        <div id="channel-tagline" class="channel-tagline">Gaming • Strategy • Community</div>
        <p id="channel-description" class="channel-description">Default portal — public demo for SquadVertex template C.</p>
      </div>

      <div class="social-media" style="margin-left:auto">
        <a id="youtube-link" href="https://www.youtube.com/" target="_blank">
          <img src="https://img.icons8.com/color/48/youtube-play.png" style="width:28px;height:28px" alt="YouTube">
          <span id="youtube-subs" class="skeleton" style="width:120px;height:14px;display:inline-block;border-radius:6px"></span>
        </a>
        <a id="instagram-link" href="https://www.instagram.com/" target="_blank">
          <img src="https://img.icons8.com/color/48/instagram-new.png" style="width:28px;height:28px" alt="Instagram">
          <span id="instagram-followers" class="skeleton" style="width:80px;height:14px;display:inline-block;border-radius:6px"></span>
        </a>
      </div>
    </div>

    <div class="nav-buttons" role="navigation" aria-label="portal nav">
      <button class="nav-button" onclick="location.href='#'">Explore Content</button>
      <button class="nav-button" onclick="location.href='#'">Submit Replay</button>
      <button class="nav-button" onclick="location.href='#'">Leaderboard</button>
      <button class="nav-button" onclick="location.href='#'">Submit via Email</button>
    </div>

    <div class="main">
      <div>
        <section class="shorts-section">
          <h2 class="section-title">Fan Shorts</h2>
          <div class="shorts-grid" id="shortsContainer">
            <div class="shorts-item skeleton"><div class="video-placeholder">Loading Short...</div></div>
            <div class="shorts-item skeleton"><div class="video-placeholder">Loading Short...</div></div>
            <div class="shorts-item skeleton"><div class="video-placeholder">Loading Short...</div></div>
          </div>
        </section>

        <section class="replays-section" style="margin-top:18px;">
          <h2 class="section-title">Fan Replays</h2>
          <div class="replays-grid" id="replaysContainer">
            <div class="replays-item skeleton"><div class="video-placeholder">Loading Replay...</div></div>
            <div class="replays-item skeleton"><div class="video-placeholder">Loading Replay...</div></div>
            <div class="replays-item skeleton"><div class="video-placeholder">Loading Replay...</div></div>
          </div>
        </section>
      </div>

      <aside>
        <div class="top-contributors">
          <h3 class="section-title">Top Contributors</h3>
          <p style="color:var(--muted);margin-top:8px">Coming soon — contributors & donations will show here.</p>
          <div style="margin-top:12px;font-size:12px;color:var(--muted)">
            Viewing mode: <strong id="portal-mode">Default</strong>
            <div id="debug-note" style="margin-top:8px;font-size:12px;color:#a0a0a0"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div style="max-width:900px;margin:0 auto">
        <p style="margin:8px 0 0">© 2024-2025 SquadVertex Powered Portal. All rights reserved.</p>
      </div>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };

    // Put your YouTube API key here (client-side, visible)
    const YT_API_KEY = "AIzaSyALYK2h1PDv9yDVR3PlFkB4ZAhbu9E1-rA";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM refs
    const bannerEl = document.getElementById('channel-banner');
    const logoEl = document.getElementById('channel-logo');
    const nameEl = document.getElementById('channel-name');
    const taglineEl = document.getElementById('channel-tagline');
    const descEl = document.getElementById('channel-description');
    const ytLinkEl = document.getElementById('youtube-link');
    const instaLinkEl = document.getElementById('instagram-link');
    const ytSubsEl = document.getElementById('youtube-subs');
    const instaEl = document.getElementById('instagram-followers');
    const shortsContainer = document.getElementById('shortsContainer');
    const replaysContainer = document.getElementById('replaysContainer');
    const portalModeEl = document.getElementById('portal-mode');
    const debugNoteEl = document.getElementById('debug-note');

    // Defaults
    const defaults = {
      bannerUrl: 'https://images.unsplash.com/photo-1508766206392-8bd5cf550d1b?auto=format&fit=crop&w=1400&q=60',
      logoUrl: 'https://www.squadvertex.great-site.net/assets/default-logo.png',
      channelName: 'SquadVertex',
      tagline: 'Gaming • Strategy • Community',
      description: 'This is the default demo view for Template C. Add ?id=UID to the URL to load a user portal.',
      youtubeLink: 'https://www.youtube.com/',
      instagramLink: 'https://www.instagram.com/',
      youtubeSubsText: '— Subscribers',
      instaFollowersText: '— Followers',
      shorts: [],
      videos: []
    };

    function getQueryUID(){
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || params.get('uid') || null;
    }

    function clearGrid(container){ container.innerHTML = ''; }
    function extractVideoId(url){
      if(!url) return null;
      const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/|.*embed\/|shorts\/))([^?&/]+)/);
      return m ? m[1] : null;
    }
    function appendVideo(container, url, cls){
      const id = extractVideoId(url) || 'dQw4w9WgXcQ';
      const frame = document.createElement('iframe');
      frame.src = `https://www.youtube.com/embed/${id}`;
      frame.setAttribute('frameborder','0');
      frame.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
      frame.setAttribute('allowfullscreen','');
      frame.style.width = '100%';
      frame.style.height = '100%';
      const wrapper = document.createElement('div');
      wrapper.style.height = '120px';
      wrapper.style.overflow = 'hidden';
      wrapper.style.borderRadius = '8px';
      wrapper.appendChild(frame);
      container.appendChild(wrapper);
    }

    function applyPortalData(payload = {}){
      const data = Object.assign({}, defaults, payload || {});
      bannerEl.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url('${data.bannerUrl}')`;
      logoEl.src = data.logoUrl;
      nameEl.textContent = data.channelName;
      taglineEl.textContent = data.tagline;
      descEl.textContent = data.description;
      ytLinkEl.href = data.youtubeLink;
      instaLinkEl.href = data.instagramLink;
      ytSubsEl.classList.remove('skeleton'); ytSubsEl.textContent = data.youtubeSubsText || defaults.youtubeSubsText;
      instaEl.classList.remove('skeleton'); instaEl.textContent = data.instaFollowersText || defaults.instaFollowersText;

      clearGrid(shortsContainer);
      clearGrid(replaysContainer);

      const shorts = Array.isArray(data.shorts) ? data.shorts : [];
      const vids = Array.isArray(data.videos) ? data.videos : [];

      if(shorts.length){
        shorts.slice(0,3).forEach(u => appendVideo(shortsContainer, u, 'shorts-item'));
      } else {
        for(let i=0;i<3;i++){
          const ph = document.createElement('div'); ph.className='shorts-item skeleton'; ph.innerHTML = '<div class="video-placeholder">No Shorts</div>'; shortsContainer.appendChild(ph);
        }
      }

      if(vids.length){
        vids.slice(0,3).forEach(u => appendVideo(replaysContainer, u, 'replays-item'));
      } else {
        for(let i=0;i<3;i++){
          const ph = document.createElement('div'); ph.className='replays-item skeleton'; ph.innerHTML = '<div class="video-placeholder">No Replays</div>'; replaysContainer.appendChild(ph);
        }
      }
    }

    // fetch docs: users/{uid}/profile_data/{settings,shorts,videos}
    async function fetchUserPortal(uid){
      const settingsRef = doc(db, 'users', uid, 'profile_data', 'settings');
      const shortsRef   = doc(db, 'users', uid, 'profile_data', 'shorts');
      const videosRef   = doc(db, 'users', uid, 'profile_data', 'videos');

      const [sSnap, shSnap, vSnap] = await Promise.all([getDoc(settingsRef), getDoc(shortsRef), getDoc(videosRef)]);
      const payload = {};

      if(sSnap.exists()){
        const s = sSnap.data();
        if(s.bannerUrl) payload.bannerUrl = s.bannerUrl;
        if(s.logoUrl) payload.logoUrl = s.logoUrl;
        if(s.channelName) payload.channelName = s.channelName;
        if(s.tagline) payload.tagline = s.tagline;
        if(s.description) payload.description = s.description;
        if(s.youtubeLink) payload.youtubeLink = s.youtubeLink;
        if(s.youtubeChannelId) payload.youtubeChannelId = s.youtubeChannelId;
        if(s.youtubeSubsText) payload.youtubeSubsText = s.youtubeSubsText;
        if(s.instagramLink) payload.instagramLink = s.instagramLink;
        if(s.instaCount !== undefined) payload.instaFollowersText = `${s.instaCount} Followers`;
      }

      if(shSnap.exists()){
        const sh = shSnap.data();
        if(Array.isArray(sh.content)) payload.shorts = sh.content;
        else if(Array.isArray(sh.items)) payload.shorts = sh.items;
      }

      if(vSnap.exists()){
        const v = vSnap.data();
        if(Array.isArray(v.content)) payload.videos = v.content;
        else if(Array.isArray(v.items)) payload.videos = v.items;
      }

      return payload;
    }

    // Fetch youtube channel data via API (if we have channelId)
    async function fetchYoutubeChannel(channelId){
      if(!YT_API_KEY || !channelId) return null;
      const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${encodeURIComponent(channelId)}&key=${YT_API_KEY}`;
      try {
        const res = await fetch(url);
        if(!res.ok){
          console.warn('YT API not ok', res.status);
          return null;
        }
        const data = await res.json();
        if(data.items && data.items.length > 0) return data.items[0];
        return null;
      } catch(e){
        console.error('YT fetch error', e);
        return null;
      }
    }

    (async function main(){
      // show defaults first
      applyPortalData();

      const uid = getQueryUID();
      if(!uid){
        portalModeEl.textContent = 'Default (no UID)';
        debugNoteEl.textContent = 'Add ?id=USER_UID to URL to load a user portal.';
        return;
      }

      portalModeEl.textContent = 'User-specific (loading...)';
      debugNoteEl.textContent = `Attempting to load: users/${uid}/profile_data/{settings,shorts,videos}`;

      try {
        const payload = await fetchUserPortal(uid);
        if(Object.keys(payload).length === 0){
          debugNoteEl.textContent = `No profile_data docs found for UID ${uid}. Showing defaults.`;
          portalModeEl.textContent = 'User-specific (no data)';
          return;
        }

        // if payload contains youtubeChannelId or youtubeLink -> try YT API
        let channelId = payload.youtubeChannelId || null;
        if(!channelId && payload.youtubeLink){
          // attempt to parse /channel/ID
          const m = payload.youtubeLink.match(/youtube\.com\/channel\/([A-Za-z0-9_-]+)/);
          if(m) channelId = m[1];
        }

        if(channelId && YT_API_KEY){
          const channel = await fetchYoutubeChannel(channelId);
          if(channel){
            payload.channelName = channel.snippet?.title || payload.channelName;
            payload.logoUrl = channel.snippet?.thumbnails?.default?.url || payload.logoUrl;
            const subs = channel.statistics?.subscriberCount;
            if(subs !== undefined) payload.youtubeSubsText = `${parseInt(subs).toLocaleString()} Subscribers`;
          } else {
            // fallback: if settings provided youtubeSubsText keep it; else leave default
            console.warn('YT channel not found or API failed for', channelId);
          }
        } else {
          // If no channelId but settings provided a channelName/logo/subs, keep them.
        }

        applyPortalData(payload);
        portalModeEl.textContent = `User-specific (${uid})`;
        debugNoteEl.textContent = `Loaded data from user ${uid}.`;
        console.log('Portal payload:', payload);
      } catch(err){
        console.error('Failed to load user portal:', err);
        if(err && err.code === 'permission-denied'){
          descEl.textContent = 'This portal is private (permission-denied).';
          debugNoteEl.textContent = 'Firestore read blocked: permission-denied';
        } else {
          descEl.textContent = 'Could not load user portal — showing defaults.';
          debugNoteEl.textContent = 'Network or read error while fetching user data.';
        }
        portalModeEl.textContent = 'Error';
      }
    })();
  </script>
</body>
</html>