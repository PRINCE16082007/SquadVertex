<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Management - GalaxyWeb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body, html {
      margin: 0; padding: 0;
      background-color: #0f1620;
      color: #fff;
      font-family: Arial, sans-serif;
      height: 100%;
      min-height: 100vh;
    }
    main {
      max-width: 900px;
      margin: 90px auto 90px;
      padding: 20px;
      background: #121a30;
      border-radius: 16px;
      box-shadow: 0 0 52px #0c1425c4;
    }
    h1 {
      font-size: 2.6rem;
      font-weight: 700;
      color: #ffd03a;
      margin-bottom: 30px;
      user-select: none;
      text-shadow: 0 0 8px #fadb5d;
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }
    label {
      font-size: 1.15rem;
      font-weight: 600;
    }
    input[type="text"], textarea {
      padding: 13px 16px;
      font-size: 1rem;
      border-radius: 14px;
      border: none;
      background: #222e53;
      color: #eef4ff;
      resize: vertical;
    }
    input[type="text"]:focus, textarea:focus {
      outline: 2px solid #ffd03a;
      background: #2f3a64;
    }
    textarea {
      min-height: 100px;
      max-height: 250px;
    }
    #imagesContainer {
      border: 1px solid #2c3859;
      border-radius: 14px;
      background: #1a2348;
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 10px 16px;
    }
    .image-input-row {
      display: flex;
      gap: 12px;
    }
    .image-input-row input[type=text] {
      flex-grow: 1;
    }
    .image-input-row button {
      border-radius: 50%;
      border: none;
      background: #e94e4e;
      color: white;
      font-weight: 700;
      cursor: pointer;
      width: 32px;
      height: 32px;
      user-select: none;
      transition: background-color 0.25s;
    }
    .image-input-row button:hover {
      background: #b52f2f;
    }
    button#addImageBtn {
      margin-top: 10px;
      align-self: flex-start;
      background: #ffd036;
      color: #1d1d1d;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      padding: 12px 36px;
      cursor: pointer;
      text-shadow: 0 0 1px #3f3f3f;
      transition: background 0.3s ease;
    }
    button#addImageBtn:hover {
      background: #b58f09;
    }
    button#submitBtn {
      padding: 15px 0;
      font-size: 1.2rem;
      background: linear-gradient(90deg, #ffd034 50%, #64c3ff 100%);
      border: none;
      border-radius: 15px;
      font-weight: 700;
      cursor: pointer;
      color: #0f1620;
      margin-top: 24px;
      user-select: none;
      transition: background 0.3s ease;
    }
    button#submitBtn:hover {
      background: linear-gradient(90deg, #64c3ff 50%, #ffd034 100%);
    }
    .msg {
      margin-top: 18px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #64c3ff;
      user-select: text;
    }
    .error-msg {
      color: #f24a4a;
    }
  </style>
</head>
<body>
  <main>
    <h1>Portfolio Category Management</h1>
    <form id="portfolioForm">
      <label for="docName">Category Document ID <small>(unique, e.g., 1, 2, categoryA)</small>:</label>
      <input id="docName" name="docName" type="text" placeholder="Enter unique doc ID" required />

      <label for="title">Category Title:</label>
      <input id="title" name="title" type="text" placeholder="Enter category title" required />

      <label for="description">Category Description:</label>
      <textarea id="description" name="description" placeholder="Enter description" required></textarea>

      <label>Image URLs:</label>
      <div id="imagesContainer">
        <div class="image-input-row">
          <input name="imageUrl[]" type="text" placeholder="Enter image URL" required />
          <button type="button" class="removeBtn" style="display:none;">×</button>
        </div>
      </div>
      <button type="button" id="addImageBtn">+ Add Image URL</button>

      <button type="submit" id="submitBtn">Save Category</button>
    </form>
    <div id="msgBox" class="msg"></div>
  </main>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>
<script src="https://www.google.com/recaptcha/api.js?render=6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
  };
  firebase.initializeApp(firebaseConfig);

  // Activate App Check with reCaptcha V3
  try {
    const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider('6Ld395IrAAAAAIvG4gyf0vUJeI_jKOsI9XVn0jUx');
    firebase.appCheck().activate(appCheckProvider, true);
  } catch (e) {
    console.warn('App Check activation failed:', e);
  }

  const db = firebase.firestore();

  // Form elements refs
  const form = document.getElementById('portfolioForm');
  const imagesContainer = document.getElementById('imagesContainer');
  const addImageBtn = document.getElementById('addImageBtn');
  const msgBox = document.getElementById('msgBox');

  // Add new image URL input row
  addImageBtn.addEventListener('click', () => {
    const newDiv = document.createElement('div');
    newDiv.className = 'image-input-row';

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'imageUrl[]';
    input.placeholder = 'Enter image URL';
    input.required = true;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'removeBtn';
    removeBtn.title = 'Remove this URL';
    removeBtn.textContent = '×';
    removeBtn.addEventListener('click', () => {
      imagesContainer.removeChild(newDiv);
      updateRemoveButtons();
    });

    newDiv.appendChild(input);
    newDiv.appendChild(removeBtn);
    imagesContainer.appendChild(newDiv);
    updateRemoveButtons();
  });

  function updateRemoveButtons() {
    const removeButtons = imagesContainer.querySelectorAll('.removeBtn');
    if (removeButtons.length === 1) {
      removeButtons[0].style.display = 'none';
    } else {
      removeButtons.forEach(btn => btn.style.display = 'inline-block');
    }
  }

  updateRemoveButtons();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msgBox.textContent = '';
    msgBox.className = 'msg';

    const docName = form.docName.value.trim();
    const title = form.title.value.trim();
    const description = form.description.value.trim();

    if(!docName || !title || !description) {
      msgBox.textContent = 'Please fill all required fields.';
      msgBox.className = 'msg error-msg';
      return;
    }

    const imageInputs = imagesContainer.querySelectorAll('input[name="imageUrl[]"]');
    const imageUrls = [...imageInputs].map(input => input.value.trim()).filter(url => url.length > 0);

    if(imageUrls.length === 0) {
      msgBox.textContent = 'Please add at least one image URL.';
      msgBox.className = 'msg error-msg';
      return;
    }

    try {
      msgBox.textContent = 'Saving category... please wait.';
      // Save category document with title & description
      await db.collection('portfolio').doc(docName).set({ title, description });

      // Clear old images if any
      const imagesRef = db.collection('portfolio').doc(docName).collection('images');
      const oldImagesSnapshot = await imagesRef.get();
      const batch = db.batch();
      oldImagesSnapshot.forEach(d => batch.delete(d.ref));
      await batch.commit();

      // Add new images documents
      for (const url of imageUrls) {
        await imagesRef.add({ url });
      }

      msgBox.textContent = 'Category saved successfully!';
      form.reset();
      imagesContainer.innerHTML = '';
      // Add a fresh empty image input row after reset
      addImageBtn.click();
    } catch (error) {
      msgBox.textContent = 'Error saving category: ' + error.message;
      msgBox.className = 'msg error-msg';
    }
  });
</script>
</body>
</html>
