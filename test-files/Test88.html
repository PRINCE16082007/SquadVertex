<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | SquadVertex</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 2rem;
    }
    h1 { text-align:center; color:#1db954; margin-bottom:1.5rem; }
    #error-banner {
      display:none;
      background:#ffe6e6;
      color:#b00;
      padding:0.75rem 1rem;
      border:1px solid #f00;
      border-radius:4px;
      margin-bottom:1rem;
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
      border-radius:8px;
      overflow:hidden;
    }
    th, td {
      padding:0.75rem 1rem;
      text-align:left;
      border-bottom:1px solid #e0e0e0;
    }
    th {
      background:#e8f5e9;
      color:#2e7d32;
      font-weight:600;
    }
    tr:last-child td { border-bottom:none; }
    img.avatar {
      width:40px; height:40px;
      border-radius:50%;
      object-fit:cover;
    }
    select, input {
      padding:0.4rem 0.6rem;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:0.9rem;
      width:100%;
      box-sizing:border-box;
    }
    .actions { display:flex; gap:0.5rem; align-items:center; }
    button.apply-btn {
      padding:0.45rem 0.9rem;
      background:#1db954;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:0.9rem;
      transition:background 0.2s;
    }
    button.apply-btn:hover { background:#17a144; }
    .reason-custom { display:none; margin-top:0.5rem; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div id="error-banner"></div>
  <table id="users-table">
    <thead>
      <tr>
        <th>Photo</th>
        <th>Name / Email</th>
        <th>Status</th>
        <th>SVX</th>
        <th>Adjust</th>
        <th>Reason</th>
        <th>Apply</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Show errors
    function showError(msg) {
      const b = document.getElementById('error-banner');
      b.textContent = msg;
      b.style.display = 'block';
    }

    // Firebase init
    const cfg = {
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    const app = initializeApp(cfg);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Build a table row
    function buildRow(userDoc) {
      const data = userDoc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <img class="avatar" src="${data.photoURL||userDoc.data().email}" 
               onerror="this.src='https://www.gstatic.com/images/branding/product/1x/avatar_circle_grey_512dp.png';">
        </td>
        <td>
          <strong>${data.name||'(No Name)'}</strong><br>
          <small style="color:#555;">${data.email}</small>
        </td>
        <td>
          <select class="status-select">
            <option ${data.status==='User'?'selected':''}>User</option>
            <option ${data.status==='Creator'?'selected':''}>Creator</option>
            <option ${data.status==='Moderator'?'selected':''}>Moderator</option>
            <option ${data.status==='Admin'?'selected':''}>Admin</option>
          </select>
        </td>
        <td class="svx-cell">${data.svx||0}</td>
        <td><input type="number" class="svx-input" placeholder="+/-"></td>
        <td>
          <select class="reason-select">
            <option value="bonus">bonus</option>
            <option value="gift">gift</option>
            <option value="birthday">birthday</option>
            <option value="congratulations">congratulations</option>
            <option value="winner">winner</option>
            <option value="other">other</option>
          </select>
          <input type="text" class="reason-custom" placeholder="Reason">
        </td>
        <td><button class="apply-btn">Apply</button></td>
      `;
      // reason toggle
      const rs = tr.querySelector('.reason-select');
      const rc = tr.querySelector('.reason-custom');
      rs.addEventListener('change', ()=> rc.style.display = rs.value==='other'?'block':'none');
      // apply
      tr.querySelector('.apply-btn').addEventListener('click', async ()=>{
        try {
          const uid = userDoc.id;
          const ref = doc(db,'users',uid);
          const newStatus = tr.querySelector('.status-select').value;
          const delta = parseInt(tr.querySelector('.svx-input').value);
          let reason = rs.value==='other'
            ? rc.value.trim()||'other'
            : rs.value;
          // update status
          if (newStatus!==data.status) await updateDoc(ref,{status:newStatus});
          // update SVX
          if (!isNaN(delta)&&delta!==0) {
            const newSvx = (data.svx||0)+delta;
            await updateDoc(ref,{svx:newSvx});
            await addDoc(collection(db,'users',uid,'transactions'),{
              amount:delta,
              reason,
              timestamp:serverTimestamp()
            });
            tr.querySelector('.svx-cell').textContent=newSvx;
          }
        } catch(e) {
          console.error(e);
          showError('Error: '+e.message);
        }
      });
      return tr;
    }

    // Render
    async function renderUsers(){
      try {
        const tbody = document.querySelector('#users-table tbody');
        tbody.innerHTML='';
        const snap = await getDocs(collection(db,'users'));
        snap.forEach(doc=> tbody.appendChild(buildRow(doc)));
      } catch(e){
        console.error(e);
        showError('Failed to load users: '+e.message);
      }
    }

    // Auth
    onAuthStateChanged(auth,user=>{
      if(!user) return location.href='account.html';
      renderUsers();
    });
  </script>
</body>
</html>