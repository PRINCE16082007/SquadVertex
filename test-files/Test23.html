<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gmail-Only Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Secure Chat Login</h1>
  <input id="email" type="email" placeholder="your@gmail.com" />
  <button id="send-link">Send Magic Link</button>
  <div id="status"></div>

  <script>
    // 1️⃣ Init Supabase
    const SUPA_URL   = 'https://dvjihjkyenzkacviywgk.supabase.co';
    const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2amloamt5ZW56a2Fjdml5d2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMzQ0MTgsImV4cCI6MjA2MzgxMDQxOH0.1Hl9Cb-rTbHKDSlnn2tM-6trzOySigUg6Be0xVG2URg';
    const supabase  = supabase.createClient(SUPA_URL, SUPA_ANON);

    // 2️⃣ Magic-link flow
    document.getElementById('send-link').onclick = async () => {
      const email = document.getElementById('email').value;
      document.getElementById('status').textContent = 'Sending magic link…';
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) {
        document.getElementById('status').textContent = 'Error: ' + error.message;
      } else {
        document.getElementById('status').textContent = 'Check your Gmail for the link!';
      }
    };

    // 3️⃣ On return (user clicks link)
    window.onload = async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        console.error(error);
        return;
      }
      if (session) {
        // User’s email is session.user.email
        const email      = session.user.email;
        const name       = session.user.user_metadata.full_name || email;
        const deviceHash = await getDeviceFingerprint(); // same fingerprint fn

        // Call your register-user function…
        const res = await fetch(
          `${SUPA_URL.replace('.co','')}.functions.supabase.co/register-user`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, name, deviceHash })
          }
        );
        const data = await res.json();
        if (data.status === 'authorized'||data.status==='registered') {
          window.location.href = '/chat.html';
        } else {
          document.body.innerHTML = '<h2>Access Denied: Unauthorized device</h2>';
        }
      }
    };

    // ≥ Fingerprint fn (same as before)
    async function getDeviceFingerprint() {
      const info = [
        navigator.userAgent, navigator.language,
        screen.width, screen.height, screen.colorDepth,
        new Date().getTimezoneOffset(), window.devicePixelRatio,
        navigator.hardwareConcurrency, navigator.platform
      ];
      const buf = await crypto.subtle.digest(
        'SHA-256', new TextEncoder().encode(info.join('::'))
      );
      return Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2,'0'))
        .join('');
    }
  </script>
</body>
</html>