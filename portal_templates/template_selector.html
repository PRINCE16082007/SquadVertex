<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Selector — SquadVertex</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #0f1724;
      --card: rgba(255, 255, 255, 0.03);
      --accent: #7dd3fc;
      --accent-dark: #0ea5e9;
      --muted: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
      --text: #e6eef6;
      --border: rgba(255, 255, 255, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #061223 0%, #071425 100%);
      background-attachment: fixed;
    }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .title-section h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #7dd3fc, #38bdf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title-section p.lead {
      font-size: 16px;
      color: var(--muted);
      line-height: 1.5;
      max-width: 500px;
    }

    .user-card {
      display: flex;
      gap: 14px;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, #0ea5e9, #7dd3fc);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0f172a;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-weight: 600;
      font-size: 16px;
    }

    .user-id {
      font-size: 12px;
      color: var(--muted);
    }

    .btn {
      background: var(--accent);
      border: 0;
      color: #0f172a;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 10px rgba(125, 211, 252, 0.15);
    }

    .btn:hover {
      background: #bae6fd;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(125, 211, 252, 0.25);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }

    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      border-color: rgba(125, 211, 252, 0.2);
    }

    .card.selected {
      border: 1px solid var(--accent);
      box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.3);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .template-name {
      font-weight: 700;
      font-size: 18px;
    }

    .selected-badge {
      background: var(--success);
      color: #022;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
    }

    .template-image {
      width: 100%;
      height: 150px;
      border-radius: 8px;
      object-fit: cover;
      background: linear-gradient(135deg, #1e293b, #334155);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      overflow: hidden;
    }

    .template-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .card:hover .template-image img {
      transform: scale(1.03);
    }

    .card-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: auto;
    }

    .action-btn {
      flex: 1;
      text-align: center;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 14px 20px;
      border-radius: 8px;
      background: rgba(30, 41, 59, 0.95);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid var(--accent);
      max-width: 320px;
      backdrop-filter: blur(10px);
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--error);
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .status-bar {
      margin-top: 20px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
    }

    .status-indicator.active {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .status-indicator.loading {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 36, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .confirmation-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .confirmation-modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h2 {
      font-size: 22px;
      margin-bottom: 8px;
      color: var(--accent);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .user-card {
        width: 100%;
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .wrap {
        padding: 20px 15px;
      }

      .card-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title-section">
        <h1>Choose Your Profile Template</h1>
        <p class="lead">Select a template for your profile. Once selected, this cannot be changed.</p>
      </div>

      <div class="user-card" id="userBlock">
        <div class="avatar" id="avatar">SV</div>
        <div class="user-info">
          <div class="user-name" id="who">Not signed in</div>
          <div class="user-id" id="uidShort"></div>
        </div>
        <button id="signBtn" class="btn">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" style="margin-right:5px">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.25 15.25V6.75H8.75"></path>
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 7L6.75 17.25"></path>
          </svg>
          Sign in with Google
        </button>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <!-- Templates will be injected here -->
    </div>

    <div class="status-bar">
      <div class="status-indicator" id="statusIndicator"></div>
      <div id="status">Ready to select your template</div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="confirmation-modal" id="confirmationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Confirm Template Selection</h2>
        <p>You are about to select the template: <span id="templateNameConfirm" style="font-weight:600"></span></p>
      </div>
      <p>This action is <strong style="color:var(--accent)">permanent</strong> and cannot be changed later. Are you sure you want to proceed?</p>
      <div class="modal-actions">
        <button class="btn ghost" id="modalCancelBtn">Cancel</button>
        <button class="btn" id="modalConfirmBtn">Confirm Selection</button>
      </div>
    </div>
  </div>

  <script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
    authDomain: "squadvertex2007.firebaseapp.com",
    projectId: "squadvertex2007",
    storageBucket: "squadvertex2007.appspot.com",
    messagingSenderId: "168905083514",
    appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
  };

  // UI Elements
  const signBtn = document.getElementById('signBtn');
  const grid = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const statusIndicator = document.getElementById('statusIndicator');
  const avatar = document.getElementById('avatar');
  const who = document.getElementById('who');
  const uidShort = document.getElementById('uidShort');
  const toastContainer = document.getElementById('toastContainer');
  const confirmationModal = document.getElementById('confirmationModal');
  const templateNameConfirm = document.getElementById('templateNameConfirm');
  const modalCancelBtn = document.getElementById('modalCancelBtn');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');

  // Templates data
  const T = {
    templateA: { 
      id: 'templateA', 
      name: 'Soft Pink', 
      img: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=800&q=60',
      previewUrl: 'https://squadvertex2007.web.app/preview/templateA'
    },
    templateB: { 
      id: 'templateB', 
      name: 'Dark Minimal', 
      img: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=800&q=60',
      previewUrl: 'https://squadvertex2007.web.app/preview/templateB'
    },
    templateC: { 
      id: 'templateC', 
      name: 'Nature Green', 
      img: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=800&q=60',
      previewUrl: 'https://squadvertex2007.web.app/preview/templateC'
    }
  };

  // State
  let firebaseReady = false;
  let db = null;
  let auth = null;
  let currentUser = null;
  let currentSelection = null;
  let selectedTemplate = null;

  // Toast notification system
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    let icon = 'ℹ️';
    if (type === 'success') icon = '✅';
    if (type === 'error') icon = '❌';

    toast.innerHTML = `
      <span class="toast-icon">${icon}</span>
      <span>${message}</span>
    `;

    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Set status with visual indicator
  function setStatus(message, state = 'idle') {
    statusEl.textContent = message;

    // Update indicator
    statusIndicator.className = 'status-indicator';
    if (state === 'loading') {
      statusIndicator.classList.add('loading');
    } else if (state === 'active') {
      statusIndicator.classList.add('active');
    }
  }

  // Render templates
  function renderCards() {
    grid.innerHTML = '';
    Object.values(T).forEach(t => {
      const isSelected = currentSelection === t.id;
      const card = document.createElement('div');
      card.className = `card ${isSelected ? 'selected' : ''}`;
      card.dataset.template = t.id;

      card.innerHTML = `
        <div class="card-header">
          <div class="template-name">${t.name}</div>
          ${isSelected ? '<div class="selected-badge">Selected</div>' : ''}
        </div>
        <div class="template-image">
          <img src="${t.img}" alt="${t.name} Template">
        </div>
        <div class="card-actions">
          <button class="btn ghost action-btn btn-preview">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" style="margin-right:5px">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.75 12C4.75 7 7 4.75 12 4.75C17 4.75 19.25 7 19.25 12C19.25 17 17 19.25 12 19.25C7 19.25 4.75 17 4.75 12Z"></path>
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 12C9.75 10.7574 10.7574 9.75 12 9.75C13.2426 9.75 14.25 10.7574 14.25 12C14.25 13.2426 13.2426 14.25 12 14.25C10.7574 14.25 9.75 13.2426 9.75 12Z"></path>
            </svg>
            Preview
          </button>
          <button class="btn ghost action-btn btn-copy">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" style="margin-right:5px">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.5 15.25V15.25C5.5335 15.25 4.75 14.4665 4.75 13.5V6.75C4.75 5.64543 5.64543 4.75 6.75 4.75H13.5C14.4665 4.75 15.25 5.5335 15.25 6.5V6.5"></path>
              <rect width="10.5" height="10.5" x="8.75" y="8.75" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" rx="2"></rect>
            </svg>
            Copy Link
          </button>
          <button class="btn action-btn btn-use" ${isSelected ? 'disabled' : ''}>
            ${isSelected ? 'Currently Selected' : 'Select Template'}
          </button>
        </div>
      `;

      grid.appendChild(card);
    });
  }

  // Show confirmation modal
  function showConfirmation(templateId) {
    const template = T[templateId];
    if (!template) return;

    selectedTemplate = templateId;
    templateNameConfirm.textContent = template.name;
    confirmationModal.classList.add('active');
  }

  // Hide confirmation modal
  function hideConfirmation() {
    confirmationModal.classList.remove('active');
    selectedTemplate = null;
  }

  // Save selection to Firestore
  async function saveSelection(tplId) {
    if (!firebaseReady || !db || !currentUser) {
      setStatus('Not ready to save', 'error');
      showToast('Please sign in to save your selection', 'error');
      return;
    }

    if (currentSelection) {
      setStatus('Template already selected', 'error');
      showToast('You have already selected a template', 'error');
      return;
    }

    setStatus('Saving your selection...', 'loading');

    const ref = db.collection('users').doc(currentUser.uid).collection('profile_template').doc('selection');
    const payload = {
      template_id: tplId,
      selected_at: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await ref.set(payload, { merge: true });
      currentSelection = tplId;
      renderCards();
      setStatus('Template saved successfully', 'active');
      showToast(`"${T[tplId].name}" template selected successfully!`, 'success');
      hideConfirmation();
    } catch (err) {
      console.error(err);
      setStatus('Save failed', 'error');
      showToast('Failed to save template: ' + (err.message || err), 'error');
    }
  }

  // Load user's selection
  async function loadSelection() {
    if (!firebaseReady || !db || !currentUser) return;

    setStatus('Loading your selection...', 'loading');

    try {
      const ref = db.collection('users').doc(currentUser.uid).collection('profile_template').doc('selection');
      const snap = await ref.get();

      if (snap.exists) {
        currentSelection = snap.data().template_id;
        setStatus('Template loaded successfully', 'active');
      } else {
        currentSelection = null;
        setStatus('No template selected yet', 'idle');
      }

      renderCards();
    } catch (err) {
      setStatus('Failed to load template', 'error');
      showToast('Error loading template: ' + (err.message || err), 'error');
      renderCards();
    }
  }

  // Initialize Firebase
  function safeInit() {
    try {
      if (!window.firebase) {
        setStatus('Firebase SDK missing', 'error');
        return false;
      }

      if (!firebase.apps || firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }

      if (!firebase.auth || !firebase.firestore) {
        setStatus('Firebase modules missing', 'error');
        return false;
      }

      auth = firebase.auth();
      db = firebase.firestore();
      firebaseReady = true;
      return true;
    } catch(e) {
      setStatus('Firebase init error: ' + (e.message || e), 'error');
      return false;
    }
  }

  // Authentication handling
  async function initAuth() {
    if (!safeInit()) return;

    setStatus('Initializing...', 'loading');
    renderCards();

      // Handle authentication state changes
    auth.onAuthStateChanged(async (u) => {
      if (u) {
        currentUser = u;
        who.textContent = u.displayName || u.email || `User-${u.uid.slice(0, 6)}`;
        uidShort.textContent = u.uid ? `ID: ${u.uid.slice(0, 8)}...` : '';
        avatar.textContent = u.displayName ? u.displayName[0].toUpperCase() : 'U';
        await loadSelection();
      } else {
        currentUser = null;
        currentSelection = null;
        who.textContent = 'Not signed in';
        uidShort.textContent = '';
        avatar.textContent = 'SV';
        setStatus('Please sign in to select a template', 'idle');
        renderCards();
      }
    });

    // Sign in button handler
    signBtn.addEventListener('click', async () => {
      if (!firebaseReady) {
        setStatus('Firebase not ready', 'error');
        return;
      }

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        setStatus('Signing in...', 'loading');
      } catch (err) {
        setStatus('Sign-in failed', 'error');
        showToast('Sign-in failed: ' + (err.message || err), 'error');
      }
    });

    // Set up delegated event handling
    grid.addEventListener('click', (ev) => {
      const preview = ev.target.closest('.btn-preview');
      const copy = ev.target.closest('.btn-copy');
      const use = ev.target.closest('.btn-use');
      const card = ev.target.closest('.card');

      if (!card) return;

      const tpl = card.dataset.template;
      if (!tpl) return;

      if (preview) {
        window.open(T[tpl].previewUrl, '_blank');
        return;
      }

      if (copy) {
        navigator.clipboard?.writeText(T[tpl].previewUrl)
          .then(() => showToast('Link copied to clipboard!', 'success'))
          .catch(() => showToast('Failed to copy link', 'error'));
        return;
      }

      if (use) {
        if (!currentUser) {
          showToast('Please sign in to select a template', 'error');
          return;
        }

        if (currentSelection) {
          showToast('You have already selected a template', 'error');
          return;
        }

        showConfirmation(tpl);
      }
    });

    // Modal button handlers
    modalCancelBtn.addEventListener('click', hideConfirmation);
    modalConfirmBtn.addEventListener('click', () => {
      if (selectedTemplate) {
        saveSelection(selectedTemplate);
      }
    });

    setStatus('Ready to select your template', 'idle');
  }

  // Initialize the application
  initAuth();
  </script>
</body>
</html>