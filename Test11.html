<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel Data Fetch</title>
    <style>
        /* Styling for Channel Cards */
        .channel-item {
            display: flex;
            align-items: center;
            background: #f0f0f0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .channel-item img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }

        .channel-info {
            flex-grow: 1;
        }

        .reaction-container {
            margin-top: 10px;
        }

        .reaction-btn {
            margin-right: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .like-btn {
            background-color: #4caf50;
            color: white;
        }

        .dislike-btn {
            background-color: #f44336;
            color: white;
        }

        .vip-badge {
            background-color: gold;
            color: black;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .test-button {
            margin-top: 10px;
            cursor: not-allowed;
        }

        .countdown-timer {
            margin-top: 10px;
            color: #555;
        }
    </style>
</head>
<body>
       <div id="channel-list">
     <div id="channel-container" class="channel-item">
            </div>
        </div>

            <script>
        // Firebase Backend URL
        const firebaseURL = "https://squadvertex2007-default-rtdb.firebaseio.com/channels.json";

        // YouTube API Key and Base URL
        const apiKey = "AIzaSyALYK2h1PDv9yDVR3PlFkB4ZAhbu9E1-rA";
        const youtubeBaseURL = "https://www.googleapis.com/youtube/v3/channels";

        // Function to fetch channel data from Firebase
        async function fetchChannelData() {
            try {
                const response = await fetch(firebaseURL);
                if (!response.ok) {
                    throw new Error("Failed to fetch data from Firebase");
                }

                // Fetch document IDs and data
                const data = await response.json();
                return Object.entries(data); // Returns an array of [documentID, fields] pairs
            } catch (error) {
                console.error("Error fetching channel data:", error);
                return [];
            }
        }

        // Function to fetch YouTube data
        async function fetchYouTubeData(channelId) {
            try {
                const response = await fetch(`${youtubeBaseURL}?part=statistics&id=${channelId}&key=${apiKey}`);
                if (!response.ok) {
                    throw new Error("Failed to fetch YouTube data");
                }

                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    const stats = data.items[0].statistics;
                    return {
                        subscribers: stats.subscriberCount,
                        videos: stats.videoCount
                    };
                }
                return { subscribers: "N/A", videos: "N/A" };
            } catch (error) {
                console.error(`Error fetching data for channel ID ${channelId}:`, error);
                return { subscribers: "N/A", videos: "N/A" };
            }
        }

        // Function to render channel cards dynamically
        async function renderChannels() {
            const channelListDiv = document.getElementById("channel-list");
            const channels = await fetchChannelData();

            for (const [channelId, channelData] of channels) {
                const { vip, portal, bg } = channelData;
                const portalFile = portal?.file || "#";
                const portalTime = portal?.time || null;
                const isVIP = vip === true;

                // Fetch YouTube data
                const { subscribers, videos } = await fetchYouTubeData(channelId);

                // Create channel card
                const channelCard = document.createElement("div");
                channelCard.className = "channel-item";
                channelCard.id = `channel-bg-${channelId}`;
                channelCard.style.backgroundImage = `url(${bg})`;

                // Build inner HTML
                channelCard.innerHTML = `
                    <img src="https://via.placeholder.com/80" alt="Channel Image">
                    <div class="channel-info">
                        <h3>${channelId}</h3>
                        <p class="subscriber-count">Subscribers: ${subscribers}</p>
                        <p class="video-count">Videos: ${videos}</p>
                        ${isVIP ? '<div class="vip-badge">VIP</div>' : ""}
                        <a href="https://youtube.com/@${channelId}" class="visit-channel" target="_blank">Visit Channel</a>
                        <div class="reaction-container">
                            <button class="reaction-btn like-btn">üëç <span id="likesCount-${channelId}">0</span></button>
                            <button class="reaction-btn dislike-btn">üëé</button>
                        </div>
                        <button class="test-button" ${
                            portalTime ? "" : "disabled"
                        } onclick="redirectToPortal('${portalFile}')">
                            üîí CustomPortal
                        </button>
                        <div class="countdown-timer" id="timer-${channelId}">
                            ${portalTime ? `<span id="countdown-${channelId}"></span>` : "N/A"}
                        </div>
                    </div>
                `;

                // Append channel card to the list
                channelListDiv.appendChild(channelCard);

                // Start countdown if portalTime is provided
                if (portalTime) {
                    startCountdown(new Date(portalTime), `countdown-${channelId}`);
                }
            }
        }

        // Function to redirect to CustomPortal
        function redirectToPortal(portalFile) {
            window.location.href = portalFile;
        }

        // Function to start countdown timer
        function startCountdown(targetDate, countdownId) {
            const countdownEl = document.getElementById(countdownId);

            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance <= 0) {
                    clearInterval(interval);
                    countdownEl.textContent = "Expired";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }

        // Initialize the app
        renderChannels();
    </script>
</body>
</html>