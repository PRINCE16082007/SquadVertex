<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vibrant Seating Layout Print View</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* Global styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f8ff;
      color: #333;
    }

      /* Navbar override */
      .navbar-brand {
        font-weight: bold;
        font-size: 1.5rem;
      }
      .navbar-nav .nav-link.active {
        position: relative;
        color: #fff;
        background-color: #007bff;
        border-radius: 5px;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
      }
      .navbar-nav .nav-link.active::before {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border-radius: 5px;
        border: 2px solid rgba(0, 123, 255, 0.6);
        opacity: 0.7;
        animation: glow 1.5s infinite alternate;
      }
      @keyframes glow {
        from {
          box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
        }
        to {
          box-shadow: 0 0 16px rgba(0, 123, 255, 0.8);
        }
      }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 10px;
      background: linear-gradient(135deg, #6dd5fa, #2980b9);
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    header h1 {
      margin: 0;
      font-size: 32px;
    }
    .instructions {
      font-size: 16px;
      margin-top: 8px;
    }
    /* Branding: round container for logo */
    #branding {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }
    #branding .logo-container {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      margin-right: 15px;
    }
    #branding .logo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #branding .school-name {
      font-size: 24px;
      font-weight: bold;
    }
    /* Controls styling */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 25px;
    }
    #controls label {
      font-weight: bold;
      margin-right: 5px;
    }
    #controls select, #controls input[type="checkbox"] {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #controls button {
      padding: 8px 20px;
      font-size: 14px;
      background-color: #2980b9;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #controls button:hover {
      background-color: #1f6391;
    }
    /* Print area & room container */
    #printArea {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .room-container {
      background: #fff;
      border: 2px solid #2980b9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .room-container h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #2980b9;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 10px;
    }
    table, td, th {
      border: 1px solid #ddd;
    }
    td {
      width: 120px;
      height: 120px;
      text-align: center;
      vertical-align: middle;
      padding: 5px;
      background: #f9f9f9;
    }
    .print-room-btn {
      display: block;
      width: 200px;
      margin: 10px auto 0;
      padding: 10px;
      font-size: 14px;
      background-color: #27ae60;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .print-room-btn:hover {
      background-color: #1e8c4d;
    }
    /* Black & White print mode */
    .bw {
      filter: grayscale(100%);
    }
    /* Print styles */
    @media print {
      #controls, header, #branding {
        display: none;
      }
      body {
        margin: 10mm;
        background: #fff;
      }
      .print-room-btn {
        display: none;
      }
    }
  </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SchoolMS</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="../admin_dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../admission/admission.html">Admissions</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Staff <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../attendance/attendance.html">Attendance</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Classes <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../fees_module/fees_module.html">Payment Module</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="exam_module.html">Exams</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../library/library.html">Library</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" tabindex="-1" aria-disabled="true">
                Transport <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../hostel/hostel.html">Hostel</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Communications <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Inventory <span class="bi bi-lock"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../events/events.html">Events</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../admin_panel/admin_panel.html">Admin &amp; Settings panel</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">
                Reports <span class="bi bi-lock"></span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  <header>
    <div id="branding">
      <div class="logo-container" id="logoContainer">
        <!-- Logo will be injected here -->
      </div>
      <div class="school-name" id="schoolName">Loading School Name...</div>
    </div>
    <h1>Seating Layout - Print View</h1>
    <div class="instructions">
      Choose a file, select a print template, and toggle between color and black &amp; white.  
      Use the "Print This Room" button for individual room printing or "Print All" for the entire layout.
    </div>
  </header>

  <div id="controls">
    <label for="fileSelect">Select File:</label>
    <select id="fileSelect"></select>
    
    <label for="templateSelect">Template:</label>
    <select id="templateSelect">
      <option value="1">Name Only</option>
      <option value="2">Name + Class</option>
      <option value="3">Name + Class + Stream</option>
      <option value="4">Name + Class + Stream + Subjects</option>
      <option value="5">Name + Father Name</option>
    </select>
    
    <label for="bwToggle">Black &amp; White:</label>
    <input type="checkbox" id="bwToggle">
    
    <button onclick="window.print()">Print All</button>
  </div>
  
  <div id="printArea">Loading seating layoutsâ€¦</div>
  <footer class="footer-section" style="background-color: #f8f9fa; padding: 20px 0; border-top: 1px solid #ccc; margin-top: 40px;">
  <div class="container">
    <div class="row align-items-center">
      <!-- Social Links -->
      <div class="col-md-4">
        <h3 style="margin-bottom: 15px;">Connect with Us</h3>
        <div class="social-links">
          <a href="https://www.instagram.com/squadvertex/?igsh=YzljYTk1ODg3Zg%3D%3D#" target="_blank" title="Instagram" style="margin-right: 10px;">
            <img src="https://img.icons8.com/color/48/instagram-new.png" alt="Instagram" style="width:32px; height:32px;">
          </a>
          <a href="https://x.com/SquadVertex_?t=iw82z-AjSDlmZxTzNid9sw&s=09" target="_blank" title="Twitter" style="margin-right: 10px;">
            <img src="https://img.icons8.com/color/48/twitter.png" alt="Twitter" style="width:32px; height:32px;">
          </a>
          <a href="https://discord.gg/dyWSDFREWZ" target="_blank" title="Discord" style="margin-right: 10px;">
            <img src="https://img.icons8.com/color/48/discord-logo.png" alt="Discord" style="width:32px; height:32px;">
          </a>
          <a href="https://youtube.com/@prince_squadvertex?si=djSrTHGczq73iFOi" target="_blank" title="YouTube">
            <img src="https://img.icons8.com/color/48/youtube-play.png" alt="YouTube" style="width:32px; height:32px;">
          </a>
        </div>
      </div>
      <!-- Copyright -->
      <div class="col-md-4 text-center">
        <p style="margin: 0;">&copy; 2025 SquadVertex. All rights reserved.</p>
      </div>
      <!-- Docs Redirect Button -->
      <div class="col-md-4 text-end">
        <a href="https://www.squadvertex.great-site.net/001-school/001-school_docs.html" target="_blank" class="btn btn-outline-primary" style="border-radius: 20px; padding: 6px 20px;">
          Docs
        </a>
      </div>
    </div>
  </div>
</footer>
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7Jg0BVzeCNQW9oiIiNItnejUsjj2DhA",
      authDomain: "squadvertex2007.firebaseapp.com",
      projectId: "squadvertex2007",
      storageBucket: "squadvertex2007.appspot.com",
      messagingSenderId: "168905083514",
      appId: "1:168905083514:web:c8bbe2ce9f87800a0f09c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let systemSettings = {};   // To store schoolName & logoUrl from "001-school/systemSettings"
    let students = {};         // Object mapping studentId -> student details
    let files = [];            // Array of file objects: { id, name }
    let rooms = [];            // Array of room objects for the selected file

    // Fetch system settings from "001-school/systemSettings"
    async function loadSystemSettings() {
      try {
        const settingsDoc = await db.collection("001-school").doc("systemSettings").get();
        if (settingsDoc.exists) {
          systemSettings = settingsDoc.data();
        } else {
          systemSettings = { schoolName: "Your School Name", logoUrl: "" };
        }
        renderBranding();
      } catch (e) {
        console.error("Error loading system settings:", e);
        systemSettings = { schoolName: "Your School Name", logoUrl: "" };
        renderBranding();
      }
    }

    // Render branding container with round logo and school name
    function renderBranding() {
      document.getElementById("schoolName").innerText = systemSettings.schoolName || "Your School Name";
      if (systemSettings.logoUrl) {
        document.getElementById("logoContainer").innerHTML = `<img src="${systemSettings.logoUrl}" alt="School Logo">`;
      } else {
        document.getElementById("logoContainer").innerHTML = "";
      }
    }

    // Load students from "001-school/students/list"
    async function loadStudents() {
      try {
        const studentsSnap = await db.collection("001-school").doc("students").collection("list").get();
        studentsSnap.docs.forEach(doc => {
          const data = doc.data();
          students[doc.id] = {
            name: data.studentName,
            class: data.class,
            stream: data.stream,
            subjects: data.subjects,
            fatherName: data.fatherName,
            gender: data.gender
          };
        });
      } catch (e) {
        console.error("Error loading students:", e);
      }
    }

    // Load available files from "001-school/rooms/files" and populate fileSelect dropdown
    async function loadFiles() {
      try {
        const filesSnap = await db.collection("001-school").doc("rooms").collection("files").get();
        files = filesSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
        const fileSelect = document.getElementById("fileSelect");
        fileSelect.innerHTML = files.map(f => `<option value="${f.id}">${f.name}</option>`).join("");
        if (files.length > 0) {
          loadRooms(files[0].id);
        } else {
          document.getElementById("printArea").innerText = "No room files found.";
        }
      } catch (e) {
        console.error("Error loading files:", e);
        document.getElementById("printArea").innerText = "Error loading room files.";
      }
    }

    // Load rooms from selected file ("001-school/rooms/files/{fileId}/layouts")
    async function loadRooms(fileId) {
      try {
        const layoutsSnap = await db.collection("001-school").doc("rooms").collection("files").doc(fileId).collection("layouts").get();
        rooms = layoutsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderPrintView();
      } catch (e) {
        console.error("Error loading rooms:", e);
        document.getElementById("printArea").innerText = "Error loading seating layouts.";
      }
    }

    // Generate seat content based on selected template
    function generateSeatContent(student, templateId) {
      if (!student) return "";
      switch (templateId) {
        case "1":
          return `<strong>${student.name}</strong>`;
        case "2":
          return `<strong>${student.name}</strong><br>${student.class}`;
        case "3":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}`;
        case "4":
          return `<strong>${student.name}</strong><br>${student.class}<br>${student.stream || ""}<br>${Array.isArray(student.subjects) ? student.subjects.join(", ") : ""}`;
        case "5":
          return `<strong>${student.name}</strong><br>Father: ${student.fatherName || "N/A"}`;
        default:
          return `<strong>${student.name}</strong>`;
      }
    }

    // Render print view for all rooms using the selected file and template
    function renderPrintView() {
      const templateId = document.getElementById("templateSelect").value;
      const isBW = document.getElementById("bwToggle").checked;
      let html = "";
      if (rooms.length === 0) {
        html = "No room layouts found for this file.";
      } else {
        rooms.forEach(room => {
          html += `<div class="room-container ${isBW ? 'bw' : ''}">
            <h2>${room.name} (${room.type})</h2>
            <table>`;
          for (let i = 0; i < room.rows; i++) {
            html += "<tr>";
            for (let j = 0; j < room.cols; j++) {
              const index = i * room.cols + j;
              let seatContent = "";
              if (room.seating && room.seating[index]) {
                const studentId = room.seating[index];
                if (students[studentId]) {
                  seatContent = generateSeatContent(students[studentId], templateId);
                }
              }
              html += `<td>${seatContent}</td>`;
            }
            html += "</tr>";
          }
          html += `</table>
            <button class="print-room-btn" onclick="printRoom('${room.id}')">Print This Room</button>
          </div>`;
        });
      }
      document.getElementById("printArea").innerHTML = html;
    }

    // Print a specific room in a new window
    function printRoom(roomId) {
      const templateId = document.getElementById("templateSelect").value;
      const isBW = document.getElementById("bwToggle").checked;
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;
      
      let roomHtml = `<html>
      <head>
        <title>Print Room: ${room.name}</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f8ff; }
          .branding { text-align: center; margin-bottom: 20px; }
          .branding .logo-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #2980b9;
            margin: 0 auto 10px;
          }
          .branding .logo-container img { width: 100%; height: 100%; object-fit: cover; }
          .branding h2 { font-size: 24px; color: #2980b9; }
          h2 { text-align: center; }
          table { border-collapse: collapse; margin: auto; width: 90%; }
          table, td { border: 1px solid #2980b9; }
          td { width: 120px; height: 120px; text-align: center; vertical-align: middle; padding: 5px; background: #fff; }
          ${isBW ? "body { filter: grayscale(100%); }" : ""}
        </style>
      </head>
      <body>
        <div class="branding">
          <div class="logo-container">
            ${systemSettings.logoUrl ? `<img src="${systemSettings.logoUrl}" alt="School Logo">` : ""}
          </div>
          <h2>${systemSettings.schoolName}</h2>
        </div>
        <h2>${room.name} (${room.type})</h2>
        <table>`;
      for (let i = 0; i < room.rows; i++) {
        roomHtml += "<tr>";
        for (let j = 0; j < room.cols; j++) {
          const index = i * room.cols + j;
          let seatContent = "";
          if (room.seating && room.seating[index]) {
            const studentId = room.seating[index];
            if (students[studentId]) {
              seatContent = generateSeatContent(students[studentId], templateId);
            }
          }
          roomHtml += `<td>${seatContent}</td>`;
        }
        roomHtml += "</tr>";
      }
      roomHtml += `</table>
      <script>
        window.onload = function() { window.print(); }
      <\/script>
      </body></html>`;
      
      const printWindow = window.open("", "PrintWindow", "width=900,height=700");
      printWindow.document.write(roomHtml);
      printWindow.document.close();
    }

    // Event listeners for control changes
    document.getElementById("fileSelect").addEventListener("change", function() {
      loadRooms(this.value);
    });
    document.getElementById("templateSelect").addEventListener("change", renderPrintView);
    document.getElementById("bwToggle").addEventListener("change", renderPrintView);

    // Initialize: load system settings, students, then files
    async function initialize() {
      await loadSystemSettings();
      await loadStudents();
      await loadFiles();
    }
    initialize();
  </script>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>